create or replace PACKAGE pkg_extracts
  IS
--------------------------------------------------------------------------------
-- Purpose: This package holds all the Reports extracts procedures.
--
-- MODIFICATION HISTORY
-- Person            Date        Comments
-- ---------         ------      ------------------------------------------       
-- Ravi Dhanekula    01/07/2013  Initial Version
--                   04/02/2014  Added fix for the defects 50697 and 52548 
-- Swati             05/13/2014  Bug 53312 - Country Filters not holding in exports
-- Suresh J          12/18/2014  Bug Fix 58022 - Extract Report Sorting to sync with Summary Table   
-- Swati             05/13/2015  SSI-Phase II Including SSI to Individual Extracts Report
-- J Flees           05/05/2016  G5 Nomination Redesign 
--------------------------------------------------------------------------------
   -- package types
   TYPE rec_file_extract IS RECORD
   (  -- stage table fields
      file_rec    VARCHAR2(4000)
   );

   TYPE tab_file_extract IS TABLE OF rec_file_extract;

   -- 05/05/2016 publicly declared function required for use in TABLE fucntion
   FUNCTION fnc_pipe_file_records
   RETURN tab_file_extract PIPELINED;
     
      PROCEDURE prc_nomination_dtl_extract
   ( p_in_parent_node_id_list IN VARCHAR2,
     p_in_department_list     IN VARCHAR2,
     p_in_job_type_list       IN VARCHAR2,
     p_in_country_id_list     IN VARCHAR2,
     p_in_promotion_id_list   IN VARCHAR2,
     p_in_nomi_status_list    IN VARCHAR2,
     p_in_participant_status  IN VARCHAR2,
     p_in_from_date           IN VARCHAR2,
     p_in_to_date             IN VARCHAR2,   
     p_in_locale              IN VARCHAR2,
     p_in_is_team             IN NUMBER,
     p_in_include_not_given       IN NUMBER,
--     p_in_include_recvd       IN NUMBER,
     p_in_include_comment     IN NUMBER,
     p_in_has_given           IN NUMBER,
     p_in_has_recvd           IN NUMBER,
     p_in_viewer_user_id      IN NUMBER,
     p_in_user_id             IN NUMBER,--03/14/2017
     p_in_file_name           IN VARCHAR2,
     p_in_header              IN VARCHAR2,
     p_out_return_code        OUT VARCHAR2,
     p_out_result_set         OUT SYS_REFCURSOR
   );

   PROCEDURE prc_nomination_sum_extract
   ( p_in_parent_node_id_list IN VARCHAR2,
     p_in_department_list     IN VARCHAR2,
     p_in_job_type_list       IN VARCHAR2,
     p_in_country_id_list     IN VARCHAR2,
     p_in_promotion_id_list   IN VARCHAR2,
     p_in_participant_status  IN VARCHAR2,
     p_in_from_date           IN VARCHAR2,
     p_in_to_date             IN VARCHAR2,   
     p_in_locale              IN VARCHAR2,
     p_in_file_name           IN VARCHAR2,
     p_in_header              IN VARCHAR2,
     p_in_viewer_user_id      IN NUMBER,
     p_out_return_code        OUT VARCHAR2,
     p_out_result_set         OUT SYS_REFCURSOR
   );

   PROCEDURE prc_nomi_aging_dtl_extract
   ( p_in_parent_node_id_list IN VARCHAR2,
     p_in_department_list     IN VARCHAR2,
     p_in_job_type_list       IN VARCHAR2,
     p_in_country_id_list     IN VARCHAR2,
     p_in_promotion_id_list   IN VARCHAR2,
     p_in_nomi_status_list    IN VARCHAR2,
     p_in_approval_level_list IN VARCHAR2,
     p_in_participant_status  IN VARCHAR2,
     p_in_giver_recvr_type    IN VARCHAR2,
     p_in_from_date           IN VARCHAR2,
     p_in_to_date             IN VARCHAR2,
     p_in_locale              IN VARCHAR2,
     p_in_file_name           IN VARCHAR2,
     p_in_header              IN VARCHAR2,
     p_out_return_code        OUT VARCHAR2,
     p_out_result_set         OUT SYS_REFCURSOR
   );

   PROCEDURE prc_nomi_aging_sum_extract
   ( p_in_parent_node_id_list IN VARCHAR2,
     p_in_department_list     IN VARCHAR2,
     p_in_job_type_list       IN VARCHAR2,
     p_in_country_id_list     IN VARCHAR2,
     p_in_promotion_id_list   IN VARCHAR2,
     p_in_nomi_status_list    IN VARCHAR2,
     p_in_approval_level_list IN VARCHAR2,
     p_in_participant_status  IN VARCHAR2,
     p_in_giver_recvr_type    IN VARCHAR2,
     p_in_from_date           IN VARCHAR2,
     p_in_to_date             IN VARCHAR2,
     p_in_locale              IN VARCHAR2,
     p_in_file_name           IN VARCHAR2,
     p_in_header              IN VARCHAR2,
     p_out_return_code        OUT VARCHAR2,
     p_out_result_set         OUT SYS_REFCURSOR
   );

PROCEDURE PRC_CLAIMS_EXTRACT
   ( p_in_promotion_id         IN VARCHAR2,  
     p_paxid                   IN NUMBER,
     is_Team                 IN NUMBER,
     parentNodeId              IN VARCHAR2,   
     p_in_promotion_status     IN VARCHAR2,  
     p_in_pax_status           IN VARCHAR2,
     p_in_job_code             IN VARCHAR2,
     p_claim_status         IN VARCHAR2,
     p_in_department           IN VARCHAR2,
     p_in_from_date           IN VARCHAR2,
     p_in_to_date           IN VARCHAR2,
     SubmittedType             IN VARCHAR2,        
     locale                 IN VARCHAR2,
     p_in_country_id        IN NUMBER,--05/13/2014 Bug 53312  
     p_file_name             IN VARCHAR2,
     p_header                IN VARCHAR2,
     p_out_return_code      OUT varchar2,
     p_out_result_set       OUT sys_refcursor);
     
     PROCEDURE PRC_BADGE_EXTRACT
   ( parentNodeId      IN VARCHAR2,    
     p_in_pax_status IN VARCHAR2,
      is_Team IN NUMBER,
      p_paxid       IN NUMBER,
     p_in_job_code     IN VARCHAR2,    
     p_in_department   IN VARCHAR2,   
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,
     p_in_promotion_id  IN VARCHAR2,    --01/12/2017
     --receivedAwardType IN VARCHAR2, --01/12/2017            
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_POINT_BUDGET_SUMM_EXTRACT
    ( p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_countryRatio       IN NUMBER, 
      p_in_locale             IN VARCHAR,   
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
    ) ;
    
    PROCEDURE PRC_POINT_BUDGET_SMDTL_EXTRACT
    ( p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_countryRatio       IN NUMBER,  
      p_in_locale             IN VARCHAR,  
      p_in_bud_seg_id         IN NUMBER,
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
    ) ;
     
     PROCEDURE PRC_POINT_BUDGET_ISSU_EXTRACT
   (  p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_countryRatio       IN NUMBER,  
      p_in_locale             IN VARCHAR,  
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
    );

PROCEDURE PRC_AWARDS_EXTRACT
   ( p_in_promotion_id  IN VARCHAR2,
     p_in_award_type    IN VARCHAR,     --05/05/2016   
     p_paxid            IN NUMBER,
     is_Team           IN NUMBER,
     parentNodeId      IN VARCHAR2,   
     p_in_country_Ids  IN VARCHAR2,
     p_in_promotion_status IN VARCHAR2,  
     p_in_pax_status   IN VARCHAR2,
     p_in_job_code     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,
     receivedAwardType IN VARCHAR2,   
     IsOnTheSpotIncluded VARCHAR2,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_PARTICIPANT_EXTRACT
   ( p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_HIERARCHY_EXTRACT
   ( p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
    
    PROCEDURE PRC_ENROLLMENT_EXTRACT
   (parentNodeId      IN VARCHAR2,    
    p_in_pax_status IN VARCHAR2,   
    p_paxid       IN NUMBER,
    is_Team IN NUMBER,  
    p_in_role IN VARCHAR2,    
    p_in_country_Ids IN VARCHAR2,
    p_in_department IN VARCHAR2,
    p_job_code IN VARCHAR2,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,   
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor);
    
     PROCEDURE PRC_INDIVIDUAL_ACT_EXTRACT
   (p_user_id IN NUMBER,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,     
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header_summary IN VARCHAR2,
    p_header_allAwards IN VARCHAR2,
    p_header_onTheSpot IN VARCHAR2,
    p_header_goalquest IN VARCHAR2,
    p_header_challengepoint IN VARCHAR2,
    p_header_nominationsReceived IN VARCHAR2,
    p_header_nominationsGiven IN VARCHAR2,
    p_header_productClaims IN VARCHAR2,
    p_header_recognitionsGiven IN VARCHAR2,
    p_header_recognitionsReceived IN VARCHAR2,
    p_header_quizSummary IN VARCHAR2,
    p_header_quizDetail IN VARCHAR2,
    p_header_throwdown IN VARCHAR2,
    p_header_badge IN VARCHAR2,
    p_header_ssi_contests IN VARCHAR2, --04/27/2015
    p_header_ssi_contests_sec IN VARCHAR2, --04/27/2015
    p_module_type        IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_LOGIN_EXTRACT
   ( parentNodeId      IN VARCHAR2,          
     p_in_pax_status   IN VARCHAR2,
     p_paxid       IN NUMBER,
     Is_team      IN NUMBER,
     p_in_role     IN VARCHAR2,
     p_in_department   IN VARCHAR2,    
     p_in_country_Ids IN VARCHAR2,    
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,   
     login_type VARCHAR2,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT VARCHAR2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_RECOGNITION_GIVEN_EXTRACT
   ( p_in_parentNodeId      IN   VARCHAR2,       
     p_in_pax_status        IN   VARCHAR2,
     p_in_is_team           IN   NUMBER,
     p_in_paxid             IN   NUMBER,
     p_in_is_behavior       IN   NUMBER,
     p_in_promotion_Id      IN   VARCHAR2,   
     p_in_promo_status      IN   VARCHAR2,
     p_in_position_type     IN   VARCHAR2,
     p_in_department        IN   VARCHAR2,   
     p_in_country_Ids       IN   VARCHAR2,   
     p_in_from_date         IN   VARCHAR2,
     p_in_to_date           IN   VARCHAR2,   
     p_in_givenType         IN   VARCHAR2,    --05/23/2017
     p_in_locale            IN   VARCHAR2,
     p_in_file_name         IN   VARCHAR2,
     p_in_header            IN   VARCHAR2,
     p_out_return_code      OUT  VARCHAR2,
     p_out_result_set       OUT  sys_refcursor);
     
    PROCEDURE PRC_RECOGNITION_RECVD_EXTRACT
   ( p_in_parentNodeId      IN   VARCHAR2,       
     p_in_pax_status        IN   VARCHAR2,
     p_in_is_team           IN   NUMBER,
     p_in_paxid             IN   NUMBER,
     p_in_is_behavior       IN   NUMBER,
     p_in_promotion_Id      IN   VARCHAR2,   
     p_in_promo_status      IN   VARCHAR2,
     p_in_position_type     IN   VARCHAR2,
     p_in_department        IN   VARCHAR2,   
     p_in_country_Ids       IN   VARCHAR2,   
     p_in_from_date         IN   VARCHAR2,
     p_in_to_date           IN   VARCHAR2,  
     p_in_locale            IN   VARCHAR2,
     p_in_file_name         IN   VARCHAR2,
     p_in_header            IN   VARCHAR2,
     p_out_return_code      OUT  VARCHAR2,
     p_out_result_set       OUT  sys_refcursor);
     
       PROCEDURE PRC_QUIZ_EXTRACT
   ( parentNodeId      IN VARCHAR2,       
     p_in_pax_status   IN VARCHAR2,
     p_paxid       IN NUMBER,
     Is_team      IN NUMBER,
     p_in_promotion_Id IN VARCHAR2,
     p_in_quiz_id IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_result IN VARCHAR2,
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,   
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_QUIZ_ANALYSIS_EXTRACT
   ( p_in_promotion_Id IN VARCHAR2,
     p_in_quiz_id IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,    
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,   
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_PURL_EXTRACT
   ( parentNodeId      IN VARCHAR2,       
     p_in_pax_status   IN VARCHAR2,
     Is_team      IN NUMBER,
     p_paxid       IN NUMBER,
     p_in_promotion_Id IN VARCHAR2,   
     p_in_promo_status IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,   
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,   
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
        PROCEDURE PRC_AWARDLEVEL_EXTRACT
   ( parentNodeId      IN VARCHAR2,       
     Is_team      IN NUMBER,
     p_in_promotion_Id IN VARCHAR2,   
     p_in_award_level IN VARCHAR2,   
     p_in_awardstatus IN VARCHAR2,
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,   
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
     PROCEDURE PRC_AWARD_ACTIVITY_EXTRACT
   ( parentNodeId      IN VARCHAR2,       
     Is_team      IN NUMBER,
     p_in_promotion_Id IN VARCHAR2,   
     p_in_award_level IN VARCHAR2,   
     p_in_status IN VARCHAR2,
     p_in_from_date       IN VARCHAR2,
     p_in_to_date       IN VARCHAR2,   
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);
     
   PROCEDURE PRC_GQ_PAX_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);   
     
    PROCEDURE PRC_CP_PAX_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);   
     
     PROCEDURE PRC_GQ_SELECTION_EXTRACT
   (parentNodeId       IN VARCHAR2,
     is_Team            IN NUMBER,
     p_in_promotion_Id  IN VARCHAR2, 
     p_in_status        IN VARCHAR2,
     p_in_promo_status  IN VARCHAR2,
     p_country_id       IN NUMBER,
     locale             IN VARCHAR2,
     p_in_position_type IN VARCHAR2,
     p_in_department    IN VARCHAR2,
     p_in_has_select    IN VARCHAR2, 
     p_file_name        IN VARCHAR2,
     p_header           IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) ;
     
    PROCEDURE PRC_CP_SELECTION_EXTRACT
    (parentNodeId       IN VARCHAR2,
     is_Team            IN NUMBER,
     p_in_promotion_Id  IN VARCHAR2, 
     p_in_status        IN VARCHAR2,
     p_in_promo_status  IN VARCHAR2,
     p_country_id       IN NUMBER,
     locale             IN VARCHAR2,
     p_in_position_type IN VARCHAR2,
     p_in_department    IN VARCHAR2,
     p_in_has_select    IN VARCHAR2, 
     p_file_name        IN VARCHAR2,
     p_header           IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) ;
     
     PROCEDURE PRC_GQ_PROGRESS_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);   
     
    PROCEDURE PRC_CP_PROGRESS_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);    
     
     PROCEDURE PRC_GQ_MGR_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);   
     
    PROCEDURE PRC_CP_MGR_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);    
     
     PROCEDURE PRC_GQ_PROGRAM_SUMMARY_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_status IN VARCHAR2, 
     p_in_promo_status IN VARCHAR2,     
     locale IN VARCHAR2,     
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor);   
     
    PROCEDURE PRC_CP_PROGRAM_SUMMARY_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_status IN VARCHAR2,  
     p_in_promo_status IN VARCHAR2,    
     locale IN VARCHAR2,     
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor); 
     
  PROCEDURE prc_claim_report_extract
 (p_in_promotionId      IN  VARCHAR2,
  p_in_promotion_status IN  VARCHAR2,  
  p_in_claim_status     IN  VARCHAR2,
  p_in_submitted        IN  VARCHAR,     -- (Show All/Have/Have Not)
  p_in_fromdate         IN  VARCHAR,
  p_in_todate           IN  VARCHAR,
  p_in_organization_id  IN  VARCHAR2,
  p_in_filterpromo      IN  VARCHAR,
  p_in_languageCode     IN  VARCHAR,
  p_in_country_id       IN  NUMBER,
  p_in_participant_status IN VARCHAR2,
  p_in_job_position     IN   VARCHAR2,
  p_in_department       IN   VARCHAR2,
  p_file_name IN VARCHAR2,
  p_header    IN VARCHAR2,
  p_out_return_code   OUT NUMBER,
  p_out_result_set   OUT sys_refcursor
); 

PROCEDURE prc_throwdown_extract
 (p_in_promotionId      IN  VARCHAR2,
  p_in_promotion_status IN  VARCHAR2,    
  p_in_organization_id  IN  VARCHAR2,  
  p_in_round_number   IN   NUMBER,
  p_in_languageCode     IN  VARCHAR,  
  p_in_participant_status IN VARCHAR2,
  p_in_job_position     IN   VARCHAR2,
  p_in_department       IN   VARCHAR2,
  p_file_name IN VARCHAR2,
  p_header    IN VARCHAR2,
  p_out_return_code   OUT VARCHAR2,
  p_out_result_set   OUT sys_refcursor
); 

PROCEDURE prc_survey_openend_extract
 (p_in_organization_id      IN VARCHAR2,
  p_in_promotionId      IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name IN VARCHAR2,
  p_header    IN VARCHAR2,
  p_out_return_code   OUT VARCHAR2,
  p_out_result_set   OUT sys_refcursor
); 

PROCEDURE prc_survey_extract
 (p_in_organization_id      IN VARCHAR2,
  p_in_promotionId      IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name IN VARCHAR2,
  p_header    IN VARCHAR2,
  p_out_return_code   OUT VARCHAR2,
  p_out_result_set   OUT sys_refcursor
); 

PROCEDURE PRC_WORK_HAPPIER_DTL_EXTRACT
 (p_in_timeframe        IN  VARCHAR2,  
  p_header              IN  VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
); 

PROCEDURE PRC_CONFIDENTIAL_FEEDB_EXTRACT
 (p_in_timeframe        IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name           IN  VARCHAR2,
  p_header              IN  VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
);

PROCEDURE PRC_HAPPINESS_PULSE_EXTRACT
 (p_in_timeframe        IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name           IN  VARCHAR2,
  p_header              IN  VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
);  

PROCEDURE PRC_BEHAVIOR_EXTRACT
 ( parentNodeId         IN VARCHAR2,       
   p_in_pax_status      IN VARCHAR2,
   Is_team              IN NUMBER,
   p_paxid              IN NUMBER,
   p_in_promotion_Id    IN VARCHAR2,   
   p_in_position_type   IN VARCHAR2,
   p_in_department      IN VARCHAR2,    
   p_giverReceiver      IN VARCHAR2,
   p_in_from_date       IN VARCHAR2,
   p_in_to_date         IN VARCHAR2,   
   locale               IN VARCHAR2,
   p_file_name          IN VARCHAR2,
   p_header             IN VARCHAR2,
   p_out_return_code    OUT varchar2,
   p_out_result_set     OUT sys_refcursor
 );
 
PROCEDURE PRC_CASH_BUDGET_SUMARY_EXTRACT
    ( p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_userid             IN NUMBER,   
      p_in_locale             IN VARCHAR, 
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
   );
   
PROCEDURE PRC_CASH_BUDGET_SUMDTL_EXTRACT
    ( p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_userid             IN NUMBER,   
      p_in_locale             IN VARCHAR, 
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
    ) ;
   
  PROCEDURE PRC_CASH_BUDGET_ISSU_EXTRACT
   (  p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_userid             IN NUMBER,  
      p_in_locale             IN VARCHAR,  
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
     );

END pkg_extracts; -- Package spec
/



create or replace PACKAGE BODY pkg_extracts
IS
-- Purpose: This package holds all the Reports extracts procedures.
--
-- MODIFICATION HISTORY
-- Person              Date        Comments
-- ---------           ------      ------------------------------------------       
-- Ravi Dhanekula   01/07/2013   Initial Version
-- Suresh J         02/25/2014   Bug Fix 51409 - Added execution log entry to the outer most exception block 
--Suresh J          12/18/2014   Bug Fix 58022 - Extract Report Sorting to sync with Summary Table
--Suresh J          01/05/2015   Bug Fix 58022 - Fixed Issues related to Sorting of Reports   
-- Ravi Dhanekula   07/09/2015   Bug # 63248 - Added outer join to the line 'AND rch.characteristic_type = 'USER'' where rpt_characteristics table used.
-- Ravi Dhanekula   07/13/2015   Bug # 63250 - changes made to make sure the code is same for both condifitions of large_audience conditions for every extract. 
-- J Flees          05/05/2016   G5 Nomination Redesign 
--Ravi Dhanekula    11/30/2017   G6-3578 submitter comments format issue.
--Chidamba          03/07/2018   G6-3432 Changes to the Report due to OTS cards Enhancement
--Chidamba          03/08/2018   G6-3928 Recognition/Nomination Report Extracts does not pull records for the Expired Nominations. Remove restriction.
--Gorantla          03/12/2019   G6-1446  AWS - Enable Large Audience functionality.
--------------------------------------------------------------------------------

-- package constants
gc_release_level                 CONSTANT execution_log.release_level%type := 1.0;
gc_pkg_name                      CONSTANT VARCHAR2(30) := UPPER('pkg_extracts');

gc_return_code_success           CONSTANT VARCHAR2(2) := TO_CHAR(pkg_const.gc_return_code_success, 'fm09');
gc_return_code_failure           CONSTANT VARCHAR2(2) := TO_CHAR(pkg_const.gc_return_code_failure);

gc_error                         CONSTANT execution_log.severity%TYPE := pkg_const.gc_error;
gc_debug                         CONSTANT execution_log.severity%TYPE := pkg_const.gc_debug;
gc_warn                          CONSTANT execution_log.severity%TYPE := pkg_const.gc_warn;
gc_info                          CONSTANT execution_log.severity%TYPE := pkg_const.gc_info;

gc_pax_status_active             CONSTANT participant.status%TYPE := pkg_const.gc_pax_status_active;
gc_pax_status_inactive           CONSTANT participant.status%TYPE := pkg_const.gc_pax_status_inactive;

--gc_promotion_status_active       CONSTANT promotion.promotion_status%TYPE := pkg_const.gc_promotion_status_active;  --03/08/2018

gc_promotion_type_nomination     CONSTANT promotion.promotion_type%TYPE := pkg_const.gc_promotion_type_nomination; 
gc_promotion_type_recognition    CONSTANT promotion.promotion_type%TYPE := pkg_const.gc_promotion_type_recognition;            

gc_elg_type_giver                CONSTANT rpt_pax_promo_eligibility.giver_recvr_type%TYPE := pkg_const.gc_elg_type_giver;
gc_elg_type_receiver             CONSTANT rpt_pax_promo_eligibility.giver_recvr_type%TYPE := pkg_const.gc_elg_type_receiver;

gc_null_id                       CONSTANT NUMBER(18) := pkg_const.gc_null_id;
gc_search_all_values             CONSTANT VARCHAR2(30) := pkg_const.gc_search_all_values;

gc_database_currency             CONSTANT VARCHAR2(30) := pkg_const.gc_database_currency; 
gc_min_search_date               CONSTANT DATE := pkg_const.gc_min_search_date; 
gc_max_search_date               CONSTANT DATE := pkg_const.gc_max_search_date; 

gc_dir_path_like_reports         CONSTANT all_directories.directory_path%TYPE := pkg_const.gc_dir_path_like_reports;
gc_dir_path_like_datadump        CONSTANT all_directories.directory_path%TYPE := pkg_const.gc_dir_path_like_datadump;  -- 03/12/2019

gc_cms_key_fld_promotion_name    CONSTANT cms_content_data.key%TYPE := pkg_const.gc_cms_key_fld_promotion_name; 
gc_cms_key_fld_goal_level_name   CONSTANT cms_content_data.key%TYPE := pkg_const.gc_cms_key_fld_goal_level_name; --05/24/2017 

gc_cms_list_approval_status      CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_approval_status;
gc_cms_list_department_type      CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_department_type;
gc_cms_list_nomi_behavior        CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_nomi_behavior;
gc_cms_list_org_role             CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_org_role;
gc_cms_list_position_type        CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_position_type;
gc_cms_list_promo_approv_opt     CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_promo_approv_opt; --05/24/2017
gc_cms_list_promo_recog_beha     CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_promo_recog_beha; --05/24/2017
gc_cms_list_pax_status           CONSTANT cms_asset.code%TYPE := pkg_const.gc_cms_list_pax_status;       --05/24/2017

gc_ref_text_approval_level       CONSTANT gtt_id_list.ref_text_1%TYPE := 'approval_level';
gc_ref_text_country_id           CONSTANT gtt_id_list.ref_text_1%TYPE := 'country_id';
gc_ref_text_department_type      CONSTANT gtt_id_list.ref_text_1%TYPE := 'department_type';
gc_ref_text_nomination_status    CONSTANT gtt_id_list.ref_text_1%TYPE := 'nomination_status';
gc_ref_text_position_type        CONSTANT gtt_id_list.ref_text_1%TYPE := 'position_type';
gc_ref_text_parent_node_id       CONSTANT gtt_id_list.ref_text_1%TYPE := 'parent_node_id';
gc_ref_text_promotion_id         CONSTANT gtt_id_list.ref_text_1%TYPE := 'promotion_id';
gc_ref_text_budget_status        CONSTANT gtt_id_list.ref_text_1%TYPE := 'budget_status';

gc_approval_status_winner        CONSTANT claim_item_approver.approval_status_type%TYPE := pkg_const.gc_approval_status_winner;
gc_award_type_other              CONSTANT promotion.award_type%TYPE := pkg_const.gc_award_type_other;

gc_fld_separator                 CONSTANT VARCHAR2(1) := ',' ;
gc_fld_delimiter                 CONSTANT VARCHAR2(1) := '"' ;

gv_client_aws                    NUMBER(1) ;     -- 03/12/2019
gv_aws_task_id                   VARCHAR2(50);   -- 03/12/2019
gv_report_s3_bucket              VARCHAR2(100);  -- 03/12/2019

gc_str_token       		 CONSTANT VARCHAR2 (1):= '#';  --03/07/2018

-- package global variables
gv_tab_file_extract              tab_file_extract;
-- 03/12/2019
PROCEDURE prc_set_gv_client_aws IS
BEGIN
	SELECT boolean_val 
		INTO gv_client_aws
		FROM os_propertyset 
	 WHERE entity_name = 'aws.deployed';
EXCEPTION
	WHEN OTHERS THEN
		gv_client_aws := 0;
END;

-- 03/12/2019
PROCEDURE prc_set_gv_report_s3_bucket IS
BEGIN
	SELECT SUBSTR(string_val,INSTR(string_val,'/',-1)+1)||'-'||fnc_get_instance||'-oracle-reports'   
		INTO gv_report_s3_bucket    
		FROM os_propertyset
	 WHERE entity_name = 'site.url.prod';
EXCEPTION
	WHEN OTHERS THEN
		gv_report_s3_bucket := NULL;
END;

-- Pipelines the current block of file records
FUNCTION fnc_pipe_file_records
RETURN tab_file_extract PIPELINED
IS
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'fnc_pipe_file_records';
   v_stage                 execution_log.text_line%TYPE;
BEGIN
   -- loop through file records
   v_stage := 'FOR indx';
   FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
      v_stage := 'FOR indx[' || indx || ']';
      PIPE ROW(gv_tab_file_extract(indx));
   END LOOP;

   RETURN;
EXCEPTION
   WHEN OTHERS THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || '~' || SQLCODE || ':' || SQLERRM, NULL);
      RAISE;
END fnc_pipe_file_records;

PROCEDURE prc_nomination_dtl_extract
( p_in_parent_node_id_list IN VARCHAR2,
  p_in_department_list     IN VARCHAR2,
  p_in_job_type_list       IN VARCHAR2,
  p_in_country_id_list     IN VARCHAR2,
  p_in_promotion_id_list   IN VARCHAR2,
  p_in_nomi_status_list    IN VARCHAR2,
  p_in_participant_status  IN VARCHAR2,
  p_in_from_date           IN VARCHAR2,
  p_in_to_date             IN VARCHAR2,   
  p_in_locale              IN VARCHAR2,
  p_in_is_team             IN NUMBER,
  p_in_include_not_given       IN NUMBER, 
--  p_in_include_recvd       IN NUMBER,  
  p_in_include_comment     IN NUMBER,
  p_in_has_given           IN NUMBER,
  p_in_has_recvd           IN NUMBER,
  p_in_viewer_user_id      IN NUMBER,
  p_in_user_id             IN NUMBER,
  p_in_file_name           IN VARCHAR2,
  p_in_header              IN VARCHAR2,
  p_out_return_code        OUT VARCHAR2,
  p_out_result_set         OUT SYS_REFCURSOR
) IS
--*******************************************************************************
-- Purpose: This procedure queries the nomination detail extract result set and writes it to file when a file name specified.
--
-- Person         Date        Comments
-- -------------- ----------  -----------------------------------------------------
-- Ravi Dhanekula 01/07/2013  Initial Version  
--                01/29/2013  Changed the query to exclude Sweepstakes
--                12/12/2013  Fixed the defect # 50271
-- Chidamba       01/30/2014  Implementation -  Bug 50536 Add comment to nomination submission report extracts if client allows
-- Ravi Dhanekula 04/01/2014  Added temp_table_session table to fetch CM data to avoid performance issues.
-- Swati          05/29/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated   
-- nagarajs       07/15/2014  Fixed the Bug # 54789 - Claim status Needs to be Translated 
-- nagarajs       07/16/2014  Bug # 54917 - close the file and include parms value when OTHER exception  
-- Suresh J       09/18/2014  Bug #56675  - Department, Job code name translation issue
-- nagarajs       01/28/2016  Bug 65403 - Reports Nomination Submission List of Giver: The data displayed in the extract after 
--                            drilling down the summary table to the next level doesn?t match
-- nagarajs       03/03/2016  Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
-- J Flees        05/05/2016  G5 Nomination Redesign
-- Sherif Basha   11/23/2016  Bug 70026 - UAT - comments are showing when not selected-- add p_in_include_comment
--Suresh J        02/14/2017  Bug 71388 - Custom Form Element column does not have any data
-- nagarajs       03/09/2017 G6-1892-  Nomination Activity By Organisation - abnormalities in the report
-- nagarajs       03/14/2017 G6-1936 - List of Nominator and nominee Report - Summary Table export records is not matching with Summary Table records
--Suresh J        04/13/2017 G6-2178 - Oracle-Additional submitted comments are not on report extracts
--nagarajs        05/24/2017 Added Have/Have not filter    
--Chidamba        09/01/2017 G6-2871 -Report-Nominations-List of nominator and nominee -When admin extract the summary table in extract, error message is displaying
--Chidamba        09/28/2017 G6-3079 -Remove receiver userID from extract report  
--Ravi Dhanekula  10/30/2017 G6-3302 - Extract not working.p_in_include_not_given is used for have/have not functionality.
--Chidamba        11/17/2017 G6-3198 - Handling 4000 text comments entered.
--Chidamba        02/08/2018 G6-3850-Use FNC_FORMAT_COMMENTS to format comments
--Gorantla        04/16/2018 G6-3991/Bug 75871 - The extract for Nominations - List of Nominators points received 
--                           does not match extract for Nominations - List of Nominees.
--Gorantla        04/17/2018 G6-3961/Bug 75841 - prc_list_pend_nomination_extr failure when apostrophe in cfse header value
--Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
--DeepakrajS      04/08/2019 Bug 72708 : Modified Function fnc_format_comments by changing I/O param type as CLOB,
--                                        Replaced DBMS_LOB.GETLENGTH WITH LENGTHC to avoid length error
--DeepakrajS      04/09/2019 BUG 75188 Added logic to display awards in respective logged in user currency code
--*******************************************************************************
   PRAGMA AUTONOMOUS_TRANSACTION;

   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_nomination_dtl_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_viewer_currency_code  country.currency_code%TYPE;
   v_locale                locale_date_pattern.locale%TYPE;
   v_locale_date_pattern   locale_date_pattern.pattern%TYPE;
   v_from_date             DATE;
   v_to_date               DATE;
   v_is_all_audience_giver NUMBER; 
   v_is_all_audience_recvr NUMBER; 
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   v_extract               CLOB;        
   -------05/27/2014---------
   clob_len                 INTEGER; 
   v_pntr_position          INTEGER := 1;
   read_buffer_data         VARCHAR2(32767);
   --read_buffer_size         BINARY_INTEGER := 5000; --04/08/2019
   read_buffer_size         BINARY_INTEGER := 10000; --04/08/2019
   --------------------------   
   v_budget_media_value    NUMBER(12,4); --04/09/2019
   v_in_pax_countryratio   country.budget_media_value%TYPE; --04/09/2019
   v_cash_currency_value   cash_currency_current.bpom_entered_rate%TYPE;  --04/09/2019     
  
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': p_in_parent_node_id_list>' || p_in_parent_node_id_list
      || '<, p_in_department_list >' || p_in_department_list
      || '<, p_in_job_type_list >' || p_in_job_type_list
      || '<, p_in_country_id_list >' || p_in_country_id_list
      || '<, p_in_promotion_id_list >' || p_in_promotion_id_list
      || '<, p_in_nomi_status_list >' || p_in_nomi_status_list
      || '<, p_in_participant_status >' || p_in_participant_status
      || '<, p_in_from_date >' || p_in_from_date
      || '<, p_in_to_date >' || p_in_to_date
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_is_team >' || p_in_is_team
      || '<, p_in_include_not_given >' || p_in_include_not_given 
--      || '<, p_in_include_recvd >' || p_in_include_recvd  
      || '<, p_in_include_comment >' || p_in_include_comment
      || '<, p_in_has_given >' || p_in_has_given
      || '<, p_in_has_recvd >' || p_in_has_recvd
      || '<, p_in_viewer_user_id >' || p_in_viewer_user_id
      || '<, p_in_user_id >' || p_in_user_id
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';
     
   v_stage := 'call pkg_report_common.f_get_user_currency_code';
   v_viewer_currency_code := pkg_report_common.f_get_user_currency_code(p_in_viewer_user_id);

   v_stage := 'convert input strings to date';
   v_locale := NVL(p_in_locale, pkg_report_common.f_get_default_locale);
   v_locale_date_pattern := pkg_report_common.f_get_locale_date_pattern(v_locale);
   v_from_date := TO_DATE(p_in_from_date, v_locale_date_pattern);
   v_to_date   := TO_DATE(p_in_to_date,   v_locale_date_pattern);
 
   
   -- stage input lists
   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(p_in_country_id_list, gc_search_all_values), gc_ref_text_country_id, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department_list, gc_search_all_values), gc_ref_text_department_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_job_type_list, gc_search_all_values), gc_ref_text_position_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_parent_node_id_list, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id_list, gc_search_all_values), gc_ref_text_promotion_id, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_nomi_status_list, gc_search_all_values), gc_ref_text_nomination_status);

   -- stage input lists
   v_stage := 'call fnc_check_promo_aud';
   v_is_all_audience_giver := fnc_check_promo_aud(gc_elg_type_giver, gc_promotion_type_nomination, p_in_promotion_id_list); 
   v_is_all_audience_recvr := fnc_check_promo_aud(gc_elg_type_giver, gc_promotion_type_nomination, p_in_promotion_id_list); 

   --Added on 04/09/2019
   v_stage := 'Get Logged in User Media value';
    BEGIN
        SELECT c.BUDGET_MEDIA_VALUE
          INTO v_in_pax_countryratio
          FROM user_address ua, country c
         WHERE ua.user_id = p_in_viewer_user_id 
        AND ua.country_id = c.country_id;
                                                                          
         SELECT (budget_media_value / v_in_pax_countryratio)
          INTO v_budget_media_value  
          FROM country c   
         WHERE c.cm_asset_code ='country_data.country.usa'; 
    EXCEPTION WHEN OTHERS THEN
       v_budget_media_value := 1;                        
    END; 
    --Added on 04/09/2019
    v_stage := 'Get currency value';
      BEGIN    
         SELECT ccc.bpom_entered_rate
           INTO v_cash_currency_value
           FROM user_address ua,
                country c,
                cash_currency_current ccc 
          WHERE ua.user_id = p_in_viewer_user_id
            AND is_primary = 1
            AND ua.country_id = c.country_id
            AND c.currency_code = ccc.to_cur;
      EXCEPTION
         WHEN OTHERS THEN
           v_cash_currency_value := 1;
      END;   


   v_stage := 'OPEN p_out_result_set';
   OPEN p_out_result_set FOR
   WITH w_node AS
   (  -- get query node(s)
      SELECT DISTINCT
             DECODE(p_in_is_team, 1, hr.node_id, hr.child_node_id) AS node_id
        FROM gtt_id_list gil,
             rpt_hierarchy_rollup hr
       WHERE gil.ref_text_1 = gc_ref_text_parent_node_id
         AND gil.id = hr.node_id
   ),
   w_rpt_detail AS
   (  -- get nomination report details based on giver/receiver nodes
      -- have submitted a nomination
      SELECT -- nd.ROWID AS nd_rowid, wn.node_id -- 04/16/2018
             nd.ROWID AS nd_rowid -- 04/16/2018
        FROM rpt_nomination_detail nd,
             w_node wn
       WHERE p_in_has_given = 1 --NVL(p_in_include_given, 1) = 1 --03/09/2017
         --AND NVL(p_in_has_given, 1) = 1 --03/09/2017
         AND nd.claim_id IS NOT NULL
          -- restrict by required fields
         AND wn.node_id = nd.giver_node_id
         AND nd.date_submitted BETWEEN v_from_date AND v_to_date
       UNION
      -- have been nominated
      SELECT -- nd.ROWID AS nd_rowid, wn.node_id  -- 04/16/2018
             nd.ROWID AS nd_rowid -- 04/16/2018
        FROM rpt_nomination_detail nd,
             w_node wn
       WHERE p_in_has_recvd = 1 --NVL(p_in_include_recvd, 1) = 1 --03/09/2017
         --AND NVL(p_in_has_recvd, 1) = 1 --03/09/2017
         AND nd.claim_id IS NOT NULL
          -- restrict by required fields
         AND wn.node_id = nd.recvr_node_id
         AND nd.date_submitted BETWEEN v_from_date AND v_to_date
       UNION
      -- have been nominated
      SELECT -- nd.ROWID AS nd_rowid , wn.node_id --03/09/2017 -- 04/16/2018
             distinct nd.ROWID AS nd_rowid -- 04/16/2018
        FROM rpt_nomination_detail nd,
             w_node wn
       WHERE p_in_has_given = 0 
         AND p_in_has_recvd = 0 
         AND nd.claim_id IS NOT NULL
          -- restrict by required fields
         AND (wn.node_id = nd.recvr_node_id OR wn.node_id = nd.giver_node_id)
         AND nd.date_submitted BETWEEN v_from_date AND v_to_date
   ),
   w_claim_behavior AS
   (  -- build claim behavior lists
      SELECT lt.claim_id,
             LISTAGG(lt.locale_behavior , ', ') WITHIN GROUP (ORDER BY LOWER(lt.locale_behavior)) AS behavior_list
        FROM ( -- locale translations
               SELECT DISTINCT
                      nd.claim_id,
                      NVL(ccv.cms_name, ncb.behavior) AS locale_behavior
                 FROM w_rpt_detail rd,
                      rpt_nomination_detail nd,
                      nomination_claim_behaviors ncb,
                      mv_cms_code_value ccv
                WHERE rd.nd_rowid = nd.ROWID
                  AND nd.claim_id = ncb.claim_id
                  AND gc_cms_list_nomi_behavior = ccv.asset_code (+)
                  and v_locale = ccv.locale (+)
                  and ncb.behavior = ccv.cms_code (+)
             ) lt
       GROUP BY lt.claim_id
   )
   -- format the extract record
    SELECT TO_CLOB(p_in_header) AS textline  -- 09/01/2017
     FROM dual
    UNION ALL 
   SELECT -- nomination fields
             TO_CLOB(gc_fld_delimiter || fd.claim_id                      || gc_fld_delimiter || gc_fld_separator           --09/01/2017
          || gc_fld_delimiter || fd.date_submitted                || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.promotion_name                || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.claim_approval_round          || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.claim_item_status             || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.prev_round_approval_date      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.prev_round_approver_user_name || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.prev_round_approver_name      || gc_fld_delimiter || gc_fld_separator
          -- nominator fields
          || gc_fld_delimiter || fd.giver_user_name               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_first_name              || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_middle_name             || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_last_name               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_country_name            || gc_fld_delimiter || gc_fld_separator
          -- award fields
          || gc_fld_delimiter || fd.behavior_list                 || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.points_received               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.cash_received                 || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.other_award_desc              || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.other_award_qty_received      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.other_award_amt               || gc_fld_delimiter || gc_fld_separator
          -- nominator fields
          || gc_fld_delimiter || fd.giver_node_name               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_org_role                || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_department_type         || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_position_type           || gc_fld_delimiter || gc_fld_separator          
          -- nominee fields
          --|| gc_fld_delimiter || fd.recvr_user_id                 || gc_fld_delimiter || gc_fld_separator   -- 09/28/2017 G6-3079
          || gc_fld_delimiter || fd.recvr_user_name               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_first_name              || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_last_name               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.team_name                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_country_name            || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_node_name               || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_org_role                || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_department_type         || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_position_type           || gc_fld_delimiter || gc_fld_separator          
          || gc_fld_delimiter || fd.pax_char1                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char2                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char3                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char4                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char5                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char6                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char7                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char8                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char9                     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char10                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char11                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char12                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char13                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char14                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char15                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char16                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char17                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char18                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char19                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.pax_char20                    || gc_fld_delimiter )||             --09/01/2017
--         -- 11/23/2016  Bug 70026
--         CASE  WHEN p_in_include_comment = 1 THEN gc_fld_separator
--          || gc_fld_delimiter || REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE
--         (REGEXP_REPLACE(REGEXP_REPLACE(fd.submitter_comments,'<[^>]+>',''),'"','''""'''),CHR(10),''),CHR(13),''),';','') || gc_fld_delimiter||gc_fld_separator--11/30/2017
--          || gc_fld_delimiter ||fd.Custom_Form_Elements                                        || gc_fld_delimiter||gc_fld_separator    --02/14/2017    --04/13/2017
--          || gc_fld_delimiter ||fd.more_info_comments                                          || gc_fld_delimiter                      --04/13/2017
--           ELSE NULL END 
  /**************************  02/08/2017 START *********************************/
           gc_fld_separator||TO_CLOB(gc_fld_delimiter || CASE WHEN p_in_include_comment = 1 THEN
				                --FNC_FORMAT_COMMENTS(fd.submitter_comments)   --04/08/2019
				                FNC_FORMAT_COMMENTS_CLOB(fd.submitter_comments)  --04/08/2019
                                 ELSE NULL END || gc_fld_delimiter || gc_fld_separator 
          || gc_fld_delimiter || CASE WHEN p_in_include_comment = 1 THEN
      		                    --FNC_FORMAT_COMMENTS(fd.Custom_Form_Elements)  --04/08/2019
      		                    FNC_FORMAT_COMMENTS_CLOB(fd.Custom_Form_Elements)   --04/08/2019
                                 ELSE NULL END                    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || CASE WHEN p_in_include_comment = 1 THEN
				                --FNC_FORMAT_COMMENTS(fd.more_info_comments)  --04/08/2019
				                FNC_FORMAT_COMMENTS_CLOB(fd.more_info_comments)  --04/08/2019 
                                 ELSE NULL END|| gc_fld_delimiter) 
 /**************************  02/08/2017 END *********************************/       
          AS textline
     FROM ( -- build the full data set
            SELECT -- nomination fields
                   rd.claim_id,
                   rd.date_submitted,
                   NVL(cav_pn.cms_value, p.promotion_name) AS promotion_name,
                   rd.claim_approval_round,
                   NVL(ccv_as.cms_name, rd.claim_item_status) AS claim_item_status,
                   rd.prev_round_approval_date,
                   rd.prev_round_approver_user_name,
                   rd.prev_round_approver_name,
                   -- nominator fields
                   rd.giver_user_name,
                   rd.giver_first_name,
                   rd.giver_middle_name,
                   rd.giver_last_name,
                   cav_cn_g.cms_value AS giver_country_name,   
                   rd.giver_node_name,
                   NVL(ccv_or_g.cms_name, rd.giver_org_role) AS giver_org_role,
                   NVL(ccv_pt_g.cms_name, rd.giver_position_type) AS giver_position_type,
                   NVL(ccv_dt_g.cms_name, rd.giver_department_type) AS giver_department_type,
                   -- nominee fields
                   rd.recvr_user_id,
                   rd.recvr_user_name,
                   rd.recvr_first_name,
                   rd.recvr_last_name,
                   rd.team_name,
                   cav_cn_r.cms_value AS recvr_country_name,
                   rd.recvr_node_name,
                   NVL(ccv_or_r.cms_name, rd.recvr_org_role) AS recvr_org_role,
                   NVL(ccv_pt_r.cms_name, rd.recvr_position_type) AS recvr_position_type,
                   NVL(ccv_dt_r.cms_name, rd.recvr_department_type) AS recvr_department_type,
                   cuc_r.pax_char1,
                   cuc_r.pax_char2,
                   cuc_r.pax_char3,
                   cuc_r.pax_char4,
                   cuc_r.pax_char5,
                   cuc_r.pax_char6,
                   cuc_r.pax_char7,
                   cuc_r.pax_char8,
                   cuc_r.pax_char9,
                   cuc_r.pax_char10,
                   cuc_r.pax_char11,
                   cuc_r.pax_char12,
                   cuc_r.pax_char13,
                   cuc_r.pax_char14,
                   cuc_r.pax_char15,
                   cuc_r.pax_char16,
                   cuc_r.pax_char17,
                   cuc_r.pax_char18,
                   cuc_r.pax_char19,
                   cuc_r.pax_char20,
                   -- misc fields
                   rd.behavior_list,
                   -- rd.points_issued, -- 04/16/2018
                   --rd.points_received --04/09/2019
                   ROUND (rd.points_received * v_budget_media_value)as points_received, --04/09/2019
                   rd.currency_code,
                   -- rd.cash_issued, -- 04/16/2018
                   --rd.cash_received  --04/09/2019
                   ROUND(rd.cash_received * v_cash_currency_value,0) as cash_received, --04/09/2019
                   --rd.other_award_desc --04/09/2019
                   ROUND(rd.other_award_desc * v_cash_currency_value,0) as other_award_desc, --04/09/2019
                   -- NVL(( DECODE(rd.node_id, rd.giver_node_id, other_award_cnt)), 0) AS other_award_qty_issued, -- 04/16/2018
                   -- NVL(( DECODE(rd.node_id, rd.recvr_node_id, other_award_cnt)), 0) AS other_award_qty_received, -- 04/16/2018
                   NVL(other_award_cnt, 0) AS other_award_qty_received, -- 04/16/2018
                   rd.other_award_amt,
                   rd.submitter_comments  submitter_comments
                   -- ,rd.Custom_Form_Elements     --02/14/2017  -- 04/17/2018
                   ,DBMS_XMLGEN.convert(rd.Custom_Form_Elements,1) Custom_Form_Elements    -- 04/17/2018
                   ,rd.more_info_comments       --04/13/2017
              FROM ( -- get raw data
                     -- get nomination details
                     SELECT -- nomination fields
                            dtl.claim_id,
                            -- wrd.node_id,  -- 04/16/2018
                            dtl.date_submitted,
                            dtl.promotion_id,
                            dtl.promotion_name,
                            dtl.claim_approval_round,
                            dtl.claim_item_status,
                            DECODE(dtl.claim_approval_round,
                              2, dtl.r1_approval_date,
                              3, dtl.r2_approval_date,
                              4, dtl.r3_approval_date,
                              5, dtl.r4_approval_date,
                              NULL
                            ) AS prev_round_approval_date,
                            DECODE(dtl.claim_approval_round,
                              2, dtl.r1_approver_user_name,
                              3, dtl.r2_approver_user_name,
                              4, dtl.r3_approver_user_name,
                              5, dtl.r4_approver_user_name,
                              NULL
                            ) AS prev_round_approver_user_name,
                            DECODE(dtl.claim_approval_round,
                              2, fnc_format_user_name(dtl.r1_approver_last_name, dtl.r1_approver_first_name),
                              3, fnc_format_user_name(dtl.r2_approver_last_name, dtl.r2_approver_first_name),
                              4, fnc_format_user_name(dtl.r3_approver_last_name, dtl.r3_approver_first_name),
                              5, fnc_format_user_name(dtl.r4_approver_last_name, dtl.r4_approver_first_name),
                              NULL
                            ) AS prev_round_approver_name,
                            -- nominator fields
                            dtl.giver_node_id,
                            dtl.giver_user_name,
                            dtl.giver_first_name,
                            dtl.giver_middle_name,
                            dtl.giver_last_name,
                            dtl.giver_country_id,   
                            dtl.giver_node_name,
                            dtl.giver_org_role,
                            dtl.giver_position_type,
                            dtl.giver_department_type,
                            -- nominee fields
                            dtl.recvr_node_id,
                            dtl.recvr_user_id,
                            dtl.recvr_user_name,
                            dtl.recvr_first_name,
                            dtl.recvr_last_name,
                            dtl.team_name,
                            dtl.recvr_country_id,
                            dtl.recvr_node_name,
                            dtl.recvr_org_role,
                            dtl.recvr_position_type,
                            dtl.recvr_department_type,
                            -- misc fields
                            wcb.behavior_list,
                            -- NVL(( DECODE(wrd.node_id, dtl.giver_node_id, dtl.points_award_amt)), 0) AS points_issued,  -- 04/16/2018
                            -- NVL(( DECODE(wrd.node_id, dtl.recvr_node_id, dtl.points_award_amt)), 0) AS points_received, -- 04/16/2018
                            NVL(dtl.points_award_amt, 0) AS points_received, -- 04/16/2018
                            v_viewer_currency_code AS currency_code,
                            -- NVL(( DECODE(wrd.node_id, dtl.giver_node_id, dtl.cash_award_amt)), 0) AS cash_issued, -- 04/16/2018
                            -- NVL(( DECODE(wrd.node_id, dtl.recvr_node_id, dtl.cash_award_amt)), 0) AS cash_received, -- 04/16/2018
                            NVL(dtl.cash_award_amt, 0) AS cash_received, -- 04/16/2018
                            dtl.other_award_desc,
                            ( CASE WHEN (dtl.r1_award_type = gc_award_type_other AND dtl.r1_approval_status = gc_approval_status_winner) THEN 1 ELSE 0 END
                              + CASE WHEN (dtl.r2_award_type = gc_award_type_other AND dtl.r2_approval_status = gc_approval_status_winner) THEN 1 ELSE 0 END
                              + CASE WHEN (dtl.r3_award_type = gc_award_type_other AND dtl.r3_approval_status = gc_approval_status_winner) THEN 1 ELSE 0 END
                              + CASE WHEN (dtl.r4_award_type = gc_award_type_other AND dtl.r4_approval_status = gc_approval_status_winner) THEN 1 ELSE 0 END
                              + CASE WHEN (dtl.r5_award_type = gc_award_type_other AND dtl.r5_approval_status = gc_approval_status_winner) THEN 1 ELSE 0 END
                            ) AS other_award_cnt,
                            -- NVL(( DECODE(wrd.node_id, dtl.recvr_node_id, dtl.other_award_amt)), 0) AS other_award_amt, -- 04/16/2018
                            NVL(dtl.other_award_amt, 0) AS other_award_amt, -- 04/16/2018
                            nc.submitter_comments,
                            cfe.Custom_Form_Elements            --02/14/2017
                            ,nc.more_info_comments              --04/13/2017
                       FROM w_rpt_detail wrd,
                            rpt_nomination_detail dtl,
                            nomination_claim nc,
                            (select e.claim_id   --get custom form elements    --02/14/2017     
                                   --,LISTAGG(cf.form_name||':'||e.value , ', ') WITHIN GROUP (ORDER BY cf.form_name) AS Custom_Form_Elements
                                   ,RTRIM(XMLAGG(XMLELEMENT(E,cf.form_name||':'||TO_CLOB(e.value),',').EXTRACT('//text()') ORDER BY cf.form_name).GetClobVal(),',')  AS Custom_Form_Elements --09/01/2017 --04/08/2019          
                            from claim_cfse e,
                                 claim_form_step_element c,
                                 claim_form_step cs,
                                 claim_form cf
                            where 
                            e.claim_form_step_element_id =  c.claim_form_step_element_id and  
                            c.claim_form_step_id = cs.claim_form_step_id and
                            cs.claim_form_id = cf.claim_form_id and
                            e.claim_id in (select claim_id from nomination_claim) 
                            group by e.claim_id) cfe,
                            w_claim_behavior wcb,
                            gtt_id_list gil_c,     -- country
                            gtt_id_list gil_dt,    -- department type
                            gtt_id_list gil_ns,    -- nomination status
                            gtt_id_list gil_pt,    -- position type
                            gtt_id_list gil_p      -- promotion
                      WHERE wrd.nd_rowid = dtl.ROWID
                        AND p_in_include_not_given = 0
                        AND (  (p_in_has_given = 1 AND dtl.giver_user_id = NVL(p_in_user_id, dtl.giver_user_id)) --05/24/2017
                            OR (p_in_has_recvd = 1 AND dtl.recvr_user_id = NVL(p_in_user_id, dtl.recvr_user_id))
                            OR (p_in_has_given = 0 AND p_in_has_recvd = 0
                            AND (dtl.giver_user_id = NVL(p_in_user_id, dtl.giver_user_id) OR dtl.recvr_user_id = NVL(p_in_user_id, dtl.recvr_user_id)))
                            )
                        AND dtl.claim_id = nc.claim_id
                        AND dtl.claim_id = cfe.claim_id (+)   --02/14/2017
                        AND dtl.claim_id = wcb.claim_id (+)
                        --AND dtl.promotion_status = gc_promotion_status_active  --03/08/2018
                         -- restrict by optional fields
                        AND gil_ns.ref_text_1 = gc_ref_text_nomination_status
                        AND (  gil_ns.ref_text_2 = gc_search_all_values
                            OR gil_ns.ref_text_2 IN (dtl.r1_approval_status,
                                                     dtl.r2_approval_status,
                                                     dtl.r3_approval_status,
                                                     dtl.r4_approval_status,
                                                     dtl.r5_approval_status
                                                    ) )
                        AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                        AND (  gil_p.ref_text_2 = gc_search_all_values
                            OR gil_p.id = dtl.promotion_id )
                        AND gil_c.ref_text_1 = gc_ref_text_country_id
                        AND (  gil_c.ref_text_2 = gc_search_all_values
                            OR gil_c.id = dtl.giver_country_id
                            OR gil_c.id = dtl.recvr_country_id )
                        AND gil_dt.ref_text_1 = gc_ref_text_department_type
                        AND (  gil_dt.ref_text_2 = gc_search_all_values
                            OR gil_dt.ref_text_2 = dtl.giver_department_type
                            OR gil_dt.ref_text_2 = dtl.recvr_department_type )
                        AND gil_pt.ref_text_1 = gc_ref_text_position_type
                        AND (  gil_pt.ref_text_2 = gc_search_all_values
                            OR gil_pt.ref_text_2 = dtl.giver_position_type
                            OR gil_pt.ref_text_2 = dtl.recvr_position_type )
                        AND (  p_in_participant_status IS NULL
                            OR dtl.giver_pax_status = p_in_participant_status
                            OR dtl.recvr_pax_status = p_in_participant_status )
                      UNION ALL --03/09/2017 --05/24/2017
                     -- have not submitted a nomination
                     SELECT -- nomination fields
                            NULL AS claim_id,
                            -- giv.node_id,  -- 04/16/2018
                            NULL AS date_submitted,
                            NULL AS promotion_id,
                            NULL AS promotion_name,
                            NULL AS claim_approval_round,
                            NULL AS claim_item_status,
                            NULL AS prev_round_approval_date,
                            NULL AS prev_round_approver_user_name,
                            NULL AS prev_round_approver_name,
                            -- nominator fields
                            giv.node_id AS giver_node_id, 
                            au.user_name AS giver_user_name,
                            au.first_name AS giver_first_name,
                            au.middle_name AS giver_middle_name,
                            au.last_name AS giver_last_name,
                            ua.country_id AS giver_country_id,   
                            n.name AS giver_node_name,
                            giv.org_role AS giver_org_role,
                            paxe.position_type AS giver_position_type,
                            paxe.department_type AS giver_department_type,
                            -- nominee fields   
                            NULL AS recvr_node_id, 
                            NULL AS recvr_user_id,
                            NULL AS recvr_user_name,
                            NULL AS recvr_first_name,
                            NULL AS recvr_last_name,
                            NULL AS team_name,
                            NULL AS recvr_country_id,
                            NULL AS recvr_node_name,
                            NULL AS recvr_org_role,
                            NULL AS recvr_position_type,
                            NULL AS recvr_department_type,
                            -- misc fields
                            NULL AS behavior,
                            -- NULL AS points_issued, -- 04/16/2018
                            NULL AS points_received,
                            NULL AS currency_code,
                            -- NULL AS cash_issued, -- 04/16/2018
                            NULL AS cash_received,
                            NULL AS other_award_desc,
                            NULL AS other_award_qty,
                            NULL AS other_award_amt,
                            NULL AS submitter_comments,
                            NULL AS Custom_Form_Elements,   --02/14/2017
                            NULL AS more_info_comments --05/24/2017
                       FROM ( -- build giver list
                              -- all pax audience
                              SELECT un.user_id,
                                     un.node_id,
                                     un.role AS org_role
                                FROM w_node wn,
                                     user_node un
                               WHERE p_in_include_not_given = 1
                                 AND p_in_has_given = 1  
                                 AND v_is_all_audience_giver = 1
                                 AND wn.node_id = un.node_id
                                 AND un.status = 1
                                 AND un.is_primary = 1
                               UNION
                              -- specify audience
                              SELECT un.user_id,
                                     un.node_id,
                                     un.role AS org_role
                                FROM w_node wn,
                                     rpt_pax_promo_eligibility ppe,
                                     user_node un,
                                     promotion p,
                                     promo_nomination pn,
                                     gtt_id_list gil_p      -- promotion
                               WHERE p_in_include_not_given = 1
                                 AND p_in_has_given = 1
                                 AND v_is_all_audience_giver = 0
                                 AND wn.node_id = ppe.node_id
                                 AND ppe.giver_recvr_type = gc_elg_type_giver
                                 AND ppe.participant_id = un.user_id
                                 AND ppe.node_id = un.node_id
                                 AND un.status = 1
                                 AND un.is_primary = 1
                                 AND ppe.promotion_id = p.promotion_id
                                  -- restrict to nomination promotions
                                 AND ppe.promotion_id = pn.promotion_id
                                 --AND p.promotion_status = gc_promotion_status_active --03/08/2018
                                  -- restrict by optional fields
                                 AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                                 AND (  gil_p.ref_text_2 = gc_search_all_values
                                     OR gil_p.id = ppe.promotion_id )
                            ) giv,
                            application_user au,
                            rpt_participant_employer paxe,
                            user_address ua,
                            node n,
                            gtt_id_list gil_c,     -- country
                            gtt_id_list gil_dt,    -- department type
                            gtt_id_list gil_pt     -- position type
                      WHERE giv.user_id = au.user_id
                        AND giv.user_id = paxe.user_id (+)
                        AND giv.user_id = ua.user_id (+)
                        AND ua.is_primary (+) = 1
                        AND giv.node_id = n.node_id
                        AND NOT EXISTS
                            ( -- exclude any participants who have submitted a nomination
                              SELECT NULL
                                FROM rpt_nomination_detail nd
                               WHERE giv.node_id = nd.giver_node_id
                                 AND giv.user_id = nd.giver_user_id
                                 AND nd.claim_id IS NOT NULL
                                 AND nd.date_submitted BETWEEN v_from_date AND v_to_date
                            )
                         -- restrict by optional fields
                        AND gil_c.ref_text_1 = gc_ref_text_country_id
                        AND (  gil_c.ref_text_2 = gc_search_all_values
                            OR gil_c.id = ua.country_id )
                        AND gil_dt.ref_text_1 = gc_ref_text_department_type
                        AND (  gil_dt.ref_text_2 = gc_search_all_values
                            OR gil_dt.ref_text_2 = paxe.department_type )
                        AND gil_pt.ref_text_1 = gc_ref_text_position_type
                        AND (  gil_pt.ref_text_2 = gc_search_all_values
                            OR gil_pt.ref_text_2 = paxe.position_type )
                        AND DECODE(p_in_participant_status,
                              gc_pax_status_active, 1,
                              gc_pax_status_inactive, 0,
                              au.is_active) = au.is_active                    
                   ) rd,
                   country c_g,           -- country giver
                   country c_r,           -- country receiver
                   promotion p,
                   mv_cms_asset_value cav_cn_g, -- country name giver
                   mv_cms_asset_value cav_cn_r, -- country name receiver
                   mv_cms_asset_value cav_pn,   -- promotion name
                   mv_cms_code_value ccv_as,    -- approval status
                   mv_cms_code_value ccv_dt_g,  -- department type giver
                   mv_cms_code_value ccv_dt_r,  -- department type receiver
                   mv_cms_code_value ccv_or_g,  -- org role giver
                   mv_cms_code_value ccv_or_r,  -- org role receiver
                   mv_cms_code_value ccv_pt_g,  -- position type giver
                   mv_cms_code_value ccv_pt_r,   -- position type receiver
                   mv_cms_user_characteristic cuc_r   -- characteristics receiver
                -- locale translations
             WHERE rd.giver_country_id = c_g.country_id (+)
               AND rd.recvr_country_id = c_r.country_id (+)
               AND c_g.name_cm_key   = cav_cn_g.key (+)
               AND c_g.cm_asset_code = cav_cn_g.asset_code (+)
               AND v_locale          = cav_cn_g.locale (+)
               AND c_r.name_cm_key   = cav_cn_r.key (+)
               AND c_r.cm_asset_code = cav_cn_r.asset_code (+)
               AND v_locale          = cav_cn_r.locale (+)
               AND gc_cms_list_approval_status = ccv_as.asset_code (+)
               AND rd.claim_item_status        = ccv_as.cms_code (+)
               AND v_locale                    = ccv_as.locale (+)
               AND rd.promotion_id               = p.promotion_id (+)
               AND p.promo_name_asset_code       = cav_pn.asset_code (+)
               AND gc_cms_key_fld_promotion_name = cav_pn.key (+)
               AND v_locale                      = cav_pn.locale (+)
               AND gc_cms_list_department_type = ccv_dt_g.asset_code (+)
               AND rd.giver_department_type    = ccv_dt_g.cms_code (+)
               AND v_locale                    = ccv_dt_g.locale (+)
               AND gc_cms_list_department_type = ccv_dt_r.asset_code (+)
               AND rd.recvr_department_type    = ccv_dt_r.cms_code (+)
               AND v_locale                    = ccv_dt_r.locale (+)
               AND gc_cms_list_org_role = ccv_or_g.asset_code (+)
               AND rd.giver_org_role    = ccv_or_g.cms_code (+)
               AND v_locale             = ccv_or_g.locale (+)
               AND gc_cms_list_org_role = ccv_or_r.asset_code (+)
               AND rd.recvr_org_role    = ccv_or_r.cms_code (+)
               AND v_locale             = ccv_or_r.locale (+)
               AND gc_cms_list_position_type = ccv_pt_g.asset_code (+)
               AND rd.giver_position_type    = ccv_pt_g.cms_code (+)
               AND v_locale                  = ccv_pt_g.locale (+)
               AND gc_cms_list_position_type = ccv_pt_r.asset_code (+)
               AND rd.recvr_position_type    = ccv_pt_r.cms_code (+)
               AND v_locale                  = ccv_pt_r.locale (+)
               AND rd.recvr_user_id = cuc_r.user_id (+)
               AND v_locale         = cuc_r.locale (+)
          ) fd
      ;

   -- write result set to file
   IF (p_in_file_name IS NOT NULL) THEN  
      -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 32000);
      v_stage := 'FETCH p_out_result_set'; 
    ---------11/17/2017------------ 
    LOOP          
        FETCH p_out_result_set INTO  v_extract; 
        EXIT WHEN p_out_result_set%NOTFOUND;
        --clob_len := DBMS_LOB.GETLENGTH(v_extract);  --04/08/2019
        clob_len := NVL(LENGTHC(v_extract),0); --04/08/2019
        WHILE v_pntr_position <= clob_len LOOP            
            DBMS_LOB.READ(v_extract, read_buffer_size, v_pntr_position, read_buffer_data);
            UTL_FILE.PUT(file_handler, read_buffer_data);            
            v_pntr_position := v_pntr_position + read_buffer_size;
        END LOOP;
        v_pntr_position := 1;        
        UTL_FILE.NEW_LINE(file_handler);
        UTL_FILE.FFLUSH(file_handler);
    END LOOP;
    ----------11/17/2017------------
    UTL_FILE.fclose(file_handler); 
    
      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

   COMMIT;  -- release DML locks on temp table
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN --07/16/2014 Bug # 54917
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;

END prc_nomination_dtl_extract;


PROCEDURE prc_nomination_sum_extract
( p_in_parent_node_id_list IN VARCHAR2,
  p_in_department_list     IN VARCHAR2,
  p_in_job_type_list       IN VARCHAR2,
  p_in_country_id_list     IN VARCHAR2,
  p_in_promotion_id_list   IN VARCHAR2,
  p_in_participant_status  IN VARCHAR2,
  p_in_from_date           IN VARCHAR2,
  p_in_to_date             IN VARCHAR2,   
  p_in_locale              IN VARCHAR2,
  p_in_file_name           IN VARCHAR2,
  p_in_header              IN VARCHAR2,
  p_in_viewer_user_id      IN NUMBER,
  p_out_return_code        OUT VARCHAR2,
  p_out_result_set         OUT SYS_REFCURSOR
) IS
--*******************************************************************************
-- Purpose: This procedure queries the nomination summary extract result set and writes it to file when a file name specified.
--
-- Person         Date        Comments
-- -------------- ----------  -----------------------------------------------------
-- J Flees        05/05/2016  G5 Nomination Redesign
-- Sherif Basha      03/17/2017  [JIRA] (G6-1893) Nomination Activity by Organisation - Owner/Manager report - The summary details don't seem to be correct (added par. p_in_viewer_user_id to prc_nomination_sum_extract)
-- Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
--*******************************************************************************
   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_nomination_sum_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_locale                locale_date_pattern.locale%TYPE;
   v_locale_date_pattern   locale_date_pattern.pattern%TYPE;
   v_return_code           NUMBER;
   v_data_result_set       SYS_REFCURSOR;
   v_total_result_set      SYS_REFCURSOR;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            UTL_FILE.FILE_TYPE;
   
   -- build query ref cursor record type
   CURSOR cur_data_ref IS
   SELECT CAST(NULL AS NUMBER) AS org_id,
          CAST(NULL AS VARCHAR2(255)) AS org_name,
          CAST(NULL AS NUMBER) AS eligible_nominators,
          CAST(NULL AS NUMBER) AS actual_nominators,
          CAST(NULL AS NUMBER) AS pct_eligible_nominators,
          CAST(NULL AS NUMBER) AS eligible_nominees,
          CAST(NULL AS NUMBER) AS actual_nominees,
          CAST(NULL AS NUMBER) AS pct_eligible_nominees,
          CAST(NULL AS NUMBER) AS nominations_submitted,
          CAST(NULL AS NUMBER) AS nominations_received,
          CAST(NULL AS NUMBER) AS nominations_won,
          CAST(NULL AS NUMBER) AS points_received,
          CAST(NULL AS NUMBER) AS cash_received,
          CAST(NULL AS NUMBER) AS other_qty_received,
          CAST(NULL AS NUMBER) AS other_value_received,
          CAST(NULL AS NUMBER) AS total_records,
          CAST(NULL AS NUMBER) AS rec_seq
     FROM dual;

   rec_data_ref      cur_data_ref%ROWTYPE;

   -- in-line process
   PROCEDURE p_format_extract_rec
   ( p_in_rec_data_ref  IN cur_data_ref%ROWTYPE
   ) IS
   BEGIN
      gv_tab_file_extract.EXTEND;
      gv_tab_file_extract(gv_tab_file_extract.LAST).file_rec :=
            gc_fld_delimiter || p_in_rec_data_ref.org_name                || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.eligible_nominators     || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.actual_nominators       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.pct_eligible_nominators || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.eligible_nominees       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.actual_nominees         || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.pct_eligible_nominees   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.nominations_submitted   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.nominations_received    || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.nominations_won         || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.points_received         || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.cash_received           || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.other_qty_received      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.other_value_received    || gc_fld_delimiter
         ;
   END p_format_extract_rec;
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': p_in_parent_node_id_list >' || p_in_parent_node_id_list
      || '<, p_in_department_list >' || p_in_department_list 
      || '<, p_in_job_type_list >' || p_in_job_type_list 
      || '<, p_in_country_id_list >' || p_in_country_id_list
      || '<, p_in_promotion_id_list >' || p_in_promotion_id_list 
      || '<, p_in_participant_status >' || p_in_participant_status
      || '<, p_in_from_date >' || p_in_from_date
      || '<, p_in_to_date >' || p_in_to_date
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<, p_in_viewer_user_id >' || p_in_viewer_user_id  --G6-1893 03/17/2017
      || '<~';

   v_stage := 'get locale date pattern';
   v_locale := NVL(p_in_locale, pkg_report_common.f_get_default_locale);
   v_locale_date_pattern := pkg_report_common.f_get_locale_date_pattern(v_locale);

   -- get data as displayed on screen
   v_stage := 'call prc_summary_by_org';
   pkg_query_nomination.prc_summary_by_org
   ( p_in_parent_node_id_list,
     p_in_job_type_list,
     p_in_promotion_id_list,
     p_in_department_list,
     p_in_country_id_list,
     p_in_participant_status,
     v_locale_date_pattern,
     p_in_from_date,
     p_in_to_date,
     p_in_locale,
     0,     -- p_in_rowNumStart
     1000000, -- p_in_rowNumEnd
     NULL,  -- p_in_sortColName
     NULL,  -- p_in_sortedBy
     NULL,  -- p_in_nodeAndBelow
     p_in_viewer_user_id,  -- p_in_userId            --G6-1893 03/17/2017
     v_return_code,
     v_data_result_set,
     v_total_result_set
   );

   IF (v_return_code != gc_return_code_success) THEN
      RAISE_APPLICATION_ERROR(-20100, 'Process call failed');
   END IF;

   -- initialize extract formatting
   v_stage := 'initialize extract formatting';
   gv_tab_file_extract := tab_file_extract();
   gv_tab_file_extract.EXTEND;
   gv_tab_file_extract(1).file_rec := p_in_header;

   -- format summary data for extract
   v_stage := 'FETCH v_data_result_set';
   LOOP
      FETCH v_data_result_set INTO rec_data_ref;
      EXIT WHEN (v_data_result_set%NOTFOUND); 

      p_format_extract_rec(rec_data_ref);
   END LOOP;

   IF (p_in_file_name IS NULL) THEN     
      -- return extract via output ref cursor
      v_stage := 'OPEN p_out_result_set';
      OPEN p_out_result_set FOR
      SELECT fr.file_rec AS textline
        FROM TABLE(fnc_pipe_file_records) fr;

   ELSE
      -- write result set to file
      -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      -- loop through file records
      FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
         UTL_FILE.put_line(file_handler, gv_tab_file_extract(indx).file_rec);           
      END LOOP;

      UTL_FILE.fclose(file_handler);
 --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;

END prc_nomination_sum_extract;

PROCEDURE prc_nomi_aging_dtl_extract
( p_in_parent_node_id_list IN VARCHAR2,
  p_in_department_list     IN VARCHAR2,
  p_in_job_type_list       IN VARCHAR2,
  p_in_country_id_list     IN VARCHAR2,
  p_in_promotion_id_list   IN VARCHAR2,
  p_in_nomi_status_list    IN VARCHAR2,
  p_in_approval_level_list IN VARCHAR2,
  p_in_participant_status  IN VARCHAR2,
  p_in_giver_recvr_type    IN VARCHAR2,
  p_in_from_date           IN VARCHAR2,
  p_in_to_date             IN VARCHAR2,
  p_in_locale              IN VARCHAR2,
  p_in_file_name           IN VARCHAR2,
  p_in_header              IN VARCHAR2,
  p_out_return_code        OUT VARCHAR2,
  p_out_result_set         OUT SYS_REFCURSOR
) IS
--*******************************************************************************
-- Purpose: This procedure queries the nomination aging detail extract result set
--          and writes it to file when a file name specified.
--
-- Person         Date        Comments
-- -------------- ----------  -----------------------------------------------------
-- J Flees        05/26/2016  G5 Nomination Redesign
-- nagarajs       02/14/2017  Bug 71430 - Nomination Status/Aging Report -Extract Data is not Aligned to Correct Column Headers
-- Suresh J       01/18/2019  Bug 78444 Chart and Extract not matching for "Pending" status
--Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
 --*******************************************************************************
   PRAGMA AUTONOMOUS_TRANSACTION;

   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_nomi_aging_dtl_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_locale                locale_date_pattern.locale%TYPE;
   v_locale_date_pattern   locale_date_pattern.pattern%TYPE;
   v_from_date             DATE;
   v_to_date               DATE;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   v_extract               VARCHAR2(4000);
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': p_in_parent_node_id_list >' || p_in_parent_node_id_list
      || '<, p_in_department_list >' || p_in_department_list   
      || '<, p_in_job_type_list >' || p_in_job_type_list     
      || '<, p_in_country_id_list >' || p_in_country_id_list   
      || '<, p_in_promotion_id_list >' || p_in_promotion_id_list 
      || '<, p_in_nomi_status_list >' || p_in_nomi_status_list  
      || '<, p_in_approval_level_list >' || p_in_approval_level_list  
      || '<, p_in_participant_status >' || p_in_participant_status
      || '<, p_in_giver_recvr_type >' || p_in_giver_recvr_type  
      || '<, p_in_from_date >' || p_in_from_date         
      || '<, p_in_to_date >' || p_in_to_date           
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

   v_stage := 'get locale date pattern';
   v_locale := NVL(p_in_locale, pkg_report_common.f_get_default_locale);
   v_locale_date_pattern := pkg_report_common.f_get_locale_date_pattern(v_locale);

   v_stage := 'convert input strings to date';
   v_from_date := TO_DATE(p_in_from_date, v_locale_date_pattern);
   v_to_date   := TO_DATE(p_in_to_date,   v_locale_date_pattern);

   -- stage input lists
   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(p_in_parent_node_id_list, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department_list, gc_search_all_values),  gc_ref_text_department_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_job_type_list, gc_search_all_values),  gc_ref_text_position_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_country_id_list, gc_search_all_values),   gc_ref_text_country_id, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id_list, gc_search_all_values),  gc_ref_text_promotion_id, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_nomi_status_list, gc_search_all_values), gc_ref_text_nomination_status);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_approval_level_list, gc_search_all_values),  gc_ref_text_approval_level, 1);

   v_stage := 'OPEN p_out_result_set';
   OPEN p_out_result_set FOR
   -- format the extract record
   SELECT p_in_header AS textline
     FROM dual
    UNION ALL 
   SELECT    gc_fld_delimiter || fd.recvr_user_name       || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_first_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_middle_name     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_last_name       || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.team_name             || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_country_name    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_node_name       || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_department_type || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.recvr_position_type   || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_user_name       || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_first_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_last_name       || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_country_name    || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_node_name       || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_department_type || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.giver_position_type   || gc_fld_delimiter || gc_fld_separator  --02/14/2017
          || gc_fld_delimiter || fd.promotion_name        || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.date_submitted        || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.claim_item_status     || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.claim_approval_round  || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r1_approver_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r1_approval_date      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r2_approver_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r2_approval_date      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r3_approver_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r3_approval_date      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r4_approver_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r4_approval_date      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r5_approver_name      || gc_fld_delimiter || gc_fld_separator
          || gc_fld_delimiter || fd.r5_approval_date      || gc_fld_delimiter
          AS textline
     FROM ( -- build the full data set
            SELECT -- nominee fields
                   rd.recvr_user_name,
                   rd.recvr_first_name,
                   rd.recvr_middle_name,
                   rd.recvr_last_name,
                   rd.team_name,
                   cav_cn_r.cms_value AS recvr_country_name,
                   rd.recvr_node_name,
                   NVL(ccv_dt_r.cms_name, rd.recvr_department_type) AS recvr_department_type,
                   NVL(ccv_pt_r.cms_name, rd.recvr_position_type) AS recvr_position_type,
                   -- nominator fields
                   rd.giver_user_name,
                   rd.giver_first_name,
                   rd.giver_last_name,
                   cav_cn_g.cms_value AS giver_country_name,
                   rd.giver_node_name,
                   NVL(ccv_dt_g.cms_name, rd.giver_department_type) AS giver_department_type,
                   NVL(ccv_pt_g.cms_name, rd.giver_position_type) AS giver_position_type, --02/14/2017
                   -- nomination fields
                   NVL(cav_pn.cms_value, rd.promotion_name) AS promotion_name,
                   TO_CHAR(rd.date_submitted, v_locale_date_pattern) AS date_submitted,
                   NVL(ccv_as.cms_name, rd.claim_item_status) AS claim_item_status,
                   rd.claim_approval_round,
                   -- approval fields
                   fnc_format_user_name(rd.r1_approver_last_name, rd.r1_approver_first_name) AS r1_approver_name,
                   TO_CHAR(rd.r1_approval_date, v_locale_date_pattern) AS r1_approval_date,
                   fnc_format_user_name(rd.r2_approver_last_name, rd.r2_approver_first_name) AS r2_approver_name,
                   TO_CHAR(rd.r2_approval_date, v_locale_date_pattern) AS r2_approval_date,
                   fnc_format_user_name(rd.r3_approver_last_name, rd.r3_approver_first_name) AS r3_approver_name,
                   TO_CHAR(rd.r3_approval_date, v_locale_date_pattern) AS r3_approval_date,
                   fnc_format_user_name(rd.r4_approver_last_name, rd.r4_approver_first_name) AS r4_approver_name,
                   TO_CHAR(rd.r4_approval_date, v_locale_date_pattern) AS r4_approval_date,
                   fnc_format_user_name(rd.r5_approver_last_name, rd.r5_approver_first_name) AS r5_approver_name,
                   TO_CHAR(rd.r5_approval_date, v_locale_date_pattern) AS r5_approval_date
              FROM ( -- get raw data
                     SELECT -- nominee fields
                            dtl.recvr_user_name,
                            dtl.recvr_first_name,
                            dtl.recvr_middle_name,
                            dtl.recvr_last_name,
                            dtl.team_name,
                            dtl.recvr_country_id,
                            c_r.name_cm_key AS recvr_country_key,
                            c_r.cm_asset_code AS recvr_country_asset_code,
                            dtl.recvr_node_name,
                            dtl.recvr_department_type,
                            dtl.recvr_position_type,
                            dtl.recvr_pax_status,
                            -- nominator fields
                            dtl.giver_user_name,
                            dtl.giver_first_name,
                            dtl.giver_last_name,
                            dtl.giver_country_id,
                            c_g.name_cm_key AS giver_country_key,
                            c_g.cm_asset_code AS giver_country_asset_code,
                            dtl.giver_node_name,
                            dtl.giver_department_type,
                            dtl.giver_position_type,
                            dtl.giver_pax_status,
                            -- nomination fields
                            dtl.promotion_id,
                            dtl.promotion_name,
                            p.promo_name_asset_code,
                            dtl.date_submitted,
                            dtl.claim_item_status,
                            dtl.claim_approval_round,
                            -- approval fields
                            dtl.r1_approval_date,
                            dtl.r1_approver_first_name,
                            dtl.r1_approver_last_name,
                            dtl.r2_approval_date,
                            dtl.r2_approver_first_name,
                            dtl.r2_approver_last_name,
                            dtl.r3_approval_date,
                            dtl.r3_approver_first_name,
                            dtl.r3_approver_last_name,
                            dtl.r4_approval_date,
                            dtl.r4_approver_first_name,
                            dtl.r4_approver_last_name,
                            dtl.r5_approval_date,
                            dtl.r5_approver_first_name,
                            dtl.r5_approver_last_name
                       FROM rpt_nomination_detail dtl,
                            promotion p,
                            country c_g,           -- country giver
                            country c_r,           -- country receiver
                            rpt_hierarchy_rollup hr,
                            gtt_id_list gil_hr, -- hierarchy rollup
                            gtt_id_list gil_al, -- approval level
                            gtt_id_list gil_c,  -- country
                            gtt_id_list gil_dt, -- department type
                            gtt_id_list gil_ns, -- nomination status
                            gtt_id_list gil_p,  -- promotion
                            gtt_id_list gil_pt  -- position type
                      WHERE dtl.promotion_id = p.promotion_id (+)
                        AND dtl.giver_country_id = c_g.country_id (+)
                        AND dtl.recvr_country_id = c_r.country_id (+)
                         -- restrict by required fields
                        AND dtl.date_submitted BETWEEN v_from_date AND v_to_date
                        AND gil_hr.ref_text_1 = gc_ref_text_parent_node_id
                        AND gil_hr.id = hr.node_id
                        AND hr.child_node_id = DECODE(p_in_giver_recvr_type, gc_elg_type_giver, dtl.giver_node_id, dtl.recvr_node_id)
                        AND dtl.claim_id IS NOT NULL
                         -- restrict by optional fields
                        AND gil_al.ref_text_1 = gc_ref_text_approval_level
                        AND (  gil_al.ref_text_2 = gc_search_all_values
                            OR gil_al.id = dtl.claim_approval_round )
                        AND gil_ns.ref_text_1 = gc_ref_text_nomination_status
                        AND (  gil_ns.ref_text_2 = gc_search_all_values
                             OR gil_ns.ref_text_2 IN ( dtl.claim_item_status ) )  --01/18/2019
--                        AND (  gil_ns.ref_text_2 = gc_search_all_values
--                            OR gil_ns.ref_text_2 IN (dtl.r1_approval_status,
--                                                     dtl.r2_approval_status,
--                                                     dtl.r3_approval_status,
--                                                     dtl.r4_approval_status,
--                                                     dtl.r5_approval_status
--                                                    ) )
                        AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                        AND (  gil_p.ref_text_2 = gc_search_all_values
                            OR gil_p.id = dtl.promotion_id )
                        AND gil_c.ref_text_1 = gc_ref_text_country_id
                        AND (  gil_c.ref_text_2 = gc_search_all_values
                            OR gil_c.id = DECODE(p_in_giver_recvr_type, gc_elg_type_giver, dtl.giver_country_id, dtl.recvr_country_id) ) 
                        AND gil_dt.ref_text_1 = gc_ref_text_department_type
                        AND (  gil_dt.ref_text_2 = gc_search_all_values
                            OR gil_dt.ref_text_2 = DECODE(p_in_giver_recvr_type, gc_elg_type_giver, dtl.giver_department_type, dtl.recvr_department_type) )
                        AND gil_pt.ref_text_1 = gc_ref_text_position_type
                        AND (  gil_pt.ref_text_2 = gc_search_all_values
                            OR gil_pt.ref_text_2 = DECODE(p_in_giver_recvr_type, gc_elg_type_giver, dtl.giver_position_type, dtl.recvr_position_type) )
                        AND (  p_in_participant_status IS NULL
                            OR p_in_participant_status = DECODE(p_in_giver_recvr_type, gc_elg_type_giver, dtl.giver_pax_status, dtl.recvr_pax_status) )
                   ) rd,
                   mv_cms_asset_value cav_cn_g, -- country name giver
                   mv_cms_asset_value cav_cn_r, -- country name receiver
                   mv_cms_asset_value cav_pn,   -- promotion name
                   mv_cms_code_value ccv_as,    -- approval status
                   mv_cms_code_value ccv_dt_g,  -- department type giver
                   mv_cms_code_value ccv_pt_g,  -- position type giver  --02/14/2017
                   mv_cms_code_value ccv_dt_r,  -- department type receiver
                   mv_cms_code_value ccv_pt_r   -- position type receiver
                -- locale translations
             WHERE rd.giver_country_key        = cav_cn_g.key (+)
               AND rd.giver_country_asset_code = cav_cn_g.asset_code (+)
               AND v_locale                    = cav_cn_g.locale (+)
               AND rd.recvr_country_key        = cav_cn_r.key (+)
               AND rd.recvr_country_asset_code = cav_cn_r.asset_code (+)
               AND v_locale                    = cav_cn_r.locale (+)
               AND rd.promo_name_asset_code      = cav_pn.asset_code (+)
               AND gc_cms_key_fld_promotion_name = cav_pn.key (+)
               AND v_locale                      = cav_pn.locale (+)
               AND gc_cms_list_approval_status = ccv_as.asset_code (+)
               AND rd.claim_item_status        = ccv_as.cms_code (+)
               AND v_locale                    = ccv_as.locale (+)
               AND gc_cms_list_department_type = ccv_dt_g.asset_code (+)
               AND rd.giver_department_type    = ccv_dt_g.cms_code (+)
               AND v_locale                    = ccv_dt_g.locale (+)
               AND gc_cms_list_department_type = ccv_dt_r.asset_code (+)
               AND rd.recvr_department_type    = ccv_dt_r.cms_code (+)
               AND v_locale                    = ccv_dt_r.locale (+)
               AND gc_cms_list_position_type = ccv_pt_r.asset_code (+)
               AND rd.recvr_position_type    = ccv_pt_r.cms_code (+)
               AND v_locale                  = ccv_pt_r.locale (+)
               AND gc_cms_list_position_type = ccv_pt_g.asset_code (+) --02/14/2017
               AND rd.giver_position_type    = ccv_pt_g.cms_code (+)   --02/14/2017
               AND v_locale                  = ccv_pt_g.locale (+)     --02/14/2017
             ORDER BY rd.date_submitted,
                   LOWER(rd.recvr_last_name),
                   LOWER(rd.recvr_first_name),
                   LOWER(rd.recvr_middle_name),
                   LOWER(rd.giver_last_name),
                   LOWER(rd.giver_first_name)
          ) fd
      ;

   -- write result set to file
   IF (p_in_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
         UTL_FILE.put_line(file_handler, v_extract);           
      END LOOP;

      UTL_FILE.fclose(file_handler);
--start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

   COMMIT;  -- release DML locks on temp table
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN --07/16/2014 Bug # 54917
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;

END prc_nomi_aging_dtl_extract;

PROCEDURE prc_nomi_aging_sum_extract
( p_in_parent_node_id_list IN VARCHAR2,
  p_in_department_list     IN VARCHAR2,
  p_in_job_type_list       IN VARCHAR2,
  p_in_country_id_list     IN VARCHAR2,
  p_in_promotion_id_list   IN VARCHAR2,
  p_in_nomi_status_list    IN VARCHAR2,
  p_in_approval_level_list IN VARCHAR2,
  p_in_participant_status  IN VARCHAR2,
  p_in_giver_recvr_type    IN VARCHAR2,
  p_in_from_date           IN VARCHAR2,
  p_in_to_date             IN VARCHAR2,
  p_in_locale              IN VARCHAR2,
  p_in_file_name           IN VARCHAR2,
  p_in_header              IN VARCHAR2,
  p_out_return_code        OUT VARCHAR2,
  p_out_result_set         OUT sys_refcursor
) IS
--*******************************************************************************
-- Purpose: This procedure queries the nomination aging summary extract result set
--          and writes it to file when a file name specified.
--
-- Person         Date        Comments
-- -------------- ----------  -----------------------------------------------------
-- J Flees        05/26/2016  G5 Nomination Redesign
-- chidamba       02/13/2018  G6-3870 Missed columns added to the extract
--Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
--*******************************************************************************
   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_nomi_aging_sum_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_locale_date_pattern   locale_date_pattern.pattern%TYPE;
   v_return_code           NUMBER;
   v_data_result_set       SYS_REFCURSOR;
   v_total_result_set      SYS_REFCURSOR;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            UTL_FILE.FILE_TYPE;
   
   -- build ref cursor record types
   CURSOR cur_data_ref IS
   SELECT CAST(NULL AS NUMBER) AS promotion_id,
          CAST(NULL AS VARCHAR2(1000)) AS promotion_name,
          CAST(NULL AS VARCHAR2(50)) AS time_period_name,
          CAST(NULL AS NUMBER) AS r1_pending_cnt,
          CAST(NULL AS NUMBER) AS r1_avg_pending_days,
          CAST(NULL AS NUMBER) AS r1_approved_cnt,
          CAST(NULL AS NUMBER) AS r1_winner_cnt,
          CAST(NULL AS NUMBER) AS r1_non_winner_cnt,
          CAST(NULL AS NUMBER) AS r1_more_info_cnt,
          CAST(NULL AS NUMBER) AS r2_pending_cnt,
          CAST(NULL AS NUMBER) AS r2_avg_pending_days,
          CAST(NULL AS NUMBER) AS r2_approved_cnt,
          CAST(NULL AS NUMBER) AS r2_winner_cnt,
          CAST(NULL AS NUMBER) AS r2_non_winner_cnt,
          CAST(NULL AS NUMBER) AS r2_more_info_cnt,
          CAST(NULL AS NUMBER) AS r3_pending_cnt,
          CAST(NULL AS NUMBER) AS r3_avg_pending_days,
          CAST(NULL AS NUMBER) AS r3_approved_cnt,
          CAST(NULL AS NUMBER) AS r3_winner_cnt,
          CAST(NULL AS NUMBER) AS r3_non_winner_cnt,
          CAST(NULL AS NUMBER) AS r3_more_info_cnt,
          CAST(NULL AS NUMBER) AS r4_pending_cnt,
          CAST(NULL AS NUMBER) AS r4_avg_pending_days,
          CAST(NULL AS NUMBER) AS r4_approved_cnt,
          CAST(NULL AS NUMBER) AS r4_winner_cnt,
          CAST(NULL AS NUMBER) AS r4_non_winner_cnt,
          CAST(NULL AS NUMBER) AS r4_more_info_cnt,
          CAST(NULL AS NUMBER) AS r5_pending_cnt,
          CAST(NULL AS NUMBER) AS r5_avg_pending_days,
          CAST(NULL AS NUMBER) AS r5_approved_cnt,
          CAST(NULL AS NUMBER) AS r5_winner_cnt,
          CAST(NULL AS NUMBER) AS r5_non_winner_cnt,
          CAST(NULL AS NUMBER) AS r5_more_info_cnt,
          CAST(NULL AS NUMBER) AS total_records,
          CAST(NULL AS NUMBER) AS rec_seq
     FROM dual;

   rec_data_ref      cur_data_ref%ROWTYPE;

   -- in-line process
   PROCEDURE p_format_extract_rec
   ( p_in_rec_data_ref     IN cur_data_ref%ROWTYPE
   ) IS
   BEGIN
      gv_tab_file_extract.EXTEND;
      gv_tab_file_extract(gv_tab_file_extract.LAST).file_rec :=
            gc_fld_delimiter || p_in_rec_data_ref.promotion_name      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.time_period_name    || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r1_pending_cnt      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r1_avg_pending_days || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r1_approved_cnt     || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r1_winner_cnt       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r1_non_winner_cnt   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r1_more_info_cnt     || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r2_pending_cnt      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r2_avg_pending_days || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r2_approved_cnt     || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r2_winner_cnt       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r2_non_winner_cnt   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r2_more_info_cnt    || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r3_pending_cnt      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r3_avg_pending_days || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r3_approved_cnt     || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r3_winner_cnt       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r3_non_winner_cnt   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r3_more_info_cnt    || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r4_pending_cnt      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r4_avg_pending_days || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r4_approved_cnt     || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r4_winner_cnt       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r4_non_winner_cnt   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r4_more_info_cnt    || gc_fld_delimiter || gc_fld_separator  -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r5_pending_cnt      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r5_avg_pending_days || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r5_approved_cnt     || gc_fld_delimiter || gc_fld_separator   -- 02/13/2018
         || gc_fld_delimiter || p_in_rec_data_ref.r5_winner_cnt       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r5_non_winner_cnt   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.r5_more_info_cnt     || gc_fld_delimiter;   -- 02/13/2018
         
   END p_format_extract_rec;

BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': p_in_parent_node_id_list >' || p_in_parent_node_id_list
      || '<, p_in_department_list >' || p_in_department_list   
      || '<, p_in_job_type_list >' || p_in_job_type_list     
      || '<, p_in_country_id_list >' || p_in_country_id_list   
      || '<, p_in_promotion_id_list >' || p_in_promotion_id_list 
      || '<, p_in_nomi_status_list >' || p_in_nomi_status_list  
      || '<, p_in_approval_level_list >' || p_in_approval_level_list  
      || '<, p_in_participant_status >' || p_in_participant_status
      || '<, p_in_giver_recvr_type >' || p_in_giver_recvr_type  
      || '<, p_in_from_date >' || p_in_from_date         
      || '<, p_in_to_date >' || p_in_to_date           
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

   v_stage := 'get locale date pattern';
   v_locale_date_pattern := pkg_report_common.f_get_locale_date_pattern(p_in_locale);

   -- get data as displayed on screen
   v_stage := 'call prc_summary_aging';
   pkg_query_nomi_aging.prc_summary_aging
   ( p_in_parent_node_id_list,
     p_in_department_list,
     p_in_job_type_list,
     p_in_country_id_list,
     p_in_promotion_id_list,
     p_in_nomi_status_list,
     p_in_approval_level_list,
     p_in_participant_status,
     p_in_giver_recvr_type,
     v_locale_date_pattern,
     p_in_from_date,
     p_in_to_date,
     0,     -- p_in_rownum_start
     1000000, -- p_in_rownum_end
     NULL,  -- p_in_sort_col_name
     NULL,  -- p_in_sorted_by
     v_return_code,
     v_data_result_set,
     v_total_result_set
   );

   IF (v_return_code != gc_return_code_success) THEN
      RAISE_APPLICATION_ERROR(-20100, 'Process call failed');
   END IF;

   -- initialize extract formatting
   v_stage := 'initialize extract formatting';
   gv_tab_file_extract := tab_file_extract();
   gv_tab_file_extract.EXTEND;
   gv_tab_file_extract(1).file_rec := p_in_header;

   -- format data record for extract
   v_stage := 'FETCH v_data_result_set';
   LOOP
      FETCH v_data_result_set INTO rec_data_ref;
      EXIT WHEN (v_data_result_set%NOTFOUND); 

      p_format_extract_rec(rec_data_ref);
   END LOOP;

   IF (p_in_file_name IS NULL) THEN     
      -- return extract via output ref cursor
      v_stage := 'OPEN p_out_result_set';
      OPEN p_out_result_set FOR
      SELECT fr.file_rec AS textline
        FROM TABLE(fnc_pipe_file_records) fr;

   ELSE
      -- write result set to file
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      -- loop through file records
      FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
         UTL_FILE.put_line(file_handler, gv_tab_file_extract(indx).file_rec);           
      END LOOP;

      UTL_FILE.fclose(file_handler);

      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;

END prc_nomi_aging_sum_extract;

PROCEDURE PRC_CLAIMS_EXTRACT
  ( p_in_promotion_id         IN VARCHAR2,  
    p_paxid                   IN NUMBER,
    is_Team                 IN NUMBER,
    parentNodeId              IN VARCHAR2,   
    p_in_promotion_status     IN VARCHAR2,  
    p_in_pax_status           IN VARCHAR2,
    p_in_job_code             IN VARCHAR2,
    p_claim_status             IN VARCHAR2,
    p_in_department           IN VARCHAR2,
    p_in_from_date           IN VARCHAR2,
    p_in_to_date               IN VARCHAR2,
    SubmittedType             IN VARCHAR2,        
    locale                     IN VARCHAR2,
    p_in_country_id            IN NUMBER,--05/13/2014 Bug 53312  
    p_file_name             IN VARCHAR2,
    p_header                IN VARCHAR2,
    p_out_return_code          OUT varchar2,
    p_out_result_set           OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Participant Extract' for Admin.
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 01/07/2013 Initial Version  
                  03/11/2013 Changed the procedure to work for Asynochronous processing of storing the extract in reports folder.
-- Chidamba       09/13/2013 Bug fix #4398 removed Approver_first_name and Approver_last_name column and replace with APPROVER_NAME
                             becasue, Approver_first_name and Approver_last_name columns has permanent NULL values populated by PKG_REPORT_PRODUCT_CLAIM
-- nagarajs       01/15/2014 Bug Fix 51001 -column submitter_points replaced with award_amount since the points is displaying as 0 in report for sweepstakes records
-- Arun S         01/16/2014 Bug Fix 51114 - display Final Approver as System for auto approval claims
-- Ravi Dhanekula 01/27/2014 Bug fix 51080 - Added Team member count AND Team member total points.
-- Suresh J       04/01/2014 Added temp table temp_table_session to fetch the CM data to fix performance issue.
-- Swati          05/13/2014 Bug 53312 - Country Filters not holding in exports
-- Swati          05/27/2014 Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated 
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
--Ravi Dhanekula 08/06/2014   Added this sequel to get the allactive data as we no longer insert allactive data to rpt_pax_promo_eligibility
--Ravi Dhanekula 09/06/2014   Fixed the bug # 56291. Extraxt column issue.
--               10/08/2014   Fixed the bug # 57243.    
--                      06/26/2015   Fixed the bug # 61701..Fixed multiple issues found. For applyting this fix to a client, please take the entire procedure.            
--nagarajs       02/17/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
--Loganathan     04/19/2019 Bug 76478 - Product Claims: A product claim promotion setup with one to one type having 2 products selected,
                            submitted and approved shows duplicate entry in the Claims report
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   -- local variables
   l_cursor  SYS_REFCURSOR; 
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    p_in_locale VARCHAR2(10):=locale;
    v_pattern    VARCHAR2(15);
	
BEGIN

DELETE temp_table_session;

INSERT INTO temp_table_session
 SELECT asset_code,cms_name,cms_code
     FROM vw_cms_code_value E
    WHERE asset_code in ( 'picklist.claim.status.type.items','picklist.department.type.items','picklist.positiontype.items') and e.locale=p_in_locale
UNION
 SELECT asset_code,cms_value,key FROM vw_cms_asset_value where key='COUNTRY_NAME' and locale = p_in_locale
UNION --05/27/2014 Bug # 53480
 SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                            WHERE upper(promotion_type) = upper('product_claim') --Bug # 56291
                        )
    AND locale = p_in_locale;  

DELETE chacracteristics_cms;

INSERT INTO chacracteristics_cms
select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

IF p_file_name IS NULL THEN 
OPEN p_out_result_set FOR
     -- column headers
SELECT textline FROM (
SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL
SELECT * 
FROM
(SELECT 2,
       c2_delimiter||claim_number||c2_delimiter||c_delimiter||-- Bug # 56291
       c2_delimiter||claim_status||c2_delimiter||c_delimiter||  --04/01/2014
       c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
       c2_delimiter||final_approver||c2_delimiter||c_delimiter||     
       c2_delimiter||promotion_name||c2_delimiter||c_delimiter|| --05/27/2014 Bug # 53480
       c2_delimiter||product_name||c2_delimiter||c_delimiter||       
       c2_delimiter||product_category_name||c2_delimiter||c_delimiter||
       c2_delimiter||product_subcategory_name||c2_delimiter||c_delimiter||
       c2_delimiter||product_qty||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_first_name||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_last_name||c2_delimiter||c_delimiter||
       c2_delimiter||proxy_user_name||c2_delimiter||c_delimiter||
       c2_delimiter||user_name||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_country||c2_delimiter||c_delimiter|| 
       c2_delimiter||node_name||c2_delimiter||c_delimiter||
       c2_delimiter||job_title||c2_delimiter||c_delimiter|| --04/01/2014
       c2_delimiter||department||c2_delimiter||c_delimiter|| --04/01/2014
       c2_delimiter||team_member_count||c2_delimiter||c_delimiter|| --01/27/2014
       c2_delimiter||team_member_total_points||c2_delimiter||c_delimiter|| --01/27/2014
       c2_delimiter||nvl (submitter_points, 0)||c2_delimiter||c_delimiter|| --01/15/2014 --submitter_points replaced with award_amount
       c2_delimiter||nvl (submitter_sweepstakes_won, 0)||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_1||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_2||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_3||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_4||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_5||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_6||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_7||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_8||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_9||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_10||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_11||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_12||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_13||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_14||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_15||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_16||c2_delimiter||c_delimiter||      --02/17/2016 Start 
       c2_delimiter||participant_char_17||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_18||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_19||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_20||c2_delimiter     --02/17/2016 End   
--select *
FROM
( select CASE WHEN row_num IS NULL THEN (ROWNUM+1)
                      ELSE  row_num END row_num,
                      rs.*
FROM 
(
SELECT
2 as row_num,
rcd.claim_number
,(select cms_name from temp_table_session where asset_code='picklist.claim.status.type.items' and cms_code=rcd.claim_status) as claim_status
,rcd.date_submitted
,CASE
     WHEN rcp.approver_user_id IS NULL THEN DECODE(rcd.claim_status,'closed','System',NULL)  --NULL  --01/16/2014
     ELSE rcp.approver_name                                 --09/13/2013 Bug fix #4398 --rcp.approver_last_name || ', ' || rcp.approver_first_name
  END Final_Approver     
,(select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) as promotion_name
,rcp.product_name
,rcp.product_category_name
,rcp.product_subcategory_name
,rcp.product_qty
,rcd.submitter_first_name
,rcd.submitter_middle_name
,rcd.submitter_last_name
,rcd.proxy_user_name
,submitter.user_name
,(select cms_name from temp_table_session where asset_code=c.cm_asset_code) as submitter_country                                
,rcd.node_name
,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=rcd.submitter_job_position) as job_title
,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=rcd.submitter_department) as department
,(SELECT COUNT(1) FROM user_node WHERE is_primary=1 AND node_id=rcd.node_id) as team_member_count
,(SELECT SUM(award_amount) FROM rpt_claim_detail WHERE node_id=rcd.node_id) as Team_member_total_points
,NVL (CASE WHEN rcd.claim_id IS NULL THEN award_amount ELSE rcp.product_award_amount END, 0) as submitter_points --07/02/2015 --04/19/2019 Bug 76478 replaced submitter_points with  product_award_amount
,NVL (rcd.submitter_sweepstakes_won, 0) submitter_sweepstakes_won 
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) as Participant_Char_1
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) as Participant_Char_2
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) as Participant_Char_3
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) as Participant_Char_4
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) as Participant_Char_5
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) as Participant_Char_6
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) as Participant_Char_7
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) as Participant_Char_8
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) as Participant_Char_9
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) as Participant_Char_10
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) as Participant_Char_11
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) as Participant_Char_12
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) as Participant_Char_13
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) as Participant_Char_14
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) as Participant_Char_15
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as Participant_Char_16     --02/17/2016 Start
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as Participant_Char_17
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as Participant_Char_18
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as Participant_Char_19
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as Participant_Char_20     --02/17/2016 End
FROM rpt_claim_detail rcd,
       rpt_claim_product rcp,
       promotion p,
       application_user submitter,
       rpt_characteristic rch,
       country c
 WHERE     rcd.promotion_id = p.promotion_id
       AND rcd.claim_id = rcp.claim_id(+) --10/08/2014
       AND rcd.submitter_user_id = submitter.user_id
       AND rcd.submitter_user_id = rch.user_nt_id(+)
       AND rch.characteristic_type(+) = 'USER' --10/07/2014
       AND rcd.submitter_country_id = c.country_id
       AND p.promotion_status = NVL (p_in_promotion_status, p.promotion_status)
       AND (rcd.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL))
       AND rcd.claim_status = NVL (p_claim_status, rcd.claim_status)
       AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rcd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   where node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rcd.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rcd.submitter_user_id=p_paxid))
       AND rcd.submitter_pax_status =
              NVL (p_in_pax_status, rcd.submitter_pax_status)
       AND NVL(rcd.submitter_job_position,'job') =
              NVL (p_in_job_code, NVL(rcd.submitter_job_position,'job'))
       AND (rcd.submitter_department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND NVL (TRUNC (rcd.date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 1)
            OR (SubmittedType = 'haveNot' AND 1 = 2))     
       AND rcd.submitter_country_id = NVL(p_in_country_id,rcd.submitter_country_id)--05/13/2014  Bug 53312               
UNION ALL
SELECT NULL AS row_num
       ,NULL
       ,NULL
       ,rcd.date_submitted
       ,NULL   
       ,(select cms_name from temp_table_session where asset_code=p.promo_name_asset_code) 
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,rcd.submitter_first_name
       ,rcd.submitter_middle_name
       ,rcd.submitter_last_name
       ,rcd.proxy_user_name
       ,submitter.user_name
       ,(select cms_name from temp_table_session where asset_code=c.cm_asset_code)
       ,rcd.node_name
        ,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=rcd.submitter_job_position)
        ,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=rcd.submitter_department)
        ,(SELECT COUNT(1) FROM user_node WHERE is_primary=1 AND node_id=rcd.node_id)
        ,(SELECT SUM(award_amount) FROM rpt_claim_detail WHERE node_id=rcd.node_id)
        ,NVL (rcd.award_amount, 0)
        ,NVL (rcd.submitter_sweepstakes_won, 0)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as Participant_Char_16     --02/17/2016 Start
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as Participant_Char_17
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as Participant_Char_18
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as Participant_Char_19
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as Participant_Char_20     --02/17/2016 End
  FROM rpt_claim_detail rcd,      
       promotion p,
       application_user submitter,
       rpt_characteristic rch,
       country c
 WHERE     rcd.promotion_id = p.promotion_id       
       AND rcd.submitter_user_id = submitter.user_id
       AND rcd.submitter_user_id = rch.user_nt_id(+)
       AND rch.characteristic_type(+) = 'USER' --10/07/2014
       AND rcd.submitter_country_id = c.country_id
       AND p.promotion_status = NVL (p_in_promotion_status, p.promotion_status)
      AND (rcd.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL))
       AND rcd.claim_status IS NULL
     AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rcd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   where node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rcd.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rcd.submitter_user_id=p_paxid))
       AND rcd.submitter_pax_status =
              NVL (p_in_pax_status, rcd.submitter_pax_status)
       AND NVL(rcd.submitter_job_position,'job') =
              NVL (p_in_job_code, NVL(rcd.submitter_job_position,'job'))
       AND (rcd.submitter_department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND NVL (TRUNC (rcd.date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 1)
            OR (SubmittedType = 'haveNot' AND 1 = 2))
       AND rcd.submitter_country_id = NVL(p_in_country_id,rcd.submitter_country_id)--05/13/2014 Bug 53312                 
            UNION ALL
SELECT  NULL AS row_num--,(ROWNUM+1) as row_num
       ,NULL 
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,0
       ,au.first_name
       ,au.middle_name
       ,au.last_name
       ,NULL
       ,au.user_name
       ,(select cms_name from temp_table_session where asset_code=c.cm_asset_code) --04/01/2014
       ,pax.name
       ,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=vpe.position_type)  --04/01/2014
       ,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=vpe.department_type)  --04/01/2014
       ,0
       ,0
       ,0
       ,0       
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL        --02/17/2016 Start
       ,NULL
       ,NULL
       ,NULL
       ,NULL        --02/17/2016 End
  FROM application_user au,
       user_address ua,
       country c,
       vw_curr_pax_employer vpe,
       (SELECT DISTINCT r.participant_id, n.name
          FROM rpt_pax_promo_eligibility r,
               promo_product_claim pn,
               promotion promo,
               node n,
               participant p,
               vw_curr_pax_employer vpe
         WHERE     r.promotion_id = pn.promotion_id
               AND pn.promotion_id = promo.promotion_id
               AND r.node_id = n.node_id
               AND r.participant_id = p.user_id
               AND r.participant_id = vpe.user_id(+)
               AND r.giver_recvr_type = 'giver'
               AND NOT EXISTS
                          (SELECT 'X'
                             FROM rpt_claim_detail
                            WHERE submitter_user_id = r.participant_id
                                  AND node_id = r.node_id
                                  AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)
                                  )
               AND promo.promotion_status =
                      NVL (p_in_promotion_status, promo.promotion_status)              
              AND (r.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL))
               AND p.status = NVL (p_in_pax_status, p.status)
               AND NVL(vpe.position_type,'job') = NVL (p_in_job_code, NVL(vpe.position_type,'job'))
               AND (vpe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                      AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND r.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND r.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  p.user_id=p_paxid))) pax
 WHERE     au.user_id = ua.user_id
       AND ua.country_id = c.country_id
       AND au.user_id = pax.participant_id
       AND au.user_id = vpe.user_id(+)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 2)
            OR (SubmittedType = 'haveNot' AND 1 = 1))
              AND ua.country_id = NVL(p_in_country_id,ua.country_id)--05/13/2014 Bug 53312
UNION ALL--08/06/2014
SELECT   NULL AS row_num--(ROWNUM+1) 
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,0
,au.first_name
,au.middle_name
,au.last_name
,NULL
,au.user_name
,(select cms_name from temp_table_session where asset_code=c.cm_asset_code) --04/01/2014
,pax.name
,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=vpe.position_type)  --04/01/2014
,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=vpe.department_type)  --04/01/2014
,0
,0
,0
,0       
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL        --02/17/2016 Start
,NULL
,NULL
,NULL
,NULL        --02/17/2016 End
  FROM application_user au,
       user_address ua,
       country c,
       vw_curr_pax_employer vpe,
       (SELECT  p.user_id participant_id, n.name
          FROM 
               node n,
               user_node un,
               participant p,
               rpt_participant_employer vpe
         WHERE un.user_id = p.user_id
               AND un.node_id = n.node_id
               AND p.status = 'active'              
              AND p.user_id = vpe.user_id(+)                            
               AND NOT EXISTS
                          (SELECT 'X'
                             FROM rpt_claim_detail r,
                             promotion promo
                            WHERE submitter_user_id = p.user_id
                                  AND node_id = n.node_id
                                  AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)       
               AND promo.promotion_status =
                      NVL (p_in_promotion_status, promo.promotion_status)              
              AND (promo.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL)))
               AND p.status = NVL (p_in_pax_status, p.status)
               AND NVL(vpe.position_type,'job') = NVL (p_in_job_code, NVL(vpe.position_type,'job'))
               AND (vpe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                      AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND n.node_id IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND n.node_id=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  p.user_id=p_paxid))) pax
 WHERE     au.user_id = ua.user_id
       AND ua.country_id = c.country_id
       AND au.user_id = pax.participant_id
       AND au.user_id = vpe.user_id(+)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 2)
            OR (SubmittedType = 'haveNot' AND 1 = 1))
              AND ua.country_id = NVL(p_in_country_id,ua.country_id)
              )rs) order by submitter_last_name asc,submitter_first_name asc));

p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
 
OPEN l_cursor FOR
SELECT textline FROM (      --12/18/2014
SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL
SELECT * 
FROM
(SELECT 2,
       c2_delimiter||claim_number||c2_delimiter||c_delimiter||-- Bug # 56291
       c2_delimiter||claim_status||c2_delimiter||c_delimiter||  --04/01/2014
       c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
       c2_delimiter||final_approver||c2_delimiter||c_delimiter||     
       c2_delimiter||promotion_name||c2_delimiter||c_delimiter|| --05/27/2014 Bug # 53480
       c2_delimiter||product_name||c2_delimiter||c_delimiter||       
       c2_delimiter||product_category_name||c2_delimiter||c_delimiter||
       c2_delimiter||product_subcategory_name||c2_delimiter||c_delimiter||
       c2_delimiter||product_qty||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_first_name||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_last_name||c2_delimiter||c_delimiter||
       c2_delimiter||proxy_user_name||c2_delimiter||c_delimiter||
       c2_delimiter||user_name||c2_delimiter||c_delimiter||
       c2_delimiter||submitter_country||c2_delimiter||c_delimiter|| 
       c2_delimiter||node_name||c2_delimiter||c_delimiter||
       c2_delimiter||job_title||c2_delimiter||c_delimiter|| --04/01/2014
       c2_delimiter||department||c2_delimiter||c_delimiter|| --04/01/2014
       c2_delimiter||team_member_count||c2_delimiter||c_delimiter|| --01/27/2014
       c2_delimiter||team_member_total_points||c2_delimiter||c_delimiter|| --01/27/2014
       c2_delimiter||nvl (submitter_points, 0)||c2_delimiter||c_delimiter|| --01/15/2014 --submitter_points replaced with award_amount
       c2_delimiter||nvl (submitter_sweepstakes_won, 0)||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_1||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_2||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_3||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_4||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_5||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_6||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_7||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_8||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_9||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_10||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_11||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_12||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_13||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_14||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_15||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_16||c2_delimiter||c_delimiter||      --02/17/2016 Start 
       c2_delimiter||participant_char_17||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_18||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_19||c2_delimiter||c_delimiter||
       c2_delimiter||participant_char_20||c2_delimiter     --02/17/2016 End   
--select *
FROM
( select CASE WHEN row_num IS NULL THEN (ROWNUM+1)
                      ELSE  row_num END row_num,
                      rs.*
FROM 
(
SELECT
2 as row_num,
rcd.claim_number
,(select cms_name from temp_table_session where asset_code='picklist.claim.status.type.items' and cms_code=rcd.claim_status) as claim_status
,rcd.date_submitted
,CASE
     WHEN rcp.approver_user_id IS NULL THEN DECODE(rcd.claim_status,'closed','System',NULL)  --NULL  --01/16/2014
     ELSE rcp.approver_name                                 --09/13/2013 Bug fix #4398 --rcp.approver_last_name || ', ' || rcp.approver_first_name
  END Final_Approver     
,(select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) as promotion_name
,rcp.product_name
,rcp.product_category_name
,rcp.product_subcategory_name
,rcp.product_qty
,rcd.submitter_first_name
,rcd.submitter_middle_name
,rcd.submitter_last_name
,rcd.proxy_user_name
,submitter.user_name
,(select cms_name from temp_table_session where asset_code=c.cm_asset_code) as submitter_country                                
,rcd.node_name
,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=rcd.submitter_job_position) as job_title
,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=rcd.submitter_department) as department
,(SELECT COUNT(1) FROM user_node WHERE is_primary=1 AND node_id=rcd.node_id) as team_member_count
,(SELECT SUM(award_amount) FROM rpt_claim_detail WHERE node_id=rcd.node_id) as Team_member_total_points
,NVL (CASE WHEN rcd.claim_id IS NULL THEN award_amount ELSE rcd.submitter_points END, 0) as submitter_points --07/02/2015
,NVL (rcd.submitter_sweepstakes_won, 0) submitter_sweepstakes_won 
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) as Participant_Char_1
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) as Participant_Char_2
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) as Participant_Char_3
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) as Participant_Char_4
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) as Participant_Char_5
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) as Participant_Char_6
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) as Participant_Char_7
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) as Participant_Char_8
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) as Participant_Char_9
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) as Participant_Char_10
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) as Participant_Char_11
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) as Participant_Char_12
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) as Participant_Char_13
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) as Participant_Char_14
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) as Participant_Char_15
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as Participant_Char_16     --02/17/2016 Start
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as Participant_Char_17
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as Participant_Char_18
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as Participant_Char_19
,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as Participant_Char_20     --02/17/2016 End
  FROM rpt_claim_detail rcd,
       rpt_claim_product rcp,
       promotion p,
       application_user submitter,
       rpt_characteristic rch,
       country c
 WHERE     rcd.promotion_id = p.promotion_id
       AND rcd.claim_id = rcp.claim_id(+) --10/08/2014
       AND rcd.submitter_user_id = submitter.user_id
       AND rcd.submitter_user_id = rch.user_nt_id(+)
       AND rch.characteristic_type(+) = 'USER' --10/07/2014
       AND rcd.submitter_country_id = c.country_id
       AND p.promotion_status = NVL (p_in_promotion_status, p.promotion_status)
       AND (rcd.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL))
       AND rcd.claim_status = NVL (p_claim_status, rcd.claim_status)
       AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rcd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   where node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rcd.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rcd.submitter_user_id=p_paxid))
       AND rcd.submitter_pax_status =
              NVL (p_in_pax_status, rcd.submitter_pax_status)
       AND NVL(rcd.submitter_job_position,'job') =
              NVL (p_in_job_code, NVL(rcd.submitter_job_position,'job'))
       AND (rcd.submitter_department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND NVL (TRUNC (rcd.date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 1)
            OR (SubmittedType = 'haveNot' AND 1 = 2))     
       AND rcd.submitter_country_id = NVL(p_in_country_id,rcd.submitter_country_id)--05/13/2014  Bug 53312               
UNION ALL
SELECT NULL AS row_num
       ,NULL
       ,NULL
       ,rcd.date_submitted
       ,NULL   
       ,(select cms_name from temp_table_session where asset_code=p.promo_name_asset_code) 
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,rcd.submitter_first_name
       ,rcd.submitter_middle_name
       ,rcd.submitter_last_name
       ,rcd.proxy_user_name
       ,submitter.user_name
       ,(select cms_name from temp_table_session where asset_code=c.cm_asset_code)
       ,rcd.node_name
        ,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=rcd.submitter_job_position)
        ,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=rcd.submitter_department)
        ,(SELECT COUNT(1) FROM user_node WHERE is_primary=1 AND node_id=rcd.node_id)
        ,(SELECT SUM(award_amount) FROM rpt_claim_detail WHERE node_id=rcd.node_id)
        ,NVL (rcd.award_amount, 0)
        ,NVL (rcd.submitter_sweepstakes_won, 0)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15)
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as Participant_Char_16     --02/17/2016 Start
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as Participant_Char_17
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as Participant_Char_18
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as Participant_Char_19
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as Participant_Char_20     --02/17/2016 End
  FROM rpt_claim_detail rcd,      
       promotion p,
       application_user submitter,
       rpt_characteristic rch,
       country c
 WHERE     rcd.promotion_id = p.promotion_id       
       AND rcd.submitter_user_id = submitter.user_id
       AND rcd.submitter_user_id = rch.user_nt_id(+)
       AND rch.characteristic_type(+) = 'USER' --10/07/2014
       AND rcd.submitter_country_id = c.country_id
       AND p.promotion_status = NVL (p_in_promotion_status, p.promotion_status)
      AND (rcd.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL))
       AND rcd.claim_status IS NULL
     AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rcd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   where node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rcd.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rcd.submitter_user_id=p_paxid))
       AND rcd.submitter_pax_status =
              NVL (p_in_pax_status, rcd.submitter_pax_status)
       AND NVL(rcd.submitter_job_position,'job') =
              NVL (p_in_job_code, NVL(rcd.submitter_job_position,'job'))
       AND (rcd.submitter_department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND NVL (TRUNC (rcd.date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 1)
            OR (SubmittedType = 'haveNot' AND 1 = 2))
       AND rcd.submitter_country_id = NVL(p_in_country_id,rcd.submitter_country_id)--05/13/2014 Bug 53312                 
            UNION ALL
SELECT  NULL AS row_num--,(ROWNUM+1) as row_num
       ,NULL 
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,0
       ,au.first_name
       ,au.middle_name
       ,au.last_name
       ,NULL
       ,au.user_name
       ,(select cms_name from temp_table_session where asset_code=c.cm_asset_code) --04/01/2014
       ,pax.name
       ,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=vpe.position_type)  --04/01/2014
       ,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=vpe.department_type)  --04/01/2014
       ,0
       ,0
       ,0
       ,0       
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL        --02/17/2016 Start
       ,NULL
       ,NULL
       ,NULL
       ,NULL        --02/17/2016 End
  FROM application_user au,
       user_address ua,
       country c,
       vw_curr_pax_employer vpe,
       (SELECT DISTINCT r.participant_id, n.name
          FROM rpt_pax_promo_eligibility r,
               promo_product_claim pn,
               promotion promo,
               node n,
               participant p,
               vw_curr_pax_employer vpe
         WHERE     r.promotion_id = pn.promotion_id
               AND pn.promotion_id = promo.promotion_id
               AND r.node_id = n.node_id
               AND r.participant_id = p.user_id
               AND r.participant_id = vpe.user_id(+)
               AND r.giver_recvr_type = 'giver'
               AND NOT EXISTS
                          (SELECT 'X'
                             FROM rpt_claim_detail
                            WHERE submitter_user_id = r.participant_id
                                  AND node_id = r.node_id
                                  AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)
                                  )
               AND promo.promotion_status =
                      NVL (p_in_promotion_status, promo.promotion_status)              
              AND (r.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL))
               AND p.status = NVL (p_in_pax_status, p.status)
               AND NVL(vpe.position_type,'job') = NVL (p_in_job_code, NVL(vpe.position_type,'job'))
               AND (vpe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                      AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND r.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND r.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  p.user_id=p_paxid))) pax
 WHERE     au.user_id = ua.user_id
       AND ua.country_id = c.country_id
       AND au.user_id = pax.participant_id
       AND au.user_id = vpe.user_id(+)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 2)
            OR (SubmittedType = 'haveNot' AND 1 = 1))
              AND ua.country_id = NVL(p_in_country_id,ua.country_id)--05/13/2014 Bug 53312
UNION ALL--08/06/2014
SELECT   NULL AS row_num--(ROWNUM+1) 
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,0
,au.first_name
,au.middle_name
,au.last_name
,NULL
,au.user_name
,(select cms_name from temp_table_session where asset_code=c.cm_asset_code) --04/01/2014
,pax.name
,(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=vpe.position_type)  --04/01/2014
,(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=vpe.department_type)  --04/01/2014
,0
,0
,0
,0       
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL
,NULL        --02/17/2016 Start
,NULL
,NULL
,NULL
,NULL        --02/17/2016 End
  FROM application_user au,
       user_address ua,
       country c,
       vw_curr_pax_employer vpe,
       (SELECT  p.user_id participant_id, n.name
          FROM 
               node n,
               user_node un,
               participant p,
               rpt_participant_employer vpe
         WHERE un.user_id = p.user_id
               AND un.node_id = n.node_id
               AND p.status = 'active'              
              AND p.user_id = vpe.user_id(+)                            
               AND NOT EXISTS
                          (SELECT 'X'
                             FROM rpt_claim_detail r,
                             promotion promo
                            WHERE submitter_user_id = p.user_id
                                  AND node_id = n.node_id
                                  AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN 
       TO_DATE(p_in_from_date,v_pattern)
       AND
       TO_DATE(p_in_to_date,v_pattern)       
               AND promo.promotion_status =
                      NVL (p_in_promotion_status, promo.promotion_status)              
              AND (promo.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
           OR (p_in_promotion_id is NULL)))
               AND p.status = NVL (p_in_pax_status, p.status)
               AND NVL(vpe.position_type,'job') = NVL (p_in_job_code, NVL(vpe.position_type,'job'))
               AND (vpe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                      AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND n.node_id IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND n.node_id=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  p.user_id=p_paxid))) pax
 WHERE     au.user_id = ua.user_id
       AND ua.country_id = c.country_id
       AND au.user_id = pax.participant_id
       AND au.user_id = vpe.user_id(+)
       AND (   (NVL (SubmittedType, 'show_all') = 'show_all' AND 1 = 1)
            OR (SubmittedType = 'have' AND 1 = 2)
            OR (SubmittedType = 'haveNot' AND 1 = 1))
              AND ua.country_id = NVL(p_in_country_id,ua.country_id)
              )rs) order by submitter_last_name asc,submitter_first_name asc));

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019 
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;

    UTL_FILE.fclose(file_handler);
       
--start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_CLAIMS_EXTRACT',1,'ERROR',
        'Params: p_in_promotion_id'||': '||p_in_promotion_id||'p_paxid'||': '||p_paxid||'is_Team'||': '||is_Team||'parentNodeId'||': '||parentNodeId||  --07/16/2014 Bug # 54917
        'p_in_promotion_status'||': '||p_in_promotion_status||'p_in_pax_status'||': '||p_in_pax_status||'p_in_job_code'||': '||p_in_job_code||
        'p_claim_status'||': '||p_claim_status||'p_in_department'||': '||p_in_department||'p_in_from_date'||': '||p_in_from_date||   
        'p_in_to_date'||': '||p_in_to_date||'SubmittedType'||': '||SubmittedType||'locale'||': '||locale||   
        'p_in_country_id'||': '||p_in_country_id||'p_file_name'||': '||p_file_name||'p_header'||': '||p_header||CHR(10)||SQLERRM,null);   --02/25/2014
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_CLAIMS_EXTRACT;

PROCEDURE PRC_BADGE_EXTRACT
   (parentNodeId      IN VARCHAR2,    
    p_in_pax_status IN VARCHAR2,
    is_Team IN NUMBER,
    p_paxid       IN NUMBER,
    p_in_job_code     IN VARCHAR2,    
    p_in_department   IN VARCHAR2,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,
    p_in_promotion_id   IN VARCHAR2,     
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
   p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Participant Extract' for Admin.
-- Person          Date        Comments
-- ---------      ----------  -----------------------------------------------------
- nagarajs       01/12/2017        Rewritten query for G5.6.3.3 report changes   
- Gorantla       03/28/2018        G6-3990 Badge Activity Report Extract not pulling data for expired badges
--Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
       
   -- local variables
   l_cursor  SYS_REFCURSOR;    
    file_handler           UTL_FILE.file_type;
   v_extract        VARCHAR2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
     p_in_locale VARCHAR2(10):=locale;
     v_pattern    VARCHAR2(15);
   v_stage          VARCHAR2(1000);
   v_directory_name  all_directories.directory_name%TYPE;
BEGIN

DELETE FROM temp_table_session;
INSERT INTO temp_table_session
      SELECT asset_code,cms_value,key FROM mv_cms_asset_value WHERE key='COUNTRY_NAME' AND locale = p_in_locale 
      UNION
     SELECT asset_code,cms_value,key FROM mv_cms_asset_value WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p  )AND locale = p_in_locale
      UNION   
     SELECT asset_code,cms_name,cms_code FROM mv_cms_code_value E WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items') AND e.locale=p_in_locale ;

DELETE chacracteristics_cms;
INSERT INTO chacracteristics_cms
      SELECT c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,mv_cms_code_value vw where pl_name is not null and vw.asset_code = c.pl_name and locale = p_in_locale
UNION
      SELECT characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
       UNION
      SELECT characteristic_id,cms_name,cms_code from rpt_user_characteristic WHERE locale = p_in_locale;

-- stage input lists
   DELETE gtt_id_list;   
   pkg_report_common.p_stage_search_criteria(NVL(parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department, gc_search_all_values), gc_ref_text_department_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_job_code, gc_search_all_values), gc_ref_text_position_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id, gc_search_all_values), gc_ref_text_promotion_id, 1); 
   
BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header Textline
        FROM dual      
      UNION ALL
SELECT (ROWNUM+1),
               c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
               c2_delimiter||login_id||c2_delimiter||c_delimiter|| 
               c2_delimiter||first_name||c2_delimiter||c_delimiter||
               c2_delimiter||middle_name||c2_delimiter||c_delimiter||
               c2_delimiter||last_name||c2_delimiter||c_delimiter||
               c2_delimiter||country||c2_delimiter||c_delimiter||
               c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
               c2_delimiter||department||c2_delimiter||c_delimiter||
               c2_delimiter||job_title||c2_delimiter||c_delimiter||
               c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
               c2_delimiter||badge_name||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
               c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      
                                   c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
               c2_delimiter||pax_char20||c2_delimiter                                                      
          FROM ( SELECT * FROM ( 
                SELECT earned_date AS transaction_date,
                       rbd.user_first_name AS first_name,
                       rbd.user_middle_name AS middle_name,
                       rbd.user_last_name AS last_name,
                       rbd.login_id AS login_id,
                       (select cms_name from temp_table_session where asset_code=c.cm_asset_code) AS country, 
                       rbd.node_name AS primary_org_unit,
                       (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= rbd.position_type) AS job_title,  
                       (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= rbd.department) AS department, 
                       r.promotion_name, 
                       vw.cms_value AS badge_name, 
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
                       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as PAX_CHAR16,    
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as PAX_CHAR17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as PAX_CHAR18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as PAX_CHAR19,
                       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as PAX_CHAR20    
                         ,CASE
            WHEN REGEXP_COUNT (n.PATH, '/') = 1
            THEN
               n.name
            WHEN REGEXP_COUNT (n.PATH, '/') = 2
            THEN
               SUBSTR (n.PATH, 3, LENGTH (TRIM (n.PATH)))
            ELSE
               SUBSTR (n.PATH,3,INSTR (n.PATH,'/',1,3)-3)
                         END node_name_sort   
                         ,n.path  
  FROM rpt_badge_detail rbd,
       country c,
       rpt_characteristic rch,
                       (SELECT * FROM vw_cms_asset_value WHERE locale = p_in_locale and key = 'HTML_KEY') vw ,   
                        (SELECT r.rpt_badge_detail_id,          
                LISTAGG(cms_name , ' ,') WITHIN GROUP (ORDER BY cms_name) AS promotion_name
           FROM temp_table_session v,
                (SELECT rpt_badge_detail_id,
                        REGEXP_SUBSTR(promotion_name, '[^,]+', 1, LEVEL) promotion_name
                   FROM rpt_badge_detail 
                CONNECT BY LEVEL <= LENGTH(promotion_name) - LENGTH(REPLACE(promotion_name, ',')) + 1
                    AND rpt_badge_detail_id = PRIOR rpt_badge_detail_id 
                    AND PRIOR dbms_random.value IS NOT NULL ) r
        WHERE v.asset_code = r.promotion_name
       GROUP BY rpt_badge_detail_id) r
       ,node n
                       , promotion p                                
       , gtt_id_list gil_dt  -- department type
       , gtt_id_list gil_pt  -- position type
                       , gtt_id_list gil_p  -- promotion 
                 WHERE rbd.promotion_id = p.promotion_id 
                        AND rbd.rpt_badge_detail_id = r.rpt_badge_detail_id (+)
       AND rbd.participant_current_status =
              NVL (p_in_pax_status, rbd.participant_current_status)
       AND rch.user_nt_id(+) = rbd.user_id
       AND rbd.badge_name = vw.asset_code
       AND NVL(TRUNC(rbd.earned_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)      
       AND rbd.country_id = c.country_id
       AND n.node_id = rbd.node_id
                       AND gil_p.ref_text_1 = gc_ref_text_promotion_id 
       AND (  gil_p.ref_text_2 = gc_search_all_values
            OR gil_p.id = p.promotion_id )
       AND gil_dt.ref_text_1 = gc_ref_text_department_type
       AND (  gil_dt.ref_text_2 = gc_search_all_values
            OR gil_dt.ref_text_2 = rbd.department ) 
       AND gil_pt.ref_text_1 = gc_ref_text_position_type
       AND (  gil_pt.ref_text_2 = gc_search_all_values
            OR gil_pt.ref_text_2 = rbd.position_type ) 
       AND ((p_in_promotion_Id IS NULL AND p.promotion_status IN('live','expired')) 
                           OR (p_in_promotion_Id IS NOT NULL AND p.promotion_status IN ('live','expired'))) -- 03/28/2018   
        AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rbd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2,
                                               gtt_id_list gil_hr
                                                           WHERE gil_hr.ref_text_1 = gc_ref_text_parent_node_id    
                                                            AND gil_hr.id = N2.node_id ))
                             OR
                           (  is_Team=1 AND rbd.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rbd.user_id=p_paxid))  
             )order by node_name_sort asc,path asc 
                                                                          )
) ;
-- write result set to file
   IF (p_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 

      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
           UTL_FILE.put_line(file_handler, v_extract);
END LOOP;

    UTL_FILE.fclose(file_handler);
       
      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket; 
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_file_name IS NOT NULL
   
   p_out_return_code :=  '00' ;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_BADGE_EXTRACT',1,'ERROR',
        'parentNodeId'||': '||parentNodeId||'p_in_pax_status'||': '||p_in_pax_status||'is_Team'||': '||is_Team|| 
        'p_paxid'||': '||p_paxid||'p_in_job_code'||': '||p_in_job_code||'p_in_department'||': '||p_in_department||'p_in_from_date'||': '||
        p_in_from_date||'p_in_to_date'||': '||p_in_to_date||
        'locale '||': '||locale ||
        'p_file_name '||': '||p_file_name ||'p_header'||': '||p_header||CHR(10)||SQLERRM,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_BADGE_EXTRACT;

PROCEDURE PRC_POINT_BUDGET_SUMM_EXTRACT
( p_in_parentNodeId       IN VARCHAR,
  p_in_promotionId        IN VARCHAR,
  p_in_budgetStatus       IN VARCHAR,
  p_in_budgetDistribution IN VARCHAR,
  p_in_countryRatio       IN NUMBER,  
  p_in_locale             IN VARCHAR, 
  p_in_file_name          IN VARCHAR2,
  p_in_header             IN VARCHAR2,
  p_out_return_code       OUT VARCHAR2,
  p_out_result_set        OUT SYS_REFCURSOR
) IS
/********************************************************************************
 Purpose: This procedure queries the points budget summary extract result set and writes it to file when a file name specified.
  Date               Author           Description
  ----------       -------------      ------------------------------------------------
 12/15/2016         nagarajs          Initial Creation - G5.6.3.3 Budget Redesign
 08/10/2017         Gorantla          JIRA# G6-2800 - To pass list of promotion ids for shared distribution type.
 04/03/2017         Sherif Basha      Bug 72096 - Point Budget Balance Report - Budget Period Field drilling down ,records are not displaying correctly as per date range for Pax and node budget --12/04/2018 copied from ACYZ
 03/12/2019         Gorantla          G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/
   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_point_budget_summ_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_return_code           NUMBER;
   v_data_result_set       SYS_REFCURSOR;
   v_total_result_set      SYS_REFCURSOR;
   v_total_rec             NUMBER;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;

   
   -- build query ref cursor record type
   CURSOR cur_data_ref IS
   SELECT CAST(NULL AS VARCHAR2(2000)) AS promo_id,  --08/10/2017  JIRA# G6-2800
          CAST(NULL AS VARCHAR2(2000)) AS promo_name,
          CAST(NULL AS VARCHAR2(2000)) AS budget_master_name,
          CAST(NULL AS VARCHAR2(100)) AS budget_period,
          CAST(NULL AS NUMBER) AS original_budget,
          CAST(NULL AS NUMBER) AS budget_adjustments,
          CAST(NULL AS NUMBER) AS awarded,
          CAST(NULL AS NUMBER) AS available_balance,
          CAST(NULL AS NUMBER) AS budget_segment_id,   -- 04/03/2017   Bug 72096
          CAST(NULL AS NUMBER) AS total_records,
          CAST(NULL AS NUMBER) AS rec_seq
     FROM dual;

   rec_data_ref      cur_data_ref%ROWTYPE;

   -- in-line process
   PROCEDURE p_format_extract_rec
   ( p_in_rec_data_ref  IN cur_data_ref%ROWTYPE
   ) IS
   BEGIN
      gv_tab_file_extract.EXTEND;
      gv_tab_file_extract(gv_tab_file_extract.LAST).file_rec :=
            gc_fld_delimiter || p_in_rec_data_ref.promo_name           || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_master_name   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_period         || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.original_budget       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_adjustments     || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.awarded               || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.available_balance     || gc_fld_delimiter 
         ;
   END p_format_extract_rec;
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      || '<, p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_promotionId >' || p_in_promotionId
      || '<, p_in_budgetStatus >' || p_in_budgetStatus
      || '<, p_in_budgetDistribution >' || p_in_budgetDistribution
      || '<, p_in_countryRatio >' || p_in_countryRatio              
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

   -- get data as displayed on screen
   v_stage := 'call prc_getBalanceTabRes';
   pkg_query_point_budget_balance.prc_getBalanceTabRes
   ( p_in_locale,
     1000000,
     0,
     p_in_parentNodeId,
     p_in_promotionId,
     p_in_budgetStatus,
     p_in_budgetDistribution,
     p_in_countryRatio,  
     NULL,  -- p_in_sortColName
     NULL,  -- p_in_sortedBy
     v_return_code,
     v_data_result_set,
--     v_total_rec,
     v_total_result_set
   );

   IF (v_return_code != gc_return_code_success) THEN
      RAISE_APPLICATION_ERROR(-20100, 'Process call failed');
   END IF;

   -- initialize extract formatting
   v_stage := 'initialize extract formatting';
   gv_tab_file_extract := tab_file_extract();
   gv_tab_file_extract.EXTEND;
   gv_tab_file_extract(1).file_rec := p_in_header;

   -- format summary data for extract
   v_stage := 'FETCH v_data_result_set';
   LOOP
      FETCH v_data_result_set INTO rec_data_ref;
      EXIT WHEN (v_data_result_set%NOTFOUND); 
      p_format_extract_rec(rec_data_ref);
   END LOOP;

   IF (p_in_file_name IS NULL) THEN     
      -- return extract via output ref cursor
      v_stage := 'OPEN p_out_result_set';
      OPEN p_out_result_set FOR
      SELECT fr.file_rec AS textline
        FROM TABLE(fnc_pipe_file_records) fr;

   ELSE
      -- write result set to file
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      -- loop through file records
      FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
         UTL_FILE.put_line(file_handler, gv_tab_file_extract(indx).file_rec);           
      END LOOP;

      UTL_FILE.fclose(file_handler);
 --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;

END PRC_POINT_BUDGET_SUMM_EXTRACT;

PROCEDURE PRC_POINT_BUDGET_SMDTL_EXTRACT
( p_in_parentNodeId       IN VARCHAR,
  p_in_promotionId        IN VARCHAR,
  p_in_budgetStatus       IN VARCHAR,
  p_in_budgetDistribution IN VARCHAR,
  p_in_countryRatio       IN NUMBER,  
  p_in_locale             IN VARCHAR,  
  p_in_bud_seg_id         IN NUMBER,
  p_in_file_name          IN VARCHAR2,
  p_in_header             IN VARCHAR2,
  p_out_return_code       OUT VARCHAR2,
  p_out_result_set        OUT SYS_REFCURSOR
) IS
/********************************************************************************
 Purpose: This procedure queries the points budget summary detail extract result set and writes it to file when a file name specified.
  Date               Author           Description
  ----------       -------------      ------------------------------------------------
 12/15/2016         nagarajs          Initial Creation - G5.6.3.3 Budget Redesign
 04/03/2017         Sherif Basha      Bug 72096 - Point Budget Balance Report - Budget Period Field drilling down ,records are not displaying correctly as per date range for Pax and node budget
                                        (Added parameter p_in_bud_seg_id)
 04/05/2019 		Loganathan 		  Bug 78127 - Award amount on points budget balance report is not matching 
                           				with the award amount on Budget issuance report
 03/12/2019         Gorantla          G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/
   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_point_budget_smdtl_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_return_code           NUMBER;
   v_data_result_set       SYS_REFCURSOR;
   v_total_result_set      SYS_REFCURSOR;
   v_total_rec             NUMBER;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   v_localeDatePattern   VARCHAR2(50) := 'MM/DD/YYYY';
   v_from_date          DATE;
   v_to_date            DATE;

   -- build query ref cursor record type
   CURSOR cur_data_ref IS
   SELECT CAST(NULL AS VARCHAR2(4000)) AS budget_owner_name,
          CAST(NULL AS VARCHAR2(2000)) AS budget_master_name,
          CAST(NULL AS VARCHAR2(100)) AS budget_period,
          CAST(NULL AS NUMBER) AS original_budget,
          CAST(NULL AS NUMBER) AS budget_adjustments,
          CAST(NULL AS NUMBER) AS awarded,
          CAST(NULL AS NUMBER) AS available_balance,
          CAST(NULL AS NUMBER) AS total_records,
          CAST(NULL AS NUMBER) AS rec_seq
     FROM dual;

   rec_data_ref      cur_data_ref%ROWTYPE;

   -- in-line process
   PROCEDURE p_format_extract_rec
   ( p_in_rec_data_ref  IN cur_data_ref%ROWTYPE
   ) IS
   BEGIN
      gv_tab_file_extract.EXTEND;
      gv_tab_file_extract(gv_tab_file_extract.LAST).file_rec :=
            gc_fld_delimiter || p_in_rec_data_ref.budget_owner_name    || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_master_name   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_period        || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.original_budget      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_adjustments   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.awarded              || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.available_balance    || gc_fld_delimiter 
         ;
   END p_format_extract_rec;
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      || '<, p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_promotionId >' || p_in_promotionId
      || '<, p_in_budgetStatus >' || p_in_budgetStatus
      || '<, p_in_budgetDistribution >' || p_in_budgetDistribution
      || '<, p_in_countryRatio >' || p_in_countryRatio              
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

   -- get data as displayed on screen
   v_stage := 'call prc_getBalanceByPromoTabRes';
   pkg_query_point_budget_balance.prc_getBalanceByPromoTabRes
   ( p_in_locale,
     1000000,
     0,
     p_in_parentNodeId,
     p_in_promotionId,
     p_in_budgetStatus,
     p_in_budgetDistribution,
     p_in_countryRatio,  
     NULL,  -- p_in_sortColName
     NULL,  -- p_in_sortedBy
     p_in_bud_seg_id,  -- 04/03/2017 Bug 72096
     v_return_code,
     v_data_result_set,
--     v_total_rec,
     v_total_result_set
   );

   IF (v_return_code != gc_return_code_success) THEN
      RAISE_APPLICATION_ERROR(-20100, 'Process call failed');
   END IF;

   -- initialize extract formatting
   v_stage := 'initialize extract formatting';
   gv_tab_file_extract := tab_file_extract();
   gv_tab_file_extract.EXTEND;
   gv_tab_file_extract(1).file_rec := p_in_header;

   -- format summary data for extract
   v_stage := 'FETCH v_data_result_set';
   LOOP
      FETCH v_data_result_set INTO rec_data_ref;
      EXIT WHEN (v_data_result_set%NOTFOUND); 

      p_format_extract_rec(rec_data_ref);
   END LOOP;

   IF (p_in_file_name IS NULL) THEN     
      -- return extract via output ref cursor
      v_stage := 'OPEN p_out_result_set';
      OPEN p_out_result_set FOR
      SELECT fr.file_rec AS textline
        FROM TABLE(fnc_pipe_file_records) fr;

   ELSE
      -- write result set to file
 -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      -- loop through file records
      FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
         UTL_FILE.put_line(file_handler, gv_tab_file_extract(indx).file_rec);           
      END LOOP;

      UTL_FILE.fclose(file_handler);
   --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket; 
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019 
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;

END PRC_POINT_BUDGET_SMDTL_EXTRACT;

PROCEDURE PRC_POINT_BUDGET_ISSU_EXTRACT
   (  p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_countryRatio       IN NUMBER,  
      p_in_locale             IN VARCHAR,  
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
    )
   IS
/********************************************************************************
 Purpose: This procedure extract result set of point budget issuance and writes it to file when a file name specified.
  Date               Author           Description
  ----------       -------------      ------------------------------------------------
 12/15/2016         nagarajs           Initial Creation - G5.6.3.3 Budget Redesign
 02/01/2017         Suresh J           Bug 71040  - First and Last names should be separate columns 
 03/12/2019         Gorantla          G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   PRAGMA AUTONOMOUS_TRANSACTION;
   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   c_process_name           CONSTANT execution_log.process_name%TYPE := 'PRC_POINT_BUDGET_ISSU_EXTRACT';

   -- local variables
   v_budget_media_value    NUMBER(12,4);
   v_extract               VARCHAR2(4000);
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   v_locale                locale_date_pattern.locale%TYPE;
   v_pattern               locale_date_pattern.pattern%TYPE;
   
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      || '<, p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_promotionId >' || p_in_promotionId
      || '<, p_in_budgetStatus >' || p_in_budgetStatus
      || '<, p_in_budgetDistribution >' || p_in_budgetDistribution
      || '<, p_in_countryRatio >' || p_in_countryRatio              
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

  DELETE FROM temp_table_session;

  INSERT INTO temp_table_session
    SELECT asset_code,cms_value,key from mv_cms_asset_value where key IN ('COUNTRY_NAME','BUDGET_NAME') and locale = p_in_locale 
    UNION
    SELECT asset_code,cms_value,key FROM mv_cms_asset_value 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p)
AND locale = p_in_locale
    UNION 
SELECT asset_code,cms_name,cms_code
    FROM mv_cms_code_value E
WHERE asset_code in ( 'picklist.budgettype.items') and e.locale = p_in_locale;



DELETE chacracteristics_cms;

INSERT INTO chacracteristics_cms
    SELECT c.characteristic_id,vw.cms_name,vw.cms_code 
      FROM characteristic c,mv_cms_code_value vw 
     WHERE pl_name is not null 
       AND vw.asset_code = c.pl_name and locale = p_in_locale
UNION
    SELECT characteristic_id,characteristic_value cms_name,characteristic_value cms_code 
      FROM user_characteristic 
     WHERE characteristic_id in (select characteristic_id from characteristic where pl_name is null)
     UNION
    SELECT characteristic_id,cms_name,cms_code 
      FROM rpt_user_characteristic
WHERE locale = p_in_locale;

   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(p_in_parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_budgetStatus, gc_search_all_values), gc_ref_text_budget_status, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotionId, gc_search_all_values), gc_ref_text_promotion_id, 1);
   
BEGIN
    SELECT pattern 
      INTO v_pattern 
      FROM locale_date_pattern 
     WHERE locale=p_in_locale;
  EXCEPTION 
    WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

  BEGIN                                                                  
     SELECT (budget_media_value / p_in_countryRatio)
      INTO v_budget_media_value  
      FROM country c      
     WHERE c.cm_asset_code ='country_data.country.usa';                       
  END;        

OPEN p_out_result_set FOR    
    -- format the extract record
    SELECT p_in_header AS textline
        FROM dual
     UNION ALL 
    SELECT c2_delimiter||budget_master_name||c2_delimiter||c_delimiter||
           c2_delimiter||budget_type||c2_delimiter||c_delimiter||
           c2_delimiter||budget_owner||c2_delimiter||c_delimiter||
           c2_delimiter||award_date||c2_delimiter||c_delimiter||
           --c2_delimiter||recipient_name||c2_delimiter||c_delimiter||          --02/01/2017
           c2_delimiter||recipient_first_name||c2_delimiter||c_delimiter||      --02/01/2017     
           c2_delimiter||recipient_last_name ||c2_delimiter||c_delimiter||      --02/01/2017     
           c2_delimiter||recvr_country||c2_delimiter||c_delimiter||
           c2_delimiter||award_amount||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
           c2_delimiter||recvr_org_unit||c2_delimiter||c_delimiter||  
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
           c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      
                                   c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
           c2_delimiter||pax_char20||c2_delimiter    
      FROM ( SELECT  (SELECT cms_name FROM temp_table_session WHERE asset_code=bm.cm_asset_code) AS budget_master_name,
                     (SELECT cms_name FROM temp_table_session WHERE asset_code='picklist.budgettype.items' AND cms_code=bm.budget_type) AS budget_type,       
                     DECODE (bm.budget_type,'pax', au.last_name || ' , ' || au.first_name, n.name) AS budget_owner,
                     TRUNC (rad.trans_date) AS award_date,
                     rad.recipient_name AS recipient_name,
                     rad.recipient_first_name,     --02/01/2017
                     rad.recipient_last_name,      --02/01/2017     
                     (SELECT cms_name FROM temp_table_session WHERE asset_code=c.cm_asset_code) AS recvr_country, 
                     --ROUND(rad.trans_amount * v_budget_media_value, 2) AS award_amount,--04/05/2019 Bug 78127
                     ROUND(rad.trans_amount * v_budget_media_value, 0) AS award_amount,--04/05/2019 Bug 78127
                     (SELECT cms_name FROM temp_table_session WHERE asset_code = p.promo_name_asset_code) AS promotion_name, 
                     (SELECT node_name FROM rpt_hierarchy WHERE node_id = un.node_id) AS recvr_org_unit,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id1 AND cms_code=rch.characteristic_charvalue1) AS pax_char1,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id2 AND cms_code=rch.characteristic_charvalue2) AS pax_char2,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id3 AND cms_code=rch.characteristic_charvalue3) AS pax_char3,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id4 AND cms_code=rch.characteristic_charvalue4) AS pax_char4,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id5 AND cms_code=rch.characteristic_charvalue5) AS pax_char5,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id6 AND cms_code=rch.characteristic_charvalue6) AS pax_char6,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id7 AND cms_code=rch.characteristic_charvalue7) AS pax_char7,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id8 AND cms_code=rch.characteristic_charvalue8) AS pax_char8,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id9 AND cms_code=rch.characteristic_charvalue9) AS pax_char9,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id10 AND cms_code=rch.characteristic_charvalue10) AS pax_char10,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id11 AND cms_code=rch.characteristic_charvalue11) AS pax_char11,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id12 AND cms_code=rch.characteristic_charvalue12) AS pax_char12,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id13 AND cms_code=rch.characteristic_charvalue13) AS pax_char13,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id14 AND cms_code=rch.characteristic_charvalue14) AS pax_char14,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id15 AND cms_code=rch.characteristic_charvalue15) AS pax_char15,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id16 AND cms_code=rch.characteristic_charvalue16) AS pax_char16,    
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id17 AND cms_code=rch.characteristic_charvalue17) AS pax_char17,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id18 AND cms_code=rch.characteristic_charvalue18) AS pax_char18,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id19 AND cms_code=rch.characteristic_charvalue19) AS pax_char19,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id20 AND cms_code=rch.characteristic_charvalue20) AS pax_char20     
    FROM rpt_budget_trans_detail rad,
         promotion p,
         budget_master bm,
         budget b,
         application_user au,
         user_node un,
         rpt_characteristic rch,        
         node n,
                     country c,
                     rpt_hierarchy_rollup hr,
                     gtt_id_list gil_hr, -- hierarchy rollup
                     gtt_id_list gil_b,  -- budget status
                     gtt_id_list gil_p  -- promotion
   WHERE     rad.promotion_id = p.promotion_id(+)
                 AND ((p_in_promotionId IS NULL AND p.promotion_status IN('live','expired')) 
                      OR (p_in_promotionId IS NOT NULL AND p.promotion_status = 'live'))
         AND rad.budget_master_id = bm.budget_master_id
                 AND bm.multi_promotion = NVL ( DECODE (p_in_budgetdistribution,'one_to_one', 0, 'shared', 1, NULL),bm.multi_promotion)
         AND rad.budget_id = b.budget_id
                 AND gil_hr.ref_text_1 = gc_ref_text_parent_node_id
                 AND gil_hr.id = hr.node_id (+)
                 AND hr.child_node_id = un.node_id(+)
                 AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                 AND (  gil_p.ref_text_2 = gc_search_all_values
                        OR gil_p.id = p.promotion_id )
                 AND gil_b.ref_text_1 = gc_ref_text_budget_status
                 AND (  gil_b.ref_text_2 = gc_search_all_values
                        OR gil_b.ref_text_2 = rad.budget_status )
                 AND un.is_primary = 1   
         AND b.user_id = au.user_id(+)
         AND rch.user_nt_id(+) = au.user_id       
         AND rad.recipient_user_id = un.user_id
         AND b.node_id = n.node_id(+)
         AND rad.recipient_country_id = c.country_id
            ORDER BY budget_master_name,
                     budget_type,
                     budget_owner,
                     recipient_name
) ;
  
-- write result set to file
   IF (p_in_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 

      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
           UTL_FILE.put_line(file_handler, v_extract);           
END LOOP;

    UTL_FILE.fclose(file_handler);
--start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := '00';

   COMMIT;  -- release DML locks on temp table
EXCEPTION
    WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, 1, 'ERROR', v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := '99';
      IF UTL_FILE.is_open(file_handler) THEN 
          UTL_FILE.fclose(file_handler);
        END IF;

        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_POINT_BUDGET_ISSU_EXTRACT;

PROCEDURE PRC_AWARDS_EXTRACT
    ( 
    p_in_promotion_id       IN VARCHAR2,
    p_in_award_type         IN VARCHAR,     --05/05/2016    
    p_paxid                 IN NUMBER,
    is_Team                 IN NUMBER,
    parentNodeId            IN VARCHAR2,   
    p_in_country_Ids        IN VARCHAR2,
    p_in_promotion_status   IN VARCHAR2,  
    p_in_pax_status         IN VARCHAR2,
    p_in_job_code           IN VARCHAR2,
    p_in_department         IN VARCHAR2,
    p_in_from_date          IN VARCHAR2,
    p_in_to_date            IN VARCHAR2,
    receivedAwardType       IN VARCHAR2,   
    IsOnTheSpotIncluded     VARCHAR2,
    locale                  IN VARCHAR2,
    p_file_name             IN VARCHAR2,
    p_header                IN VARCHAR2,
    p_out_return_code       OUT varchar2,
    p_out_result_set        OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Participant Extract' for Admin.
-- Person              Date         Comments
-- ---------        ----------     -----------------------------------------------------
-- Ravi Dhanekula   12/28/2012      Initial Version  
                    01/16/2014      Fixed the bug # 51118
                    04/15/2014      Added lookup from CM for the 'OnTheSpot' promo name.
-- Swati            05/29/2014      Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated  
-- nagarajs         07/16/2014      Bug # 54917 - close the file and include parms value when OTHER exception     
-- Swati            08/19/2014      Bug 55855 - Awards received Reports - List of recipients: Promotion name is not showing up in report extract                             
-- nagarajs         08/28/2014      Bug 55859 - Awards Received - List of Recipients: OTS serial number in the extract is not correct.
-- Swati            09/16/2014      Bug 56594 - In The Award report extract change the short form display.
-- Suresh J         09/25/2014      Bug Fix 56601 - Excluded OnTheSpot points and counts when Promotion Status is INACTIVE.
--Suresh J          01/02/2015      Bug Fix 58886 -Promotion Name should display instead of Badge Name in Promotion name column
                    01/12/2015     Reverted the above bug fix as badge setup name is also a promotion name.
--Suresh J          05/12/2015     SSI Award Activity CR Changes  
--Suresh J          07/02/2015     Bug 63062 - Excel is blank when selected Have NOT Received Awards option     
--Suresh J          07/22/2015     Bug 63093 - Report shows wrong other value for DTGT contest      
--Suresh J          08/14/2015     Bug 63634 - Promotion Status = Inactive in SSI not fetching any result   
--nagarajs          09/30/2015     G5E-22 - Remove Points, On the spot Deposits ,Sweepstakes column if plateau.platform.only enabled  
--nagarajs          10/29/2015     Bug 64502 - Report: Awards Received - List of Recipients - Report export values are not matching with summary table values             
--nagarajs          11/13/2015     Bug 64662 - PRC_AWARDS_EXTRACT execution_log - needs to be removed
--nagarajs          11/26/2015     Bug 64819 - Points column value not showing in Extracts
--nagarajs          01/08/2016     Bug 65135] 'Awards Received - List of Recipients' rpt- summary and extract points not matching
--nagarajs          03/03/2016     Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--Suresh J          05/05/2016     New Nomination Report Changes
--nagarajs          10/05/2016     New Nomination Report Changes
--Sherif Basha      10/18/2016     Bug 69570  p_in_award_type is passsed as "merchandise" since the nomination changes.
--Suresh J          02/03/2017     Bug 71268 - Awards Received - List of Participants Report Extract
--Suresh J          03/09/2017     G6-1896 - Extract showing HTML tags
--Suresh J          03/13/2017     G6-1959  Extract contains records of PAX who have not received any awards. 
--Suresh J          03/14/2017     G6-1968  Extract contains other payout type pax when filtered for points only.
--Chidamba          03/07/2018     G6-3432 Changes to the Report due to OTS cards Enhancement
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter          CONSTANT VARCHAR2(1)  := ',' ;
   c2_delimiter         CONSTANT VARCHAR2(1)  := '"' ;
   c_award_type_points  CONSTANT VARCHAR2(10) := 'points';
   c_award_type_cash    CONSTANT VARCHAR2(10) := 'cash';
   c_award_type_other   CONSTANT VARCHAR2(10) := 'other';
   c_award_type_plateau CONSTANT VARCHAR2(15) := 'merchandise';  -- Bug 69570  10/18/2016
             
   
   p_in_locale VARCHAR2(10):=locale;
   file_handler           UTL_FILE.file_type;
   v_extract varchar2(4000);
   v_file_location VARCHAR2(1000);
   directory_error exception;    
   l_cursor  SYS_REFCURSOR;
   v_pattern    VARCHAR2(15);
   v_plateau_enable  NUMBER(1); --09/30/2015
   
   -- local variables
BEGIN

--    prc_execution_log_entry('PRC_AWARDS_EXTRACT',1,'INFO',p_in_award_type||':'||'~p_in_award_type~'||p_in_promotion_id||': '||'p_in_promotion_id'||p_paxid ||': '||'p_paxid '||is_Team ||': '||'is_Team '|| --07/16/2014 Bug # 54917
--    parentNodeId||': '||'parentNodeId'||p_in_country_Ids||': '||'p_in_country_Ids'||p_in_promotion_status||': '||'p_in_promotion_status'||
--    p_in_pax_status||': '||'p_in_pax_status'||p_in_job_code ||': '||'p_in_job_code '||p_in_department||': '||'p_in_department'||
--    p_in_from_date||': '||'p_in_from_date'||p_in_to_date||': '||'p_in_to_date'||receivedAwardType||': '||'receivedAwardType'||
--    IsOnTheSpotIncluded ||': '||'IsOnTheSpotIncluded '||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null); --02/25/2014        

    DELETE temp_table_session;

    INSERT INTO temp_table_session
    SELECT asset_code, cms_value, key
      FROM mv_cms_asset_value
     WHERE key IN ( 'COUNTRY_NAME','PAYOUT_DESCRIPTION_') AND locale = p_in_locale --10/05/2016
    UNION ALL
    SELECT asset_code, cms_value, key
      FROM mv_cms_asset_value
     WHERE     key = 'ONTHESPOT'
           AND asset_code = 'report.awards.participant'
           AND locale = p_in_locale
    UNION                                                  -- 08/18/2014 Bug 55855
    SELECT asset_code, cms_value, key
      FROM mv_cms_asset_value
     WHERE     asset_code IN (SELECT promo_name_asset_code FROM promotion)
           AND locale = p_in_locale
    UNION                                                   --09/16/2014 Bug 56594
    SELECT asset_code, cms_name, cms_code
      FROM mv_cms_code_value E
     WHERE     asset_code IN ('picklist.department.type.items',
                              'picklist.positiontype.items')
           AND e.locale = p_in_locale
    UNION ALL                                                         --05/12/2015
    SELECT asset_code, cms_value, key
      FROM mv_cms_asset_value
     WHERE key IN ('CONTEST_NAME', 'SSI_CONTEST') AND locale = p_in_locale
    UNION ALL                                                         --05/12/2015
    SELECT asset_code, cms_value, key
      FROM mv_cms_asset_value
     WHERE key = 'LEVEL_NAME'
           AND locale = p_in_locale
    UNION ALL
    SELECT asset_code, cms_value, key  --03/07/2018 new OTS
      FROM mv_cms_asset_value
     WHERE key = 'OTS_BATCH_NAME_'
           AND locale = p_in_locale;
  
                                           
    DELETE chacracteristics_cms;
    INSERT INTO chacracteristics_cms
       SELECT c.characteristic_id, vw.cms_name, vw.cms_code
         FROM characteristic c, mv_cms_code_value vw
        WHERE     pl_name IS NOT NULL
              AND vw.asset_code = c.pl_name
              AND locale = p_in_locale
       UNION                                                         --Bug # 50969
       SELECT characteristic_id,
              characteristic_value cms_name,
              characteristic_value cms_code
         FROM user_characteristic
        WHERE characteristic_id IN (SELECT characteristic_id
                                      FROM characteristic
                                     WHERE pl_name IS NULL)
       UNION
       SELECT characteristic_id, cms_name, cms_code
         FROM rpt_user_characteristic
        WHERE locale = p_in_locale;
    BEGIN
    SELECT pattern
      INTO v_pattern
      FROM locale_date_pattern
     WHERE locale = p_in_locale;    EXCEPTION WHEN no_data_found THEN 
        v_pattern :='MM/DD/YYYY';
    END;
 
    BEGIN  --09/30/2015
    SELECT boolean_val
      INTO v_plateau_enable
      FROM os_propertyset
     WHERE entity_name = 'drive.enabled';
    EXCEPTION WHEN no_data_found THEN 
    v_plateau_enable := 0;
    END;

IF p_file_name IS NULL THEN 
         
OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header    
         Textline
        FROM dual
       UNION ALL   --12/18/2014
       SELECT (ROWNUM+1),
         CASE WHEN p_in_award_type = c_award_type_points THEN 
         
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||            --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
             CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||points_received_cnt||c2_delimiter||c_delimiter ELSE NULL END|| --09/30/2015 --11/26/2015
             --c2_delimiter||plateau_earned_cnt||c2_delimiter||c_delimiter||
             CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||sweepstakes_won_cnt||c2_delimiter||c_delimiter ELSE NULL END|| --09/30/2015  --11/26/2015
             CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||on_the_spot_serial||c2_delimiter||c_delimiter ELSE NULL END||  --09/30/2015  --11/26/2015
             --c2_delimiter||other||c2_delimiter||c_delimiter||   --05/12/2015
             --c2_delimiter||other_value||c2_delimiter||c_delimiter||   --05/12/2015                  
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        WHEN p_in_award_type = c_award_type_cash THEN 
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||        --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
             c2_delimiter||cash_received_cnt||c2_delimiter||c_delimiter||      --05/05/2016
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        WHEN p_in_award_type = c_award_type_other THEN 
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||            --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
             c2_delimiter||other||c2_delimiter||c_delimiter||   
             c2_delimiter||other_value||c2_delimiter||c_delimiter||                     
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        
        WHEN p_in_award_type = c_award_type_plateau THEN
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||        --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
--             c2_delimiter||plateau_earned_cnt||c2_delimiter||c_delimiter||
             c2_delimiter||level_name||c2_delimiter||c_delimiter||    --05/05/2016             
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        END textline
        FROM 
(SELECT rad.journal_id transaction_id,
       rad.media_date transaction_date,
       rad.pax_first_name first_name,
       rad.pax_middle_name middle_name,
       rad.pax_last_name last_name,
       au.user_name login_id,
   (select cms_name from temp_table_session where asset_code=c.cm_asset_code) country,
       rh.node_name primary_org_unit,
       rad.position_type job_position,
       rad.department department,
       rad.promotion_type,
       --rad.promotion_name,
       --(select cms_name from temp_table_session where asset_code = 'report.awards.participant') AS promotion_name, --05/29/2014 Bug # 53480  
       (select cms_name from temp_table_session where asset_code=p.promo_name_asset_code) AS promotion_name, --08/18/2014 Bug 55855   --01/12/2015
       DECODE (rad.is_taxable,  1, 'Y',  0, 'N') taxable,
       --NVL (rad.media_amount, 0) points_received_cnt,     --05/05/2016
          CASE 
            WHEN rad.award_payout_type <> 'cash' 
                THEN NVL (rad.media_amount, 0) 
            ELSE 0    
          END AS points_received_cnt,                       --05/05/2016
       NVL (rad.plateau_earned, 0) plateau_earned_cnt,
       NVL (rad.sweepstakes_won, 0) sweepstakes_won_cnt,
       NULL AS on_the_spot_serial,
       (select cms_name from temp_table_session where asset_code=rad.asset_key_level_name) other,  --05/12/2015 --10/05/2016
       rad.media_amount other_value,  --05/12/2015 --10/05/2016
          CASE 
             WHEN rad.award_payout_type = 'cash' 
                THEN NVL (rad.media_amount, 0) 
              ELSE 0   
            END AS cash_received_cnt,    --05/05/2016
       (select t.cms_name as level_name 
        from temp_table_session t 
        where t.asset_code=rad.asset_key_level_name 
              AND t.cms_code = 'LEVEL_NAME') as level_name,     --05/05/2016     
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
  FROM rpt_awardmedia_detail rad,
       application_user au,
       rpt_hierarchy rh,
       rpt_characteristic rch,
       promotion p,
       country c
WHERE     
        au.user_id(+) = rad.user_id
       AND rad.award_payout_type = NVL(p_in_award_type, award_payout_type) --10/05/2016
       AND rh.node_id = rad.node_id
       AND rch.user_nt_id(+) = rad.user_id
       AND rch.characteristic_type (+) = 'USER' --01/08/2016
       AND p.promotion_id = rad.promotion_id
       AND rad.country_id = c.country_id
       AND NVL(rad.position_type,'job') = NVL (p_in_job_code, NVL(rad.position_type,'job'))       
       AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
        AND (rad.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
       AND p.promotion_status = NVL (p_in_promotion_status, p.promotion_status)
       AND rad.participant_current_status =
              NVL (p_in_pax_status, rad.participant_current_status)
             AND (rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id))) OR (p_in_promotion_id is NULL))
             AND NVL (TRUNC (rad.media_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
             AND (  ( (p_paxid IS NULL OR p_paxid = 0)                                                                 
        AND (            
                 (NVL(is_Team,0)=0 AND rad.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rad.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND p_paxid <> 0 AND rad.user_id=p_paxid))   
        --       AND (   (NVL (receivedAwardType, 'show_all') = 'show_all' AND 1 = 1)    --03/13/2017
        --            OR (receivedAwardType = 'received' AND 1 = 1)
        --            OR (receivedAwardType = 'notReceived' AND 1 = 2))      
       AND NOT EXISTS (select j2.journal_id from rpt_ssi_award_detail j2 where j2.journal_id = rad.journal_id)  --05/12/2015                  
UNION ALL
SELECT rad.journal_id transaction_id,
       rad.trans_date transaction_date,
       rad.user_first_name first_name,
       au.middle_name middle_name,
       rad.user_last_name last_name,
       au.user_name login_id,
         (select cms_name from temp_table_session where asset_code = c.cm_asset_code) country,
       rh.node_name primary_org_unit,
       rad.position_type job_position,
       rad.department department,
       (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT') AS promotion_type, --04/15/2014   --03/09/2017
       CASE WHEN rad.batch_description IS NULL THEN 
       (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT')   --03/09/2017
       WHEN rad.batch_description like '%'||gc_str_token THEN REPLACE(rad.batch_description,gc_str_token)                      --03/07/2018 
       ELSE (SELECT t.cms_name FROM temp_table_session t WHERE t.asset_code=rad.batch_description) END   AS PROMOTION_NAME,  --03/07/2018   added case           
       'Y' AS taxable,
       rad.transaction_amount points_received_cnt,
       0 plateau_earned_cnt,
       0 sweepstakes_won_cnt,
       '#'||cert_num AS on_the_spot_serial, --08/28/2014 Added #
       NULL AS other,  --05/12/2015  --10/05/2016
       0 other_value,  --05/12/2015
       0 AS cash_received_cnt,    --05/05/2016
       NULL AS level_name,        --05/05/2016
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
  FROM rpt_qcard_detail rad,
       application_user au,
       rpt_hierarchy rh,
       rpt_characteristic rch,
       country c
WHERE     au.user_id(+) = rad.user_id
       AND rh.node_id = rad.node_id
       AND rch.user_nt_id(+) = rad.user_id
       AND rch.characteristic_type (+) = 'USER' --01/08/2016
       AND rad.country_id = c.country_id
       AND 'Y' = IsOnTheSpotIncluded
       AND NVL(p_in_promotion_status,'showall') in ('showall','live')   --09/25/2014
       AND NVL(rad.position_type,'job') = NVL (p_in_job_code, NVL(rad.position_type,'job'))
       AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND (rad.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
       AND NVL (TRUNC (rad.trans_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
        AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rad.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rad.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rad.user_id=p_paxid))
        --       AND (   (NVL (receivedAwardType, 'show_all') = 'show_all' AND 1 = 1)          --03/13/2017
        --            OR (receivedAwardType = 'received' AND 1 = 1)
        --            OR (receivedAwardType = 'notReceived' AND 1 = 2))            
--05/12/2015
UNION ALL
SELECT rad.journal_id transaction_id,
       rad.payout_issue_date transaction_date,
       rad.pax_first_name first_name,
       au.middle_name middle_name,
       rad.pax_last_name last_name,
       au.user_name login_id,
         (select cms_name from temp_table_session where asset_code = c.cm_asset_code) country,
       rh.node_name primary_org_unit,
       rad.position_type job_position,
       rad.department department,
       (select cms_name from temp_table_session where cms_code='SSI_CONTEST' AND asset_code = 'profile.proxies.tab') AS promotion_type, --05/12/2015
       (select cms_name from temp_table_session where cms_code='CONTEST_NAME' AND asset_code = rad.ssi_contest_name) AS promotion_name,  --05/12/2015
       'Y' AS taxable,
       CASE WHEN rad.payout_type <> 'other' THEN rad.payout_amount ELSE 0 END points_received_cnt,
       0 plateau_earned_cnt,
       0 sweepstakes_won_cnt,
       NULL AS on_the_spot_serial, --08/28/2014 Added #
       CASE WHEN rad.payout_type = 'other' THEN TO_CHAR(rad.other) ELSE NULL END other,    --07/22/2015  --10/05/2016
       CASE WHEN rad.payout_type = 'other' THEN rad.payout_amount ELSE 0 END other_value,
       0 AS cash_received_cnt,    --05/05/2016
       NULL AS level_name,        --05/05/2016
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
  FROM rpt_ssi_award_detail rad,
       application_user au,
       rpt_hierarchy rh,
       rpt_characteristic rch,
       country c,
       participant p
       ,promotion promo   --08/14/2015
WHERE  rad.payout_type =  NVL(p_in_award_type,rad.payout_type)   --03/14/2017
       AND au.user_id(+) = rad.user_id
       AND rh.node_id = rad.node_id
       AND rch.user_nt_id(+) = rad.user_id
       AND rch.characteristic_type (+) = 'USER'  --01/08/2016
       AND p.user_id (+) = rad.user_id
       AND rad.country_id = c.country_id
       AND promo.promotion_id = rad.promotion_id  --08/14/2015
--       AND NVL(p_in_promotion_status,'showall') in ('showall','live')    --08/14/2015     
       AND promo.promotion_status = NVL (p_in_promotion_status, promo.promotion_status)   --08/14/2015       
       AND NVL(p.status,'showall') = NVL (p_in_pax_status, NVL(p.status,'showall'))  --05/12/2015
       AND NVL(rad.position_type,'job') = NVL (p_in_job_code, NVL(rad.position_type,'job'))
      AND (rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id))) OR (p_in_promotion_id is NULL))        --05/12/2015
       AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND (rad.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
       AND NVL (TRUNC (rad.payout_issue_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
        AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rad.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rad.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rad.user_id=p_paxid))
        --       AND (   (NVL (receivedAwardType, 'show_all') = 'show_all' AND 1 = 1)
        --            OR (receivedAwardType = 'received' AND 1 = 1)
        --            OR (receivedAwardType = 'notReceived' AND 1 = 2))            
            ) ex   --12/18/2014
) ;
p_out_return_code :=  '00' ;
  

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
OPEN l_cursor FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header    
         Textline
        FROM dual
       UNION ALL   --12/18/2014
       SELECT (ROWNUM+1),
         CASE WHEN p_in_award_type = c_award_type_points THEN 
         
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||            --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
             CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||points_received_cnt||c2_delimiter||c_delimiter ELSE NULL END|| --09/30/2015 --11/26/2015
             --c2_delimiter||plateau_earned_cnt||c2_delimiter||c_delimiter||
             CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||sweepstakes_won_cnt||c2_delimiter||c_delimiter ELSE NULL END|| --09/30/2015  --11/26/2015
             CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||on_the_spot_serial||c2_delimiter||c_delimiter ELSE NULL END||  --09/30/2015  --11/26/2015
             --c2_delimiter||other||c2_delimiter||c_delimiter||   --05/12/2015
             --c2_delimiter||other_value||c2_delimiter||c_delimiter||   --05/12/2015                  
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        WHEN p_in_award_type = c_award_type_cash THEN 
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||        --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
             c2_delimiter||cash_received_cnt||c2_delimiter||c_delimiter||      --05/05/2016
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        WHEN p_in_award_type = c_award_type_other THEN 
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||            --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
             c2_delimiter||other||c2_delimiter||c_delimiter||   
             c2_delimiter||other_value||c2_delimiter||c_delimiter||                     
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        
        WHEN p_in_award_type = c_award_type_plateau THEN
             c2_delimiter||transaction_id||c2_delimiter||c_delimiter||
             c2_delimiter||transaction_date||c2_delimiter||c_delimiter||
             c2_delimiter||login_id||c2_delimiter||c_delimiter||        --02/03/2017
             c2_delimiter||first_name||c2_delimiter||c_delimiter||
             c2_delimiter||middle_name||c2_delimiter||c_delimiter||
             c2_delimiter||last_name||c2_delimiter||c_delimiter||
             c2_delimiter||country||c2_delimiter||c_delimiter||
             c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                                cms_code= ex.department)||c2_delimiter||c_delimiter||
             c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and -- 09/16/2014 Bug 56594
                                                                                cms_code= ex.job_position)||c2_delimiter||c_delimiter||
             c2_delimiter||CASE WHEN promotion_type = 'SSI Contest' THEN promotion_type ELSE INITCAP(promotion_type) END||c2_delimiter||c_delimiter||   --05/12/2015 
             c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
             c2_delimiter||taxable||c2_delimiter||c_delimiter||
--             c2_delimiter||plateau_earned_cnt||c2_delimiter||c_delimiter||
             c2_delimiter||level_name||c2_delimiter||c_delimiter||    --05/05/2016             
             c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
             c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
             c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        END textline
        FROM 
(SELECT rad.journal_id transaction_id,
       rad.media_date transaction_date,
       rad.pax_first_name first_name,
       rad.pax_middle_name middle_name,
       rad.pax_last_name last_name,
       au.user_name login_id,
   (select cms_name from temp_table_session where asset_code=c.cm_asset_code) country,
       rh.node_name primary_org_unit,
       rad.position_type job_position,
       rad.department department,
       rad.promotion_type,
       --rad.promotion_name,
       --(select cms_name from temp_table_session where asset_code = 'report.awards.participant') AS promotion_name, --05/29/2014 Bug # 53480  
       (select cms_name from temp_table_session where asset_code=p.promo_name_asset_code) AS promotion_name, --08/18/2014 Bug 55855   --01/12/2015
       DECODE (rad.is_taxable,  1, 'Y',  0, 'N') taxable,
       --NVL (rad.media_amount, 0) points_received_cnt,     --05/05/2016
          CASE 
            WHEN rad.award_payout_type <> 'cash' 
                THEN NVL (rad.media_amount, 0) 
            ELSE 0    
          END AS points_received_cnt,                       --05/05/2016
       NVL (rad.plateau_earned, 0) plateau_earned_cnt,
       NVL (rad.sweepstakes_won, 0) sweepstakes_won_cnt,
       NULL AS on_the_spot_serial,
       (select cms_name from temp_table_session where asset_code=rad.asset_key_level_name) other,  --05/12/2015 --10/05/2016
       rad.media_amount other_value,  --05/12/2015 --10/05/2016
          CASE 
             WHEN rad.award_payout_type = 'cash' 
                THEN NVL (rad.media_amount, 0) 
              ELSE 0   
            END AS cash_received_cnt,    --05/05/2016
       (select t.cms_name as level_name 
        from temp_table_session t 
        where t.asset_code=rad.asset_key_level_name 
              AND t.cms_code = 'LEVEL_NAME') as level_name,     --05/05/2016     
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
  FROM rpt_awardmedia_detail rad,
       application_user au,
       rpt_hierarchy rh,
       rpt_characteristic rch,
       promotion p,
       country c
WHERE     
        au.user_id(+) = rad.user_id
       AND rad.award_payout_type = NVL(p_in_award_type, award_payout_type) --10/05/2016
       AND rh.node_id = rad.node_id
       AND rch.user_nt_id(+) = rad.user_id
       AND rch.characteristic_type (+) = 'USER' --01/08/2016
       AND p.promotion_id = rad.promotion_id
       AND rad.country_id = c.country_id
       AND NVL(rad.position_type,'job') = NVL (p_in_job_code, NVL(rad.position_type,'job'))       
       AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
        AND (rad.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
       AND p.promotion_status = NVL (p_in_promotion_status, p.promotion_status)
       AND rad.participant_current_status =
              NVL (p_in_pax_status, rad.participant_current_status)
             AND (rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id))) OR (p_in_promotion_id is NULL))
             AND NVL (TRUNC (rad.media_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
             AND (  ( (p_paxid IS NULL OR p_paxid = 0)                                                                 
        AND (            
                 (NVL(is_Team,0)=0 AND rad.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rad.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND p_paxid <> 0 AND rad.user_id=p_paxid))   
        --       AND (   (NVL (receivedAwardType, 'show_all') = 'show_all' AND 1 = 1)    --03/13/2017
        --            OR (receivedAwardType = 'received' AND 1 = 1)
        --            OR (receivedAwardType = 'notReceived' AND 1 = 2))      
       AND NOT EXISTS (select j2.journal_id from rpt_ssi_award_detail j2 where j2.journal_id = rad.journal_id)  --05/12/2015                  
UNION ALL
SELECT rad.journal_id transaction_id,
       rad.trans_date transaction_date,
       rad.user_first_name first_name,
       au.middle_name middle_name,
       rad.user_last_name last_name,
       au.user_name login_id,
         (select cms_name from temp_table_session where asset_code = c.cm_asset_code) country,
       rh.node_name primary_org_unit,
       rad.position_type job_position,
       rad.department department,
       (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT') AS promotion_type, --04/15/2014   --03/09/2017       
       CASE WHEN rad.batch_description IS NULL THEN 
       (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT')       --03/09/2017
       WHEN rad.batch_description like '%'||gc_str_token THEN REPLACE(rad.batch_description,gc_str_token)                      --03/07/2018 
       ELSE (SELECT t.cms_name FROM temp_table_session t WHERE t.asset_code=rad.batch_description) END   AS PROMOTION_NAME,   --03/07/2018   added case       
       'Y' AS taxable,
       rad.transaction_amount points_received_cnt,
       0 plateau_earned_cnt,
       0 sweepstakes_won_cnt,
       '#'||cert_num AS on_the_spot_serial, --08/28/2014 Added #
       NULL AS other,  --05/12/2015  --10/05/2016
       0 other_value,  --05/12/2015
       0 AS cash_received_cnt,    --05/05/2016
       NULL AS level_name,        --05/05/2016
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
  FROM rpt_qcard_detail rad,
       application_user au,
       rpt_hierarchy rh,
       rpt_characteristic rch,
       country c
WHERE     au.user_id(+) = rad.user_id
       AND rh.node_id = rad.node_id
       AND rch.user_nt_id(+) = rad.user_id
       AND rch.characteristic_type (+) = 'USER' --01/08/2016
       AND rad.country_id = c.country_id
       AND 'Y' = IsOnTheSpotIncluded
       AND NVL(p_in_promotion_status,'showall') in ('showall','live')   --09/25/2014
       AND NVL(rad.position_type,'job') = NVL (p_in_job_code, NVL(rad.position_type,'job'))
       AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND (rad.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
       AND NVL (TRUNC (rad.trans_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
        AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rad.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rad.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rad.user_id=p_paxid))
        --       AND (   (NVL (receivedAwardType, 'show_all') = 'show_all' AND 1 = 1)          --03/13/2017
        --            OR (receivedAwardType = 'received' AND 1 = 1)
        --            OR (receivedAwardType = 'notReceived' AND 1 = 2))            
--05/12/2015
UNION ALL
SELECT rad.journal_id transaction_id,
       rad.payout_issue_date transaction_date,
       rad.pax_first_name first_name,
       au.middle_name middle_name,
       rad.pax_last_name last_name,
       au.user_name login_id,
         (select cms_name from temp_table_session where asset_code = c.cm_asset_code) country,
       rh.node_name primary_org_unit,
       rad.position_type job_position,
       rad.department department,
       (select cms_name from temp_table_session where cms_code='SSI_CONTEST' AND asset_code = 'profile.proxies.tab') AS promotion_type, --05/12/2015
       (select cms_name from temp_table_session where cms_code='CONTEST_NAME' AND asset_code = rad.ssi_contest_name) AS promotion_name,  --05/12/2015
       'Y' AS taxable,
       CASE WHEN rad.payout_type <> 'other' THEN rad.payout_amount ELSE 0 END points_received_cnt,
       0 plateau_earned_cnt,
       0 sweepstakes_won_cnt,
       NULL AS on_the_spot_serial, --08/28/2014 Added #
       CASE WHEN rad.payout_type = 'other' THEN TO_CHAR(rad.other) ELSE NULL END other,    --07/22/2015  --10/05/2016
       CASE WHEN rad.payout_type = 'other' THEN rad.payout_amount ELSE 0 END other_value,
       0 AS cash_received_cnt,    --05/05/2016
       NULL AS level_name,        --05/05/2016
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
  FROM rpt_ssi_award_detail rad,
       application_user au,
       rpt_hierarchy rh,
       rpt_characteristic rch,
       country c,
       participant p
       ,promotion promo   --08/14/2015
WHERE  rad.payout_type =  NVL(p_in_award_type,rad.payout_type)   --03/14/2017
       AND au.user_id(+) = rad.user_id
       AND rh.node_id = rad.node_id
       AND rch.user_nt_id(+) = rad.user_id
       AND rch.characteristic_type (+) = 'USER'  --01/08/2016
       AND p.user_id (+) = rad.user_id
       AND rad.country_id = c.country_id
       AND promo.promotion_id = rad.promotion_id  --08/14/2015
--       AND NVL(p_in_promotion_status,'showall') in ('showall','live')    --08/14/2015     
       AND promo.promotion_status = NVL (p_in_promotion_status, promo.promotion_status)   --08/14/2015       
       AND NVL(p.status,'showall') = NVL (p_in_pax_status, NVL(p.status,'showall'))  --05/12/2015
       AND NVL(rad.position_type,'job') = NVL (p_in_job_code, NVL(rad.position_type,'job'))
      AND (rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id))) OR (p_in_promotion_id is NULL))        --05/12/2015
       AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
       AND (rad.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
       AND NVL (TRUNC (rad.payout_issue_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
        AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rad.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rad.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rad.user_id=p_paxid))
        --       AND (   (NVL (receivedAwardType, 'show_all') = 'show_all' AND 1 = 1)
        --            OR (receivedAwardType = 'received' AND 1 = 1)
        --            OR (receivedAwardType = 'notReceived' AND 1 = 2))            
            ) ex   --12/18/2014
) ;

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF; 
  --end AWS changes 03/12/2019    

    --prc_execution_log_entry('PRC_AWARDS_EXTRACT',1,'INFO','p_file_name----->>>>>>'||': '||p_file_name||CHR(10),null);         

file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;--Change done to remove duplicate last rows.
           UTL_FILE.put_line(file_handler, v_extract);
           -- prc_execution_log_entry('PRC_AWARDS_EXTRACT',1,'INFO',v_extract,NULL);   --11/13/2015          
      --exit when l_cursor%notfound;
END LOOP;

    UTL_FILE.fclose(file_handler);

	
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_AWARDS_EXTRACT',1,'ERROR',p_in_promotion_id||': '||'p_in_promotion_id'||p_paxid ||': '||'p_paxid '||is_Team ||': '||'is_Team '|| --07/16/2014 Bug # 54917
        parentNodeId||': '||'parentNodeId'||p_in_country_Ids||': '||'p_in_country_Ids'||p_in_promotion_status||': '||'p_in_promotion_status'||
        p_in_pax_status||': '||'p_in_pax_status'||p_in_job_code ||': '||'p_in_job_code '||p_in_department||': '||'p_in_department'||
        p_in_from_date||': '||'p_in_from_date'||p_in_to_date||': '||'p_in_to_date'||receivedAwardType||': '||'receivedAwardType'||
        IsOnTheSpotIncluded ||': '||'IsOnTheSpotIncluded '||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null); --02/25/2014        
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_AWARDS_EXTRACT;

PROCEDURE PRC_PARTICIPANT_EXTRACT
   ( p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Participant Extract' for Admin.
-- Person              Date           Comments
-- ---------           ----------     -----------------------------------------------------
-- Ravi Dhanekula     12/28/2012     04/25/2008  Initial Version
-- Arun S            01/29/2012     modified to use report table rpt_enrollment_detail   
-- Ravi Dhanekula     02/10/2014  Modified the procedure to have country and state codes instead of names. Bug # 51414
-- nagarajs           07/16/2014     Bug # 54917 - close the file and include parms value when OTHER exception
-- nagarajs           07/18/2014     Bug # 51414 - display dates in MM/DD/YYYY format
-- Swati            10/10/2014    Bug 57227 - Reports-Participant Export: The inactive participants are not getting listed out in the Participant export report
-- Suresh J         07/01/2015 Bug 61595 - Pax Extracts running for 5 hours 
-- Ravi Dhanekula   08/27/2015 Bug # 63804 - Participant Export Report -No PAX information is available in the Participant extract
-- Ravi Arumugam   01/29/2016 Bug # 65415  - Participant Export is showing duplicate pax record
--Ravi Arumugam   02/02/2016 Bug#65464 - Admin/Reports/Participant Export extract:-
                                        The column "country" and "state" should be abbreviated with full name of the city and state in the "Participant export" extracted sheet.
--Ravi Arumugam  02/04/2016 Bug#65513 - Participant Export report is missing the last column and some column are not formatted correctly.                                                                              
--nagarajs      02/11/2016  Bug 65666 - Pax load has been changed recently to include 20 characteristics
--Ravi Arumugam 03/09/2016 Bug#65901 -Participant Export report should display the records in the extract sorted by First column
--Gorantla        05/29/2018  GitLab#1098/Bug# 76482 - Recovery email address displaying unmasked in Participant Export 
--Gorantla        06/07/2018  GitLab#1098/Bug# 76482 - Recovery email address displaying unmasked in Participant Export
--Gorantla        06/26/2018  GitLab#1183/Bug 76960 - Participant export doesn't line up the pax characteristics 
--Gorantla        08/31/2018  Bug 76860 - Job position and department values are showing as null in participant export if pax are loaded with position type/department in lowercase
--Ramkumar        12/05/2018  Bug fix 76860 - copied from Nestle ACNH - causing errors because there are "dupe" dept/jobs
--                              populate them in temp_table_session separately, as UPPER
--Gorantla       03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
--Loganathan     07/17/2019   Bug 79092 - Unencrypted SSN data available via Participant Export
*******************************************************************************/

   -- constants
   c_delimiter  CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   
    p_in_locale     VARCHAR2(10):= 'en_US';--Default locale
    l_cursor        SYS_REFCURSOR;
    file_handler           UTL_FILE.file_type;
    v_extract       varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    
   
   -- local variables
BEGIN

DELETE temp_table_session;

--INSERT INTO temp_table_session -- 12/05/2018
--   SELECT asset_code,cms_name,cms_code
--     FROM vw_cms_code_value E
--    WHERE asset_code IN ( 'picklist.addresstype.items','picklist.department.type.items','picklist.positiontype.items',
--                                           'picklist.hierarchyrole.type.items','picklist.participantstatus.items','picklist.phonetype.items','picklist.emailtype.items','default.locale.items','picklist.statetype.items') AND e.locale=p_in_locale --bug#65464 02/02/2016
--                                           UNION                                           
--                                           SELECT asset_code,cms_value,KEY FROM VW_CMS_ASSET_VALUE WHERE KEY IN ('CHARACTERISTIC_NAME') AND locale = p_in_locale
--                                           UNION
--                                           SELECT asset_code,cms_value,KEY FROM VW_CMS_ASSET_VALUE WHERE KEY= 'COUNTRY_NAME' AND locale = p_in_locale;     --bug#65464 --02/02/2016   
INSERT INTO temp_table_session
   SELECT asset_code,cms_name,cms_code
     FROM vw_cms_code_value E
    WHERE asset_code IN ( 'picklist.addresstype.items', -- 'picklist.department.type.items','picklist.positiontype.items', -- 12/05/2018
                          'picklist.hierarchyrole.type.items','picklist.participantstatus.items',
                          'picklist.phonetype.items','picklist.emailtype.items','default.locale.items','picklist.statetype.items') 
      AND e.locale=p_in_locale --bug#65464 02/02/2016
	  UNION         
   SELECT asset_code,UPPER(cms_name) cms_name,UPPER(cms_code) cms_code -- 12/05/2018
     FROM vw_cms_code_value E
    WHERE asset_code IN ( 'picklist.department.type.items','picklist.positiontype.items') 
      AND e.locale=p_in_locale --bug#65464 02/02/2016
	  UNION                                   
	 SELECT asset_code,cms_value,KEY FROM VW_CMS_ASSET_VALUE WHERE KEY IN ('CHARACTERISTIC_NAME') AND locale = p_in_locale
	  UNION
	 SELECT asset_code,cms_value,KEY FROM VW_CMS_ASSET_VALUE WHERE KEY= 'COUNTRY_NAME' AND locale = p_in_locale;     --bug#65464 --02/02/2016  
	                                     
DELETE gtt_user_char;  --01/29/2016        

INSERT INTO gtt_user_char   --07/01/2015
SELECT user_id,
               characteristic1_name,
               characteristic1_value,
               characteristic2_name,
               characteristic2_value,
               characteristic3_name,
               characteristic3_value,
               characteristic4_name,
               characteristic4_value,
               characteristic5_name,
               characteristic5_value,
               characteristic6_name,
               characteristic6_value,
               characteristic7_name,
               characteristic7_value,
               characteristic8_name,
               characteristic8_value,
               characteristic9_name,
               characteristic9_value,
               characteristic10_name,
               characteristic10_value,
               characteristic11_name,
               characteristic11_value,
               characteristic12_name,
               characteristic12_value,
               characteristic13_name,
               characteristic13_value,
               characteristic14_name,
               characteristic14_value,
               characteristic15_name,
               characteristic15_value,
               characteristic16_name,       --02/11/2016 Start
               characteristic16_value,
               characteristic17_name,
               characteristic17_value,
               characteristic18_name,
               characteristic18_value,
               characteristic19_name,
               characteristic19_value,
               characteristic20_name,
               characteristic20_value       --02/11/2016 End
          FROM (SELECT vcav.cms_name cm_char,
                       uc.characteristic_value characteristic_values,
                       DENSE_RANK ()
                       -- OVER (PARTITION BY user_id ORDER BY uc.user_characteristic_id) char_num,  -- 06/26/2018  commented out
                       OVER (PARTITION BY user_id ORDER BY uc.characteristic_id) char_num,  -- 06/26/2018
                       user_id
                  FROM user_characteristic uc, characteristic c,
                       temp_table_session vcav
                 WHERE uc.characteristic_id = c.characteristic_id
                   AND c.cm_asset_code = vcav.asset_code
                   ) PIVOT (MIN (SUBSTR(cm_char, 1, 120)) name,
                                                                          MIN (UPPER(characteristic_values)) VALUE
                                                                   FOR (char_num)
                                                                    IN (1 AS characteristic1,
                                                                        2 AS characteristic2,
                                                                        3 AS characteristic3,
                                                                        4 AS characteristic4,
                                                                        5 AS characteristic5,
                                                                        6 AS characteristic6,
                                                                        7 AS characteristic7,
                                                                        8 AS characteristic8,
                                                                        9 AS characteristic9,
                                                                        10 AS characteristic10,
                                                                         11 AS characteristic11,
                                                                        12 AS characteristic12,
                                                                        13 AS characteristic13,
                                                                        14 AS characteristic14,
                                                                        15 AS characteristic15,
                                                                        16 AS characteristic16,     --02/11/2016 Start
                                                                        17 AS characteristic17,
                                                                        18 AS characteristic18,
                                                                        19 AS characteristic19,
                                                                        20 AS characteristic20));   --02/11/2016 Start
DELETE gtt_user_org;          --01/29/2016
                                                                           
INSERT into gtt_user_org            --07/01/2015                                                         
SELECT user_id,
               org_unit1_name,
               org_unit1_value,
               org_unit2_name,
               org_unit2_value,
               org_unit3_name,
               org_unit3_value,
               org_unit4_name,
               org_unit4_value,
               org_unit5_name,
               org_unit5_value
          FROM (SELECT un.user_id,
                       n.name node_name,
                       vccv.cms_name role,
                       DENSE_RANK ()
                       OVER (PARTITION BY user_id ORDER BY un.user_node_id) nod_num
                  FROM user_node un, node n,
                       temp_table_session vccv
                 WHERE un.node_id = n.node_id
                   AND un.role    = vccv.cms_code 
                   AND vccv.asset_code = 'picklist.hierarchyrole.type.items'                   
                   AND un.status = 1) PIVOT (MIN (
                                                                           node_name) name,
                                                                       MIN (
                                                                          role) VALUE
                                                                 FOR (
                                                                    nod_num)
                                                                 IN  (1 AS ORG_UNIT1,
                                                                     2 AS ORG_UNIT2,
                                                                     3 AS ORG_UNIT3,
                                                                     4 AS ORG_UNIT4,
                                                                     5 AS ORG_UNIT5));
DELETE gtt_user_email;  --01/29/2016
/* -- 05/29/2018 Commented out
INSERT INTO gtt_user_email  --07/01/2015--08/27/2015
SELECT ua.user_id,
       ua.email_addr as primary_email_address,
       e_typ.cms_name as primary_email_type,
       uea.email_addr
FROM user_email_address ua,
     temp_table_session e_typ,
     (SELECT email_addr,user_id FROM (SELECT email_addr,user_id,RANK () 
                                                                     OVER (
                                                                        PARTITION BY user_id
                                                                        ORDER BY
                                                                           email_type) rec_rank FROM user_email_address WHERE is_primary = 0) WHERE rec_rank =1) uea
WHERE (is_primary = 1 OR email_type = 'sms')  AND
       ua.email_type   = e_typ.cms_code AND
       ua.is_primary   = 1 AND
       e_typ.asset_code = 'picklist.emailtype.items'
       AND ua.user_id = uea.user_id(+);         
*/ -- 05/29/2018 Commented out   

-- 05/29/2018 start
INSERT INTO gtt_user_email
WITH email_address as
(SELECT CASE WHEN length(email) >= 5 THEN first_3||mask3||last3 
             WHEN length(email) > 1 AND length(email) < 5 THEN first_2||mask2||last2
             WHEN length(email) = 1 THEN 'x'
        END||'@'||
        CASE WHEN length(domain) >= 5 THEN d_first_3||d_mask3||d_last3
             WHEN length(domain) > 1 AND length(domain) < 5 THEN d_first_2||d_mask2||d_last2
             WHEN length(domain) = 1 THEN 'x'
        END||
        replace(email_addr,email||'@'||domain) email_address,
        email_type,
        email_addr,
        user_id,
        is_primary
  FROM 
(SELECT email,
       domain,
       email_addr,
       email_type,
       user_id,
       is_primary,
       substr(email,0,3) first_3,
       regexp_replace(substr(email,4, (length(email) - 4)),'[^ ]','x') mask3,
       substr(email,-1) last3,
       substr(domain,0,3) d_first_3,
       regexp_replace(substr(domain,4, (length(domain) - 4)),'[^ ]','x') d_mask3,
       substr(domain,-1) d_last3,
       substr(email,0,1) first_2,
       regexp_replace(substr(email,2, (length(email) - 2)),'[^ ]','x') mask2,
       substr(email,-1) last2,
       substr(domain,0,1) d_first_2,
       regexp_replace(substr(domain,2, (length(domain) - 2)),'[^ ]','x') d_mask2,
       substr(domain,-1) d_last2
  FROM (
SELECT substr(email_addr, 1, instr(email_addr, '@')-1) email, -- to get user from email
       substr(email_addr,instr(email_addr,'@')+1,
          (instr(email_addr,'.',-1) - (instr(email_addr,'@')+1))) domain,  -- to get domain name
       email_addr,
       email_type,
       user_id,
       is_primary
  FROM user_email_address)
  ))
SELECT ua.user_id,
       ua.email_addr as primary_email_address, -- 06/07/2018
       e_typ.cms_name as primary_email_type,
       --uea.email_addr  -- 06/07/2018
       decode(uea.email_type,'rec',email_address,uea.email_addr) as email_addr  -- 06/07/2018
FROM email_address ua,
     temp_table_session e_typ,
     (SELECT email_addr,user_id,email_type FROM (SELECT email_type,email_addr,user_id,RANK () -- 06/07/2018 added email_type
                                                                     OVER (
                                                                        PARTITION BY user_id
                                                                        ORDER BY
                                                                           email_type) rec_rank FROM email_address WHERE is_primary = 0) WHERE rec_rank =1) uea
WHERE (is_primary = 1 OR ua.email_type = 'sms')  AND  -- 06/07/2018 added alias ua
       ua.email_type   = e_typ.cms_code AND
       ua.is_primary   = 1 AND
       e_typ.asset_code = 'picklist.emailtype.items'
       AND ua.user_id = uea.user_id(+);       
-- 05/29/2018 End

    BEGIN   --07/01/2015
    SYS.DBMS_STATS.GATHER_TABLE_STATS 
    ( OWNNAME          => USER,
      TABNAME          => 'GTT_USER_CHAR',
      ESTIMATE_PERCENT => 10,
      CASCADE          => TRUE,
      METHOD_OPT       => 'for all columns size auto'
    );

    SYS.DBMS_STATS.GATHER_TABLE_STATS 
    ( OWNNAME          => USER,
      TABNAME          => 'GTT_USER_ORG',
      ESTIMATE_PERCENT => 10,
      CASCADE          => TRUE,
      METHOD_OPT       => 'for all columns size auto'
    );

    SYS.DBMS_STATS.GATHER_TABLE_STATS 
    ( OWNNAME          => USER,
      TABNAME          => 'GTT_USER_EMAIL',
      ESTIMATE_PERCENT => 10,
      CASCADE          => TRUE,
      METHOD_OPT       => 'for all columns size auto'
    );
    END;

                                           
IF p_file_name IS NULL THEN                                                                                 

     -- column headers
     OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (     
     SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL --07/01/2015
      
      SELECT *  --03/09/2016 Bug#65901
      FROM      --03/09/2016 Bug#65901
      (         --03/09/2016 Bug#65901
      
       SELECT (ROWNUM+1),   c2_delimiter||au.user_name||c2_delimiter||c_delimiter||
                            c2_delimiter||au.first_name||c2_delimiter||c_delimiter||
                            c2_delimiter||au.middle_name||c2_delimiter||c_delimiter||
                            c2_delimiter||au.last_name||c2_delimiter||c_delimiter||
                            c2_delimiter||au.suffix||c2_delimiter||c_delimiter||
                            --c2_delimiter||fnc_java_decrypt (au.ssn)||c2_delimiter||c_delimiter|| --07/17/2019 Bug 79092
                            c2_delimiter||au.birth_date||c2_delimiter||c_delimiter||
                            c2_delimiter||au.gender||c2_delimiter||c_delimiter||
      c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and
                                                                            cms_code=DECODE (au.is_active, 1, 'active', 'inactive'))||c2_delimiter||c_delimiter||
      c2_delimiter||pm_email.primary_email_address||c2_delimiter||c_delimiter||
      c2_delimiter||pm_email.primary_email_type||c2_delimiter||c_delimiter||
      c2_delimiter||pm_email.text_message_address||c2_delimiter||c_delimiter||
      c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.addresstype.items' and
                                                                            cms_code=ua.address_type)||c2_delimiter||c_delimiter||
      c2_delimiter||(select cms_name from temp_table_session where asset_code=ua.cm_asset_code)||c2_delimiter||c_delimiter|| --Bug # 51414  --02/10/2014 ua.country_code --bug#65464 --02/02/2016
      c2_delimiter||ua.addr1||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr2||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr3||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr4||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr5||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr6||c2_delimiter||c_delimiter||
      c2_delimiter||ua.city||c2_delimiter||c_delimiter||
      c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.statetype.items' and cms_code=ua.state)||c2_delimiter||c_delimiter||  --Bug # 51414  --02/10/2014 --Bug#65464 --02/02/2016
      c2_delimiter||ua.postal_code||c2_delimiter||c_delimiter||
      c2_delimiter||UP.home_phn||c2_delimiter||c_delimiter||
      c2_delimiter||UP.business_phn||c2_delimiter||c_delimiter||
      c2_delimiter||UP.mobile_phn||c2_delimiter||c_delimiter||
       c2_delimiter||e.name||c2_delimiter||c_delimiter||
       c2_delimiter||(select vpe.position_type from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            upper(cms_code)= upper(vpe.position_type))||c2_delimiter||c_delimiter||  -- 08/31/2018
        c2_delimiter||(select vpe.department_type from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            upper(cms_code)= upper(vpe.department_type))||c2_delimiter||c_delimiter|| -- 08/31/2018
           c2_delimiter||TO_CHAR(vpe.hire_date,'MM/DD/YYYY')||c2_delimiter||c_delimiter||  --07/18/2014 Bug 51414
       c2_delimiter||TO_CHAR(vpe.termination_date,'MM/DD/YYYY')||c2_delimiter||c_delimiter|| --07/18/2014 Bug 51414
       c2_delimiter||uorg.org_unit1_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit1_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit2_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit2_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit3_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit3_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit4_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit4_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit5_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit5_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic1_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic1_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic2_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic2_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic3_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic3_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic4_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic4_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic5_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic5_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic6_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic6_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic7_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic7_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic8_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic8_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic9_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic9_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic10_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic10_value||c2_delimiter||c_delimiter||      
       c2_delimiter||uchr.characteristic11_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic11_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic12_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic12_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic13_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic13_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic14_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic14_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic15_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic15_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic16_name||c2_delimiter||c_delimiter||            --02/11/2016 Start
       c2_delimiter||uchr.characteristic16_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic17_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic17_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic18_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic18_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic19_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic19_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic20_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic20_value||c2_delimiter||c_delimiter||           --02/11/2016 End 
       c2_delimiter||urol.role1_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role2_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role3_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role4_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role5_name||c2_delimiter||c_delimiter||
       c2_delimiter||au.language_id||c2_delimiter||c_delimiter||
       c2_delimiter||pax.sso_id||c2_delimiter --02/04/2016 Bug#65513 Added SSO_ID column
  FROM participant pax,
       application_user au,
       (SELECT usr_a.user_id,
               usr_a.address_type,
               usr_a.addr1,
               usr_a.addr2,
               usr_a.addr3,
               usr_a.addr4,
               usr_a.addr5,
               usr_a.addr6,
               usr_a.city,
               usr_a.state,
               usr_a.postal_code,
               c.country_code,--Bug # 51414  --02/10/2014
               c.cm_asset_code, 
               c.name_cm_key
          FROM user_address usr_a,
               country c
         WHERE usr_a.country_id = c.country_id
           AND usr_a.is_primary = 1) ua,
       (SELECT user_id, business_phn, mobile_phn, home_phn
          FROM (WITH usr_ph AS (SELECT user_id, phone_type, phone_nbr
                                  FROM user_phone)
                                SELECT up_d.user_id,
                                       (SELECT up1.phone_nbr 
                                          FROM usr_ph up1 
                                         WHERE up1.user_id    = up_d.user_id 
                                           AND up1.phone_type = 'bus') business_phn,
                                       (SELECT up2.phone_nbr 
                                          FROM usr_ph up2 
                                         WHERE up2.user_id    = up_d.user_id 
                                           AND up2.phone_type = 'mob') mobile_phn,
                                       (SELECT up3.phone_nbr 
                                          FROM usr_ph up3 
                                         WHERE up3.user_id    = up_d.user_id 
                                           AND up3.phone_type = 'hom') home_phn
                                  FROM (SELECT DISTINCT up.user_id
                                          FROM usr_ph up) up_d)) UP,
       gtt_user_email pm_email,  --07/01/2015
       (SELECT user_id,
               role1_name,
               role2_name,
               role3_name,
               role4_name,
               role5_name
          FROM (WITH usr_rol AS (SELECT r.name,
                                        user_id,
                                        DENSE_RANK () 
                                        OVER (PARTITION BY user_id ORDER BY r.name)
                                        rol_num
                                   FROM user_role ur, role r
                                  WHERE ur.role_id = r.role_id)
                                 SELECT ur.user_id,
                                        (SELECT ur1.name
                                           FROM usr_rol ur1
                                          WHERE ur1.user_id = ur.user_id
                                            AND ur1.rol_num = 1) role1_name,
                                        (SELECT ur2.name
                                           FROM usr_rol ur2
                                          WHERE ur2.user_id = ur.user_id
                                            AND ur2.rol_num = 2) role2_name,
                                        (SELECT ur3.name
                                           FROM usr_rol ur3
                                          WHERE ur3.user_id = ur.user_id
                                            AND ur3.rol_num = 3) role3_name,
                                        (SELECT ur4.name
                                           FROM usr_rol ur4
                                          WHERE ur4.user_id = ur.user_id
                                            AND ur4.rol_num = 4) role4_name,
                                        (SELECT ur5.name
                                           FROM usr_rol ur5
                                          WHERE ur5.user_id = ur.user_id
                                            AND ur5.rol_num = 5) role5_name                
                                   FROM (SELECT DISTINCT usr.user_id
                                           FROM usr_rol usr) ur)) urol,
       gtt_user_char uchr,  --07/01/2015
       gtt_user_org uorg,   --07/01/2015 
       vw_curr_pax_employer vpe,
       employer e
WHERE pax.user_id = au.user_id
   AND au.user_id = ua.user_id
   AND pax.user_id = UP.user_id(+)
   AND pax.user_id = pm_email.user_id(+)
   AND pax.user_id = vpe.user_id(+)
   AND vpe.employer_id = e.employer_id(+)
   AND pax.user_id = urol.user_id(+)
   AND pax.user_id = uchr.user_id(+)
   AND pax.user_id = uorg.user_id(+)
   --AND au.is_active = 1 -- 10/10/2014 Bug 57227
   AND au.user_type = 'pax'
   ORDER BY au.user_name asc)  --Bug#65901 03/09/2016
   );
   
p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
OPEN l_cursor FOR
     -- column headers
     SELECT textline FROM (     
     SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL --07/01/2015
      
      SELECT *  --03/09/2016 Bug#65901
      FROM      --03/09/2016 Bug#65901
      (         --03/09/2016 Bug#65901
      
       SELECT (ROWNUM+1),   c2_delimiter||au.user_name||c2_delimiter||c_delimiter||
                                             c2_delimiter||au.first_name||c2_delimiter||c_delimiter||
                                            c2_delimiter||au.middle_name||c2_delimiter||c_delimiter||
                                            c2_delimiter||au.last_name||c2_delimiter||c_delimiter||
                                            c2_delimiter||au.suffix||c2_delimiter||c_delimiter||
                         c2_delimiter||fnc_java_decrypt (au.ssn)||c2_delimiter||c_delimiter||
                           c2_delimiter||au.birth_date||c2_delimiter||c_delimiter||
                           c2_delimiter||au.gender||c2_delimiter||c_delimiter||
       c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and
                                                                            cms_code=DECODE (au.is_active, 1, 'active', 'inactive'))||c2_delimiter||c_delimiter||
     c2_delimiter||pm_email.primary_email_address||c2_delimiter||c_delimiter||
     c2_delimiter||pm_email.primary_email_type||c2_delimiter||c_delimiter||
    c2_delimiter||pm_email.text_message_address||c2_delimiter||c_delimiter||
    c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.addresstype.items' and
                                                                            cms_code=ua.address_type)||c2_delimiter||c_delimiter||
      c2_delimiter||(select cms_name from temp_table_session where asset_code=ua.cm_asset_code)||c2_delimiter||c_delimiter|| --Bug # 51414  --02/10/2014 --ua.country_code bug#65464 --02/02/2016
      c2_delimiter||ua.addr1||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr2||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr3||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr4||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr5||c2_delimiter||c_delimiter||
      c2_delimiter||ua.addr6||c2_delimiter||c_delimiter||
      c2_delimiter||ua.city ||c2_delimiter||c_delimiter||
      c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.statetype.items' and cms_code=ua.state)||c2_delimiter||c_delimiter||  --Bug # 51414  --02/10/2014 Bug#65464 --02/02/2016
      c2_delimiter||ua.postal_code||c2_delimiter||c_delimiter||
      c2_delimiter||UP.home_phn||c2_delimiter||c_delimiter||
      c2_delimiter||UP.business_phn||c2_delimiter||c_delimiter||
      c2_delimiter||UP.mobile_phn||c2_delimiter||c_delimiter||
       c2_delimiter||e.name||c2_delimiter||c_delimiter||
       c2_delimiter||(select vpe.position_type from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            upper(cms_code)= upper(vpe.position_type))||c2_delimiter||c_delimiter|| -- 08/31/2018
        c2_delimiter||(select vpe.department_type from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            upper(cms_code)= upper(vpe.department_type))||c2_delimiter||c_delimiter|| -- 08/31/2018
           c2_delimiter||TO_CHAR(vpe.hire_date,'MM/DD/YYYY')||c2_delimiter||c_delimiter||  --07/18/2014 Bug 51414
       c2_delimiter||TO_CHAR(vpe.termination_date,'MM/DD/YYYY')||c2_delimiter||c_delimiter|| --07/18/2014 Bug 51414
       c2_delimiter||uorg.org_unit1_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit1_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit2_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit2_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit3_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit3_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit4_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit4_value||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit5_name||c2_delimiter||c_delimiter||
       c2_delimiter||uorg.org_unit5_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic1_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic1_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic2_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic2_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic3_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic3_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic4_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic4_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic5_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic5_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic6_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic6_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic7_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic7_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic8_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic8_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic9_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic9_value||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic10_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic10_value||c2_delimiter||c_delimiter||      
       c2_delimiter||uchr.characteristic11_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic11_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic12_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic12_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic13_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic13_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic14_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic14_value||c2_delimiter||c_delimiter||       
       c2_delimiter||uchr.characteristic15_name||c2_delimiter||c_delimiter||
       c2_delimiter||uchr.characteristic15_value||c2_delimiter||c_delimiter||        
       c2_delimiter||urol.role1_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role2_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role3_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role4_name||c2_delimiter||c_delimiter||
       c2_delimiter||urol.role5_name||c2_delimiter||c_delimiter||
       c2_delimiter||au.language_id||c2_delimiter||c_delimiter||
       c2_delimiter||pax.sso_id||c2_delimiter --02/04/2016 Bug#65513 Added SSO_ID column
  FROM participant pax,
       application_user au,
       (SELECT usr_a.user_id,
               usr_a.address_type,
               usr_a.addr1,
               usr_a.addr2,
               usr_a.addr3,
               usr_a.addr4,
               usr_a.addr5,
               usr_a.addr6,
               usr_a.city,
               usr_a.state,
               usr_a.postal_code,
               c.country_code,--Bug # 51414  --02/10/2014
               c.cm_asset_code, 
               c.name_cm_key
          FROM user_address usr_a,
               country c
         WHERE usr_a.country_id = c.country_id
           AND usr_a.is_primary = 1) ua,
       (SELECT user_id, business_phn, mobile_phn, home_phn
          FROM (WITH usr_ph AS (SELECT user_id, phone_type, phone_nbr
                                  FROM user_phone)
                                SELECT up_d.user_id,
                                       (SELECT up1.phone_nbr 
                                          FROM usr_ph up1 
                                         WHERE up1.user_id    = up_d.user_id 
                                           AND up1.phone_type = 'bus') business_phn,
                                       (SELECT up2.phone_nbr 
                                          FROM usr_ph up2 
                                         WHERE up2.user_id    = up_d.user_id 
                                           AND up2.phone_type = 'mob') mobile_phn,
                                       (SELECT up3.phone_nbr 
                                          FROM usr_ph up3 
                                         WHERE up3.user_id    = up_d.user_id 
                                           AND up3.phone_type = 'hom') home_phn
                                  FROM (SELECT DISTINCT up.user_id
                                          FROM usr_ph up) up_d)) UP,
       gtt_user_email pm_email,  --07/01/2015
       (SELECT user_id,
               role1_name,
               role2_name,
               role3_name,
               role4_name,
               role5_name
          FROM (WITH usr_rol AS (SELECT r.name,
                                        user_id,
                                        DENSE_RANK () 
                                        OVER (PARTITION BY user_id ORDER BY r.name)
                                        rol_num
                                   FROM user_role ur, role r
                                  WHERE ur.role_id = r.role_id)
                                 SELECT ur.user_id,
                                        (SELECT ur1.name
                                           FROM usr_rol ur1
                                          WHERE ur1.user_id = ur.user_id
                                            AND ur1.rol_num = 1) role1_name,
                                        (SELECT ur2.name
                                           FROM usr_rol ur2
                                          WHERE ur2.user_id = ur.user_id
                                            AND ur2.rol_num = 2) role2_name,
                                        (SELECT ur3.name
                                           FROM usr_rol ur3
                                          WHERE ur3.user_id = ur.user_id
                                            AND ur3.rol_num = 3) role3_name,
                                        (SELECT ur4.name
                                           FROM usr_rol ur4
                                          WHERE ur4.user_id = ur.user_id
                                            AND ur4.rol_num = 4) role4_name,
                                        (SELECT ur5.name
                                           FROM usr_rol ur5
                                          WHERE ur5.user_id = ur.user_id
                                            AND ur5.rol_num = 5) role5_name                
                                   FROM (SELECT DISTINCT usr.user_id
                                           FROM usr_rol usr) ur)) urol,
       gtt_user_char uchr,  --07/01/2015
       gtt_user_org uorg,   --07/01/2015 
       vw_curr_pax_employer vpe,
       employer e
WHERE pax.user_id = au.user_id
   AND au.user_id = ua.user_id
   AND pax.user_id = UP.user_id(+)
   AND pax.user_id = pm_email.user_id(+)
   AND pax.user_id = vpe.user_id(+)
   AND vpe.employer_id = e.employer_id(+)
   AND pax.user_id = urol.user_id(+)
   AND pax.user_id = uchr.user_id(+)
   AND pax.user_id = uorg.user_id(+)
   --AND au.is_active = 1 -- 10/10/2014 Bug 57227
   AND au.user_type = 'pax'
   ORDER BY au.user_name asc)  --Bug#65901 03/09/2016
   );

   -- start AWS changes 03/12/2019
   prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);
LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;
    UTL_FILE.fclose(file_handler);

	--start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;


EXCEPTION
    WHEN OTHERS  THEN  
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_PARTICIPANT_EXTRACT',1,'ERROR',
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null); --02/25/2014     --07/16/2014 Bug # 54917    
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_PARTICIPANT_EXTRACT;


PROCEDURE PRC_HIERARCHY_EXTRACT
   (p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for ''Hierarchy Extract' for Admin.
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 12/28/2012  Initial Version
                            04/01/2014  Added temp_table_session table to fetch CM data to avoid performance issues.
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
-- KrishnaDeepika 11/03/2014 bug # 51124 - Hierarchy Export and Org unit Details - 
Org unit type char name and value is extracted even the org unit is changed to Org unit type which doesn't have characteristics
--Ravi Dhanekula 06/23/2015 Bug # 61994 --Hierarchy extract includes too many characteristic fields and has data in the record type field
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   -- local variables
    l_cursor  SYS_REFCURSOR;
  -- var1 NUMBER;
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;

BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key IN ('NODE_TYPE_NAME','CHARACTERISTIC_NAME') and locale = 'en_US';

IF p_file_name IS NULL THEN                                                                                 

     -- column headers
     OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (     
     SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL --01/05/2015
SELECT * FROM   --01/05/2015
(SELECT    (ROWNUM+1),c2_delimiter||NULL||c2_delimiter||c_delimiter||--Bug # 61994
          c2_delimiter||nc.name||c2_delimiter||c_delimiter||
           c2_delimiter||NULL||c2_delimiter||c_delimiter||
           c2_delimiter||NULL||c2_delimiter||c_delimiter||
           c2_delimiter||nc.description||c2_delimiter||c_delimiter||
--          c2_delimiter||fnc_cms_asset_code_val_extr (nt.cm_asset_code,nt.name_cm_key,'en_US')||c2_delimiter||c_delimiter|| --07/01/2013
          c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code='NODE_TYPE_NAME' AND asset_code=nt.cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
          c2_delimiter||np.name||c2_delimiter||c_delimiter||
           c2_delimiter||NULL||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char1_name||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char1_value||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char2_name||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char2_value||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char3_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char3_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char4_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char4_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char5_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char5_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char6_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char6_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char7_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char7_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char8_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char8_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char9_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char9_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char10_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char10_value||c2_delimiter--||c_delimiter||--Bug # 61994
--c2_delimiter||org_unit_char11_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char11_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char12_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char12_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char13_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char13_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char14_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char14_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char15_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char15_value||c2_delimiter
      FROM node nc,
           node_type nt,
           node np,
           (  SELECT *
                FROM (  SELECT DISTINCT
--                               fnc_cms_asset_code_val_extr (cm_asset_code,name_cm_key,'en_US') --07/01/2013
--                                  node_char_name,
                               (SELECT cms_name FROM temp_table_session WHERE cms_code='CHARACTERISTIC_NAME' AND asset_code=cm_asset_code) node_char_name, --04/01/2014
                               nc.characteristic_value,
                               nc.node_id,
                               c.domain_id,-- 11/03/2014 bug 51124
                               DENSE_RANK ()
                               OVER (
                                  PARTITION BY nc.node_id
                                  ORDER BY  (select cms_name from temp_table_session where cms_code='CHARACTERISTIC_NAME' AND asset_code=cm_asset_code))--04/01/2014
--                                  ORDER BY fnc_cms_asset_code_val_extr (cm_asset_code,name_cm_key,'en_US')) --07/01/2013
                                  org_char
                          FROM characteristic c, node_characteristic nc
                         WHERE c.characteristic_id(+) = nc.characteristic_id
                               AND c.is_active = 1
                      ORDER BY node_id) PIVOT (MIN (node_char_name) AS name,
                                              MIN (characteristic_value) AS VALUE
                                        FOR (org_char)
                                        IN  (1 AS org_unit_char1,
                                            2 AS org_unit_char2,
                                            3 AS org_unit_char3,
                                            4 AS org_unit_char4,
                                            5 AS org_unit_char5,
                                            6 AS org_unit_char6,
                                            7 AS org_unit_char7,
                                            8 AS org_unit_char8,
                                            9 AS org_unit_char9,
                                            10 AS org_unit_char10--,
--                                            11 AS org_unit_char11,
--                                            12 AS org_unit_char12,
--                                            13 AS org_unit_char13,
--                                            14 AS org_unit_char14,
--                                            15 AS org_unit_char15
                                            ))
            ORDER BY 2, 3  
            ) ouc
     WHERE     nc.node_type_id = nt.node_type_id
           AND nc.parent_node_id = np.node_id(+)
           AND nc.is_deleted = 0
           AND nc.node_id = ouc.node_id(+)
           AND ouc.domain_id(+) = nc.node_type_id   -- 11/03/2014 bug 51124
CONNECT BY PRIOR nc.node_id = nc.parent_node_id
START WITH nc.parent_node_id IS NULL
ORDER BY nc.path asc, nc.name asc  --01/05/2015
) --01/05/2015
) ;
  p_out_return_code :=  '00' ;

ELSE 
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
OPEN l_cursor FOR
     -- column headers
     SELECT textline FROM (     
     SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL --01/05/2015
SELECT * FROM   --01/05/2015
(SELECT    (ROWNUM+1),c2_delimiter||NULL||c2_delimiter||c_delimiter||--Bug # 61994
          c2_delimiter||nc.name||c2_delimiter||c_delimiter||
           c2_delimiter||NULL||c2_delimiter||c_delimiter||
           c2_delimiter||NULL||c2_delimiter||c_delimiter||
           c2_delimiter||nc.description||c2_delimiter||c_delimiter||
--          c2_delimiter||fnc_cms_asset_code_val_extr (nt.cm_asset_code,nt.name_cm_key,'en_US')||c2_delimiter||c_delimiter|| --07/01/2013
          c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code='NODE_TYPE_NAME' AND asset_code=nt.cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
          c2_delimiter||np.name||c2_delimiter||c_delimiter||
           c2_delimiter||NULL||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char1_name||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char1_value||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char2_name||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char2_value||c2_delimiter||c_delimiter||
           c2_delimiter||org_unit_char3_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char3_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char4_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char4_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char5_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char5_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char6_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char6_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char7_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char7_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char8_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char8_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char9_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char9_value||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char10_name||c2_delimiter||c_delimiter||
c2_delimiter||org_unit_char10_value||c2_delimiter--||c_delimiter||--Bug # 61994
--c2_delimiter||org_unit_char11_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char11_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char12_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char12_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char13_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char13_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char14_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char14_value||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char15_name||c2_delimiter||c_delimiter||
--c2_delimiter||org_unit_char15_value||c2_delimiter
      FROM node nc,
           node_type nt,
           node np,
           (  SELECT *
                FROM (  SELECT DISTINCT
--                               fnc_cms_asset_code_val_extr (cm_asset_code,name_cm_key,'en_US') --07/01/2013
--                                  node_char_name,
                               (SELECT cms_name FROM temp_table_session WHERE cms_code='CHARACTERISTIC_NAME' AND asset_code=cm_asset_code) node_char_name, --04/01/2014
                               nc.characteristic_value,
                               nc.node_id,
                               c.domain_id,-- 11/03/2014 bug 51124
                               DENSE_RANK ()
                               OVER (
                                  PARTITION BY nc.node_id
                                  ORDER BY  (select cms_name from temp_table_session where cms_code='CHARACTERISTIC_NAME' AND asset_code=cm_asset_code))--04/01/2014
--                                  ORDER BY fnc_cms_asset_code_val_extr (cm_asset_code,name_cm_key,'en_US')) --07/01/2013
                                  org_char
                          FROM characteristic c, node_characteristic nc
                         WHERE c.characteristic_id(+) = nc.characteristic_id
                               AND c.is_active = 1
                      ORDER BY node_id) PIVOT (MIN (node_char_name) AS name,
                                              MIN (characteristic_value) AS VALUE
                                        FOR (org_char)
                                        IN  (1 AS org_unit_char1,
                                            2 AS org_unit_char2,
                                            3 AS org_unit_char3,
                                            4 AS org_unit_char4,
                                            5 AS org_unit_char5,
                                            6 AS org_unit_char6,
                                            7 AS org_unit_char7,
                                            8 AS org_unit_char8,
                                            9 AS org_unit_char9,
                                            10 AS org_unit_char10--,
--                                            11 AS org_unit_char11,
--                                            12 AS org_unit_char12,
--                                            13 AS org_unit_char13,
--                                            14 AS org_unit_char14,
--                                            15 AS org_unit_char15
                                            ))
            ORDER BY 2, 3
            ) ouc
     WHERE     nc.node_type_id = nt.node_type_id
           AND nc.parent_node_id = np.node_id(+)
           AND nc.is_deleted = 0
           AND nc.node_id = ouc.node_id(+)
           AND ouc.domain_id(+) = nc.node_type_id   -- 11/03/2014 bug 51124
CONNECT BY PRIOR nc.node_id = nc.parent_node_id
START WITH nc.parent_node_id IS NULL
ORDER BY nc.path asc, nc.name asc  --01/05/2015
) --01/05/2015
) ;


-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
  
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);
LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;
    UTL_FILE.fclose(file_handler);

	
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;

EXCEPTION
    WHEN OTHERS  THEN 
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_HIERARCHY_EXTRACT',1,'ERROR',
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null);  --02/25/2014 --07/16/2014 Bug # 54917        
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_HIERARCHY_EXTRACT;


PROCEDURE PRC_ENROLLMENT_EXTRACT
    (parentNodeId      IN VARCHAR2,    
    p_in_pax_status IN VARCHAR2,   
    p_paxid       IN NUMBER,
    is_Team IN NUMBER,
    p_in_role IN VARCHAR2,    
    p_in_country_Ids IN VARCHAR2,
    p_in_department IN VARCHAR2,
    p_job_code IN VARCHAR2,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,   
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Participant Extract' for Admin.
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 12/28/2012  Initial Version
                            04/02/2014 Added fix for the defect # 52211
-- nagarajs       07/15/2014  Fixed Bug 54765 -  Enrollment Report not pulling Inactive participant
                              and fixed duplicate record issue
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--DeepikaM       04/26/2017 G6-2223 - Report to include TnC and Opt out columns
--Ravi Dhanekula 05/03/2017 G6-2298 - Adding term date column.
--Gorantla       03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   p_in_locale VARCHAR2(10):= locale;
   default_locale VARCHAR2(10); --04/02/2014 Added fix for the defect # 52211
   v_pattern    VARCHAR2(15);
   file_handler           UTL_FILE.file_type;
   v_extract varchar2(4000);
   v_file_location VARCHAR2(1000);
   directory_error exception;
    
     l_cursor  SYS_REFCURSOR;
   -- local variables
BEGIN
  
BEGIN ----04/02/2014 Added fix for the defect # 52211

SELECT string_val
  INTO default_locale
  FROM os_propertyset
 WHERE entity_name = 'default.language';

EXCEPTION WHEN OTHERS THEN
default_locale := 'en_US';
END;

DELETE temp_table_session;

INSERT INTO temp_table_session ------04/02/2014 Added fix for the defect # 52211
   SELECT asset_code, cms_name, cms_code
     FROM vw_cms_code_value vw
    WHERE     asset_code IN ('picklist.participantenrollmentsource.items',
                             'picklist.addresstype.items',
                             'picklist.department.type.items',
                             'picklist.positiontype.items',
                             'picklist.hierarchyrole.type.items',
                             'picklist.participantstatus.items',
                             'picklist.phonetype.items',
                             'picklist.emailtype.items',
                             'default.locale.items',
                             'picklist.statetype.items')
          AND locale = default_locale
          AND NOT EXISTS
                     (SELECT *
                        FROM vw_cms_code_value
                       WHERE     asset_code =
                                    'picklist.department.type.items'
                             AND locale = p_in_locale)
   UNION ALL
   SELECT asset_code, cms_name, cms_code
     FROM vw_cms_code_value E
    WHERE     asset_code IN ('picklist.participantenrollmentsource.items',
                             'picklist.addresstype.items',
                             'picklist.department.type.items',
                             'picklist.positiontype.items',
                             'picklist.hierarchyrole.type.items',
                             'picklist.participantstatus.items',
                             'picklist.phonetype.items',
                             'picklist.emailtype.items',
                             'default.locale.items',
                             'picklist.statetype.items')
          AND e.locale = p_in_locale
   UNION ALL
   SELECT asset_code, cms_value, key
     FROM vw_cms_asset_value vw
    WHERE     key = 'COUNTRY_NAME'
          AND locale = default_locale
          AND NOT EXISTS
                     (SELECT *
                        FROM vw_cms_code_value
                       WHERE     asset_code =
                                    'picklist.department.type.items'
                             AND locale = p_in_locale)
   UNION ALL
   SELECT asset_code, cms_value, key
     FROM vw_cms_asset_value
    WHERE key = 'COUNTRY_NAME' AND locale = p_in_locale;

DELETE chacracteristics_cms;

INSERT INTO chacracteristics_cms
   SELECT c.characteristic_id, vw.cms_name, vw.cms_code
     FROM characteristic c, vw_cms_code_value vw
    WHERE     pl_name IS NOT NULL
          AND vw.asset_code = c.pl_name
          AND locale = p_in_locale
   UNION                                                         --Bug # 50969
   SELECT characteristic_id,
          characteristic_value cms_name,
          characteristic_value cms_code
     FROM user_characteristic
    WHERE characteristic_id IN (SELECT characteristic_id
                                  FROM characteristic
                                 WHERE pl_name IS NULL)
   UNION
   SELECT characteristic_id, cms_name, cms_code
     FROM rpt_user_characteristic
    WHERE locale = p_in_locale;

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

IF p_file_name IS NULL THEN 
OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL  --12/18/2014
SELECT (ROWNUM+1),c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_init||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||user_name||c2_delimiter||c_delimiter||
         c2_delimiter||terms_acceptance||c2_delimiter||c_delimiter||  --04/26/2017 changes starts
         c2_delimiter||date_terms_accepted||c2_delimiter||c_delimiter||
         c2_delimiter||is_opt_out_of_awards||c2_delimiter||c_delimiter||
         c2_delimiter||date_opt_out_of_awards||c2_delimiter||c_delimiter||
         c2_delimiter||is_opt_out_of_program||c2_delimiter||c_delimiter||
         c2_delimiter||date_opt_out_of_program||c2_delimiter||c_delimiter||  --04/26/2017 changes ends
         c2_delimiter||language_preference||c2_delimiter||c_delimiter||
         c2_delimiter||primary_email_addr_type||c2_delimiter||c_delimiter||
         c2_delimiter||primary_email_address||c2_delimiter||c_delimiter||
         c2_delimiter||primary_phone_type||c2_delimiter||c_delimiter||
         c2_delimiter||primary_phone_number||c2_delimiter||c_delimiter||  
         c2_delimiter||country||c2_delimiter||c_delimiter|| 
         c2_delimiter||status||c2_delimiter||c_delimiter||          
         c2_delimiter||node_name||c2_delimiter||c_delimiter||  
         c2_delimiter||role||c2_delimiter||c_delimiter|| 
         c2_delimiter||job_position||c2_delimiter||c_delimiter|| 
         c2_delimiter||department||c2_delimiter||c_delimiter||  
         c2_delimiter||enrollment_date||c2_delimiter||c_delimiter|| 
         c2_delimiter||enrollment_source||c2_delimiter||c_delimiter|| 
         c2_delimiter||birth_date||c2_delimiter||c_delimiter||  
         c2_delimiter||title||c2_delimiter||c_delimiter|| 
         c2_delimiter||suffix||c2_delimiter||c_delimiter|| 
         c2_delimiter||gender||c2_delimiter||c_delimiter||  
         c2_delimiter||primary_address_type||c2_delimiter||c_delimiter|| 
         c2_delimiter||address1||c2_delimiter||c_delimiter|| 
         c2_delimiter||address2||c2_delimiter||c_delimiter||  
         c2_delimiter||address3||c2_delimiter||c_delimiter|| 
         c2_delimiter||city||c2_delimiter||c_delimiter|| 
         c2_delimiter||state||c2_delimiter||c_delimiter||  
         c2_delimiter||postal_code||c2_delimiter||c_delimiter|| 
         c2_delimiter||employer||c2_delimiter||c_delimiter||
         c2_delimiter||termination_date||c2_delimiter||c_delimiter||  --05/03/2017       
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
                                   c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        FROM (SELECT    red.first_name,        
         red.middle_init,
         red.last_name,
         usr.user_name,
         p.terms_acceptance, --04/26/2017 changes starts
         p.date_terms_accepted,
         decode (p.is_opt_out_of_awards,1,'Yes',0,'No') is_opt_out_of_awards,
         p.date_opt_out_of_awards,
         decode (p.is_opt_out_of_program,1,'Yes',0,'No') is_opt_out_of_program,
         p.date_opt_out_of_program, --04/26/2017 changes ends
         (select cms_name from temp_table_session where asset_code='default.locale.items' and
                                                                            cms_code= NVL(red.language_preference,default_locale)) language_preference, ----04/02/2014 Added fix for the defect # 52211
         (select cms_name from temp_table_session where asset_code='picklist.emailtype.items' and
                                                                            cms_code=red.primary_email_addr_type) primary_email_addr_type,                                                                   
         red.primary_email_address,
         (select cms_name from temp_table_session where asset_code='picklist.phonetype.items' and
                                                                            cms_code=red.primary_phone_type) primary_phone_type,     
         red.primary_phone_number,
          (select cms_name from temp_table_session where asset_code=country.cm_asset_code) country,
      (select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and
                                                                            cms_code=red.status) status,     
         rh.node_name,
            (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=red.role) role,  
             (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=red.job_position) job_position,  
          (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=red.department) department,  
         red.enrollment_date,
             (select cms_name from temp_table_session where asset_code='picklist.participantenrollmentsource.items' and
                                                                            cms_code=red.enrollment_source) enrollment_source,  
         red.birth_date,
         red.title,
         red.suffix,
         red.gender,
           (select cms_name from temp_table_session where asset_code='picklist.addresstype.items' and
                                                                            cms_code=red.primary_address_type) primary_address_type,  
         red.address1,
         red.address2,
         red.address3,
         red.city,
              (select cms_name from temp_table_session where asset_code='picklist.statetype.items' and
                                                                            cms_code=red.state) state,  
         red.postal_code,
         emp.name employer,
        p.termination_date, --05/03/2017
        (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End     
       ,  CASE  --12/18/2014
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
    FROM rpt_enrollment_detail red,
         rpt_characteristic rchar,
         rpt_hierarchy rh,
         country,
         application_user usr,
         rpt_characteristic rch,
         vw_curr_pax_employer pe,
         employer emp,
         participant p --04/26/2017
   WHERE     red.user_id = rchar.user_nt_id(+)
         AND rh.node_id = red.node_id
         AND usr.user_id = red.user_id(+)
         AND usr.user_id = rch.user_nt_id(+)
         AND rch.characteristic_type (+) = 'USER' --07/15/2014 Bug # 54765
         AND red.user_id = pe.user_id(+)
         AND red.hire_date = pe.hire_date(+)
         AND pe.employer_id = emp.employer_id(+)
         AND P.USER_ID = usr.USER_ID  --04/26/2017
         --AND pe.termination_date IS NULL  --07/15/2014 Bug # 54765
         AND NVL (rchar.characteristic_type, 'USER') = 'USER'
         AND country.country_id = red.country_id
         AND (red.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
         AND NVL (TRUNC (red.enrollment_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
         AND (red.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
         AND UPPER (red.role) = NVL (UPPER (P_IN_ROLE), UPPER (red.role))
         AND NVL(red.job_position,'job') = NVL (p_job_code, NVL(red.job_position,'job'))
         AND red.status = NVL (p_in_pax_status, red.status)
             AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND red.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND red.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  red.user_id=p_paxid))
ORDER BY node_name_sort asc, rh.path asc  --12/18/2014
--         ,red.FIRST_NAME asc, --12/18/2014
--         MIDDLE_INIT asc,   --12/18/2014
--         red.LAST_NAME asc,  --12/18/2014
--         USER_NAME asc    --12/18/2014
));
p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
      UNION ALL  --12/18/2014
SELECT (ROWNUM+1),c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_init||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||user_name||c2_delimiter||c_delimiter||
         c2_delimiter||terms_acceptance||c2_delimiter||c_delimiter||  --04/26/2017 changes starts
         c2_delimiter||date_terms_accepted||c2_delimiter||c_delimiter||
         c2_delimiter||is_opt_out_of_awards||c2_delimiter||c_delimiter||
         c2_delimiter||date_opt_out_of_awards||c2_delimiter||c_delimiter||
         c2_delimiter||is_opt_out_of_program||c2_delimiter||c_delimiter||
         c2_delimiter||date_opt_out_of_program||c2_delimiter||c_delimiter||  --04/26/2017 changes ends
         c2_delimiter||language_preference||c2_delimiter||c_delimiter||
         c2_delimiter||primary_email_addr_type||c2_delimiter||c_delimiter||
         c2_delimiter||primary_email_address||c2_delimiter||c_delimiter||
         c2_delimiter||primary_phone_type||c2_delimiter||c_delimiter||
         c2_delimiter||primary_phone_number||c2_delimiter||c_delimiter||  
         c2_delimiter||country||c2_delimiter||c_delimiter|| 
         c2_delimiter||status||c2_delimiter||c_delimiter||          
         c2_delimiter||node_name||c2_delimiter||c_delimiter||  
         c2_delimiter||role||c2_delimiter||c_delimiter|| 
         c2_delimiter||job_position||c2_delimiter||c_delimiter|| 
         c2_delimiter||department||c2_delimiter||c_delimiter||  
         c2_delimiter||enrollment_date||c2_delimiter||c_delimiter|| 
         c2_delimiter||enrollment_source||c2_delimiter||c_delimiter|| 
         c2_delimiter||birth_date||c2_delimiter||c_delimiter||  
         c2_delimiter||title||c2_delimiter||c_delimiter|| 
         c2_delimiter||suffix||c2_delimiter||c_delimiter|| 
         c2_delimiter||gender||c2_delimiter||c_delimiter||  
         c2_delimiter||primary_address_type||c2_delimiter||c_delimiter|| 
         c2_delimiter||address1||c2_delimiter||c_delimiter|| 
         c2_delimiter||address2||c2_delimiter||c_delimiter||  
         c2_delimiter||address3||c2_delimiter||c_delimiter|| 
         c2_delimiter||city||c2_delimiter||c_delimiter|| 
         c2_delimiter||state||c2_delimiter||c_delimiter||  
         c2_delimiter||postal_code||c2_delimiter||c_delimiter|| 
         c2_delimiter||employer||c2_delimiter||c_delimiter||          
         c2_delimiter||termination_date||c2_delimiter||c_delimiter||  --05/03/2017 
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
                                   c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
                                   c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        FROM (SELECT    red.first_name,        
         red.middle_init,
         red.last_name,
         usr.user_name,
         p.terms_acceptance, --04/26/2017 changes starts
         p.date_terms_accepted,
         decode (p.is_opt_out_of_awards,1,'Yes',0,'No') is_opt_out_of_awards,
         p.date_opt_out_of_awards,
         decode (p.is_opt_out_of_program,1,'Yes',0,'No') is_opt_out_of_program,
         p.date_opt_out_of_program, --04/26/2017 changes ends
         (select cms_name from temp_table_session where asset_code='default.locale.items' and
                                                                            cms_code= NVL(red.language_preference,default_locale)) language_preference, ----04/02/2014 Added fix for the defect # 52211
         (select cms_name from temp_table_session where asset_code='picklist.emailtype.items' and
                                                                            cms_code=red.primary_email_addr_type) primary_email_addr_type,                                                                   
         red.primary_email_address,
         (select cms_name from temp_table_session where asset_code='picklist.phonetype.items' and
                                                                            cms_code=red.primary_phone_type) primary_phone_type,     
         red.primary_phone_number,
          (select cms_name from temp_table_session where asset_code=country.cm_asset_code) country,
      (select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and
                                                                            cms_code=red.status) status,     
         rh.node_name,
            (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=red.role) role,  
             (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=red.job_position) job_position,  
          (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=red.department) department,  
         red.enrollment_date,
             (select cms_name from temp_table_session where asset_code='picklist.participantenrollmentsource.items' and
                                                                            cms_code=red.enrollment_source) enrollment_source,  
         red.birth_date,
         red.title,
         red.suffix,
         red.gender,
           (select cms_name from temp_table_session where asset_code='picklist.addresstype.items' and
                                                                            cms_code=red.primary_address_type) primary_address_type,  
         red.address1,
         red.address2,
         red.address3,
         red.city,
              (select cms_name from temp_table_session where asset_code='picklist.statetype.items' and
                                                                            cms_code=red.state) state,  
         red.postal_code,
         emp.name employer,
         p.termination_date, --05/03/2017
        (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End     
       ,  CASE  --12/18/2014
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
    FROM rpt_enrollment_detail red,
         rpt_characteristic rchar,
         rpt_hierarchy rh,
         country,
         application_user usr,
         rpt_characteristic rch,
         vw_curr_pax_employer pe,
         employer emp,
         participant p --04/26/2017
   WHERE     red.user_id = rchar.user_nt_id(+)
         AND rh.node_id = red.node_id
         AND usr.user_id = red.user_id(+)
         AND usr.user_id = rch.user_nt_id(+)
         AND rch.characteristic_type (+) = 'USER' --07/15/2014 Bug # 54765
         AND red.user_id = pe.user_id(+)
         AND red.hire_date = pe.hire_date(+)
         AND pe.employer_id = emp.employer_id(+)
         AND P.USER_ID = usr.USER_ID  --04/26/2017
         --AND pe.termination_date IS NULL  --07/15/2014 Bug # 54765
         AND NVL (rchar.characteristic_type, 'USER') = 'USER'
         AND country.country_id = red.country_id
         AND (red.country_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))
           OR (p_in_country_Ids is NULL))
         AND NVL (TRUNC (red.enrollment_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
         AND (red.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
         AND UPPER (red.role) = NVL (UPPER (P_IN_ROLE), UPPER (red.role))
         AND NVL(red.job_position,'job') = NVL (p_job_code, NVL(red.job_position,'job'))
         AND red.status = NVL (p_in_pax_status, red.status)
             AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND red.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND red.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  red.user_id=p_paxid))
ORDER BY node_name_sort asc, rh.path asc  --12/18/2014
--         ,red.FIRST_NAME asc, --12/18/2014
--         MIDDLE_INIT asc,   --12/18/2014
--         red.LAST_NAME asc,  --12/18/2014
--         USER_NAME asc    --12/18/2014
));

-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019 
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;

    UTL_FILE.fclose(file_handler);

	
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;
EXCEPTION
    WHEN OTHERS  THEN 
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_ENROLLMENT_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_pax_status||': '||' p_in_pax_status'||p_paxid ||': '||' p_paxid '|| --07/16/2014 Bug # 54917
        is_Team||': '||' is_Team'||p_in_role ||': '||' p_in_role '||p_in_country_Ids||': '||' p_in_country_Ids'||
        p_in_department||': '||' p_in_department'||p_job_code||': '||' p_job_code'||p_in_from_date||': '||' p_in_from_date'||
        p_in_to_date||': '||' p_in_to_date'||locale||': '||' locale'||p_file_name||': '||' p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null); --02/25/2014        
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_ENROLLMENT_EXTRACT;

 PROCEDURE PRC_INDIVIDUAL_ACT_EXTRACT
   (p_user_id IN NUMBER,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,     
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header_summary IN VARCHAR2,
    p_header_allAwards IN VARCHAR2,
    p_header_onTheSpot IN VARCHAR2,
    p_header_goalquest IN VARCHAR2,
    p_header_challengepoint IN VARCHAR2,
    p_header_nominationsReceived IN VARCHAR2,
    p_header_nominationsGiven IN VARCHAR2,
    p_header_productClaims IN VARCHAR2,
    p_header_recognitionsGiven IN VARCHAR2,
    p_header_recognitionsReceived IN VARCHAR2,
    p_header_quizSummary IN VARCHAR2,
    p_header_quizDetail IN VARCHAR2,
    p_header_throwdown IN VARCHAR2,
    p_header_badge IN VARCHAR2,--01/23/2015
    p_header_ssi_contests IN VARCHAR2, --04/27/2015
    p_header_ssi_contests_sec IN VARCHAR2, --04/27/2015
    p_module_type        IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for ''Individual Activity extract' .
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula   01/07/2013  Initial Version  
-- Suresh J         04/01/2014  Added temp table temp_table_session to fetch the CM data to fix performance issue.
-- Ravi Dhanekula   04/04/2014  Fixed the bug # 51009
-- nagarajs         07/16/2014  Bug # 54917 - close the file and include parms value when OTHER exception
-- Suresh J         09/12/2014  Bug # 56491 - Fixed points column for recognition given
-- Suresh J         09/23/2014  Bug # 56844 - In Individual Activity report the OTS serial number should start with #
-- Swati            09/29/2014  Bug 57024 - Individual Activity report the extract value first letter should be displayed in capital letter
-- Ravi Dhanekula   09/26/2014  Bug # 56902 - Added Challenegepoint info to Extract.
-- Suresh J         10/01/2014  Bug# 57071,57076 -- Updated Points to Include Basic Points also
-- Ravi Dhanekula   01/23/2015  Bug # 59285 -- Include badge awards too.
-- Swati            04/27/2015  SSI-Phase II Including SSI to Individual Extracts Report
-- Suresh J         07/03/2015  Bug 63071 - SSI Contest Name didn't get translated  
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   -- local variables
      file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;    
     l_cursor  SYS_REFCURSOR;
     
     p_in_locale VARCHAR2(10):=locale;
     v_pattern    VARCHAR2(15);
     
     --Data check variables
     
     v_gq_count NUMBER;
    
BEGIN

DELETE temp_table_session;

INSERT INTO temp_table_session
SELECT asset_code,cms_name,cms_code
FROM vw_cms_code_value E
WHERE asset_code in ( 'picklist.claim.status.type.items') and e.locale=p_in_locale
UNION ALL
SELECT asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key='GOALS' and locale = p_in_locale
UNION ALL --07/03/2015
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key in ('CONTEST_NAME','SSI_CONTEST') and locale = p_in_locale   --07/03/2015 
UNION ALL 
SELECT asset_code, cms_value, key from mv_cms_asset_value WHERE key = 'OTS_BATCH_NAME_' AND locale = p_in_locale; --03/07/2018

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;


IF p_file_name IS NULL THEN 
          prc_execution_log_entry('PRC_INDIVIDUAL_ACT_EXTRACT',1,'INFO','p_module_type'||p_module_type||' '||'p_user_id'||p_user_id||' '||'p_header_summary'||p_header_summary,NULL);   
OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header_summary 
         Textline
        FROM dual where  p_module_type is NULL
      UNION ALL
        SELECT (ROWNUM+1),
c2_delimiter||Activity||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||Plateau_Earned||c2_delimiter||c_delimiter||
c2_delimiter||Sweepstakes_Won||c2_delimiter||c_delimiter||
c2_delimiter||Received||c2_delimiter||c_delimiter||
c2_delimiter||Sent||c2_delimiter||c_delimiter||
c2_delimiter||Other_Awards||c2_delimiter--04/27/2015
FROM ( 
 SELECT 'GoalQuest' AS Activity,
         SUM (NVL (calculated_payout, 0)) AS Points,
         0 AS Plateau_Earned,
         0 AS Sweepstakes_Won,          
           NVl(COUNT(rpt_goal_selection_detail_id),0) AS Received, 
           NULL AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_goal_selection_detail
   WHERE user_id = NVL (p_user_id, user_id)
         AND p_module_type is NULL
         AND TRUNC (trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id
UNION ALL --09/26/2014 Bug # 56902 Start
SELECT 'ChallengePoint' AS Activity,
--         SUM (NVL (calculated_payout, 0)) AS Points,  --10/01/2014
         SUM((NVL(calculated_payout,0)+NVL(basic_award_deposited,0))) AS Points,   --10/01/2014
         0 AS Plateau_Earned,
         0 AS Sweepstakes_Won,         
           NVl(COUNT(rpt_cp_selection_detail_id),0) AS Received, 
           NULL AS Sent,
         0 AS Other_Awards        --04/27/2015  
    FROM rpt_cp_selection_detail
   WHERE user_id = NVL (p_user_id, user_id)
         AND p_module_type is NULL
         AND TRUNC (trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id ----09/26/2014 Bug # 56902 End
UNION ALL ----1/23/2015
SELECT 'Badge' AS Activity,
         SUM(NVL(media_amount,0)) AS Points,   
         0 AS Plateau_Earned,
         0 AS Sweepstakes_Won,          
         0 AS Received, 
           NULL AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_awardmedia_detail
   WHERE user_id = NVL (p_user_id, user_id)
         AND p_module_type is NULL
         AND promotion_type = 'badge'
         AND TRUNC (media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id
UNION ALL
  SELECT 'Nomination Received' AS Activity,
         SUM (points_award_amt) AS Points,
         SUM (DECODE (promotion_award_type, 'merchandise', 1, 0)) AS Plateau_Earned,         
         NVL(SUM (sweepstakes_won),0) AS Sweepstakes_Won,         
         NVL(COUNT(claim_id),0) AS Received, 
         0 AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_nomination_detail
   WHERE recvr_user_id = NVL (p_user_id, recvr_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY recvr_user_id
UNION ALL
  SELECT 'Nomination Submitted' AS Activity,
         0 AS Points,
         0 AS Plateau_Earned,         
         0 AS Sweepstakes_Won,         
         0 AS Received, 
         NVL(COUNT(claim_id),0) AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_nomination_detail
   WHERE giver_user_id = NVL (p_user_id, giver_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
      --   AND giver_sweepstakes_points > 0
GROUP BY giver_user_id
UNION ALL
  SELECT 'Product Claims' AS Activity,
         NVL (SUM (submitter_points), 0) AS Points,
         NVL (SUM (DECODE (award_type, 'merchandise', 1, 0)), 0)
            AS Plateau_Earned,         
         NVL (SUM (submitter_sweepstakes_won), 0) AS Sweepstakes_Won,         
         NVL(count(RPT_CLAIM_DETAIL_ID),0) AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_claim_detail
   WHERE submitter_user_id = NVL (p_user_id, submitter_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY submitter_user_id
UNION ALL
  SELECT 'Recognitions Received' AS Activity,
         NVL (SUM (award_amt), 0) AS Points,
         NVL (SUM (recvr_plateau_earned), 0) AS Plateau_Earned,         
         NVL (SUM (recvr_sweepstakes_won), 0) AS Sweepstakes_Won,         
         NVL(count(claim_id),0) AS Received, 
           0             AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_recognition_detail
   WHERE recvr_user_id = NVL (p_user_id, recvr_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY recvr_user_id
UNION ALL
  SELECT 'Recognitions Given' AS Activity,
          NVL (SUM (award_amt), 0) AS Points,  --09/12/2014
         0 AS Plateau_Earned,         
         NVL(SUM (giver_sweepstakes_won),0) AS Sweepstakes_Won,         
         0 AS Received, 
           NVL(count(claim_id),0)             AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_recognition_detail
   WHERE giver_user_id = NVL (p_user_id, giver_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY giver_user_id
UNION
  SELECT 'Quizzes' AS Activity,
         NVL (SUM (award_amount), 0) AS Points,
         NVL (SUM (DECODE (award_type, 'merchandise', 1, 0)), 0)
            AS Plateau_Earned,         
         NVL (SUM (sweepstakes_won), 0) AS Sweepstakes_Won,         
         NVL(COUNT(quiz_claim_id),0) AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_quiz_activity_detail
   WHERE  p_module_type is NULL 
         AND  participant_id = NVL (p_user_id, participant_id)         
         AND NVL (TRUNC (quiz_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY participant_id
UNION
  SELECT 'Throwdown' AS Activity,
         NVL (SUM (payout), 0) AS Points,
         0        AS Plateau_Earned,         
         0        AS Sweepstakes_Won,         
         0 AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_throwdown_activity rpt
   WHERE  p_module_type is NULL 
         AND  user_id = NVL (p_user_id, user_id)         
         AND NVL (TRUNC (payout_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id
UNION
  SELECT CASE WHEN r.batch_description IS NULL THEN 
         (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT') 
         WHEN r.batch_description like '%'||gc_str_token THEN REPLACE(r.batch_description,gc_str_token)                      --03/07/2018 
         ELSE (SELECT t.cms_name FROM temp_table_session t WHERE t.asset_code=r.batch_description) END  AS Activity, --03/07/2018   added case
         NVL (SUM (transaction_amount), 0) AS Points,
         0 AS Plateau_Earned,         
         0 AS Sweepstakes_Won,         
         COUNT(qcard_detail_id) AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_qcard_detail r
   WHERE  p_module_type is NULL
         AND user_id = NVL (p_user_id, user_id)
         AND NVL (TRUNC (trans_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY r.user_id,
         r.batch_description --03/07/2018
UNION --04/27/2015
  SELECT 'Contests' AS Activity,
         NVL (SUM (POINTS), 0) AS Points,
         0 AS Plateau_Earned,         
         0 AS Sweepstakes_Won,         
         0 AS Received, 
         0 AS Sent,
         NVL (SUM (OTHER), 0) AS Other_Awards
    FROM rpt_ssi_contest_detail r
   WHERE  p_module_type is NULL
         AND user_id = NVL (p_user_id, user_id)
         AND NVL (TRUNC (PAYOUT_ISSUE_DATE), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
GROUP BY r.user_id
)
WHERE p_module_type is NULL
UNION ALL
SELECT 1,' ' FROM  rpt_goal_selection_detail rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'GoalQuest' FROM rpt_goal_selection_detail rpt
WHERE NVL(p_module_type,'goalquest')='goalquest' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_goalquest FROM rpt_goal_selection_detail rpt
WHERE NVL(p_module_type,'goalquest')='goalquest' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||Level_Selected||c2_delimiter||c_delimiter||
c2_delimiter||Base||c2_delimiter||c_delimiter||
c2_delimiter||Goal||c2_delimiter||c_delimiter||
c2_delimiter||Actual_Results||c2_delimiter||c_delimiter||
c2_delimiter||Pct_of_Goal||c2_delimiter||c_delimiter||
c2_delimiter||Achieved||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned||c2_delimiter
FROM ( 
SELECT rpt.Promotion_name           AS PROMOTION, 
--       FNC_CMS_ASSET_CODE_VAL_EXTR(goal_level_name,'GOALS',locale)                   AS Level_Selected, 
       (SELECT cms_name FROM temp_table_session WHERE cms_code='GOALS' AND asset_code=goal_level_name) AS Level_Selected,  --04/01/2014
       rpt.base_quantity                 AS Base, 
       rpt.amount_to_achieve             AS Goal, 
       rpt.current_value                 AS Actual_Results, 
       rpt.percent_of_goal               AS Pct_of_Goal, 
       DECODE(rpt.achieved,1,'Yes','No') AS Achieved, 
       NVL(rpt.calculated_payout,0)             AS Points, 
       rpt.plateau_earned               
     FROM rpt_goal_selection_detail rpt 
     WHERE TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015
     )   
     WHERE NVL(p_module_type,'goalquest')='goalquest'      
     UNION ALL --01/23/2015
SELECT 1,' ' FROM  rpt_awardmedia_detail rpt
WHERE  p_module_type is NULL
     AND rpt.promotion_type = 'badge'
     AND TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'Badge' FROM rpt_awardmedia_detail rpt
WHERE NVL(p_module_type,'badge')='badge' 
     AND TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_badge FROM rpt_awardmedia_detail rpt
WHERE NVL(p_module_type,'badge')='badge' 
     AND rpt.promotion_type = 'badge' 
     AND TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||Award_Date||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter
FROM ( 
SELECT rpt.Promotion_name           AS PROMOTION, 
            rpt.media_date                   AS Award_date,
       rpt.media_amount                 AS Points  
     FROM rpt_awardmedia_detail rpt 
     WHERE TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern)
     AND rpt.promotion_type = 'badge'
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name
     )   
     WHERE NVL(p_module_type,'badge')='badge'     
 UNION ALL
SELECT 1,' ' FROM  rpt_cp_selection_detail rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'ChallengePoint' FROM rpt_cp_selection_detail rpt
WHERE NVL(p_module_type,'challengepoint')='challengepoint' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_challengepoint FROM rpt_cp_selection_detail rpt
WHERE NVL(p_module_type,'challengepoint')='challengepoint' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL ----09/26/2014 Bug # 56902 Start
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||Level_Selected||c2_delimiter||c_delimiter||
c2_delimiter||Base||c2_delimiter||c_delimiter||
c2_delimiter||Goal||c2_delimiter||c_delimiter||
c2_delimiter||Actual_Results||c2_delimiter||c_delimiter||
c2_delimiter||Pct_of_Goal||c2_delimiter||c_delimiter||
c2_delimiter||Achieved||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned||c2_delimiter
FROM ( 
SELECT rpt.Promotion_name           AS PROMOTION, 
       rpt.level_id AS Level_Selected,  --04/01/2014
       rpt.base_quantity                 AS Base, 
       rpt.amount_to_achieve             AS Goal, 
       rpt.current_value                 AS Actual_Results, 
--       NULL              AS Pct_of_Goal,  --10/01/2014 
       DECODE(rpt.amount_to_achieve,0,0,ROUND((NVL(rpt.current_value,0)/rpt.amount_to_achieve)*100,2)) AS Pct_of_Goal, --10/01/2014
       DECODE(rpt.achieved,1,'Yes','No') AS Achieved, 
--       NVL(rpt.calculated_payout,0)             AS Points,   --10/01/2014 
       (NVL(rpt.calculated_payout,0)+NVL(rpt.basic_award_deposited,0)) AS Points,   --10/01/2014
       NULL plateau_earned               
     FROM rpt_cp_selection_detail rpt 
     WHERE TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015
     )   
     WHERE NVL(p_module_type,'challengepoint')='challengepoint' 
 UNION ALL ----09/26/2014 Bug # 56902 End
 SELECT 1,' ' FROM  rpt_nomination_detail  rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'NominationReceived' FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsReceived')='nominationsReceived' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_nominationsReceived FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsReceived')='nominationsReceived' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id)
     AND ROWNUM<2 
    UNION ALL
   SELECT 1,
          c2_delimiter||promotion||c2_delimiter||c_delimiter||
          c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
          c2_delimiter||nominator||c2_delimiter||c_delimiter||
          c2_delimiter||points||c2_delimiter||c_delimiter||
          c2_delimiter||sweepstakes_won||c2_delimiter||c_delimiter||
          c2_delimiter||initcap(status)||c2_delimiter --09/29/2014  Bug 57024
     FROM ( 
            SELECT rpt.Promotion_name AS promotion, 
                   date_submitted AS date_submitted, 
                   fnc_format_user_name(rpt.giver_last_name, rpt.giver_first_name) AS nominator, 
                   NVL(rpt.points_award_amt,0) AS points, 
-- commented until report table design finalized
--       NVL(rpt.recvr_sweepstakes_won,0) AS sweepstakes_won, 
0 AS sweepstakes_won, 
                   rpt.recvr_pax_status AS status                
              FROM rpt_nomination_detail rpt 
             WHERE rpt.date_submitted BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
              AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
             ORDER BY rpt.Promotion_name   --01/05/2015
          )   
    WHERE NVL(p_module_type,'nominationsReceived')='nominationsReceived'
UNION ALL
           SELECT 1,' ' FROM  rpt_nomination_detail  rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'NominationSubmitted' FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsGiven')='nominationsGiven' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_nominationsGiven FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsGiven')='nominationsGiven' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
    UNION ALL
   SELECT 1,
          c2_delimiter||promotion||c2_delimiter||c_delimiter||
          c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
          c2_delimiter||nominee||c2_delimiter||c_delimiter||
          c2_delimiter||points||c2_delimiter||c_delimiter||
          c2_delimiter||sweepstakes_won||c2_delimiter
     FROM ( 
            SELECT rpt.Promotion_name AS promotion, 
                   date_submitted, 
                   fnc_format_user_name(rpt.recvr_last_name, rpt.recvr_first_name) AS nominee, 
                   NVL(rpt.points_award_amt,0) AS points, 
-- commented until report table design finalized
--       NVL(rpt.giver_sweepstakes_won,0) AS sweepstakes_won                 
0 AS sweepstakes_won                 
              FROM rpt_nomination_detail rpt 
             WHERE rpt.date_submitted BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
               AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
             ORDER BY rpt.Promotion_name   --01/05/2015     
          )   
    WHERE NVL(p_module_type,'nominationsGiven')='nominationsGiven'     
      UNION ALL
           SELECT 1,' ' FROM  rpt_qcard_detail  rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,CASE WHEN rpt.batch_description IS NULL THEN 
         (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT') 
         WHEN rpt.batch_description like '%'||gc_str_token THEN REPLACE(rpt.batch_description,gc_str_token)              --03/07/2018 
         ELSE (SELECT t.cms_name FROM temp_table_session t WHERE t.asset_code=rpt.batch_description) END  AS Activity  --03/07/2018
	 FROM rpt_qcard_detail rpt
WHERE NVL(p_module_type,'onTheSpot')='onTheSpot' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_onTheSpot FROM rpt_qcard_detail rpt
WHERE NVL(p_module_type,'onTheSpot')='onTheSpot' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||Trans_Date||c2_delimiter||c_delimiter||
c2_delimiter||Recipient||c2_delimiter||c_delimiter||
c2_delimiter||Org_Name||c2_delimiter||c_delimiter||
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||OnTheSpot||c2_delimiter
FROM ( 
SELECT trans_date AS Trans_Date, 
       user_full_name          AS Recipient, 
       node_name                 AS Org_Name, 
       NVL(transaction_amount,0) AS Points, 
       '#'||cert_num                  AS OnTheSpot    --09/23/2014               
     FROM rpt_qcard_detail rpt 
     WHERE 
      TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id)
     ORDER BY rpt.trans_date   --01/05/2015
      )   
     WHERE NVL(p_module_type,'onTheSpot')='onTheSpot'     
     UNION ALL
           SELECT 1,' ' FROM  rpt_claim_detail   rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'ProductClaims' FROM rpt_claim_detail  rpt
WHERE NVL(p_module_type,'productClaims')='productClaims' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_productClaims FROM rpt_claim_detail  rpt
WHERE NVL(p_module_type,'productClaims')='productClaims' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||claim_number||c2_delimiter||c_delimiter||
c2_delimiter||promotion||c2_delimiter||c_delimiter||
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||sold_to||c2_delimiter||c_delimiter||
c2_delimiter||initcap(claim_status)||c2_delimiter||c_delimiter||----09/29/2014  Bug 57024
c2_delimiter||points||c2_delimiter --bug # 51009--04/04/2014
FROM ( 
SELECT rpt.claim_number                                                                     AS claim_number, 
       rpt.promotion_name                                                                        AS promotion, 
       rpt.date_submitted                                                                        AS date_submitted, 
       rpt.claim_company_name                                                                    AS sold_to, 
--       fnc_cms_picklist_value('picklist.claim.status.type.items',rpt.claim_status,locale) AS claim_status       
      (select cms_name from temp_table_session where asset_code='picklist.claim.status.type.items' and cms_code=rpt.claim_status) AS claim_status,   --04/01/2014 
      rpt.submitter_points Points --bug # 51009--04/04/2014
     FROM rpt_claim_detail  rpt 
     WHERE 
      TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015     
     )   
     WHERE NVL(p_module_type,'productClaims')='productClaims'
          UNION ALL     
          SELECT 1,' ' FROM  rpt_recognition_detail rpt
WHERE p_module_type is NULL
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id)      
     AND ROWNUM<2
UNION ALL
SELECT 1,'Recognitions Given' FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsGiven')='recognitionsGiven' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_recognitionsGiven FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsGiven')='recognitionsGiven' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promo_name||c2_delimiter||c_delimiter||
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||receiver_name||c2_delimiter||c_delimiter||
c2_delimiter||points_cnt||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won_cnt||c2_delimiter
FROM ( 
SELECT rpt.promotion_name          AS promo_name, 
       rpt.date_submitted               AS date_submitted, 
       rpt.recvr_full_name              AS receiver_name, 
       NVL(rpt.award_amt,0)             AS points_cnt, 
       NVL(giver_sweepstakes_won,0)                                AS sweepstakes_won_cnt                
     FROM rpt_recognition_detail rpt 
     WHERE  TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015     
     )   
     WHERE NVL(p_module_type,'recognitionsGiven')='recognitionsGiven'  
     UNION ALL    
     SELECT 1,' ' FROM  rpt_recognition_detail rpt
WHERE p_module_type is NULL
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id)      
     AND ROWNUM<2
UNION ALL
SELECT 1,'Recognitions Received' FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsReceived')='recognitionsReceived' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_recognitionsReceived FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsReceived')='recognitionsReceived' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||giver_full_name||c2_delimiter||c_delimiter||
c2_delimiter||points_cnt||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned_cnt||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won_cnt||c2_delimiter||c_delimiter||
c2_delimiter||initcap(status)||c2_delimiter--09/29/2014  Bug 57024
FROM ( 
SELECT rpt.Promotion_name           AS promotion, 
       date_submitted                   AS date_submitted, 
       rpt.giver_full_name                 AS giver_full_name, 
       NVL(rpt.award_amt,0)             AS points_cnt, 
       NVL(rpt.recvr_plateau_earned,0)  AS plateau_earned_cnt, 
       NVL(rpt.recvr_sweepstakes_won,0) AS sweepstakes_won_cnt, 
       rpt.recvr_pax_status             AS status               
     FROM rpt_recognition_detail rpt 
     WHERE  TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015     
     )   
     WHERE NVL(p_module_type,'recognitionsReceived')='recognitionsReceived'  
     UNION ALL     
          SELECT 1,' ' FROM  rpt_quiz_activity_detail  rpt
WHERE p_module_type is NULL
     AND NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
       AND participant_id = NVL(p_user_id,participant_id)  
       AND ROWNUM<2
UNION ALL
SELECT 1,'Quizzes' FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizSummary')='quizSummary' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_quizSummary FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizSummary')='quizSummary' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promo_quiz_name||c2_delimiter||c_delimiter||
c2_delimiter||attempts||c2_delimiter||c_delimiter||
c2_delimiter||passed||c2_delimiter||c_delimiter||
c2_delimiter||failed||c2_delimiter||c_delimiter||
c2_delimiter||progress||c2_delimiter||c_delimiter||
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won||c2_delimiter||c_delimiter||
c2_delimiter||initcap(result)||c2_delimiter--09/29/2014  Bug 57024
FROM ( 
SELECT rpt.promo_quiz_name, 
         rpt.participant_id, 
         COUNT(rpt.rpt_quiz_activity_detail_id) attempts, 
         SUM(DECODE(quiz_result,'passed',1,0)) passed, 
         SUM(DECODE(quiz_result,'failed',1,0)) failed, 
         SUM(DECODE(quiz_result,'progress',1,0)) progress, 
         SUM(AWARD_AMOUNT) points, 
         NVL(SUM(SWEEPSTAKES_WON),0) sweepstakes_won, 
         pkg_quiz_reports.fnc_get_quiz_result(rpt.participant_id,rpt.promo_quiz_name) result 
       FROM rpt_quiz_activity_detail rpt 
       WHERE NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
       AND participant_id = NVL(p_user_id,participant_id) 
       GROUP BY rpt.promo_quiz_name, 
         rpt.participant_id 
     ORDER BY rpt.promo_quiz_name   --01/05/2015
       )    
     WHERE NVL(p_module_type,'quizSummary')='quizSummary'   
     UNION ALL     
          SELECT 1,' ' FROM  rpt_quiz_activity_detail  rpt
WHERE p_module_type is NULL
     AND NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
       AND participant_id = NVL(p_user_id,participant_id)  
       AND ROWNUM<2
UNION ALL
SELECT 1,'QuizDetail' FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizDetail')='quizDetail' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_quizDetail FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizDetail')='quizDetail' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promotion||c2_delimiter||c_delimiter||
c2_delimiter||quiz_date||c2_delimiter||c_delimiter||
c2_delimiter||initcap(quiz_result)||c2_delimiter||c_delimiter||--09/29/2014  Bug 57024
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won||c2_delimiter
FROM ( 
SELECT promo_quiz_name AS promotion, 
       quiz_date            AS quiz_date, 
       quiz_result          AS quiz_result, 
       award_amount         AS points, 
       sweepstakes_won      AS sweepstakes_won
     FROM rpt_quiz_activity_detail 
     WHERE NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND participant_id = NVL(p_user_id,participant_id)
     ORDER BY promo_quiz_name   --01/05/2015
       )    
     WHERE NVL(p_module_type,'quizDetail')='quizDetail'
     UNION ALL
SELECT 1,'Throwdown' FROM rpt_throwdown_activity rpt
WHERE NVL(p_module_type,'Throwdown')='Throwdown'
     AND TRUNC(rpt.payout_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id)
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_throwdown FROM rpt_throwdown_activity rpt
WHERE NVL(p_module_type,'throwdown')='throwdown'
     AND TRUNC(rpt.payout_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
c2_delimiter||round_number||c2_delimiter||c_delimiter||
c2_delimiter||Wins||c2_delimiter||c_delimiter||
c2_delimiter||Ties||c2_delimiter||c_delimiter||
c2_delimiter||Losses||c2_delimiter||c_delimiter||
c2_delimiter||activity||c2_delimiter||c_delimiter||
c2_delimiter||rank||c2_delimiter||c_delimiter||
c2_delimiter||payout||c2_delimiter
FROM ( 
WITH pax_rank AS
(SELECT 
ts.promotion_id,ts.round_number,tsp.user_id,tsp.rank 
FROM 
throwdown_stackrank ts,
throwdown_stackrank_node tsn,
throwdown_stackrank_pax tsp
WHERE
ts.stackrank_id = tsn.stackrank_id
AND ts.round_number is NOT NULL
AND tsn.stackrank_node_id = tsp.stackrank_node_id
AND tsp.user_id = p_user_id)
SELECT 
rpt.promotion_name,rpt.round_number,SUM (DECODE(outcome,'win',1,0)) Wins,SUM (DECODE(outcome,'tie',1,0)) Ties,SUM (DECODE(outcome,'loss',1,0)) Losses,SUM (current_value) activity,pax_rank.RANK,SUM(payout) AS payout
  FROM rpt_throwdown_activity rpt,
  pax_rank
WHERE rpt.user_id = p_user_id
AND rpt.promotion_id = pax_rank.promotion_id(+)
AND NVL(p_module_type,'throwdown')='throwdown' 
AND TRUNC(rpt.payout_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
AND rpt.round_number = pax_rank.round_number(+)
GROUP BY 
rpt.promotion_name,rpt.round_number,pax_rank.rank
ORDER BY rpt.promotion_name   --01/05/2015
)
UNION ALL--04/27/2015
SELECT 1,' ' FROM  rpt_ssi_contest_detail rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'SSIContests' FROM rpt_ssi_contest_detail rpt
WHERE NVL(p_module_type,'ssicontests')='ssicontests' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_ssi_contests FROM rpt_ssi_contest_detail rpt
WHERE NVL(p_module_type,'ssicontests')='ssicontests' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||Contest_Name||c2_delimiter||c_delimiter||
c2_delimiter||Payout_Issue_Date||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||Other||c2_delimiter
FROM ( 
SELECT (select cms_name from temp_table_session where cms_code='CONTEST_NAME' AND asset_code = rpt.ssi_contest_name) AS Contest_Name,  --07/03/2015 
--      ssi_contest_name AS Contest_Name,
      payout_issue_date Payout_Issue_Date,points Points,other Other        
     FROM rpt_ssi_contest_detail rpt 
     WHERE TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   
     )   
     WHERE NVL(p_module_type,'ssicontests')='ssicontests'  
UNION ALL--04/27/2015
SELECT 1,'SSIContests' FROM rpt_ssi_contest_detail rpt
WHERE p_module_type = 'ssicontests_sec' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_ssi_contests_sec FROM rpt_ssi_contest_detail rpt
WHERE p_module_type = 'ssicontests_sec' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||Contest_Name||c2_delimiter||c_delimiter||
c2_delimiter||Payout_Issue_Date||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||Other||c2_delimiter||c_delimiter||
c2_delimiter||Other_Value||c2_delimiter
FROM ( 
SELECT (select cms_name from temp_table_session where cms_code='CONTEST_NAME' AND asset_code = rpt.ssi_contest_name) AS Contest_Name,  --07/03/2015
     -- ssi_contest_name AS Contest_Name,
      payout_issue_date Payout_Issue_Date,points Points,other Other,other_value Other_Value        
     FROM rpt_ssi_contest_detail rpt 
     WHERE TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   
     )   
     WHERE p_module_type = 'ssicontests_sec'       
UNION ALL     
          SELECT 1,' ' FROM  (SELECT media_date                                                    AS date_submitted      
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted       
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     )
WHERE p_module_type is NULL and rownum<2 
UNION ALL
SELECT 1,'AllAwards' FROM  (SELECT media_date                                                    AS date_submitted      
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted       
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     )
WHERE p_module_type='allAwards' and rownum<2 
     UNION ALL
SELECT 1,    p_header_allAwards FROM  (SELECT media_date                                                    AS date_submitted      
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted       
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     )
WHERE p_module_type='allAwards' and rownum<2 
UNION ALL
        SELECT 1,
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||recipient||c2_delimiter||c_delimiter||
c2_delimiter||sender||c2_delimiter||c_delimiter||
c2_delimiter||org_name||c2_delimiter||c_delimiter||
c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won||c2_delimiter||c_delimiter||
c2_delimiter||onthespot||c2_delimiter
FROM ( 
SELECT media_date                                                    AS date_submitted, 
       participant_name                                                   AS recipient, 
       fnc_format_user_name(sender_last_name,sender_first_name,NULL,NULL) AS sender, 
       node_name                                                          AS org_name, 
       r.Promotion_name                                                   AS promotion_name, 
       NVL(points,0)                                                      AS points, 
       NVL(plateau_earned,0)                                              AS plateau_earned, 
       NVL(sweepstakes_won,0)                                             AS sweepstakes_won, 
       NULL                                                               AS onthespot 
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted, 
       user_full_name            AS recipient, 
       NULL                      AS sender, 
       node_name                 AS org_name, 
       NULL                      AS promotion_name, 
       NVL(transaction_amount,0) AS points, 
       0                         AS plateau_earned, 
       0                         AS sweepstakes_won, 
       '#'||cert_num                  AS onthespot    --09/23/2014
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     ORDER BY date_submitted    --01/05/2015
       )    
     WHERE p_module_type='allAwards'      
 )
 ;

p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
 
OPEN l_cursor FOR
     -- column headers
       SELECT textline FROM (
        SELECT 1,p_header_summary 
         Textline
        FROM dual where  p_module_type is NULL
      UNION ALL
        SELECT (ROWNUM+1),
c2_delimiter||Activity||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||Plateau_Earned||c2_delimiter||c_delimiter||
c2_delimiter||Sweepstakes_Won||c2_delimiter||c_delimiter||
c2_delimiter||Received||c2_delimiter||c_delimiter||
c2_delimiter||Sent||c2_delimiter||c_delimiter||
c2_delimiter||Other_Awards||c2_delimiter--04/27/2015
FROM ( 
 SELECT 'GoalQuest' AS Activity,
         SUM (NVL (calculated_payout, 0)) AS Points,
         0 AS Plateau_Earned,
         0 AS Sweepstakes_Won,          
           NVl(COUNT(rpt_goal_selection_detail_id),0) AS Received, 
           NULL AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_goal_selection_detail
   WHERE user_id = NVL (p_user_id, user_id)
         AND p_module_type is NULL
         AND TRUNC (trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id
UNION ALL --09/26/2014 Bug # 56902 Start
SELECT 'ChallengePoint' AS Activity,
--         SUM (NVL (calculated_payout, 0)) AS Points,  --10/01/2014
         SUM((NVL(calculated_payout,0)+NVL(basic_award_deposited,0))) AS Points,   --10/01/2014
         0 AS Plateau_Earned,
         0 AS Sweepstakes_Won,         
           NVl(COUNT(rpt_cp_selection_detail_id),0) AS Received, 
           NULL AS Sent,
         0 AS Other_Awards        --04/27/2015  
    FROM rpt_cp_selection_detail
   WHERE user_id = NVL (p_user_id, user_id)
         AND p_module_type is NULL
         AND TRUNC (trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id ----09/26/2014 Bug # 56902 End
UNION ALL ----1/23/2015
SELECT 'Badge' AS Activity,
         SUM(NVL(media_amount,0)) AS Points,   
         0 AS Plateau_Earned,
         0 AS Sweepstakes_Won,          
         0 AS Received, 
           NULL AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_awardmedia_detail
   WHERE user_id = NVL (p_user_id, user_id)
         AND p_module_type is NULL
         AND promotion_type = 'badge'
         AND TRUNC (media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id
UNION ALL
  SELECT 'Nomination Received' AS Activity,
         SUM (points_award_amt) AS Points,
         SUM (DECODE (promotion_award_type, 'merchandise', 1, 0)) AS Plateau_Earned,         
         NVL(SUM (sweepstakes_won),0) AS Sweepstakes_Won,         
         NVL(COUNT(claim_id),0) AS Received, 
         0 AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_nomination_detail
   WHERE recvr_user_id = NVL (p_user_id, recvr_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY recvr_user_id
UNION ALL
  SELECT 'Nomination Submitted' AS Activity,
         0 AS Points,
         0 AS Plateau_Earned,         
         0 AS Sweepstakes_Won,         
         0 AS Received, 
         NVL(COUNT(claim_id),0) AS Sent,
         0 AS Other_Awards--04/27/2015
    FROM rpt_nomination_detail
   WHERE giver_user_id = NVL (p_user_id, giver_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
      --   AND giver_sweepstakes_points > 0
GROUP BY giver_user_id
UNION ALL
  SELECT 'Product Claims' AS Activity,
         NVL (SUM (submitter_points), 0) AS Points,
         NVL (SUM (DECODE (award_type, 'merchandise', 1, 0)), 0)
            AS Plateau_Earned,         
         NVL (SUM (submitter_sweepstakes_won), 0) AS Sweepstakes_Won,         
         NVL(count(RPT_CLAIM_DETAIL_ID),0) AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_claim_detail
   WHERE submitter_user_id = NVL (p_user_id, submitter_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY submitter_user_id
UNION ALL
  SELECT 'Recognitions Received' AS Activity,
         NVL (SUM (award_amt), 0) AS Points,
         NVL (SUM (recvr_plateau_earned), 0) AS Plateau_Earned,         
         NVL (SUM (recvr_sweepstakes_won), 0) AS Sweepstakes_Won,         
         NVL(count(claim_id),0) AS Received, 
           0             AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_recognition_detail
   WHERE recvr_user_id = NVL (p_user_id, recvr_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY recvr_user_id
UNION ALL
  SELECT 'Recognitions Given' AS Activity,
          NVL (SUM (award_amt), 0) AS Points,  --09/12/2014
         0 AS Plateau_Earned,         
         NVL(SUM (giver_sweepstakes_won),0) AS Sweepstakes_Won,         
         0 AS Received, 
           NVL(count(claim_id),0)             AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_recognition_detail
   WHERE giver_user_id = NVL (p_user_id, giver_user_id)
         AND p_module_type is NULL
         AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY giver_user_id
UNION
  SELECT 'Quizzes' AS Activity,
         NVL (SUM (award_amount), 0) AS Points,
         NVL (SUM (DECODE (award_type, 'merchandise', 1, 0)), 0)
            AS Plateau_Earned,         
         NVL (SUM (sweepstakes_won), 0) AS Sweepstakes_Won,         
         NVL(COUNT(quiz_claim_id),0) AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_quiz_activity_detail
   WHERE  p_module_type is NULL 
         AND  participant_id = NVL (p_user_id, participant_id)         
         AND NVL (TRUNC (quiz_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY participant_id
UNION
  SELECT 'Throwdown' AS Activity,
         NVL (SUM (payout), 0) AS Points,
         0        AS Plateau_Earned,         
         0        AS Sweepstakes_Won,         
         0 AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_throwdown_activity rpt
   WHERE  p_module_type is NULL 
         AND  user_id = NVL (p_user_id, user_id)         
         AND NVL (TRUNC (payout_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY user_id
UNION
  SELECT CASE WHEN r.batch_description IS NULL THEN 
         (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT')  
         WHEN r.batch_description like '%'||gc_str_token THEN REPLACE(r.batch_description,gc_str_token)                   --03/07/2018 
         ELSE (SELECT t.cms_name FROM temp_table_session t WHERE t.asset_code=r.batch_description) END  AS Activity,	--03/07/2018   added case
         NVL (SUM (transaction_amount), 0) AS Points,
         0 AS Plateau_Earned,         
         0 AS Sweepstakes_Won,         
         COUNT(qcard_detail_id) AS Received, 
           0 AS Sent,
         0 AS Other_Awards --04/27/2015
    FROM rpt_qcard_detail r
   WHERE  p_module_type is NULL
         AND user_id = NVL (p_user_id, user_id)
         AND NVL (TRUNC (trans_date), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
GROUP BY r.user_id, 
         r.batch_description  --03/07/2018
UNION --04/27/2015
  SELECT 'Contests' AS Activity,
         NVL (SUM (POINTS), 0) AS Points,
         0 AS Plateau_Earned,         
         0 AS Sweepstakes_Won,         
         0 AS Received, 
         0 AS Sent,
         NVL (SUM (OTHER), 0) AS Other_Awards
    FROM rpt_ssi_contest_detail r
   WHERE  p_module_type is NULL
         AND user_id = NVL (p_user_id, user_id)
         AND NVL (TRUNC (PAYOUT_ISSUE_DATE), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
GROUP BY r.user_id
)
WHERE p_module_type is NULL
UNION ALL
SELECT 1,' ' FROM  rpt_goal_selection_detail rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'GoalQuest' FROM rpt_goal_selection_detail rpt
WHERE NVL(p_module_type,'goalquest')='goalquest' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_goalquest FROM rpt_goal_selection_detail rpt
WHERE NVL(p_module_type,'goalquest')='goalquest' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||Level_Selected||c2_delimiter||c_delimiter||
c2_delimiter||Base||c2_delimiter||c_delimiter||
c2_delimiter||Goal||c2_delimiter||c_delimiter||
c2_delimiter||Actual_Results||c2_delimiter||c_delimiter||
c2_delimiter||Pct_of_Goal||c2_delimiter||c_delimiter||
c2_delimiter||Achieved||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned||c2_delimiter
FROM ( 
SELECT rpt.Promotion_name           AS PROMOTION, 
--       FNC_CMS_ASSET_CODE_VAL_EXTR(goal_level_name,'GOALS',locale)                   AS Level_Selected, 
       (SELECT cms_name FROM temp_table_session WHERE cms_code='GOALS' AND asset_code=goal_level_name) AS Level_Selected,  --04/01/2014
       rpt.base_quantity                 AS Base, 
       rpt.amount_to_achieve             AS Goal, 
       rpt.current_value                 AS Actual_Results, 
       rpt.percent_of_goal               AS Pct_of_Goal, 
       DECODE(rpt.achieved,1,'Yes','No') AS Achieved, 
       NVL(rpt.calculated_payout,0)             AS Points, 
       rpt.plateau_earned               
     FROM rpt_goal_selection_detail rpt 
     WHERE TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015
     )   
     WHERE NVL(p_module_type,'goalquest')='goalquest'      
     UNION ALL --01/23/2015
SELECT 1,' ' FROM  rpt_awardmedia_detail rpt
WHERE  p_module_type is NULL
     AND rpt.promotion_type = 'badge'
     AND TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'Badge' FROM rpt_awardmedia_detail rpt
WHERE NVL(p_module_type,'badge')='badge' 
     AND TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_badge FROM rpt_awardmedia_detail rpt
WHERE NVL(p_module_type,'badge')='badge' 
     AND rpt.promotion_type = 'badge' 
     AND TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||Award_Date||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter
FROM ( 
SELECT rpt.Promotion_name           AS PROMOTION, 
            rpt.media_date                   AS Award_date,
       rpt.media_amount                 AS Points  
     FROM rpt_awardmedia_detail rpt 
     WHERE TRUNC(rpt.media_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern)
     AND rpt.promotion_type = 'badge'
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name
     )   
     WHERE NVL(p_module_type,'badge')='badge'     
 UNION ALL
SELECT 1,' ' FROM  rpt_cp_selection_detail rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'ChallengePoint' FROM rpt_cp_selection_detail rpt
WHERE NVL(p_module_type,'challengepoint')='challengepoint' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_challengepoint FROM rpt_cp_selection_detail rpt
WHERE NVL(p_module_type,'challengepoint')='challengepoint' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL ----09/26/2014 Bug # 56902 Start
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||Level_Selected||c2_delimiter||c_delimiter||
c2_delimiter||Base||c2_delimiter||c_delimiter||
c2_delimiter||Goal||c2_delimiter||c_delimiter||
c2_delimiter||Actual_Results||c2_delimiter||c_delimiter||
c2_delimiter||Pct_of_Goal||c2_delimiter||c_delimiter||
c2_delimiter||Achieved||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned||c2_delimiter
FROM ( 
SELECT rpt.Promotion_name           AS PROMOTION, 
       rpt.level_id AS Level_Selected,  --04/01/2014
       rpt.base_quantity                 AS Base, 
       rpt.amount_to_achieve             AS Goal, 
       rpt.current_value                 AS Actual_Results, 
--       NULL              AS Pct_of_Goal,  --10/01/2014 
       DECODE(rpt.amount_to_achieve,0,0,ROUND((NVL(rpt.current_value,0)/rpt.amount_to_achieve)*100,2)) AS Pct_of_Goal, --10/01/2014
       DECODE(rpt.achieved,1,'Yes','No') AS Achieved, 
--       NVL(rpt.calculated_payout,0)             AS Points,   --10/01/2014 
       (NVL(rpt.calculated_payout,0)+NVL(rpt.basic_award_deposited,0)) AS Points,   --10/01/2014
       NULL plateau_earned               
     FROM rpt_cp_selection_detail rpt 
     WHERE TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015
     )   
     WHERE NVL(p_module_type,'challengepoint')='challengepoint' 
 UNION ALL ----09/26/2014 Bug # 56902 End
 SELECT 1,' ' FROM  rpt_nomination_detail  rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'NominationReceived' FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsReceived')='nominationsReceived' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_nominationsReceived FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsReceived')='nominationsReceived' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id)
     AND ROWNUM<2 
    UNION ALL
   SELECT 1,
          c2_delimiter||promotion||c2_delimiter||c_delimiter||
          c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
          c2_delimiter||nominator||c2_delimiter||c_delimiter||
          c2_delimiter||points||c2_delimiter||c_delimiter||
          c2_delimiter||sweepstakes_won||c2_delimiter||c_delimiter||
          c2_delimiter||initcap(status)||c2_delimiter --09/29/2014  Bug 57024
     FROM ( 
            SELECT rpt.Promotion_name AS promotion, 
                   date_submitted, 
                   fnc_format_user_name(rpt.giver_last_name, rpt.giver_first_name) AS nominator, 
                   NVL(rpt.points_award_amt,0) AS points, 
-- commented until report table design finalized
--       NVL(rpt.recvr_sweepstakes_won,0) AS sweepstakes_won, 
0 AS sweepstakes_won, 
                   rpt.recvr_pax_status             AS status                
              FROM rpt_nomination_detail rpt 
             WHERE rpt.date_submitted BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
               AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
             ORDER BY rpt.Promotion_name   --01/05/2015
          )   
    WHERE NVL(p_module_type,'nominationsReceived')='nominationsReceived'
    UNION ALL
           SELECT 1,' ' FROM  rpt_nomination_detail  rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'NominationSubmitted' FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsGiven')='nominationsGiven' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_nominationsGiven FROM rpt_nomination_detail rpt
WHERE NVL(p_module_type,'nominationsGiven')='nominationsGiven' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
    UNION ALL
   SELECT 1,
          c2_delimiter||promotion||c2_delimiter||c_delimiter||
          c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
          c2_delimiter||nominee||c2_delimiter||c_delimiter||
          c2_delimiter||points||c2_delimiter||c_delimiter||
          c2_delimiter||sweepstakes_won||c2_delimiter
     FROM ( 
            SELECT rpt.Promotion_name AS promotion, 
                   date_submitted, 
                   fnc_format_user_name(rpt.recvr_last_name, rpt.recvr_first_name) AS nominee, 
                   NVL(rpt.points_award_amt,0) AS points, 
-- commented until report table design finalized
--       NVL(rpt.giver_sweepstakes_won,0) AS sweepstakes_won                 
0 AS sweepstakes_won                 
              FROM rpt_nomination_detail rpt 
             WHERE rpt.date_submitted BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
               AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
             ORDER BY rpt.Promotion_name   --01/05/2015     
          )   
    WHERE NVL(p_module_type,'nominationsGiven')='nominationsGiven'     
    UNION ALL
           SELECT 1,' ' FROM  rpt_qcard_detail  rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,CASE WHEN rpt.batch_description IS NULL THEN 
         (select cms_name from temp_table_session where asset_code = 'report.awards.participant' AND cms_code = 'ONTHESPOT')  
	 WHEN rpt.batch_description like '%'||gc_str_token THEN REPLACE(rpt.batch_description,gc_str_token)              --03/07/2018 
         ELSE (SELECT t.cms_name FROM temp_table_session t WHERE t.asset_code=rpt.batch_description) END  AS Activity  --03/07/2018   added case
	 FROM rpt_qcard_detail rpt
WHERE NVL(p_module_type,'onTheSpot')='onTheSpot' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_onTheSpot FROM rpt_qcard_detail rpt
WHERE NVL(p_module_type,'onTheSpot')='onTheSpot' 
     AND TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||Trans_Date||c2_delimiter||c_delimiter||
c2_delimiter||Recipient||c2_delimiter||c_delimiter||
c2_delimiter||Org_Name||c2_delimiter||c_delimiter||
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||OnTheSpot||c2_delimiter
FROM ( 
SELECT trans_date AS Trans_Date, 
       user_full_name          AS Recipient, 
       node_name                 AS Org_Name, 
       NVL(transaction_amount,0) AS Points, 
       '#'||cert_num                  AS OnTheSpot    --09/23/2014               
     FROM rpt_qcard_detail rpt 
     WHERE 
      TRUNC(rpt.trans_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id)
     ORDER BY rpt.trans_date   --01/05/2015
      )   
     WHERE NVL(p_module_type,'onTheSpot')='onTheSpot'     
     UNION ALL
           SELECT 1,' ' FROM  rpt_claim_detail   rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'ProductClaims' FROM rpt_claim_detail  rpt
WHERE NVL(p_module_type,'productClaims')='productClaims' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_productClaims FROM rpt_claim_detail  rpt
WHERE NVL(p_module_type,'productClaims')='productClaims' 
     AND TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||claim_number||c2_delimiter||c_delimiter||
c2_delimiter||promotion||c2_delimiter||c_delimiter||
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||sold_to||c2_delimiter||c_delimiter||
c2_delimiter||initcap(claim_status)||c2_delimiter||c_delimiter||----09/29/2014  Bug 57024
c2_delimiter||points||c2_delimiter --bug # 51009--04/04/2014
FROM ( 
SELECT rpt.claim_number                                                                     AS claim_number, 
       rpt.promotion_name                                                                        AS promotion, 
       rpt.date_submitted                                                                        AS date_submitted, 
       rpt.claim_company_name                                                                    AS sold_to, 
--       fnc_cms_picklist_value('picklist.claim.status.type.items',rpt.claim_status,locale) AS claim_status       
      (select cms_name from temp_table_session where asset_code='picklist.claim.status.type.items' and cms_code=rpt.claim_status) AS claim_status,   --04/01/2014 
      rpt.submitter_points Points --bug # 51009--04/04/2014
     FROM rpt_claim_detail  rpt 
     WHERE 
      TRUNC(rpt.date_submitted) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.submitter_user_id = NVL(p_user_id,rpt.submitter_user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015     
     )   
     WHERE NVL(p_module_type,'productClaims')='productClaims'
          UNION ALL     
          SELECT 1,' ' FROM  rpt_recognition_detail rpt
WHERE p_module_type is NULL
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id)      
     AND ROWNUM<2
UNION ALL
SELECT 1,'Recognitions Given' FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsGiven')='recognitionsGiven' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_recognitionsGiven FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsGiven')='recognitionsGiven' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promo_name||c2_delimiter||c_delimiter||
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||receiver_name||c2_delimiter||c_delimiter||
c2_delimiter||points_cnt||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won_cnt||c2_delimiter
FROM ( 
SELECT rpt.promotion_name          AS promo_name, 
       rpt.date_submitted               AS date_submitted, 
       rpt.recvr_full_name              AS receiver_name, 
       NVL(rpt.award_amt,0)             AS points_cnt, 
       NVL(giver_sweepstakes_won,0)                                AS sweepstakes_won_cnt                
     FROM rpt_recognition_detail rpt 
     WHERE  TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.giver_user_id = NVL(p_user_id,rpt.giver_user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015     
     )   
     WHERE NVL(p_module_type,'recognitionsGiven')='recognitionsGiven'  
     UNION ALL    
     SELECT 1,' ' FROM  rpt_recognition_detail rpt
WHERE p_module_type is NULL
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id)      
     AND ROWNUM<2
UNION ALL
SELECT 1,'Recognitions Received' FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsReceived')='recognitionsReceived' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_recognitionsReceived FROM rpt_recognition_detail rpt
WHERE NVL(p_module_type,'recognitionsReceived')='recognitionsReceived' 
     AND TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||PROMOTION||c2_delimiter||c_delimiter||
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||giver_full_name||c2_delimiter||c_delimiter||
c2_delimiter||points_cnt||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned_cnt||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won_cnt||c2_delimiter||c_delimiter||
c2_delimiter||initcap(status)||c2_delimiter--09/29/2014  Bug 57024
FROM ( 
SELECT rpt.Promotion_name           AS promotion, 
       date_submitted                   AS date_submitted, 
       rpt.giver_full_name                 AS giver_full_name, 
       NVL(rpt.award_amt,0)             AS points_cnt, 
       NVL(rpt.recvr_plateau_earned,0)  AS plateau_earned_cnt, 
       NVL(rpt.recvr_sweepstakes_won,0) AS sweepstakes_won_cnt, 
       rpt.recvr_pax_status             AS status               
     FROM rpt_recognition_detail rpt 
     WHERE  TRUNC(rpt.date_approved) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.recvr_user_id = NVL(p_user_id,rpt.recvr_user_id) 
     ORDER BY rpt.Promotion_name   --01/05/2015     
     )   
     WHERE NVL(p_module_type,'recognitionsReceived')='recognitionsReceived'  
     UNION ALL     
          SELECT 1,' ' FROM  rpt_quiz_activity_detail  rpt
WHERE p_module_type is NULL
     AND NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 
       AND participant_id = NVL(p_user_id,participant_id)  
       AND ROWNUM<2
UNION ALL
SELECT 1,'Quizzes' FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizSummary')='quizSummary' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_quizSummary FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizSummary')='quizSummary' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promo_quiz_name||c2_delimiter||c_delimiter||
c2_delimiter||attempts||c2_delimiter||c_delimiter||
c2_delimiter||passed||c2_delimiter||c_delimiter||
c2_delimiter||failed||c2_delimiter||c_delimiter||
c2_delimiter||progress||c2_delimiter||c_delimiter||
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won||c2_delimiter||c_delimiter||
c2_delimiter||initcap(result)||c2_delimiter--09/29/2014  Bug 57024
FROM ( 
SELECT rpt.promo_quiz_name, 
         rpt.participant_id, 
         COUNT(rpt.rpt_quiz_activity_detail_id) attempts, 
         SUM(DECODE(quiz_result,'passed',1,0)) passed, 
         SUM(DECODE(quiz_result,'failed',1,0)) failed, 
         SUM(DECODE(quiz_result,'progress',1,0)) progress, 
         SUM(AWARD_AMOUNT) points, 
         NVL(SUM(SWEEPSTAKES_WON),0) sweepstakes_won, 
         pkg_quiz_reports.fnc_get_quiz_result(rpt.participant_id,rpt.promo_quiz_name) result 
       FROM rpt_quiz_activity_detail rpt 
       WHERE NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
       AND participant_id = NVL(p_user_id,participant_id) 
       GROUP BY rpt.promo_quiz_name, 
         rpt.participant_id 
     ORDER BY rpt.promo_quiz_name   --01/05/2015
       )    
     WHERE NVL(p_module_type,'quizSummary')='quizSummary'   
     UNION ALL     
          SELECT 1,' ' FROM  rpt_quiz_activity_detail  rpt
WHERE p_module_type is NULL
     AND NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
       AND participant_id = NVL(p_user_id,participant_id)  
       AND ROWNUM<2
UNION ALL
SELECT 1,'QuizDetail' FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizDetail')='quizDetail' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_quizDetail FROM rpt_quiz_activity_detail  rpt
WHERE NVL(p_module_type,'quizDetail')='quizDetail' 
     AND TRUNC(rpt.quiz_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.participant_id = NVL(p_user_id,rpt.participant_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promotion||c2_delimiter||c_delimiter||
c2_delimiter||quiz_date||c2_delimiter||c_delimiter||
c2_delimiter||initcap(quiz_result)||c2_delimiter||c_delimiter||--09/29/2014  Bug 57024
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won||c2_delimiter
FROM ( 
SELECT promo_quiz_name AS promotion, 
       quiz_date            AS quiz_date, 
       quiz_result          AS quiz_result, 
       award_amount         AS points, 
       sweepstakes_won      AS sweepstakes_won
     FROM rpt_quiz_activity_detail 
     WHERE NVL(TRUNC(quiz_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND participant_id = NVL(p_user_id,participant_id)
     ORDER BY promo_quiz_name   --01/05/2015
       )    
     WHERE NVL(p_module_type,'quizDetail')='quizDetail'
     UNION ALL
SELECT 1,'Throwdown' FROM rpt_throwdown_activity rpt
WHERE NVL(p_module_type,'Throwdown')='Throwdown'
     AND TRUNC(rpt.payout_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id)
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_throwdown FROM rpt_throwdown_activity rpt
WHERE NVL(p_module_type,'throwdown')='throwdown'
     AND TRUNC(rpt.payout_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
c2_delimiter||round_number||c2_delimiter||c_delimiter||
c2_delimiter||Wins||c2_delimiter||c_delimiter||
c2_delimiter||Ties||c2_delimiter||c_delimiter||
c2_delimiter||Losses||c2_delimiter||c_delimiter||
c2_delimiter||activity||c2_delimiter||c_delimiter||
c2_delimiter||rank||c2_delimiter||c_delimiter||
c2_delimiter||payout||c2_delimiter
FROM ( 
WITH pax_rank AS
(SELECT 
ts.promotion_id,ts.round_number,tsp.user_id,tsp.rank 
FROM 
throwdown_stackrank ts,
throwdown_stackrank_node tsn,
throwdown_stackrank_pax tsp
WHERE
ts.stackrank_id = tsn.stackrank_id
AND ts.round_number is NOT NULL
AND tsn.stackrank_node_id = tsp.stackrank_node_id
AND tsp.user_id = p_user_id)
SELECT 
rpt.promotion_name,rpt.round_number,SUM (DECODE(outcome,'win',1,0)) Wins,SUM (DECODE(outcome,'tie',1,0)) Ties,SUM (DECODE(outcome,'loss',1,0)) Losses,SUM (current_value) activity,pax_rank.RANK,SUM(payout) AS payout
  FROM rpt_throwdown_activity rpt,
  pax_rank
WHERE rpt.user_id = p_user_id
AND rpt.promotion_id = pax_rank.promotion_id(+)
AND NVL(p_module_type,'throwdown')='throwdown' 
AND TRUNC(rpt.payout_date) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
AND rpt.round_number = pax_rank.round_number(+)
GROUP BY 
rpt.promotion_name,rpt.round_number,pax_rank.rank
ORDER BY rpt.promotion_name   --01/05/2015
)
UNION ALL--04/27/2015
SELECT 1,' ' FROM  rpt_ssi_contest_detail rpt
WHERE  p_module_type is NULL
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
SELECT 1,'SSIContests' FROM rpt_ssi_contest_detail rpt
WHERE NVL(p_module_type,'ssicontests')='ssicontests' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_ssi_contests FROM rpt_ssi_contest_detail rpt
WHERE NVL(p_module_type,'ssicontests')='ssicontests' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||Contest_Name||c2_delimiter||c_delimiter||
c2_delimiter||Payout_Issue_Date||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||Other||c2_delimiter
FROM ( 
SELECT (select cms_name from temp_table_session where cms_code='CONTEST_NAME' AND asset_code = rpt.ssi_contest_name) AS Contest_Name,  --07/03/2015 
--      ssi_contest_name AS Contest_Name,
      payout_issue_date Payout_Issue_Date,points Points,other Other        
     FROM rpt_ssi_contest_detail rpt 
     WHERE TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   
     )   
     WHERE NVL(p_module_type,'ssicontests')='ssicontests'  
UNION ALL--04/27/2015
SELECT 1,'SSIContests' FROM rpt_ssi_contest_detail rpt
WHERE p_module_type = 'ssicontests_sec' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
     UNION ALL
SELECT 1,p_header_ssi_contests_sec FROM rpt_ssi_contest_detail rpt
WHERE p_module_type = 'ssicontests_sec' 
     AND TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     AND ROWNUM<2
UNION ALL
        SELECT 1,
c2_delimiter||Contest_Name||c2_delimiter||c_delimiter||
c2_delimiter||Payout_Issue_Date||c2_delimiter||c_delimiter||
c2_delimiter||Points||c2_delimiter||c_delimiter||
c2_delimiter||Other||c2_delimiter||c_delimiter||
c2_delimiter||Other_Value||c2_delimiter
FROM ( 
SELECT (select cms_name from temp_table_session where cms_code='CONTEST_NAME' AND asset_code = rpt.ssi_contest_name) AS Contest_Name,  --07/03/2015
     -- ssi_contest_name AS Contest_Name,
      payout_issue_date Payout_Issue_Date,points Points,other Other,other_value Other_Value        
     FROM rpt_ssi_contest_detail rpt 
     WHERE TRUNC(rpt.PAYOUT_ISSUE_DATE) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) 
     AND rpt.user_id = NVL(p_user_id,rpt.user_id) 
     ORDER BY rpt.Promotion_name   
     )   
     WHERE p_module_type = 'ssicontests_sec'       
UNION ALL     
          SELECT 1,' ' FROM  (SELECT media_date                                                    AS date_submitted      
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted       
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     )
WHERE p_module_type is NULL and rownum<2 
UNION ALL
SELECT 1,'AllAwards' FROM  (SELECT media_date                                                    AS date_submitted      
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted       
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     )
WHERE p_module_type='allAwards' and rownum<2 
     UNION ALL
SELECT 1,    p_header_allAwards FROM  (SELECT media_date                                                    AS date_submitted      
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted       
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     )
WHERE p_module_type='allAwards' and rownum<2 
UNION ALL
        SELECT 1,
c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
c2_delimiter||recipient||c2_delimiter||c_delimiter||
c2_delimiter||sender||c2_delimiter||c_delimiter||
c2_delimiter||org_name||c2_delimiter||c_delimiter||
c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
c2_delimiter||points||c2_delimiter||c_delimiter||
c2_delimiter||plateau_earned||c2_delimiter||c_delimiter||
c2_delimiter||sweepstakes_won||c2_delimiter||c_delimiter||
c2_delimiter||onthespot||c2_delimiter
FROM ( 
SELECT media_date                                                    AS date_submitted, 
       participant_name                                                   AS recipient, 
       fnc_format_user_name(sender_last_name,sender_first_name,NULL,NULL) AS sender, 
       node_name                                                          AS org_name, 
       r.Promotion_name                                                   AS promotion_name, 
       NVL(points,0)                                                      AS points, 
       NVL(plateau_earned,0)                                              AS plateau_earned, 
       NVL(sweepstakes_won,0)                                             AS sweepstakes_won, 
       NULL                                                               AS onthespot 
     FROM rpt_awardmedia_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(media_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     UNION ALL 
     SELECT trans_date           AS date_submitted, 
       user_full_name            AS recipient, 
       NULL                      AS sender, 
       node_name                 AS org_name, 
       NULL                      AS promotion_name, 
       NVL(transaction_amount,0) AS points, 
       0                         AS plateau_earned, 
       0                         AS sweepstakes_won, 
       '#'||cert_num                  AS onthespot    --09/23/2014
     FROM rpt_qcard_detail r 
     WHERE user_id = NVL(p_user_id, user_id) 
     AND NVL(TRUNC(trans_date), TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern)  AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
     ORDER BY date_submitted    --01/05/2015
       )    
     WHERE p_module_type='allAwards'      
 )
 ;
 
  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019   
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);      

      
END LOOP;

    UTL_FILE.fclose(file_handler);
       
 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_INDIVIDUAL_ACT_EXTRACT',1,'ERROR',
        p_user_id ||': '||'p_user_id '||p_in_from_date||': '||' p_in_from_date'||p_in_to_date||': '||' p_in_to_date'|| --07/16/2014 Bug # 54917
         locale||': '||' locale'||p_file_name||': '||' p_file_name'||p_header_summary||': '||' p_header_summary'||
         p_header_allAwards||': '||' p_header_allAwards'||p_header_onTheSpot||': '||' p_header_onTheSpot'||
         p_header_goalquest||': '||' p_header_goalquest'||p_header_challengepoint||': '||' p_header_challengepoint'||p_header_nominationsReceived||': '||' p_header_nominationsReceived'||
         p_header_nominationsGiven||': '||' p_header_nominationsGiven'||p_header_productClaims||': '||' p_header_productClaims'||
         p_header_recognitionsGiven||': '||' p_header_recognitionsGiven'||p_header_recognitionsReceived||': '||' p_header_recognitionsReceived'||
         p_header_quizSummary||': '||' p_header_quizSummary'||p_header_quizDetail||': '||' p_header_quizDetail'||
         p_header_throwdown||': '||' p_header_throwdown'||p_module_type ||': '||' p_module_type '||CHR(10)||SQLERRM,null);        
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_INDIVIDUAL_ACT_EXTRACT;

PROCEDURE PRC_LOGIN_EXTRACT
   (parentNodeId      IN VARCHAR2,       
    p_in_pax_status   IN VARCHAR2,
    P_paxid IN NUMBER,
    is_Team IN NUMBER,
    p_in_role     IN VARCHAR2,
    p_in_department   IN VARCHAR2,    
    p_in_country_Ids IN VARCHAR2,    
    p_in_from_date       IN VARCHAR2,
      p_in_to_date       IN VARCHAR2,   
    login_type VARCHAR2,
      locale IN VARCHAR2,
      p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
   p_out_return_code  OUT VARCHAR2,
     p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Login Activity Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
-- Ravi Dhanekula     01/07/2013  Initial Version 
                    06/19/2013  Fixed the information related to Manager info for users. 
                    07/22/2014  Fixed the defect # 3597
                    01/27/2014  Fixed the bug # 50969    
-- Chidamba       06/17/2014  Bug 54228 - Login Activity - List of Participants - Duplicate Issue
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
-- KrishnaDeepika 10/17/2014 Bug # 57477 - Added characteristic_type user for list of pax where Total Visits count is not matching between Summary and Extract
-- murphyc        01/15/2015  check user_node.status for manager rec Bug 59077
-- nagarajs       11/26/2015 Bug 64788 and 64786  - Login Activity Reports : There is mismatch in the total of "total no of visits" column between the summary table and the extracted sheet
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   p_in_locale VARCHAR2(10):=locale;
   v_pattern    VARCHAR2(15);
   l_cursor  SYS_REFCURSOR; 
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
   -- local variables
   
  L_from_date     DATE;
  L_to_date       DATE;
   
BEGIN

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

L_from_date := TO_DATE(p_in_from_date, v_pattern); 
L_to_date := TO_DATE(p_in_to_date, v_pattern); 

DELETE FROM GTT_MANAGER_ID;
INSERT INTO GTT_MANAGER_ID
(SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
                      AND n.parent_node_id= un2.node_id and un2.role='own'
                      AND un2.status = 1  -- 01/15/2015
                      UNION ALL
                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own'
                      AND un2.status = 1  -- 01/15/2015
                      UNION ALL
                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
                      AND un.status = 1  -- 01/15/2015
                      and node_id in (select node_id from node where parent_node_id is NULL));
delete from temp_table_session;

INSERT INTO temp_table_session
   SELECT asset_code,cms_name,cms_code
     FROM vw_cms_code_value E
    WHERE asset_code in ( 'picklist.participantenrollmentsource.items','picklist.addresstype.items','picklist.department.type.items','picklist.positiontype.items',
                                           'picklist.hierarchyrole.type.items','picklist.participantstatus.items','picklist.phonetype.items','picklist.emailtype.items','default.locale.items','picklist.statetype.items') and e.locale=p_in_locale
                                           UNION
                                           select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key='COUNTRY_NAME' and locale = p_in_locale;

DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;


        IF p_file_name IS NULL THEN 
OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||FIRST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MIDDLE_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||LAST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||USER_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||COUNTRY||c2_delimiter||c_delimiter||
         c2_delimiter||ORG_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||role||c2_delimiter||c_delimiter||
         c2_delimiter||position_type||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||       
         c2_delimiter||last_login||c2_delimiter||c_delimiter||
         c2_delimiter||total_visits||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_FIRST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_MIDDLE_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_LAST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_COUNTRY||c2_delimiter||c_delimiter||         
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char15||c2_delimiter
    FROM 
    (SELECT * FROM   --12/18/2014
    (SELECT au.first_name AS FIRST_NAME,
                 au.middle_name AS MIDDLE_NAME,
                 au.last_name AS LAST_NAME,
                 au.user_name AS USER_NAME,
                 (select cms_name from temp_table_session where  asset_code=c.cm_asset_code) As country,                
                 RTRIM (LTRIM (n.name) )     ORG_NAME,                
                  (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=un.role) AS role,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=pe.position_type)  AS position_type,
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=pe.department_type) AS department,
                 la.last_login,
                 la.total_visits,
                 mgr.first_name AS MGR_FIRST_NAME,
                 mgr.middle_name AS MGR_MIDDLE_NAME,
                 mgr.last_name AS MGR_LAST_NAME,
                 CASE
                    WHEN mc.cm_asset_code IS NULL THEN NULL
                    ELSE (select cms_name from temp_table_session where asset_code=mc.cm_asset_code)
                 END
                    AS MGR_COUNTRY,   
        (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15   
            FROM (  SELECT user_id,
                           MAX (TRUNC (login_date_time)) AS LAST_LOGIN,
                           COUNT (user_id) AS TOTAL_VISITS
                      FROM login_activity
                     WHERE TRUNC (login_date_time) BETWEEN L_from_date AND L_to_date --12/18/2013
                  GROUP BY user_id) la,
                 application_user au,
                 user_address ua,
                 country c,
                 user_node un,
--                 (SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
--                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
--                      AND n.parent_node_id= un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
--                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
--                      AND un.status = 1  -- 01/15/2015
--                      and node_id in (select node_id from node where parent_node_id is NULL))
                 gtt_manager_id un_mgr, --06/19/2013
                 node n,
                 application_user mgr,
                 user_address mua,
                 country mc,
                 vw_curr_pax_employer pe,
                 participant p,
                 rpt_characteristic rch
                -- rpt_characteristic rn
           WHERE     la.user_id = au.user_id
                 AND P_paxid is NULL
                 AND un.user_id = au.user_id
                 AND un.is_primary = 1
                 AND un_mgr.user_id(+) = au.user_id --06/19/2013_added outer join to get the users even if there is no mgr information. -07/22/2013
                 AND un_mgr.manager_user_id = mgr.user_id(+) --06/19/2013
                 AND n.node_id = un.node_id
                 AND au.user_id = pe.user_id(+)
                 AND au.user_id = p.user_id
                 AND ua.user_id = au.user_id
                 AND ua.is_primary = 1                --06/17/2014
                 AND au.user_id = rch.user_nt_id(+)
                -- AND n.node_id = rn.user_nt_id(+) 
                 AND ua.country_id = c.country_id
               --  AND au.master_user_id = mgr.user_id(+) --06/19/2013
                 AND mgr.user_id = mua.user_id(+)
                 AND mua.is_primary(+) = 1                --06/17/2014
                 AND mua.country_id = mc.country_id(+)
                 AND p.status = NVL (p_in_pax_status, p.status)
                 AND un.role = NVL (p_in_role, un.role)                 
                 AND (pe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                 AND (ua.country_id      IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))    OR (p_in_country_Ids is NULL))
                 AND (            
                 (NVL(is_Team,0)=0 AND n.NODE_ID IN (    SELECT child_node_id --node_id --11/26/2015
                                         --FROM NODE N2                         --11/26/2015
                                   --CONNECT BY PRIOR node_id = parent_node_id  --11/26/2015
                                   --START WITH node_id IN (SELECT *            --11/26/2015
                                    FROM rpt_hierarchy_rollup                   --11/26/2015
                                   WHERE node_id in (SELECT *                   --11/26/2015
                                       FROM TABLE (
                                               get_array_varchar (
                                                  parentNodeId)))))
                             OR
                           (  is_Team=1 AND n.NODE_ID=parentNodeId))      --Didn't change this row to accept multiple node_ids as we will never have that scenario while team=1
                 AND (NVL (login_type, 'show_all') = 'loggedIn'
                      OR NVL (login_type, 'show_all') = 'show_all')
                 AND rch.characteristic_type(+) = 'USER'          --10/17/2014   Bug# 57477 fix
          UNION ALL
          SELECT au.first_name,
                 au.middle_name,
                 au.last_name,
                 au.user_name,                                  
                 (select cms_name from temp_table_session where asset_code=c.cm_asset_code) As country,     
                 RTRIM (LTRIM (n.name) )     ORG_NAME,
                     (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=un.role) AS role,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=pe.position_type)  AS position_type,
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=pe.department_type) AS department,            
                 NULL last_login,
                 0 total_visits,
                 mgr.first_name,
                 mgr.middle_name,
                 mgr.last_name,
                 CASE
                    WHEN mc.cm_asset_code IS NULL THEN NULL
                    ELSE (select cms_name from temp_table_session where asset_code=mc.cm_asset_code)
                 END
                    AS MGR_COUNTRY,
                  (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15   
            FROM application_user au,
                 user_address ua,
                 country c,
                 user_node un,
--                  (SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
--                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
--                      AND n.parent_node_id= un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
--                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
--                      AND un.status = 1  -- 01/15/2015
--                      and node_id in (select node_id from node where parent_node_id is NULL)) un_mgr, --06/19/2013
                 gtt_manager_id un_mgr,
                 node n,
                 application_user mgr,
                 user_address mua,
                 country mc,
                 vw_curr_pax_employer pe,
                 participant p,
                 rpt_characteristic rch    
           WHERE     un.user_id(+) = au.user_id
                 AND un.is_primary = 1
                 AND P_paxid is NULL
                 AND n.node_id(+) = un.node_id
                 AND un_mgr.user_id(+) = au.user_id --06/19/2013_added outer join to get the users even if there is no mgr information. -07/22/2013
                 AND un_mgr.manager_user_id = mgr.user_id(+) --06/19/2013
                 AND au.user_id = pe.user_id(+)
                 AND au.user_id = p.user_id(+)
                 AND ua.user_id(+) = au.user_id
                 AND ua.is_primary(+) = 1                --06/17/2014
                 AND au.user_id = rch.user_nt_id(+)                
                 AND ua.country_id = c.country_id(+)
             --    AND au.master_user_id = mgr.user_id(+)
                 AND mgr.user_id = mua.user_id(+)
                 AND mua.is_primary(+) = 1                --06/17/2014
                 AND mua.country_id = mc.country_id(+)
                 AND NOT EXISTS
                            (SELECT 'X'
                               FROM login_activity la
                              WHERE la.user_id = au.user_id
                                    AND TRUNC (la.login_date_time) BETWEEN L_from_date AND L_to_date --12/18/2013
                                    )
                 AND p.status = NVL (p_in_pax_status, p.status)
                 AND un.role = NVL (p_in_role, un.role)
                 AND (pe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                 AND (ua.country_id      IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))    OR (p_in_country_Ids is NULL))
                 AND (            
                 (NVL(is_Team,0)=0 AND n.NODE_ID IN (    SELECT child_node_id --node_id --11/26/2015
                                         --FROM NODE N2                         --11/26/2015
                                   --CONNECT BY PRIOR node_id = parent_node_id  --11/26/2015
                                   --START WITH node_id IN (SELECT *            --11/26/2015
                                    FROM rpt_hierarchy_rollup                   --11/26/2015
                                   WHERE node_id in (SELECT *                   --11/26/2015
                                       FROM TABLE (
                                               get_array_varchar (
                                                  parentNodeId)))))
                             OR
                           (  is_Team=1 AND n.NODE_ID=parentNodeId))  
                 AND (NVL (login_type, 'show_all') = 'haveNotLoggedIn'
                      OR NVL (login_type, 'show_all') = 'show_all')        
                 AND rch.characteristic_type(+) = 'USER'          --10/17/2014   Bug# 57477 fix                  
         UNION ALL
         SELECT au.first_name AS FIRST_NAME,
                 au.middle_name AS MIDDLE_NAME,
                 au.last_name AS LAST_NAME,
                 au.user_name AS USER_NAME,                
                                         (select cms_name from temp_table_session where asset_code=c.cm_asset_code) As country,                
                 RTRIM (LTRIM (n.name) )      ORG_NAME,                
                (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=un.role) AS role,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=pe.position_type)  AS position_type,
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=pe.department_type) AS department,  
                 la.last_login,
                 la.total_visits,
                 mgr.first_name AS MGR_FIRST_NAME,
                 mgr.middle_name AS MGR_MIDDLE_NAME,
                 mgr.last_name AS MGR_LAST_NAME,
                CASE
                    WHEN mc.cm_asset_code IS NULL THEN NULL
                    ELSE (select cms_name from temp_table_session where asset_code=mc.cm_asset_code)
                 END
                    AS MGR_COUNTRY,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15   
            FROM (  SELECT user_id,
                           MAX (TRUNC (login_date_time)) AS LAST_LOGIN,
                           COUNT (user_id) AS TOTAL_VISITS
                      FROM login_activity
                     WHERE TRUNC (login_date_time) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
                  GROUP BY user_id) la,
                 application_user au,
                 user_address ua,
                 country c,
                 user_node un,
--                    (SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
--                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
--                      AND n.parent_node_id= un2.node_id and un2.role='own' and un.user_id=P_paxid
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
--                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own' and un.user_id=P_paxid
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
--                      AND un.status = 1  -- 01/15/2015
--                      and node_id in (select node_id from node where parent_node_id is NULL)) un_mgr, --06/19/2013
                 gtt_manager_id un_mgr,
                 node n,
                 application_user mgr,
                 user_address mua,
                 country mc,
                 vw_curr_pax_employer pe,
                 participant p,
                 rpt_characteristic rch
           WHERE     la.user_id = au.user_id
                 AND P_paxid is NOT NULL
                 AND P_paxid = la.user_id
                 AND un.user_id = au.user_id
                 AND un.is_primary = 1
                 AND un_mgr.user_id(+) = au.user_id --06/19/2013_added outer join to get the users even if there is no mgr information. -07/22/2013
                 AND un_mgr.manager_user_id = mgr.user_id(+) --06/19/2013
                 AND n.node_id = un.node_id
                 AND au.user_id = pe.user_id(+)
                 AND au.user_id = p.user_id
                 AND ua.user_id = au.user_id
                 AND ua.is_primary = 1                --06/17/2014
                 AND au.user_id = rch.user_nt_id(+)          
                 AND ua.country_id = c.country_id
               --  AND au.master_user_id = mgr.user_id(+)
                 AND mgr.user_id = mua.user_id(+)
                 AND mua.is_primary(+) = 1                --06/17/2014
                 AND mua.country_id = mc.country_id(+)
                 AND rch.characteristic_type(+) = 'USER'          --10/17/2014   Bug# 57477 fix
) --12/18/2014
            order by first_name asc)  --12/18/2014
) ;
 p_out_return_code :=  '00' ;
ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
OPEN l_cursor FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||FIRST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MIDDLE_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||LAST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||USER_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||COUNTRY||c2_delimiter||c_delimiter||
         c2_delimiter||ORG_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||role||c2_delimiter||c_delimiter||
         c2_delimiter||position_type||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||       
         c2_delimiter||last_login||c2_delimiter||c_delimiter||
         c2_delimiter||total_visits||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_FIRST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_MIDDLE_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_LAST_NAME||c2_delimiter||c_delimiter||
         c2_delimiter||MGR_COUNTRY||c2_delimiter||c_delimiter||         
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char15||c2_delimiter
    FROM 
    (SELECT * FROM   --12/18/2014
    (SELECT au.first_name AS FIRST_NAME,
                 au.middle_name AS MIDDLE_NAME,
                 au.last_name AS LAST_NAME,
                 au.user_name AS USER_NAME,
                 (select cms_name from temp_table_session where  asset_code=c.cm_asset_code) As country,                
                 RTRIM (LTRIM (n.name) )     ORG_NAME,                
                  (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=un.role) AS role,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=pe.position_type)  AS position_type,
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=pe.department_type) AS department,
                 la.last_login,
                 la.total_visits,
                 mgr.first_name AS MGR_FIRST_NAME,
                 mgr.middle_name AS MGR_MIDDLE_NAME,
                 mgr.last_name AS MGR_LAST_NAME,
                 CASE
                    WHEN mc.cm_asset_code IS NULL THEN NULL
                    ELSE (select cms_name from temp_table_session where asset_code=mc.cm_asset_code)
                 END
                    AS MGR_COUNTRY,   
        (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15   
            FROM (  SELECT user_id,
                           MAX (TRUNC (login_date_time)) AS LAST_LOGIN,
                           COUNT (user_id) AS TOTAL_VISITS
                      FROM login_activity
                     WHERE TRUNC (login_date_time) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
                  GROUP BY user_id) la,
                 application_user au,
                 user_address ua,
                 country c,
                 user_node un,
--                 (SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
--                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
--                      AND n.parent_node_id= un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
--                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
--                      AND un.status = 1  -- 01/15/2015
--                      and node_id in (select node_id from node where parent_node_id is NULL)) un_mgr, --06/19/2013
                 gtt_manager_id un_mgr,
                 node n,
                 application_user mgr,
                 user_address mua,
                 country mc,
                 vw_curr_pax_employer pe,
                 participant p,
                 rpt_characteristic rch
                -- rpt_characteristic rn
           WHERE     la.user_id = au.user_id
                 AND P_paxid is NULL
                 AND un.user_id = au.user_id
                 AND un.is_primary = 1
                 AND un_mgr.user_id(+) = au.user_id --06/19/2013_added outer join to get the users even if there is no mgr information. -07/22/2013
                 AND un_mgr.manager_user_id = mgr.user_id(+) --06/19/2013
                 AND n.node_id = un.node_id
                 AND au.user_id = pe.user_id(+)
                 AND au.user_id = p.user_id
                 AND ua.user_id = au.user_id
                 AND ua.is_primary = 1                --06/17/2014
                 AND au.user_id = rch.user_nt_id(+)
                -- AND n.node_id = rn.user_nt_id(+) 
                 AND ua.country_id = c.country_id
               --  AND au.master_user_id = mgr.user_id(+) --06/19/2013
                 AND mgr.user_id = mua.user_id(+)
                 AND mua.is_primary(+) = 1                --06/17/2014
                 AND mua.country_id = mc.country_id(+)
                 AND p.status = NVL (p_in_pax_status, p.status)
                 AND un.role = NVL (p_in_role, un.role)                 
                 AND (pe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                 AND (ua.country_id      IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))    OR (p_in_country_Ids is NULL))
                 AND (            
                 (NVL(is_Team,0)=0 AND n.NODE_ID IN (    SELECT child_node_id --node_id --11/26/2015
                                         --FROM NODE N2                         --11/26/2015
                                   --CONNECT BY PRIOR node_id = parent_node_id  --11/26/2015
                                   --START WITH node_id IN (SELECT *            --11/26/2015
                                    FROM rpt_hierarchy_rollup                   --11/26/2015
                                   WHERE node_id in (SELECT *                   --11/26/2015
                                       FROM TABLE (
                                               get_array_varchar (
                                                  parentNodeId)))))
                             OR
                           (  is_Team=1 AND n.NODE_ID=parentNodeId))      --Didn't change this row to accept multiple node_ids as we will never have that scenario while team=1
                 AND (NVL (login_type, 'show_all') = 'loggedIn'
                      OR NVL (login_type, 'show_all') = 'show_all')
                 AND rch.characteristic_type(+) = 'USER'          --10/17/2014   Bug# 57477 fix
          UNION ALL
          SELECT au.first_name,
                 au.middle_name,
                 au.last_name,
                 au.user_name,                                  
                 (select cms_name from temp_table_session where asset_code=c.cm_asset_code) As country,     
                 RTRIM (LTRIM (n.name) )     ORG_NAME,
                     (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=un.role) AS role,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=pe.position_type)  AS position_type,
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=pe.department_type) AS department,            
                 NULL last_login,
                 0 total_visits,
                 mgr.first_name,
                 mgr.middle_name,
                 mgr.last_name,
                 CASE
                    WHEN mc.cm_asset_code IS NULL THEN NULL
                    ELSE (select cms_name from temp_table_session where asset_code=mc.cm_asset_code)
                 END
                    AS MGR_COUNTRY,
                  (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15   
            FROM application_user au,
                 user_address ua,
                 country c,
                 user_node un,
--                  (SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
--                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
--                      AND n.parent_node_id= un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
--                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own'
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
--                      AND un.status = 1  -- 01/15/2015
--                      and node_id in (select node_id from node where parent_node_id is NULL)) un_mgr, --06/19/2013
                 gtt_manager_id un_mgr,
                 node n,
                 application_user mgr,
                 user_address mua,
                 country mc,
                 vw_curr_pax_employer pe,
                 participant p,
                 rpt_characteristic rch    
           WHERE     un.user_id(+) = au.user_id
                 AND un.is_primary = 1
                 AND P_paxid is NULL
                 AND n.node_id(+) = un.node_id
                 AND un_mgr.user_id(+) = au.user_id --06/19/2013_added outer join to get the users even if there is no mgr information. -07/22/2013
                 AND un_mgr.manager_user_id = mgr.user_id(+) --06/19/2013
                 AND au.user_id = pe.user_id(+)
                 AND au.user_id = p.user_id(+)
                 AND ua.user_id(+) = au.user_id
                 AND ua.is_primary(+) = 1                --06/17/2014
                 AND au.user_id = rch.user_nt_id(+)                
                 AND ua.country_id = c.country_id(+)
             --    AND au.master_user_id = mgr.user_id(+)
                 AND mgr.user_id = mua.user_id(+)
                 AND mua.is_primary(+) = 1                --06/17/2014
                 AND mua.country_id = mc.country_id(+)
                 AND NOT EXISTS
                            (SELECT 'X'
                               FROM login_activity la
                              WHERE la.user_id = au.user_id
                                    AND TRUNC (la.login_date_time) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
                                    )
                 AND p.status = NVL (p_in_pax_status, p.status)
                 AND un.role = NVL (p_in_role, un.role)
                 AND (pe.department_type IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
                 AND (ua.country_id      IN (SELECT * FROM TABLE(get_array_varchar(p_in_country_Ids)))    OR (p_in_country_Ids is NULL))
                 AND (            
                 (NVL(is_Team,0)=0 AND n.NODE_ID IN (    SELECT child_node_id --node_id --11/26/2015
                                         --FROM NODE N2                         --11/26/2015
                                   --CONNECT BY PRIOR node_id = parent_node_id  --11/26/2015
                                   --START WITH node_id IN (SELECT *            --11/26/2015
                                    FROM rpt_hierarchy_rollup                   --11/26/2015
                                   WHERE node_id in (SELECT *                   --11/26/2015
                                       FROM TABLE (
                                               get_array_varchar (
                                                  parentNodeId)))))
                             OR
                           (  is_Team=1 AND n.NODE_ID=parentNodeId))  
                 AND (NVL (login_type, 'show_all') = 'haveNotLoggedIn'
                      OR NVL (login_type, 'show_all') = 'show_all')        
                 AND rch.characteristic_type(+) = 'USER'          --10/17/2014   Bug# 57477 fix                   
         UNION ALL
         SELECT au.first_name AS FIRST_NAME,
                 au.middle_name AS MIDDLE_NAME,
                 au.last_name AS LAST_NAME,
                 au.user_name AS USER_NAME,                
                                         (select cms_name from temp_table_session where asset_code=c.cm_asset_code) As country,                
                 RTRIM (LTRIM (n.name) )      ORG_NAME,                
                (select cms_name from temp_table_session where asset_code='picklist.hierarchyrole.type.items' and
                                                                            cms_code=un.role) AS role,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and
                                                                            cms_code=pe.position_type)  AS position_type,
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and
                                                                            cms_code=pe.department_type) AS department,  
                 la.last_login,
                 la.total_visits,
                 mgr.first_name AS MGR_FIRST_NAME,
                 mgr.middle_name AS MGR_MIDDLE_NAME,
                 mgr.last_name AS MGR_LAST_NAME,
                CASE
                    WHEN mc.cm_asset_code IS NULL THEN NULL
                    ELSE (select cms_name from temp_table_session where asset_code=mc.cm_asset_code)
                 END
                    AS MGR_COUNTRY,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15   
            FROM (  SELECT user_id,
                           MAX (TRUNC (login_date_time)) AS LAST_LOGIN,
                           COUNT (user_id) AS TOTAL_VISITS
                      FROM login_activity
                     WHERE TRUNC (login_date_time) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
                  GROUP BY user_id) la,
                 application_user au,
                 user_address ua,
                 country c,
                 user_node un,
--                    (SELECT un.user_id,un2.user_id manager_user_id FROM USER_NODE UN,USER_NODE UN2, node n
--                      WHERE un.role='own' and un.is_primary = 1 and un.node_id = n.node_id
--                      AND n.parent_node_id= un2.node_id and un2.role='own' and un.user_id=P_paxid
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,un2.user_id mgr_user_id FROM USER_NODE UN,USER_NODE UN2
--                      WHERE un.role<>'own' and un.is_primary = 1 and un.node_id = un2.node_id and un2.role='own' and un.user_id=P_paxid
--                      AND un2.status = 1  -- 01/15/2015
--                      UNION ALL
--                      SELECT un.user_id,NULL manager_user_id FROM user_node un where role='own' 
--                      AND un.status = 1  -- 01/15/2015
--                      and node_id in (select node_id from node where parent_node_id is NULL)) un_mgr, --06/19/2013
                 gtt_manager_id un_mgr,
                 node n,
                 application_user mgr,
                 user_address mua,
                 country mc,
                 vw_curr_pax_employer pe,
                 participant p,
                 rpt_characteristic rch
           WHERE     la.user_id = au.user_id
                 AND P_paxid is NOT NULL
                 AND P_paxid = la.user_id
                 AND un.user_id = au.user_id
                 AND un.is_primary = 1
                 AND un_mgr.user_id(+) = au.user_id --06/19/2013_added outer join to get the users even if there is no mgr information. -07/22/2013
                 AND un_mgr.manager_user_id = mgr.user_id(+) --06/19/2013
                 AND n.node_id = un.node_id
                 AND au.user_id = pe.user_id(+)
                 AND au.user_id = p.user_id
                 AND ua.user_id = au.user_id
                 AND ua.is_primary = 1                --06/17/2014
                 AND au.user_id = rch.user_nt_id(+)          
                 AND ua.country_id = c.country_id
               --  AND au.master_user_id = mgr.user_id(+)
                 AND mgr.user_id = mua.user_id(+)
                 AND mua.is_primary(+) = 1                --06/17/2014
                 AND mua.country_id = mc.country_id(+)
                 AND rch.characteristic_type(+) = 'USER'          --10/17/2014   Bug# 57477 fix
) --12/18/2014
            order by first_name asc)  --12/18/2014
) ;
 -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);
            --prc_execution_log_entry('PRC_LOGIN_EXTRACT',1,'INFO',v_extract,SQLERRM);    
      
END LOOP;

    UTL_FILE.fclose(file_handler);

	
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  99 ;
        prc_execution_log_entry('PRC_LOGIN_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_pax_status||': '||'p_in_pax_status'||p_paxid ||': '||'p_paxid '|| --07/16/2014 Bug # 54917
        Is_team||': '||'Is_team'||p_in_role ||': '||'p_in_role '||p_in_department||': '||'p_in_department'||
        p_in_country_Ids ||': '||'p_in_country_Ids '||p_in_from_date||': '||'p_in_from_date'||p_in_to_date||': '||'p_in_to_date'||
        login_type||': '||'login_type,'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                                  ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_LOGIN_EXTRACT;

PROCEDURE PRC_RECOGNITION_GIVEN_EXTRACT
    (p_in_parentNodeId      IN   VARCHAR2,       
     p_in_pax_status        IN   VARCHAR2,
     p_in_is_team           IN   NUMBER,
     p_in_paxid             IN   NUMBER,
     p_in_is_behavior       IN   NUMBER,
     p_in_promotion_Id      IN   VARCHAR2,   
     p_in_promo_status      IN   VARCHAR2,
     p_in_position_type     IN   VARCHAR2,
     p_in_department        IN   VARCHAR2,   
     p_in_country_Ids       IN   VARCHAR2,   
     p_in_from_date         IN   VARCHAR2,
     p_in_to_date           IN   VARCHAR2,
     p_in_givenType         IN   VARCHAR2,    --05/23/2017
     p_in_locale            IN   VARCHAR2,
     p_in_file_name         IN   VARCHAR2,
     p_in_header            IN   VARCHAR2,
     p_out_return_code      OUT  VARCHAR2,
     p_out_result_set       OUT  sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Recognition Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
--  nagarajs           04/03/2017  Initial Creation - G6.2 Query redesign for perfomance changes
-- nagarajs            05/23/2017  Added Have/Have not filter                         
--Ravi Dhanekula       08/01/2017  G6-2770 submitter_comments not displaying.              
--Chidamba             09/28/2017  G6-2770 Added regular expression to remove HTML tags in submitter comments.
-- murphyc             01/10/2018  Bug 75238/G6-3759 - user_characteristics should be joined to giver, not recvr
--Chidamba             02/08/2018  use FNC_FORMAT_COMMENTS to format comments
--Gorantla             03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
--Loganathan 		   07/24/2019  Bug 79088 - Recognition Submitted as Private are coming in Recognition Report Extract
--Loganathan 		   07/24/2019  Bug 79105 - Recognition Submitted Private or Public should be distinguished in a new column in Recognition Received Reports
*******************************************************************************/

   -- constants
   c_delimiter                  CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter                 CONSTANT VARCHAR2(1) := '"' ;
   c_process_name               CONSTANT execution_log.process_name%TYPE := 'prc_recognition_given_extract';

   -- local variables
   file_handler                UTL_FILE.file_type;
   v_extract                   VARCHAR2(4000);
   v_file_location             VARCHAR2(1000);
   v_directory_name            all_directories.directory_name%TYPE; 
   directory_error             EXCEPTION;
   v_parm_list                 execution_log.text_line%TYPE;
   v_pattern                   VARCHAR2(15);
   v_recog_comment_enable      NUMBER(1);  
   v_stage                     VARCHAR2(1000);
   v_is_all_audience_giver     NUMBER; 
   v_locale                    VARCHAR2(15);
   
BEGIN
-- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_pax_status >' || p_in_pax_status   
      || '<, p_in_is_team >' || p_in_is_team     
      || '<, p_in_paxid >' || p_in_paxid   
      || '<, p_in_is_behavior >' || p_in_is_behavior 
      || '<, p_in_promotion_Id >' || p_in_promotion_Id  
      || '<, p_in_promo_status >' || p_in_promo_status  
      || '<, p_in_position_type >' || p_in_position_type
      || '<, p_in_department >' || p_in_department  
      || '<, p_in_country_Ids >' || p_in_country_Ids         
      || '<, p_in_from_date >' || p_in_from_date
      || '<, p_in_to_date >' || p_in_to_date
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header;

  BEGIN
    SELECT pattern 
      INTO v_pattern 
      FROM locale_date_pattern 
     WHERE locale=p_in_locale;
  EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
      v_pattern :='MM/DD/YYYY';
  END;

  v_stage := 'Get recognition comment system variable';
  BEGIN 
    SELECT boolean_val
      INTO v_recog_comment_enable
      FROM os_propertyset
     WHERE entity_name = 'report.recognition.comment.display';
  EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
    v_recog_comment_enable := 0;
  END;
  
  v_locale := NVL(p_in_locale, pkg_report_common.f_get_default_locale); --05/23/2017
  
  -- stage input lists
  v_stage := 'call fnc_check_promo_aud';
 v_is_all_audience_giver := fnc_check_promo_aud(gc_elg_type_giver, gc_promotion_type_recognition, p_in_promotion_id);  --05/23/2017

  -- stage input lists
   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(p_in_parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department, gc_search_all_values),  gc_ref_text_department_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_position_type, gc_search_all_values),  gc_ref_text_position_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_country_Ids, gc_search_all_values),   gc_ref_text_country_id, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id, gc_search_all_values),  gc_ref_text_promotion_id, 1);


  v_stage := 'Open p_out_result_set';
  OPEN p_out_result_set FOR
   WITH w_node AS
   (  -- get query node(s)
      SELECT DISTINCT
             DECODE(p_in_is_team, 1, hr.node_id, hr.child_node_id) AS node_id
        FROM gtt_id_list gil,
             rpt_hierarchy_rollup hr
       WHERE gil.ref_text_1 = gc_ref_text_parent_node_id
         AND gil.id = hr.node_id
   )
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_in_header 
         Textline
        FROM dual
       UNION ALL
      SELECT (ROWNUM+1),
       c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
       c2_delimiter||final_approver_name||c2_delimiter||c_delimiter||
       c2_delimiter||reason_denied||c2_delimiter||c_delimiter||         
       c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
       c2_delimiter||behavior||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_first_name||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_last_name||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_login_id||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_country||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_primary_org_unit||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_job_position||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_department||c2_delimiter||c_delimiter||
       c2_delimiter||giver_first_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_last_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_login_id||c2_delimiter||c_delimiter|| 
       c2_delimiter||proxy_user_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_country||c2_delimiter||c_delimiter||
       c2_delimiter||giver_primary_org_unit||c2_delimiter||c_delimiter||
       c2_delimiter||giver_job_position||c2_delimiter||c_delimiter||
       c2_delimiter||giver_department||c2_delimiter||c_delimiter||
       c2_delimiter||points||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_plateau_earned||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char15||c2_delimiter||c_delimiter||--G6-2770 08/01/2017 Added missingg characteristics also along with orginal fix listed in the bug.
       c2_delimiter||pax_char16||c2_delimiter||c_delimiter||       
       c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char20||c2_delimiter||c_delimiter|| 
       c2_delimiter||private_yn||c2_delimiter||c_delimiter||                 --07/24/2019 Bug 79088   
       CASE WHEN v_recog_comment_enable = 1 THEN c2_delimiter||
      --REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(submitter_comments,'<[^>]+>',''),'"','''""'''),CHR(10),''),CHR(13),''),';','')--02/08/2018
      FNC_FORMAT_COMMENTS(submitter_comments)  --02/08/2018 added
      ||c2_delimiter||c_delimiter ELSE NULL END --|| --G6-2770 08/01/2017 --09/28/2017--11/30/2017
--       CASE WHEN v_recog_comment_enable = 1 THEN c2_delimiter||submitter_comments_lang_id||c2_delimiter ELSE NULL END
  FROM (SELECT date_submitted,
               final_approver_name,
               ccv_pa.cms_name AS reason_denied, 
               cav_pn.cms_value AS promotion_name, 
               ccv_rb.cms_name AS behavior,  
               recvr_first_name,
               recvr_middle_name,
               recvr_last_name,
               recvr_login_id,
               cav_cn_r.cms_value AS recvr_country,
               recvr_primary_org_unit,
               ccv_pt_r.cms_name AS recvr_job_position, 
               ccv_dt_r.cms_name AS recvr_department,
               giver_user_id, -- 01/10/2018  
               giver_first_name,
               giver_middle_name,
               giver_last_name,
               giver_login_id, 
               proxy_user_name,
               cav_cn_g.cms_value AS giver_country,    
               giver_primary_org_unit,
               ccv_pt_g.cms_name AS giver_job_position, 
               ccv_dt_g.cms_name AS giver_department, 
               points,
               recvr_plateau_earned,    
               cuc_r.pax_char1,
               cuc_r.pax_char2,
               cuc_r.pax_char3,
               cuc_r.pax_char4,
               cuc_r.pax_char5,
               cuc_r.pax_char6,
               cuc_r.pax_char7,
               cuc_r.pax_char8,
               cuc_r.pax_char9,
               cuc_r.pax_char10,
               cuc_r.pax_char11,
               cuc_r.pax_char12,
               cuc_r.pax_char13,
               cuc_r.pax_char14,
               cuc_r.pax_char15,
               cuc_r.pax_char16,
               cuc_r.pax_char17,
               cuc_r.pax_char18,
               cuc_r.pax_char19,
               cuc_r.pax_char20,
               submitter_comments,   
               submitter_comments_lang_id,
               private_yn					--07/24/2019 Bug 79088	
          FROM (SELECT date_submitted,
                       final_approver_name,
                       reason_denied, 
                       p.promo_name_asset_code , 
                       rd.behavior,  				--07/24/2019 Bug 79088 Added the Alias "rd."
                       recvr_user_id,
                       recvr_first_name,
                       recvr_middle_name,
                       recvr_last_name,
                       recvr_login_id,
                       recvr_country_id,
                       n_r.name as recvr_primary_org_unit,
                       recvr_job_position,
                       recvr_department,
                       giver_user_id, -- 01/10/2018  
                       giver_first_name,
                       giver_middle_name,
                       giver_last_name,
                       giver_login_id, 
                       proxy_user_name,
                       giver_country_id,    
                       n_g.name AS giver_primary_org_unit,
                       giver_job_position, 
                       giver_department, 
                       award_amt points,
                       recvr_plateau_earned, 
                       --rd.submitter_comments,   			--07/24/2019 Bug 79088 Commented
                       case when allow_public_recognition=0 then NULL else  --08/02/2019 Bug 79105 
                       case when rc.hide_public_recognition = 1 then NULL else rd.submitter_comments end end  submitter_comments, --07/24/2019 Bug 79088
                       case when allow_public_recognition=0 then 'PRIVATE' else    --08/02/2019 Bug 79105
                       case when rc.hide_public_recognition = 1 then 'PRIVATE' else 'PUBLIC' end end private_yn, --07/24/2019 Bug 79088        
                       rd.submitter_comments_lang_id  
                  FROM w_node wn,
                       rpt_recognition_detail rd,
                       recognition_claim rc,			--07/24/2019 Bug 79088 Added
                       promo_recognition pr,            --08/02/2019 Bug 79105 
                       promotion p,
                       node n_g,
                       node n_r,
                       gtt_id_list gil_p,  -- promotion
                       gtt_id_list gil_c,  -- country
                       gtt_id_list gil_dt,  -- department
                       gtt_id_list gil_pt  -- position type
                 WHERE rd.claim_id IS NOT NULL
                   AND wn.node_id = rd.giver_node_id
                   AND rd.promotion_id   = p.promotion_id
                   AND p.promotion_status = NVL ( p_in_promo_status,p.promotion_status)
                   AND rd.claim_id      = rc.claim_id 	--07/24/2019 Bug 79088 Condition Added
                   AND p. promotion_id  = pr.promotion_id  		 --08/02/2019 Bug 79105 
                   AND rd.giver_node_id = n_g.node_id
                   AND rd.recvr_node_id = n_r.node_id
                   AND rd.giver_user_id = NVL(p_in_paxid, rd.giver_user_id) 
                   -- restrict by optional fields
                   AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                   AND (  gil_p.ref_text_2 = gc_search_all_values
                        OR gil_p.id = rd.promotion_id )
                   AND gil_dt.ref_text_1 = gc_ref_text_department_type
                   AND (  gil_dt.ref_text_2 = gc_search_all_values
                        OR gil_dt.ref_text_2 = giver_department )
                   AND gil_pt.ref_text_1 = gc_ref_text_position_type
                   AND (  gil_pt.ref_text_2 = gc_search_all_values
                        OR gil_pt.ref_text_2 = giver_job_position )
                   AND gil_c.ref_text_1 = gc_ref_text_country_id
                   AND (  gil_c.ref_text_2 = gc_search_all_values
                        OR gil_c.id =  rd.giver_country_id )
                   AND (  p_in_pax_status IS NULL
                        OR p_in_pax_status = giver_pax_status ) 
                   AND NVL (TRUNC (date_approved), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) 
                   AND ((p_in_is_behavior = 1 AND TRIM(rd.behavior) IS NOT NULL) OR p_in_is_behavior=0) --07/24/2019 Bug 79088 Added the Alias "rd." in behavior
                   AND p_in_givenType = 'have'
                 UNION ALL
                SELECT NULL date_submitted,
                       NULL final_approver_name,
                       NULL reason_denied,  
                       NULL AS promotion_name,
                       NULL AS recvr_user_id,
                       NULL AS behavior,              
                       NULL AS recvr_first_name,
                       NULL AS recvr_middle_name,
                       NULL AS recvr_last_name,
                       NULL AS recvr_login_id,
                       NULL AS recvr_country,
                       NULL AS recvr_primary_org_unit,
                       NULL AS recvr_job_position,
                       NULL AS recvr_department,
                       au.user_id giver_user_id, -- 01/10/2018
                       au.first_name giver_first_name,
                       au.middle_name giver_middle_name,
                       au.last_name giver_last_name,
                       au.user_name giver_login_id, 
                       au.user_name proxy_user_name,
                       c.country_id,
                       n.name AS giver_primary_org_unit,
                       paxe.position_type,  
                       paxe.department_type,  
                       NULL POINTS,
                       0 AS recvr_plateau_earned,
                       NULL AS submitter_comments,   
                       NULL AS private_yn ,                          --07/24/2019 Bug 79088 Added 
                       NULL AS submitter_comments_lang_id   
                 FROM ( -- build giver list
                          -- all pax audience
                          SELECT un.user_id,
                                 un.node_id,
                                 un.role AS org_role
                            FROM w_node wn,
                                 user_node un
                           WHERE v_is_all_audience_giver = 1
                             AND wn.node_id = un.node_id
                             AND un.status = 1
                             AND un.is_primary = 1
                           UNION
                          -- specify audience
                          SELECT un.user_id,
                                 un.node_id,
                                 un.role AS org_role
                            FROM w_node wn,
                                 rpt_pax_promo_eligibility ppe,
                                 user_node un,
                                 promotion p,
                                 promo_recognition pn,
                                 gtt_id_list gil_p      -- promotion
                           WHERE v_is_all_audience_giver = 0
                             AND wn.node_id = ppe.node_id
                             AND ppe.giver_recvr_type = gc_elg_type_giver
                             AND ppe.participant_id = un.user_id
                             AND ppe.node_id = un.node_id
                             AND un.status = 1
                             AND un.is_primary = 1
                             AND ppe.promotion_id = p.promotion_id
                              -- restrict to recognition promotions
                             AND ppe.promotion_id = pn.promotion_id
                             --AND p.promotion_status = gc_promotion_status_active --03/08/2018
                              -- restrict by optional fields
                             AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                             AND (  gil_p.ref_text_2 = gc_search_all_values
                                 OR gil_p.id = ppe.promotion_id )
                        ) giv,
                        (SELECT giver_user_id 
                           FROM rpt_recognition_detail rd,
                                gtt_id_list gil_p  -- promotion
                          WHERE gil_p.ref_text_1 = gc_ref_text_promotion_id
                            AND (  gil_p.ref_text_2 = gc_search_all_values
                                OR gil_p.id = rd.promotion_id )
                            AND NVL(recvr_sweepstakes_won,0) <> 1
                            AND NVL (TRUNC (date_approved),TRUNC (SYSDATE)) BETWEEN  TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)
                        ) rd,
                        application_user au,
                        rpt_participant_employer paxe,
                        gtt_id_list gil_dt,    -- department type
                        gtt_id_list gil_pt,     -- position type
                        user_address ua,
                        country c,
                        node n
                  WHERE giv.user_id = rd.giver_user_id (+)
                    AND rd.giver_user_id IS NULL
                    AND giv.user_id = au.user_id
                    AND giv.user_id = paxe.user_id (+) 
                     -- restrict by optional fields
                    AND gil_dt.ref_text_1 = gc_ref_text_department_type
                    AND (  gil_dt.ref_text_2 = gc_search_all_values
                        OR gil_dt.ref_text_2 = paxe.department_type )
                    AND gil_pt.ref_text_1 = gc_ref_text_position_type
                    AND (  gil_pt.ref_text_2 = gc_search_all_values
                        OR gil_pt.ref_text_2 = paxe.position_type )
                    AND DECODE(p_in_pax_status,
                          gc_pax_status_active, 1,
                          gc_pax_status_inactive, 0,
                          au.is_active) = au.is_active
                    AND giv.user_id = ua.user_id (+)
                    AND ua.is_primary (+) = 1
                    AND ua.country_id = c.country_id (+)
                    AND giv.node_id = n.node_id
                    AND p_in_givenType = 'have_not'
               ) rd,
               country c_g,
               country c_r,
               mv_cms_asset_value cav_cn_g, -- country name giver
               mv_cms_asset_value cav_cn_r, -- country name receiver
               mv_cms_asset_value cav_pn,   -- promotion name
               mv_cms_code_value ccv_pa,    -- promo approval option
               mv_cms_code_value ccv_rb,    --recognition behavior
               mv_cms_code_value ccv_dt_g,  -- department type giver
               mv_cms_code_value ccv_dt_r,  -- department type receiver
               mv_cms_code_value ccv_pt_g,  -- position type giver
               mv_cms_code_value ccv_pt_r,   -- position type receiver
               mv_cms_user_characteristic cuc_r   -- characteristics giver --01/10/2018
         WHERE rd.giver_country_id = c_g.country_id (+)
               AND rd.recvr_country_id = c_r.country_id (+)
               AND c_g.name_cm_key   = cav_cn_g.key (+)
               AND c_g.cm_asset_code = cav_cn_g.asset_code (+)
               AND v_locale          = cav_cn_g.locale (+)
               AND c_r.name_cm_key   = cav_cn_r.key (+)
               AND c_r.cm_asset_code = cav_cn_r.asset_code (+)
               AND v_locale          = cav_cn_r.locale (+)
               AND gc_cms_list_promo_approv_opt = ccv_pa.asset_code (+)
               AND rd.reason_denied        = ccv_pa.cms_code (+)
               AND v_locale                    = ccv_pa.locale (+)
               AND gc_cms_list_promo_recog_beha = ccv_rb.asset_code (+)
               AND rd.behavior        = ccv_rb.cms_code (+)
               AND v_locale                    = ccv_rb.locale (+)
               AND rd.promo_name_asset_code       = cav_pn.asset_code (+)
               AND gc_cms_key_fld_promotion_name = cav_pn.key (+)
               AND v_locale                      = cav_pn.locale (+)
               AND gc_cms_list_department_type = ccv_dt_g.asset_code (+)
               AND rd.giver_department    = ccv_dt_g.cms_code (+)
               AND v_locale                    = ccv_dt_g.locale (+)
               AND gc_cms_list_department_type = ccv_dt_r.asset_code (+)
               AND rd.recvr_department    = ccv_dt_r.cms_code (+)
               AND v_locale                    = ccv_dt_r.locale (+)
               AND gc_cms_list_position_type = ccv_pt_g.asset_code (+)
               AND rd.giver_job_position    = ccv_pt_g.cms_code (+)
               AND v_locale                  = ccv_pt_g.locale (+)
               AND gc_cms_list_position_type = ccv_pt_r.asset_code (+)
               AND rd.recvr_job_position    = ccv_pt_r.cms_code (+)
               AND v_locale                  = ccv_pt_r.locale (+)
--               AND rd.recvr_user_id = cuc_r.user_id (+) -- 01/10/2018
               AND rd.giver_user_id = cuc_r.user_id (+) -- 01/10/2018
               AND v_locale         = cuc_r.locale (+)
         --ORDER BY date_submitted ASC        
       ) 
  ) ;
  
  -- write result set to file
   IF (p_in_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
         UTL_FILE.put_line(file_handler, v_extract);           
      END LOOP;

      UTL_FILE.fclose(file_handler);

      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

   COMMIT;  -- release DML locks on temp table
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN 
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;
END PRC_RECOGNITION_GIVEN_EXTRACT;

PROCEDURE PRC_RECOGNITION_RECVD_EXTRACT
    (p_in_parentNodeId      IN   VARCHAR2,       
     p_in_pax_status        IN   VARCHAR2,
     p_in_is_team           IN   NUMBER,
     p_in_paxid             IN   NUMBER,
     p_in_is_behavior       IN   NUMBER,
     p_in_promotion_Id      IN   VARCHAR2,   
     p_in_promo_status      IN   VARCHAR2,
     p_in_position_type     IN   VARCHAR2,
     p_in_department        IN   VARCHAR2,   
     p_in_country_Ids       IN   VARCHAR2,   
     p_in_from_date         IN   VARCHAR2,
     p_in_to_date           IN   VARCHAR2,  
     p_in_locale            IN   VARCHAR2,
     p_in_file_name         IN   VARCHAR2,
     p_in_header            IN   VARCHAR2,
     p_out_return_code      OUT  VARCHAR2,
     p_out_result_set       OUT  sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Recognition Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
--  nagarajs           04/03/2017  Initial Creation - G6.2 Query redesign for perfomance changes
-- nagarajs            05/23/2017  Added Have/Have not filter
-- murphyc             01/10/2018  Bug 75238/G6-3759 - user_characteristics should be joined to recvr, not giver
-- chidamba			   02/08/2018  G6-3850 use FNC_FORMAT_COMMENTS to format comments                                    
-- Chidamba            02/15/2018  G6-3871 - include sweepstacks in extract.     
-- Gorantla            03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
-- Loganathan          08/02/2019  Bug 79105 - Recognition Submitted Private or Public should be distinguished in a new column in Recognition Received Reports
*******************************************************************************/

   -- constants
   c_delimiter                  CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter                 CONSTANT VARCHAR2(1) := '"' ;
   c_process_name               CONSTANT execution_log.process_name%TYPE := 'prc_recognition_recvd_extract';
   
   -- local variables
   file_handler                UTL_FILE.file_type;
   v_extract                   VARCHAR2(4000);
   v_file_location             VARCHAR2(1000);
   v_directory_name            all_directories.directory_name%TYPE; 
   directory_error             EXCEPTION;
   v_parm_list                 execution_log.text_line%TYPE;
   v_pattern                   VARCHAR2(15);
   v_recog_comment_enable      NUMBER(1);  
   v_stage                     VARCHAR2(1000);
   
BEGIN
-- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_pax_status >' || p_in_pax_status   
      || '<, p_in_is_team >' || p_in_is_team     
      || '<, p_in_paxid >' || p_in_paxid   
      || '<, p_in_is_behavior >' || p_in_is_behavior 
      || '<, p_in_promotion_Id >' || p_in_promotion_Id  
      || '<, p_in_promo_status >' || p_in_promo_status  
      || '<, p_in_position_type >' || p_in_position_type
      || '<, p_in_department >' || p_in_department  
      || '<, p_in_country_Ids >' || p_in_country_Ids         
      || '<, p_in_from_date >' || p_in_from_date
      || '<, p_in_to_date >' || p_in_to_date
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header;
      
      v_stage := 'DELETE and INSERT temp_table_session';
  DELETE temp_table_session;
    INSERT INTO temp_table_session
      SELECT asset_code,cms_value,key 
        FROM vw_cms_asset_value 
       WHERE key='COUNTRY_NAME' and locale = p_in_locale
       UNION
      SELECT asset_code,cms_value,key 
        FROM vw_cms_asset_value 
       WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                             WHERE promotion_type = 'recognition')
         AND locale = p_in_locale
       UNION  
      SELECT asset_code,cms_name,cms_code
        FROM vw_cms_code_value E
       WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items','picklist.promo.recognition.behavior.items','picklist.promotion.approval.option.reason.type.items')   
         AND e.locale=p_in_locale;

  v_stage := 'DELETE and INSERT chacracteristics_cms';
  DELETE chacracteristics_cms;                                  
    INSERT INTO chacracteristics_cms
      SELECT c.characteristic_id,vw.cms_name,vw.cms_code 
        FROM characteristic c,vw_cms_code_value vw 
       WHERE pl_name is not null 
         AND vw.asset_code = c.pl_name 
         AND locale = p_in_locale
       UNION 
      SELECT characteristic_id,characteristic_value cms_name,characteristic_value cms_code 
        FROM user_characteristic 
       WHERE characteristic_id in (SELECT characteristic_id FROM characteristic WHERE pl_name is null)
       UNION
      SELECT characteristic_id,cms_name,cms_code 
        FROM rpt_user_characteristic
       WHERE locale = p_in_locale;

  BEGIN
    SELECT pattern 
      INTO v_pattern 
      FROM locale_date_pattern 
     WHERE locale=p_in_locale;
  EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
      v_pattern :='MM/DD/YYYY';
  END;

  v_stage := 'Get recognition comment system variable';
  BEGIN 
    SELECT boolean_val
      INTO v_recog_comment_enable
      FROM os_propertyset
     WHERE entity_name = 'report.recognition.comment.display';
  EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
    v_recog_comment_enable := 0;
  END;
  
  -- stage input lists
   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(p_in_parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department, gc_search_all_values),  gc_ref_text_department_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_position_type, gc_search_all_values),  gc_ref_text_position_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_country_Ids, gc_search_all_values),   gc_ref_text_country_id, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id, gc_search_all_values),  gc_ref_text_promotion_id, 1);


  v_stage := 'Open p_out_result_set';
  OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_in_header 
         Textline
        FROM dual
       UNION
      SELECT (ROWNUM+1),
       c2_delimiter||date_submitted||c2_delimiter||c_delimiter||
       c2_delimiter||final_approver_name||c2_delimiter||c_delimiter||
       c2_delimiter||reason_denied||c2_delimiter||c_delimiter||         
       c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
       c2_delimiter||behavior||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_first_name||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_last_name||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_login_id||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_country||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_primary_org_unit||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_job_position||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_department||c2_delimiter||c_delimiter||
       c2_delimiter||giver_first_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_last_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_login_id||c2_delimiter||c_delimiter|| 
       c2_delimiter||proxy_user_name||c2_delimiter||c_delimiter||
       c2_delimiter||giver_country||c2_delimiter||c_delimiter||
       c2_delimiter||giver_primary_org_unit||c2_delimiter||c_delimiter||
       c2_delimiter||giver_job_position||c2_delimiter||c_delimiter||
       c2_delimiter||giver_department||c2_delimiter||c_delimiter||
       c2_delimiter||points||c2_delimiter||c_delimiter||
       c2_delimiter||recvr_plateau_earned||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char16||c2_delimiter||c_delimiter||       
       c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char20||c2_delimiter||c_delimiter|| 
       c2_delimiter||private_yn||c2_delimiter||c_delimiter||		--08/02/2019 Bug 79105 
       CASE WHEN v_recog_comment_enable = 1 THEN c2_delimiter||
       --REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(submitter_comments,'<[^>]+>',''),'"','''""'''),CHR(10),''),CHR(13),''),';','')--02/08/2017 
        fnc_format_comments(submitter_comments)||c2_delimiter||c_delimiter ELSE NULL END ||  --G6-2770  --09/28/2017--11/30/2017   --02/08/2018 
       CASE WHEN v_recog_comment_enable = 1 THEN c2_delimiter||submitter_comments_lang_id||c2_delimiter ELSE NULL END
  FROM (SELECT date_submitted,
               final_approver_name,
               (select cms_name from temp_table_session where asset_code = 'picklist.promotion.approval.option.reason.type.items' and cms_code = reason_denied) AS reason_denied, 
               (select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) promotion_name, 
               (select cms_name from temp_table_session where asset_code = 'picklist.promo.recognition.behavior.items' and cms_code = rd.behavior) AS behavior, --08/02/2019 Bug 79105 Added "rd."  in behavior   
               recvr_first_name,
               recvr_middle_name,
               recvr_last_name,
               recvr_login_id,
               (select cms_name from temp_table_session where asset_code = c.cm_asset_code) recvr_country,
               (select node_name FROM rpt_hierarchy where node_id = recvr_node_id) recvr_primary_org_unit,
               (select cms_name from temp_table_session where asset_code = 'picklist.positiontype.items' and cms_code = recvr_job_position) AS recvr_job_position, 
               (select cms_name from temp_table_session where asset_code = 'picklist.department.type.items' and cms_code = recvr_department) AS recvr_department,  
               giver_first_name,
               giver_middle_name,
               giver_last_name,
               giver_login_id, 
               proxy_user_name,
               (select cms_name from temp_table_session where asset_code=c1.cm_asset_code) giver_country,    
               (select node_name FROM rpt_hierarchy where node_id = giver_node_id ) giver_primary_org_unit,
               (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= giver_job_position) AS giver_job_position, 
               (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= giver_department) AS giver_department, 
               award_amt points,
               recvr_plateau_earned,    
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,    
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
               (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20,     
                 --rd.submitter_comments,   --08/02/2019 Bug 79105 commented
               case when allow_public_recognition=0 then NULL else  --08/02/2019 Bug 79105
               case when rc.hide_public_recognition = 1 then NULL else rd.submitter_comments end  end submitter_comments, --08/02/2019 Bug 79105
               case when allow_public_recognition=0 then 'PRIVATE' else 
               case when rc.hide_public_recognition = 1 then 'PRIVATE' else 'PUBLIC' end end private_yn, ---08/02/2019 Bug 79105   
               rd.submitter_comments_lang_id  
          FROM rpt_recognition_detail rd,
          	   recognition_claim rc,			---08/02/2019 Bug 79105 Added
               promo_recognition pr,---08/02/2019 Bug 79105 Added
               promotion p,
               country c,
               country c1,
               rpt_characteristic rch,
               gtt_id_list gil_p,  -- promotion
               gtt_id_list gil_c,  -- country
               gtt_id_list gil_dt,  -- department
               gtt_id_list gil_pt  -- position type
         WHERE --rd.claim_id IS NOT NULL  --02/15/2018 claim id will be null for sweepstakes 
               rd.promotion_id   = p.promotion_id
           AND p.promotion_status = NVL ( p_in_promo_status,p.promotion_status) 
           AND rd.claim_id          = rc.claim_id 	                                  ---08/02/2019 Bug 79105 Condition Added
           AND p. promotion_id      = pr.promotion_id                                  ---08/02/2019 Bug 79105 Condition Added
           AND rd.recvr_country_id  = c.country_id(+)   --02/15/2018 country id will be null for sweepstakes 
           AND rd.giver_country_id  = c1.country_id(+)  --02/15/2018 claim id will be null for sweepstakes 
--           AND rch.user_nt_id(+)  = rd.giver_user_id -- 01/10/2018
           AND rch.user_nt_id(+)  = rd.recvr_user_id -- 01/10/2018
           AND rch.characteristic_type (+) = 'USER'  
           -- restrict by optional fields
           AND gil_p.ref_text_1 = gc_ref_text_promotion_id
           AND (  gil_p.ref_text_2 = gc_search_all_values
                OR gil_p.id = rd.promotion_id )
           AND gil_dt.ref_text_1 = gc_ref_text_department_type
           AND (  gil_dt.ref_text_2 = gc_search_all_values
                OR gil_dt.ref_text_2 = recvr_department )
           AND gil_pt.ref_text_1 = gc_ref_text_position_type
           AND (  gil_pt.ref_text_2 = gc_search_all_values
                OR gil_pt.ref_text_2 = recvr_job_position )
           AND gil_c.ref_text_1 = gc_ref_text_country_id
           AND (  gil_c.ref_text_2 = gc_search_all_values
                OR gil_c.id =  c.country_id )
           AND (  p_in_pax_status IS NULL
                OR p_in_pax_status = recvr_pax_status ) 
           AND NVL (TRUNC (date_approved), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) 
           AND ((p_in_is_behavior = 1 AND TRIM(rd.behavior) IS NOT NULL) OR p_in_is_behavior=0) --08/02/2019 Bug 79105 Added "rd."  in behavior
           AND ((p_in_paxid IS  NOT NULL AND  recvr_user_id = p_in_paxid) OR
                (p_in_paxid IS NULL AND ((NVL(p_in_is_Team,0) = 0 AND EXISTS (SELECT 1
                                                                                FROM gtt_id_list gil,
                                                                                     rpt_hierarchy h,
                                                                                     rpt_hierarchy_rollup hr
                                                                               WHERE gil.ref_text_1 = gc_ref_text_parent_node_id
                                                                                 AND gil.id = h.node_id 
                                                                                 AND h.is_deleted = 0
                                                                                 AND h.node_id = hr.node_id
                                                                                 AND hr.child_node_id =  recvr_node_id))
                                          OR(p_in_is_Team=1 AND recvr_node_id = p_in_parentNodeId))))
          ORDER BY date_submitted ASC        
       ) 
  ) ;

  -- write result set to file
   IF (p_in_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
         UTL_FILE.put_line(file_handler, v_extract);           
      END LOOP;

      UTL_FILE.fclose(file_handler);
--start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

   COMMIT;  -- release DML locks on temp table
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN 
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;
END PRC_RECOGNITION_RECVD_EXTRACT;

PROCEDURE PRC_QUIZ_EXTRACT
   (parentNodeId      IN VARCHAR2,       
    p_in_pax_status   IN VARCHAR2,
    p_paxid       IN NUMBER,
    Is_team      IN NUMBER,
    p_in_promotion_Id IN VARCHAR2,
    p_in_quiz_id IN VARCHAR2,
    p_in_promo_status IN VARCHAR2,
    p_in_position_type     IN VARCHAR2,
    p_in_department   IN VARCHAR2,
    p_result IN VARCHAR2,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,   
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for ' Quiz Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
-- Ravi Dhanekula     01/16/2013    Initial Version
                    04/02/2014     Added fix for the defects 50697 and 52548 
                    04/04/2014     Fixed the bug # 51804
-- nagarajs           07/15/2014  Fixed the Bug # 54789 - Quiz status Needs to be Translated 
-- nagarajs           07/16/2014     Bug # 54917 - close the file and include parms value when OTHER exception
-- Swati              10/24/2014    Bug 57501 - Reports - Quiz Activity - Summary - Quiz Attempts column value is not matching with Extract
--nagarajs          09/30/2015     G5E-28 - Remove Points column if plateau.platform.only enabled
--nagarajs          11/26/2015     Bug 64819 and 64785 - Points column value not showing in Extracts
--nagarajs          01/08/2016    Bug 65113 - Quiz-Activity-Reports-Summary table is not matched with export records
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
*******************************************************************************/

   -- constants
    c_delimiter CONSTANT VARCHAR2(1) := ',' ;
    c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
    -- local variables
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    p_in_locale VARCHAR2(10) :=locale;
    v_pattern    VARCHAR2(15);
    v_plateau_enable  NUMBER(1); --09/30/2015
    
    l_cursor  SYS_REFCURSOR;
   
BEGIN

DELETE temp_table_session;

INSERT INTO temp_table_session --04/04/2014---Bug #51804
 SELECT asset_code,cms_name,cms_code
     FROM vw_cms_code_value E
    WHERE asset_code in ( 'picklist.department.type.items','picklist.positiontype.items') and e.locale=p_in_locale
UNION --07/15/2014 Bug # 54789
SELECT asset_code,cms_name,cms_code
  FROM vw_cms_code_value 
 WHERE asset_code = 'picklist.quiz.result.type.items'
   AND locale = p_in_locale;

DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

BEGIN  --09/30/2015
SELECT boolean_val INTO v_plateau_enable FROM os_propertyset WHERE entity_name = 'drive.enabled';
EXCEPTION WHEN no_data_found THEN 
v_plateau_enable := 0;
END;

IF p_file_name IS NULL THEN         
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
       c2_delimiter||first_name||c2_delimiter||c_delimiter||
       c2_delimiter||middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||last_name||c2_delimiter||c_delimiter||
       c2_delimiter||login_id||c2_delimiter||c_delimiter||
       c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
       c2_delimiter||job_position||c2_delimiter||c_delimiter||
       c2_delimiter||department||c2_delimiter||c_delimiter||       
       c2_delimiter||quiz_promotion||c2_delimiter||c_delimiter||
       c2_delimiter||q_date||c2_delimiter||c_delimiter||
       c2_delimiter||quiz_score||c2_delimiter||c_delimiter||
       c2_delimiter||quiz_result||c2_delimiter||c_delimiter||
       CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||points_cnt||c2_delimiter||c_delimiter ELSE NULL END||  --09/30/2015 --11/26/2015
       c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
       c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
  FROM (SELECT rad.participant_first_name first_name,
  rad.participant_middle_name middle_name,
  rad.participant_last_name last_name,
  au.user_name login_id,
  rh.node_name primary_org_unit,
  (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=rad.job_title) job_position, --04/04/2014---Bug #51804
  (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=rad.department) department, --04/04/2014---Bug #51804
  rad.promo_quiz_name AS quiz_promotion,
  TO_CHAR(rad.quiz_date,'dd-Mon-yy') q_date,
  decode(rad.quiz_score,NULL,NULL,rad.quiz_score
  ||' of '
  ||rad.quiz_passing_score
  ||' ('
  ||rad.quiz_passing_score
  ||')') quiz_score,
  (select cms_name from temp_table_session where asset_code='picklist.quiz.result.type.items' and cms_code=rad.quiz_result) quiz_result, --rad.quiz_result --07/15/2014 Bug # 54789 
  rad.award_amount points_cnt,
  (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
FROM rpt_quiz_activity_detail rad,
  application_user au,
  rpt_hierarchy rh,
  promotion p,
  rpt_characteristic rch
WHERE au.user_id(+)        = rad.participant_id
AND rch.user_nt_id(+)      = rad.participant_id
AND rch.characteristic_type(+)  = 'USER' --10/24/2014 Bug 57501
AND rad.quiz_claim_id IS NOT NULL
AND rh.node_id             = rad.node_id
AND rad.promotion_id       = p.promotion_id
--AND (rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) --04/02/2014 Start --fix for the defects 50697 and 52548 
--           OR (p_in_promotion_Id is NULL))
AND ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND rad.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 Start --fixfor the defects 50697 and 52548  
AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rh.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rh.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rad.participant_id=p_paxid))
AND rad.participant_status = NVL(p_in_pax_status, rad.participant_status)
AND p.promotion_status     = NVL(p_in_promo_status,p.promotion_status)
--AND NVL(TRUNC(rad.award_date),TRUNC(sysdate)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 --01/08/2016
AND NVL(TRUNC(rad.quiz_date),TRUNC(sysdate)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)  --01/08/2016
AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
AND NVL(rad.job_title,'job')     = NVL(p_in_position_type,NVL(rad.job_title,'job'))
AND NVL(rad.quiz_result,'sweep')   = NVL(p_result ,NVL(rad.quiz_result,'sweep') ) ORDER BY node_name_sort,rh.path )   --12/18/2014 
) ;

p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
 
OPEN l_cursor FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
       c2_delimiter||first_name||c2_delimiter||c_delimiter||
       c2_delimiter||middle_name||c2_delimiter||c_delimiter||
       c2_delimiter||last_name||c2_delimiter||c_delimiter||
       c2_delimiter||login_id||c2_delimiter||c_delimiter||
       c2_delimiter||primary_org_unit||c2_delimiter||c_delimiter||
       c2_delimiter||job_position||c2_delimiter||c_delimiter||
       c2_delimiter||department||c2_delimiter||c_delimiter||       
       c2_delimiter||quiz_promotion||c2_delimiter||c_delimiter||
       c2_delimiter||q_date||c2_delimiter||c_delimiter||
       c2_delimiter||quiz_score||c2_delimiter||c_delimiter||
       c2_delimiter||quiz_result||c2_delimiter||c_delimiter||
       CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||points_cnt||c2_delimiter||c_delimiter ELSE NULL END||  --09/30/2015 --11/26/2015
       c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
       c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
  FROM (SELECT rad.participant_first_name first_name,
  rad.participant_middle_name middle_name,
  rad.participant_last_name last_name,
  au.user_name login_id,
  rh.node_name primary_org_unit,
  (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code=rad.job_title) job_position, --04/04/2014---Bug #51804
  (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code=rad.department) department, --04/04/2014---Bug #51804
  rad.promo_quiz_name AS quiz_promotion,
  TO_CHAR(rad.quiz_date,'dd-Mon-yy') q_date,
  decode(rad.quiz_score,NULL,NULL,rad.quiz_score
  ||' of '
  ||rad.quiz_passing_score
  ||' ('
  ||rad.quiz_passing_score
  ||')') quiz_score,
  (select cms_name from temp_table_session where asset_code='picklist.quiz.result.type.items' and cms_code=rad.quiz_result) quiz_result, --rad.quiz_result --07/15/2014 Bug # 54789 
  rad.award_amount points_cnt,
  (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
FROM rpt_quiz_activity_detail rad,
  application_user au,
  rpt_hierarchy rh,
  promotion p,
  rpt_characteristic rch
WHERE au.user_id(+)        = rad.participant_id
AND rch.user_nt_id(+)      = rad.participant_id
AND rch.characteristic_type(+)  = 'USER' --10/24/2014 Bug 57501
AND rad.quiz_claim_id IS NOT NULL
AND rh.node_id             = rad.node_id
AND rad.promotion_id       = p.promotion_id
--AND (rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) --04/02/2014 Start --fix for the defects 50697 and 52548 
--           OR (p_in_promotion_Id is NULL))
AND ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND rad.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND rad.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 Start --fixfor the defects 50697 and 52548  
AND (  ( p_paxid IS NULL                                                                
        AND (            
                 (NVL(is_Team,0)=0 AND rh.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND rh.NODE_ID=parentNodeId)))   OR  (p_paxid IS  NOT NULL AND  rad.participant_id=p_paxid))
AND rad.participant_status = NVL(p_in_pax_status, rad.participant_status)
AND p.promotion_status     = NVL(p_in_promo_status,p.promotion_status)
--AND NVL(TRUNC(rad.award_date),TRUNC(sysdate)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013 --01/08/2016
AND NVL(TRUNC(rad.quiz_date),TRUNC(sysdate)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern)  --01/08/2016
AND (rad.department IN (SELECT * FROM TABLE(get_array_varchar(p_in_department)))
           OR (p_in_department is NULL))
AND NVL(rad.job_title,'job')     = NVL(p_in_position_type,NVL(rad.job_title,'job'))
AND NVL(rad.quiz_result,'sweep')   = NVL(p_result ,NVL(rad.quiz_result,'sweep') ) ORDER BY node_name_sort,rh.path )   --12/18/2014 
) ;

-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;

    UTL_FILE.fclose(file_handler);

	 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_QUIZ_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_pax_status||': '||'p_in_pax_status'||p_paxid ||': '||'p_paxid '|| --07/16/2014 Bug # 54917
        Is_team||': '||'Is_team'||p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_quiz_id||': '||'p_in_quiz_id'||
        p_in_promo_status||': '||'p_in_promo_status'||p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||
        p_result||': '||'p_result'||p_in_from_date||': '||'p_in_from_date'||p_in_to_date||': '||'p_in_to_date'||
        locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null);   --02/25/2014     
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_QUIZ_EXTRACT;

 PROCEDURE PRC_QUIZ_ANALYSIS_EXTRACT
   (p_in_promotion_Id IN VARCHAR2,
    p_in_quiz_id IN VARCHAR2,
    p_in_promo_status IN VARCHAR2,    
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,   
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor)
      IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for ' Quiz Analysis Extract'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 01/16/2013  Initial Version
                           04/02/2014 fix for the defects 50697 and 52548 
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
--Suresh J       09/30/2014  Bug Fix 57049 - In Asynchronous report extract Quiz Analysis report extract is displaying no data.
--Suresh J       08/01/2015  Bug Fix 58951 - Display Quiz Promotion Name as the first column in Summary Table 
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.                                 
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   -- local variables
      file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    p_in_locale VARCHAR2(10) :=locale;
    v_pattern    VARCHAR2(15);
    
    l_cursor  SYS_REFCURSOR;
BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE WHERE key='QUESTION_NAME' AND locale = p_in_locale; --04/01/2014

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;
--09/30/2014
IF p_file_name IS NULL THEN         
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||Quiz_Promotion_Name||c2_delimiter||c_delimiter||
       c2_delimiter||Quiz_Type||c2_delimiter||c_delimiter||
       c2_delimiter||Quiz_Start_Date||c2_delimiter||c_delimiter||
       c2_delimiter||Quiz_End_Date||c2_delimiter||c_delimiter||
       c2_delimiter||Questions_In_Pool||c2_delimiter||c_delimiter||
       c2_delimiter||Questions_To_Ask_Per_Attempt||c2_delimiter||c_delimiter||
       c2_delimiter||Max_Attempts_Allowed_for_Pax||c2_delimiter||c_delimiter||
       c2_delimiter||Questions||c2_delimiter||c_delimiter||
       c2_delimiter||Number_Of_Times_Asked||c2_delimiter||c_delimiter||
       c2_delimiter||Number_of_Correct_Responses||c2_delimiter||c_delimiter||
       c2_delimiter||Percent_Of_Correct_Response||c2_delimiter||c_delimiter||
       c2_delimiter||Number_of_InCorrect_Responses||c2_delimiter||c_delimiter||
       c2_delimiter||Percent_Of_InCorrect_Response||c2_delimiter  
  FROM (SELECT 
--  qa.q_name Quiz_Promotion_Name,   --01/08/2015
  p.promotion_name as Quiz_Promotion_Name,   --01/08/2015 
  qa.q_type Quiz_Type,
  TO_DATE(p_in_from_date,v_pattern) Quiz_Start_Date,
  TO_DATE(p_in_to_date,v_pattern) Quiz_End_Date,
  qpool.q_in_pool Questions_In_Pool,
  DECODE(UPPER(qa.q_type), 'FIXED', qpool.q_in_pool, qa.q_number_asked) questions_to_ask_per_attempt,
  NVL(DECODE(pz.allow_unlimited_attempts, 1, 'unlimited', pz.maximum_attempts), '0') Max_Attempts_Allowed_for_Pax,
--  FNC_CMS_ASSET_CODE_VAL_EXTR(QQ.QQ_CM_ASSET_NAME,'QUESTION_NAME',locale) Questions,--07/01/2013
  (SELECT cms_name FROM temp_table_session WHERE asset_code=qq.qq_cm_asset_name) Questions, --04/01/2014
  NVL(nbr_of_times_asked,0) Number_Of_Times_Asked,
  NVL(nbr_correct,0) Number_of_Correct_Responses ,
  ROUND(NVL((nbr_correct               /nbr_of_times_asked)*100,0),2) AS Percent_Of_Correct_Response,
  (NVL(nbr_of_times_asked,0)           -NVL(nbr_correct,0)) Number_of_InCorrect_Responses ,
  ROUND(NVL(((NVL(nbr_of_times_asked,0)-NVL(nbr_correct,0))/nbr_of_times_asked)*100,0),2) AS Percent_Of_InCorrect_Response
FROM
  (SELECT qq.q_id,
    qq.qq_id,
    qq.qq_cm_asset_name,
    SUM(qq.number_of_times_asked) nbr_of_times_asked,
    SUM(qq.number_of_correct_responses) nbr_correct
  FROM rpt_quiz_qq_analysis qq,
    promotion p
  WHERE qq.promotion_id  = p.promotion_id
--AND (qq.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) --04/02/2014 fix for the defects 50697 and 52548 
--           OR (p_in_promotion_Id is NULL))
AND ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND qq.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.q_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
  AND p.promotion_status = NVL(p_in_promo_status,p.promotion_status)
  AND NVL(TRUNC(qq.date_asked),TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
  GROUP BY q_id,
    qq_id,
    qq_cm_asset_name
  ) qq,
  (SELECT main.quiz_question_id qq_id,
    main.quiz_question_answer_id qqa_id,
    main.promotion_id promotion_id,
    main.is_correct,
    NVL(number_of_times_SELECTed, 0) number_of_times_selected
  FROM
    (SELECT r.qq_id,
      r.qqa_id,
      r.promotion_id,
      r.is_correct,
      SUM(r.number_of_times_SELECTed) number_of_times_SELECTed
    FROM rpt_quiz_qqa_analysis r,
      promotion p,
      quiz_question qq
    WHERE 
--     (r.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) ----04/02/2014 fix for the defects 50697 and 52548
--           OR (p_in_promotion_Id is NULL))
 ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND r.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
      AND p.promotion_status = NVL(p_in_promo_status,p.promotion_status)
    AND p.promotion_id     = r.promotion_id
    AND r.qq_id = qq.quiz_question_id
    GROUP BY r.qq_id,
      r.qqa_id,
      r.promotion_id,
      r.qqa_cm_asset_code,
      r.qqa_answer_cm_key,
      r.is_correct
    ) rpt,
    (SELECT qqa.quiz_question_id,
      qqa.quiz_question_answer_id,
      p.promotion_id,
      qqa.is_correct
    FROM promo_quiz pq,
      quiz_question qq,
      quiz_question_answer qqa,
      promotion p,
      diy_quiz dq
    WHERE  
--    (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))
--           OR (p_in_promotion_Id is NULL))
    ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
    AND p.promotion_status   = NVL(p_in_promo_status,p.promotion_status)
    AND p.promotion_id = pq.promotion_id(+)       
    AND P.promotion_id = dq.promotion_id(+)
    AND NVL(pq.quiz_id,dq.quiz_id)           = qq.quiz_id
    AND qq.quiz_question_id  = qqa.quiz_question_id
    AND lower(qq.status_type)= 'active'
    ) main
  WHERE main.quiz_question_answer_id = rpt.qqa_id(+)
  ) qqa,
  rpt_quiz_analysis qa,
  (SELECT COUNT(1) q_in_pool,
    quiz_id
  FROM quiz_question
  WHERE STATUS_TYPE = 'active'
  GROUP BY QUIZ_ID
  ) qpool,
  promo_quiz pz,
  diy_quiz dq,
  (SELECT p.promotion_id,
    maximum_attempts,
    SUM(number_passed) passed,
    SUM(number_failed) failed,
    SUM(number_incomplete) incomplete    
  FROM rpt_quiz_attempts_analysis qa,
    promotion p
  WHERE  
--  (qa.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))
--           OR (p_in_promotion_Id is NULL))
   ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qa.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
  AND p.promotion_status  = NVL(p_in_promo_status,p.promotion_status)
  AND qa.promotion_id     = p.promotion_id
  AND NVL(TRUNC(qa.submission_date),TRUNC(sysdate)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
  GROUP BY p.promotion_id,
    maximum_attempts  
  ) qaa,
  promotion p
WHERE qqa.promotion_id = pz.promotion_id(+)
AND qqa.promotion_id = dq.promotion_id(+)
--AND (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))
--           OR (p_in_promotion_Id is NULL))
AND ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.q_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548
AND p.promotion_status = NVL(p_in_promo_status,p.promotion_status)
AND qa.q_id            = NVl(pz.quiz_id,dq.quiz_id)
AND qq.qq_id           = qqa.qq_id
AND qa.q_id            = qq.q_id
AND qq.q_id            = qpool.quiz_id
AND qqa.promotion_id   = qaa.promotion_id(+)
GROUP BY 
--qa.q_name,   --01/08/2015
  p.promotion_name ,   --01/08/2015
  qa.q_type,
  qpool.q_in_pool,
  NVL(nbr_correct,0),
   NVL(nbr_of_times_asked,0),
  ROUND(NVL((nbr_correct/nbr_of_times_asked)*100,0),2),
  DECODE(UPPER(qa.q_type), 'FIXED', qpool.q_in_pool, qa.q_number_asked),
  NVL(DECODE(pz.allow_unlimited_attempts, 1, 'unlimited', pz.maximum_attempts), '0'),
--  FNC_CMS_ASSET_CODE_VAL_EXTR(QQ.QQ_CM_ASSET_NAME,'QUESTION_NAME',locale),--07/01/2013
  qq.qq_cm_asset_name, --04/01/2014
  ROUND(NVL((nbr_correct               /nbr_of_times_asked)*100,0),2),
  (NVL(nbr_of_times_asked,0)           -NVL(nbr_correct,0)),
  ROUND(NVL(((NVL(nbr_of_times_asked,0)-NVL(nbr_correct,0))/nbr_of_times_asked)*100,0),2)
ORDER BY Questions)
) ;
p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||Quiz_Promotion_Name||c2_delimiter||c_delimiter||
       c2_delimiter||Quiz_Type||c2_delimiter||c_delimiter||
       c2_delimiter||Quiz_Start_Date||c2_delimiter||c_delimiter||
       c2_delimiter||Quiz_End_Date||c2_delimiter||c_delimiter||
       c2_delimiter||Questions_In_Pool||c2_delimiter||c_delimiter||
       c2_delimiter||Questions_To_Ask_Per_Attempt||c2_delimiter||c_delimiter||
       c2_delimiter||Max_Attempts_Allowed_for_Pax||c2_delimiter||c_delimiter||
       c2_delimiter||Questions||c2_delimiter||c_delimiter||
       c2_delimiter||Number_Of_Times_Asked||c2_delimiter||c_delimiter||
       c2_delimiter||Number_of_Correct_Responses||c2_delimiter||c_delimiter||
       c2_delimiter||Percent_Of_Correct_Response||c2_delimiter||c_delimiter||
       c2_delimiter||Number_of_InCorrect_Responses||c2_delimiter||c_delimiter||
       c2_delimiter||Percent_Of_InCorrect_Response||c2_delimiter  
  FROM (SELECT 
--  qa.q_name Quiz_Promotion_Name,   --01/08/2015
  p.promotion_name as Quiz_Promotion_Name,   --01/08/2015 
  qa.q_type Quiz_Type,
  TO_DATE(p_in_from_date,v_pattern) Quiz_Start_Date,
  TO_DATE(p_in_to_date,v_pattern) Quiz_End_Date,
  qpool.q_in_pool Questions_In_Pool,
  DECODE(UPPER(qa.q_type), 'FIXED', qpool.q_in_pool, qa.q_number_asked) questions_to_ask_per_attempt,
  NVL(DECODE(pz.allow_unlimited_attempts, 1, 'unlimited', pz.maximum_attempts), '0') Max_Attempts_Allowed_for_Pax,
--  FNC_CMS_ASSET_CODE_VAL_EXTR(QQ.QQ_CM_ASSET_NAME,'QUESTION_NAME',locale) Questions,--07/01/2013
  (SELECT cms_name FROM temp_table_session WHERE asset_code=qq.qq_cm_asset_name) Questions, --04/01/2014
  NVL(nbr_of_times_asked,0) Number_Of_Times_Asked,
  NVL(nbr_correct,0) Number_of_Correct_Responses ,
  ROUND(NVL((nbr_correct               /nbr_of_times_asked)*100,0),2) AS Percent_Of_Correct_Response,
  (NVL(nbr_of_times_asked,0)           -NVL(nbr_correct,0)) Number_of_InCorrect_Responses ,
  ROUND(NVL(((NVL(nbr_of_times_asked,0)-NVL(nbr_correct,0))/nbr_of_times_asked)*100,0),2) AS Percent_Of_InCorrect_Response
FROM
  (SELECT qq.q_id,
    qq.qq_id,
    qq.qq_cm_asset_name,
    SUM(qq.number_of_times_asked) nbr_of_times_asked,
    SUM(qq.number_of_correct_responses) nbr_correct
  FROM rpt_quiz_qq_analysis qq,
    promotion p
  WHERE qq.promotion_id  = p.promotion_id
--AND (qq.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) --04/02/2014 fix for the defects 50697 and 52548 
--           OR (p_in_promotion_Id is NULL))
AND ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND qq.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.q_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
  AND p.promotion_status = NVL(p_in_promo_status,p.promotion_status)
  AND NVL(TRUNC(qq.date_asked),TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
  GROUP BY q_id,
    qq_id,
    qq_cm_asset_name
  ) qq,
  (SELECT main.quiz_question_id qq_id,
    main.quiz_question_answer_id qqa_id,
    main.promotion_id promotion_id,
    main.is_correct,
    NVL(number_of_times_SELECTed, 0) number_of_times_selected
  FROM
    (SELECT r.qq_id,
      r.qqa_id,
      r.promotion_id,
      r.is_correct,
      SUM(r.number_of_times_SELECTed) number_of_times_SELECTed
    FROM rpt_quiz_qqa_analysis r,
      promotion p,
      quiz_question qq
    WHERE 
--     (r.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) ----04/02/2014 fix for the defects 50697 and 52548
--           OR (p_in_promotion_Id is NULL))
 ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND r.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
      AND p.promotion_status = NVL(p_in_promo_status,p.promotion_status)
    AND p.promotion_id     = r.promotion_id
    AND r.qq_id = qq.quiz_question_id
    GROUP BY r.qq_id,
      r.qqa_id,
      r.promotion_id,
      r.qqa_cm_asset_code,
      r.qqa_answer_cm_key,
      r.is_correct
    ) rpt,
    (SELECT qqa.quiz_question_id,
      qqa.quiz_question_answer_id,
      p.promotion_id,
      qqa.is_correct
    FROM promo_quiz pq,
      quiz_question qq,
      quiz_question_answer qqa,
      promotion p,
      diy_quiz dq
    WHERE  
--    (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))
--           OR (p_in_promotion_Id is NULL))
    ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
    AND p.promotion_status   = NVL(p_in_promo_status,p.promotion_status)
    AND p.promotion_id = pq.promotion_id(+)       
    AND P.promotion_id = dq.promotion_id(+)
    AND NVL(pq.quiz_id,dq.quiz_id)           = qq.quiz_id
    AND qq.quiz_question_id  = qqa.quiz_question_id
    AND lower(qq.status_type)= 'active'
    ) main
  WHERE main.quiz_question_answer_id = rpt.qqa_id(+)
  ) qqa,
  rpt_quiz_analysis qa,
  (SELECT COUNT(1) q_in_pool,
    quiz_id
  FROM quiz_question
  WHERE STATUS_TYPE = 'active'
  GROUP BY QUIZ_ID
  ) qpool,
  promo_quiz pz,
  diy_quiz dq,
  (SELECT p.promotion_id,
    maximum_attempts,
    SUM(number_passed) passed,
    SUM(number_failed) failed,
    SUM(number_incomplete) incomplete    
  FROM rpt_quiz_attempts_analysis qa,
    promotion p
  WHERE  
--  (qa.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))
--           OR (p_in_promotion_Id is NULL))
   ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qa.quiz_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548  
  AND p.promotion_status  = NVL(p_in_promo_status,p.promotion_status)
  AND qa.promotion_id     = p.promotion_id
  AND NVL(TRUNC(qa.submission_date),TRUNC(sysdate)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
  GROUP BY p.promotion_id,
    maximum_attempts  
  ) qaa,
  promotion p
WHERE qqa.promotion_id = pz.promotion_id(+)
AND qqa.promotion_id = dq.promotion_id(+)
--AND (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))
--           OR (p_in_promotion_Id is NULL))
AND ((p_in_promotion_Id is NULL AND p_in_quiz_Id IS NULL) 
             OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))) OR (p_in_quiz_Id IS NOT NULL AND qq.q_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_quiz_Id)))) ))--04/02/2014 fix for the defects 50697 and 52548
AND p.promotion_status = NVL(p_in_promo_status,p.promotion_status)
AND qa.q_id            = NVl(pz.quiz_id,dq.quiz_id)
AND qq.qq_id           = qqa.qq_id
AND qa.q_id            = qq.q_id
AND qq.q_id            = qpool.quiz_id
AND qqa.promotion_id   = qaa.promotion_id(+)
GROUP BY 
--qa.q_name,   --01/08/2015
  p.promotion_name ,   --01/08/2015
  qa.q_type,
  qpool.q_in_pool,
  NVL(nbr_correct,0),
   NVL(nbr_of_times_asked,0),
  ROUND(NVL((nbr_correct/nbr_of_times_asked)*100,0),2),
  DECODE(UPPER(qa.q_type), 'FIXED', qpool.q_in_pool, qa.q_number_asked),
  NVL(DECODE(pz.allow_unlimited_attempts, 1, 'unlimited', pz.maximum_attempts), '0'),
--  FNC_CMS_ASSET_CODE_VAL_EXTR(QQ.QQ_CM_ASSET_NAME,'QUESTION_NAME',locale),--07/01/2013
  qq.qq_cm_asset_name, --04/01/2014
  ROUND(NVL((nbr_correct               /nbr_of_times_asked)*100,0),2),
  (NVL(nbr_of_times_asked,0)           -NVL(nbr_correct,0)),
  ROUND(NVL(((NVL(nbr_of_times_asked,0)-NVL(nbr_correct,0))/nbr_of_times_asked)*100,0),2)
ORDER BY Questions)
) ;

-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;

    UTL_FILE.fclose(file_handler);

	    
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019

 END IF;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_QUIZ_ANALYSIS_EXTRACT',1,'ERROR',
        p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_quiz_id||': '||'p_in_quiz_id'|| --07/16/2014 Bug # 54917
        p_in_promo_status ||': '||'p_in_promo_status '||p_in_from_date||': '||'p_in_from_date'||
        p_in_to_date||': '||'p_in_to_date'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null);        --02/25/2014
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_QUIZ_ANALYSIS_EXTRACT;


PROCEDURE PRC_PURL_EXTRACT
   (parentNodeId      IN VARCHAR2,       
    p_in_pax_status   IN VARCHAR2,
    Is_team      IN NUMBER,    
    p_paxid       IN NUMBER,
    p_in_promotion_Id IN VARCHAR2,   
    p_in_promo_status IN VARCHAR2,
    p_in_position_type     IN VARCHAR2,
    p_in_department   IN VARCHAR2,      
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,    
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor)
     
     IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Recognition Extract'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 01/07/2013  Initial Version  
                  03/07/2014  Bug # 51887 Changed award_date to purl_created date
-- Swati          06/02/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated
-- nagarajs       07/16/2014  Bug # 54917 - close the file and include parms value when OTHER exception                  
-- KrishnaDeepika 09/29/2014  Bug # 57030 - In the report extract of Recognition PURL Activity report promotion name is not getting displayed
--Suresh J        10/28/2014  Bug 57627 - Duplicate record in Extract    
--Swati           10/31/2014  Bug 57632 -PURL Status Issue
--KrishnaDeepika  11/04/2014  Bug 57725 -Report Recognition PURL Activity extract is not displaying the record displaying in the summary table
--Suresh J        05/29/2015  Bug 62417 - Total Values of # Recipient(s), # Contributors Invited, # Actual Contributors, Contribution % and 
--                              Contributions Posted of Org unit are not same when we drill down by org unit (edit)
-- nagarajs       11/12/2015  Bug 64368 - Recognition PURL Activity: Before Award process is run, in the extract output 2 PURL status appears
  Suresh J        12/28/2015  Bug 61865 - Recognition PURL Activity Report - incorrect Recipients count
  Ravi Arumugam   03/24/2016  Bug  66133 -Recognition Purl Activity Report - Changes
 --nagarajs       03/03/2016  Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
 --Sherif Basha   11/01/2016  Bug 69770 -- There should be only 2 statuses Open and Complete.Thus changin the "In-progress" to Open  
 --Gorantla       03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
 --Loganathan     04/23/2019  Bug 79021 - Recognition PURL Activity Report is pulling off the date initiated instead of date awarded
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   -- local variables
      file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;    
    p_in_locale VARCHAR2(10) :=locale;
    v_pattern    VARCHAR2(15);
    
     l_cursor  SYS_REFCURSOR;
   
BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key='COUNTRY_NAME' and locale = p_in_locale
UNION --06/02/2014 Bug # 53480
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
--                        WHERE upper(promotion_type) = upper('purl') 
                        WHERE upper(promotion_type) =  upper('recognition')       --bug fix 57030 9/29/2014 added the promotion_type recognition
                    )
AND locale = p_in_locale;

   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;
          

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

   IF p_file_name IS NULL THEN         
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
        UNION ALL --01/05/2015
        SELECT   (ROWNUM+1),
c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
c2_delimiter||Recipient_First_Name||c2_delimiter||c_delimiter||
c2_delimiter||recipient_middle_name||c2_delimiter||c_delimiter||
c2_delimiter||Recipient_Last_Name||c2_delimiter||c_delimiter||
c2_delimiter||recipient_user_name||c2_delimiter||c_delimiter||
c2_delimiter||recipient_email_addr||c2_delimiter||c_delimiter||
         c2_delimiter||recipient_country||c2_delimiter||c_delimiter||
         c2_delimiter||recipient_primary_org_unit||c2_delimiter||c_delimiter||
         c2_delimiter||manager_first_name||c2_delimiter||c_delimiter||
         c2_delimiter||manager_last_name||c2_delimiter||c_delimiter||
         c2_delimiter||manager_primary_org_unit||c2_delimiter||c_delimiter||
         c2_delimiter||manager_country||c2_delimiter||c_delimiter||         
         c2_delimiter||award_date||c2_delimiter||c_delimiter||
         c2_delimiter||purl_status||c2_delimiter||c_delimiter||
         c2_delimiter||award||c2_delimiter||c_delimiter||
         c2_delimiter||contributors_invited||c2_delimiter||c_delimiter||
         c2_delimiter||contributed||c2_delimiter||c_delimiter||
         c2_delimiter||contributions_posted_perc||c2_delimiter||c_delimiter||
         c2_delimiter||contributions_posted||c2_delimiter||c_delimiter||      
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
         c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
       c2_delimiter  ||pax_char11||c2_delimiter||c_delimiter||
       c2_delimiter  ||pax_char12||c2_delimiter||c_delimiter||
       c2_delimiter  ||pax_char13||c2_delimiter||c_delimiter||
       c2_delimiter  ||pax_char14||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
       c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        FROM (   
         select promotion_name,        
        recipient_user_id,
        recipient_first_name,
        recipient_middle_name,
        recipient_last_name,
        recipient_user_name,
        recipient_email_addr,
        recipient_country,
        recipient_primary_org_unit,
        manager_first_name,
        manager_last_name,
        manager_primary_org_unit,
        manager_country,
        award_date,
        purl_status,
        award,
        contributors_invited,
        contributed,
        contributions_posted_perc,
        contributions_posted,       
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End  
       FROM (             
         select --cd.promotion_name,    
        (select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) promotion_name, --06/02/2014 Bug # 53480
        cd.recipient_user_id,
        cd.Recipient_First_Name,
        NULL as recipient_middle_name,
        cd.Recipient_Last_Name,
        cd.recipient_user_name,
        cd.recipient_email_addr,
--         fnc_cms_asset_code_val_extr (rc.cm_asset_code,rc.name_cm_key,locale) as recipient_country,   
         (select cms_name from temp_table_session where asset_code=rc.cm_asset_code) AS recipient_country,       
         --cd.node_name recipient_primary_org_unit,
           rh.node_name recipient_primary_org_unit,   --02/17/2016         
         cd.manager_first_name,
         cd.manager_last_name,
         cd.manager_node_name as manager_primary_org_unit,
         (select cms_name from temp_table_session where asset_code=mc.cm_asset_code) AS manager_country, --04/01/2014
         award_date,
         --CASE WHEN (award_date > SYSDATE) THEN 'Sent' ELSE 'In-progress' END AS purl_status,   --10/31/2014  Bug 57632
--         MAX(PURL_STATUS) KEEP (DENSE_RANK FIRST ORDER BY PURL_STATUS_ORDER)      --11/12/2015 Bug 64368 
--         /*CASE                                         --11/12/2015 Bug 64368 
--            WHEN contribution_state = 'invitation' 
--                THEN 'Sent'
--            WHEN contribution_state = 'contribution' 
--                THEN 'In-progress'
--            WHEN contribution_state = 'complete' 
--                THEN 'Complete'
--            WHEN contribution_state = 'expired' 
--                THEN 'Complete'
--            WHEN contribution_state = 'archived' 
--                THEN 'Complete'    
--        END*/
--        AS PURL_STATUS, --10/31/2014  Bug 57632
         cd.PURL_STATUS as PURL_STATUS,  --12/28/2015
         award_amount as award, --bug # 51887 03/07/2014
--         COUNT (cd.purl_contributor_id) as contributors_invited,
         SUM(NVL(PURL_CONTRIBUTOR_COUNT,0)) AS CONTRIBUTORS_INVITED,    --12/28/2015
--         SUM (DECODE (contributed_flg, 'Y', 1, 0))  as contributed,
         SUM (NVL(CONTRIBUTED_COUNT,0))   AS CONTRIBUTED,  --12/28/2015         
--         ROUND(DECODE ( COUNT (cd.purl_contributor_id),0,0,(SUM (DECODE (contributed_flg, 'Y', 1, 0)) / COUNT (cd.purl_contributor_id)))* 100, 2) as contributions_posted_perc,
         CASE WHEN SUM (NVL(PURL_CONTRIBUTOR_COUNT,0)) =0 THEN 0
         ELSE ROUND (  (  SUM(NVL(CONTRIBUTED_COUNT,0)) / SUM (NVL(PURL_CONTRIBUTOR_COUNT,0))) * 100, 2)  --12/28/2015 
         END                    AS contributions_posted_perc,
--         SUM(NVL (cp.Contributions_Posted, 0) + NVL (pm.media_Posted, 0)) As contributions_posted
         SUM(cd.CONTRIBUTION_POSTED_COUNT) AS CONTRIBUTIONS_POSTED    --12/28/2015      
         ,CASE  --01/05/2015
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
         ,rh.path  --01/05/2015
         ,cd.purl_recipient_id  --05/29/2015
                               FROM (SELECT R.*, CASE                          --11/12/2014 Bug 64368
                                                   WHEN contribution_state = 'invitation' 
                                                          THEN 3
                                                   WHEN contribution_state = 'contribution' 
                                                          THEN 2
                                                   WHEN contribution_state = 'complete' 
                                                          THEN 1
                                                   WHEN contribution_state = 'expired' 
                                                          THEN 1
                                                   WHEN contribution_state = 'archived' 
                                                          THEN 1
                                             END as purl_status_order,
                                             CASE 
                                                   WHEN contribution_state = 'invitation' 
                                                          THEN 'Open'                         --03/24/2016 Bug#66133
                                                   WHEN contribution_state = 'contribution' 
                                                          THEN 'Open'                          -- 11/01/2016    Bug 69770
                                                   WHEN contribution_state = 'complete' 
                                                          THEN 'Complete'
                                                   WHEN contribution_state = 'expired' 
                                                          THEN 'Complete'
                                                   WHEN contribution_state = 'archived' 
                                                          THEN 'Complete'    
                                             END PURL_STATUS
                                        FROM --rpt_purl_contribution_detail R    --12/28/2015
                                               rpt_purl_recipient_detail R
                                             ) cd,
                           rpt_hierarchy rh,
--                           (  SELECT COUNT (purl_contributor_comment_id)     --12/28/2015
--                                        Contributions_Posted,
--                                     purl_contributor_id
--                                FROM purl_contributor_comment
--                            GROUP BY purl_contributor_id) cp,
--                           (  SELECT COUNT (purl_contributor_media_id) media_Posted,
--                                     purl_contributor_id
--                                FROM purl_contributor_media
--                            GROUP BY purl_contributor_id) pm,                      
                           country mc,
                           country rc,
                           promotion p            
                     WHERE     rh.node_id = cd.node_id(+)                          
--                           AND cd.purl_contributor_id = cp.purl_contributor_id(+)    --12/28/2015
--                           AND cd.purl_contributor_id = pm.purl_contributor_id(+)
                           AND cd.manager_country_id = mc.country_id(+)                        
                           AND cd.recipient_country_id = rc.country_id(+)
                           AND cd.promotion_id = p.promotion_id
                           AND NVL (cd.recipient_pax_status, 'X') =
                                  NVL (p_in_pax_status,
                                       NVL (cd.recipient_pax_status, 'X'))
                           AND NVL (cd.recipient_job_position, 'X') =
                                  NVL (p_in_position_type,
                                       NVL (cd.recipient_job_position, 'X'))
                           AND ( (p_in_department IS NULL)
                                OR (p_in_department IS NOT NULL
                                    AND cd.recipient_department IN
                                           (SELECT *
                                              FROM TABLE (
                                                      get_array_varchar (
                                                         p_in_department)))))
                           AND NVL (TRIM (TRUNC (cd.award_date)), --Bug # 51887 Changed award_date to purl_created date  --01/23/2019 Bug 79021 Changed  purl_created date to award_date
                                    TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
                           AND ( (p_in_promotion_Id IS NULL)
                                OR (p_in_promotion_Id IS NOT NULL
                                    AND cd.promotion_id IN
                                           (SELECT *
                                              FROM TABLE (
                                                      get_array_varchar (
                                                         p_in_promotion_Id)))))
                           AND NVL (p.promotion_status, 0) =
                                  NVL (p_in_promo_status,
                                       NVL (p.promotion_status, 0))
                                      AND ( ( (p_paxid IS NOT NULL) AND cd.recipient_user_id = p_paxid)
                                      OR
                 (NVL(is_Team,0)=0 AND cd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND cd.NODE_ID=parentNodeId))
                  GROUP BY --cd.promotion_name,
                           promo_name_asset_code,--06/02/2014 Bug # 53480
                           recipient_first_name,
                           recipient_user_id,
                           recipient_last_name,
                           cd.recipient_user_name,
                           cd.recipient_email_addr,
                           --cd.node_name,
                           rh.node_name, --02/17/2016  
                           cd.recipient_job_position,
                           manager_first_name,
                           award_amount, --bug # 51887 03/07/2014
                           manager_last_name,
                           cd.manager_node_name,
                           award_date,
                           rc.cm_asset_code,mc.cm_asset_code--,contribution_state --11/12/2014 Bug 64368
                         ,CASE  --01/05/2015
                            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
                            THEN
                               rh.node_name
                            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
                            THEN
                               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
                            ELSE
                               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
                         END
                         ,path --01/05/2015
                         ,cd.PURL_STATUS  --12/28/2015
                         ,cd.purl_recipient_id  --05/29/2015
                           ),rpt_characteristic rch --04/01/2014  --11/04/2014 Bug fix 57725 added contribution_state    
                           where recipient_user_id = rch.user_nt_id(+) 
                                 AND characteristic_type(+) = 'USER'
                         ORDER BY node_name_sort,path  --01/05/2015                                 
                                 ));   --10/28/2014
  
p_out_return_code :=  '00' ;

ELSE
p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
        UNION ALL --01/05/2015
   SELECT   (ROWNUM+1),
            c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
            c2_delimiter||Recipient_First_Name||c2_delimiter||c_delimiter||
            c2_delimiter||recipient_middle_name||c2_delimiter||c_delimiter||
            c2_delimiter||Recipient_Last_Name||c2_delimiter||c_delimiter||
            c2_delimiter||recipient_user_name||c2_delimiter||c_delimiter||
            c2_delimiter||recipient_email_addr||c2_delimiter||c_delimiter||
                     c2_delimiter||recipient_country||c2_delimiter||c_delimiter||
                     c2_delimiter||recipient_primary_org_unit||c2_delimiter||c_delimiter||
                     c2_delimiter||manager_first_name||c2_delimiter||c_delimiter||
                     c2_delimiter||manager_last_name||c2_delimiter||c_delimiter||
                     c2_delimiter||manager_primary_org_unit||c2_delimiter||c_delimiter||
                     c2_delimiter||manager_country||c2_delimiter||c_delimiter||         
                     c2_delimiter||award_date||c2_delimiter||c_delimiter||
                     c2_delimiter||purl_status||c2_delimiter||c_delimiter||
                     c2_delimiter||award||c2_delimiter||c_delimiter||
                     c2_delimiter||contributors_invited||c2_delimiter||c_delimiter||
                     c2_delimiter||contributed||c2_delimiter||c_delimiter||
                     c2_delimiter||contributions_posted_perc||c2_delimiter||c_delimiter||
                     c2_delimiter||contributions_posted||c2_delimiter||c_delimiter||      
                     c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
                     c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
                   c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
                   c2_delimiter||pax_char20||c2_delimiter     --03/03/2016 End 
        FROM (   
                     select promotion_name,        
                    recipient_user_id,
                    recipient_first_name,
                    recipient_middle_name,
                    recipient_last_name,
                    recipient_user_name,
                    recipient_email_addr,
                    recipient_country,
                    recipient_primary_org_unit,
                    manager_first_name,
                    manager_last_name,
                    manager_primary_org_unit,
                    manager_country,
                    award_date,
                    purl_status,
                    award,
                    contributors_invited,
                    contributed,
                    contributions_posted_perc,
                    contributions_posted,       
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as pax_char16,     --03/03/2016 Start
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as pax_char17,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as pax_char18,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as pax_char19,
                   (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as pax_char20     --03/03/2016 End  
                   FROM (             
                     select --cd.promotion_name,    
                    (select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) promotion_name, --06/02/2014 Bug # 53480
                    cd.recipient_user_id,
                    cd.Recipient_First_Name,
                    NULL as recipient_middle_name,
                    cd.Recipient_Last_Name,
                    cd.recipient_user_name,
                    cd.recipient_email_addr,
            --         fnc_cms_asset_code_val_extr (rc.cm_asset_code,rc.name_cm_key,locale) as recipient_country,   
                     (select cms_name from temp_table_session where asset_code=rc.cm_asset_code) AS recipient_country,       
                     --cd.node_name recipient_primary_org_unit,
                     rh.node_name recipient_primary_org_unit,   --02/17/2016
                     cd.manager_first_name,
                     cd.manager_last_name,
                     cd.manager_node_name as manager_primary_org_unit,
                     (select cms_name from temp_table_session where asset_code=mc.cm_asset_code) AS manager_country, --04/01/2014
                     award_date,
                     --CASE WHEN (award_date > SYSDATE) THEN 'Sent' ELSE 'In-progress' END AS purl_status,   --10/31/2014  Bug 57632
            --         MAX(PURL_STATUS) KEEP (DENSE_RANK FIRST ORDER BY PURL_STATUS_ORDER)      --11/12/2015 Bug 64368 
            --         /*CASE                                         --11/12/2015 Bug 64368 
            --            WHEN contribution_state = 'invitation' 
            --                THEN 'Sent'
            --            WHEN contribution_state = 'contribution' 
            --                THEN 'In-progress'
            --            WHEN contribution_state = 'complete' 
            --                THEN 'Complete'
            --            WHEN contribution_state = 'expired' 
            --                THEN 'Complete'
            --            WHEN contribution_state = 'archived' 
            --                THEN 'Complete'    
            --        END*/
            --        AS PURL_STATUS, --10/31/2014  Bug 57632
                     cd.PURL_STATUS as PURL_STATUS,  --12/28/2015
                     award_amount as award, --bug # 51887 03/07/2014
            --         COUNT (cd.purl_contributor_id) as contributors_invited,
                     SUM(NVL(PURL_CONTRIBUTOR_COUNT,0)) AS CONTRIBUTORS_INVITED,    --12/28/2015
            --         SUM (DECODE (contributed_flg, 'Y', 1, 0))  as contributed,
                     SUM (NVL(CONTRIBUTED_COUNT,0))   AS CONTRIBUTED,  --12/28/2015         
            --         ROUND(DECODE ( COUNT (cd.purl_contributor_id),0,0,(SUM (DECODE (contributed_flg, 'Y', 1, 0)) / COUNT (cd.purl_contributor_id)))* 100, 2) as contributions_posted_perc,
                     CASE WHEN SUM (NVL(PURL_CONTRIBUTOR_COUNT,0)) =0 THEN 0
                     ELSE ROUND (  (  SUM(NVL(CONTRIBUTED_COUNT,0)) / SUM (NVL(PURL_CONTRIBUTOR_COUNT,0))) * 100, 2)  --12/28/2015 
                     END                    AS contributions_posted_perc,
            --         SUM(NVL (cp.Contributions_Posted, 0) + NVL (pm.media_Posted, 0)) As contributions_posted
                     SUM(cd.CONTRIBUTION_POSTED_COUNT) AS CONTRIBUTIONS_POSTED    --12/28/2015      
                     ,CASE  --01/05/2015
                        WHEN REGEXP_COUNT (rh.PATH, '/') = 1
                        THEN
                           rh.node_name
                        WHEN REGEXP_COUNT (rh.PATH, '/') = 2
                        THEN
                           SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
                        ELSE
                           SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
                     END node_name_sort   --12/18/2014
                     ,rh.path  --01/05/2015
                     ,cd.purl_recipient_id  --05/29/2015
                                           FROM (SELECT R.*, CASE                          --11/12/2014 Bug 64368
                                                               WHEN contribution_state = 'invitation' 
                                                                      THEN 3
                                                               WHEN contribution_state = 'contribution' 
                                                                      THEN 2
                                                               WHEN contribution_state = 'complete' 
                                                                      THEN 1
                                                               WHEN contribution_state = 'expired' 
                                                                      THEN 1
                                                               WHEN contribution_state = 'archived' 
                                                                      THEN 1
                                                         END as purl_status_order,
                                                         CASE 
                                                               WHEN contribution_state = 'invitation' 
                                                                      THEN 'Open'                          --03/24/2016 Bug#66133
                                                               WHEN contribution_state = 'contribution' 
                                                                      THEN 'Open'                          -- 11/01/2016    Bug 69770
                                                               WHEN contribution_state = 'complete' 
                                                                      THEN 'Complete'
                                                               WHEN contribution_state = 'expired' 
                                                                      THEN 'Complete'
                                                               WHEN contribution_state = 'archived' 
                                                                      THEN 'Complete'    
                                                         END PURL_STATUS
                                                    FROM --rpt_purl_contribution_detail R    --12/28/2015
                                                           rpt_purl_recipient_detail R
                                                         ) cd,
                                       rpt_hierarchy rh,
            --                           (  SELECT COUNT (purl_contributor_comment_id)     --12/28/2015
            --                                        Contributions_Posted,
            --                                     purl_contributor_id
            --                                FROM purl_contributor_comment
            --                            GROUP BY purl_contributor_id) cp,
            --                           (  SELECT COUNT (purl_contributor_media_id) media_Posted,
            --                                     purl_contributor_id
            --                                FROM purl_contributor_media
            --                            GROUP BY purl_contributor_id) pm,                      
                                       country mc,
                                       country rc,
                                       promotion p            
                                 WHERE     rh.node_id = cd.node_id(+)                          
            --                           AND cd.purl_contributor_id = cp.purl_contributor_id(+)    --12/28/2015
            --                           AND cd.purl_contributor_id = pm.purl_contributor_id(+)
                                       AND cd.manager_country_id = mc.country_id(+)                        
                                       AND cd.recipient_country_id = rc.country_id(+)
                                       AND cd.promotion_id = p.promotion_id
                                       AND NVL (cd.recipient_pax_status, 'X') =
                                              NVL (p_in_pax_status,
                                                   NVL (cd.recipient_pax_status, 'X'))
                                       AND NVL (cd.recipient_job_position, 'X') =
                                              NVL (p_in_position_type,
                                                   NVL (cd.recipient_job_position, 'X'))
                                       AND ( (p_in_department IS NULL)
                                            OR (p_in_department IS NOT NULL
                                                AND cd.recipient_department IN
                                                       (SELECT *
                                                          FROM TABLE (
                                                                  get_array_varchar (
                                                                     p_in_department)))))
                                       AND NVL (TRIM (TRUNC (cd.purl_created_date)), --Bug # 51887 Changed award_date to purl_created date
                                                TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
                                       AND ( (p_in_promotion_Id IS NULL)
                                            OR (p_in_promotion_Id IS NOT NULL
                                                AND cd.promotion_id IN
                                                       (SELECT *
                                                          FROM TABLE (
                                                                  get_array_varchar (
                                                                     p_in_promotion_Id)))))
                                       AND NVL (p.promotion_status, 0) =
                                              NVL (p_in_promo_status,
                                                   NVL (p.promotion_status, 0))
                                                  AND ( ( (p_paxid IS NOT NULL) AND cd.recipient_user_id = p_paxid)
                                                  OR
                             (NVL(is_Team,0)=0 AND cd.NODE_ID IN (    SELECT child_node_id
                                                     FROM rpt_hierarchy_rollup N2
                                               WHERE node_id IN (SELECT *
                                             FROM TABLE (
                                                     get_array_varchar (
                                                       parentNodeId)))))
                                         OR
                                       (  is_Team=1 AND cd.NODE_ID=parentNodeId))
                              GROUP BY --cd.promotion_name,
                                       promo_name_asset_code,--06/02/2014 Bug # 53480
                                       recipient_first_name,
                                       recipient_user_id,
                                       recipient_last_name,
                                       cd.recipient_user_name,
                                       cd.recipient_email_addr,
                                       --cd.node_name,
                                       rh.node_name,   --02/17/2016  
                                       cd.recipient_job_position,
                                       manager_first_name,
                                       award_amount, --bug # 51887 03/07/2014
                                       manager_last_name,
                                       cd.manager_node_name,
                                       award_date,
                                       rc.cm_asset_code,mc.cm_asset_code--,contribution_state --11/12/2014 Bug 64368
                                     ,CASE  --01/05/2015
                                        WHEN REGEXP_COUNT (rh.PATH, '/') = 1
                                        THEN
                                           rh.node_name
                                        WHEN REGEXP_COUNT (rh.PATH, '/') = 2
                                        THEN
                                           SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
                                        ELSE
                                           SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
                                     END
                                     ,path --01/05/2015
                                     ,cd.PURL_STATUS  --12/28/2015
                                     ,cd.purl_recipient_id  --05/29/2015
                                       ),rpt_characteristic rch --04/01/2014  --11/04/2014 Bug fix 57725 added contribution_state    
                                       where recipient_user_id = rch.user_nt_id(+) 
                                             AND characteristic_type(+) = 'USER'
                                     ORDER BY node_name_sort,path  --01/05/2015                                 
                                             ));   --10/28/2014
-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;

    UTL_FILE.fclose(file_handler);
 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_PURL_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_pax_status||': '||'p_in_pax_status'||Is_team||': '||'Is_team'|| --07/16/2014 Bug # 54917
        p_paxid ||': '||'p_paxid '||p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_promo_status||': '||'p_in_promo_status'||
        p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||p_in_from_date||': '||'p_in_from_date'||
        p_in_to_date||': '||'p_in_to_date'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null);  --02/25/2014        
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_PURL_EXTRACT;           
        
   PROCEDURE PRC_AWARDLEVEL_EXTRACT
   (parentNodeId      IN VARCHAR2,   
    Is_team      IN NUMBER,
    p_in_promotion_Id IN VARCHAR2,   
    p_in_award_level IN VARCHAR2,   
    p_in_awardstatus IN VARCHAR2,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,   
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Login Activity Extract'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 03/06/2013  Initial Version  
-- Chidamba       10/01/2013  Defect fixed # 4745  
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
-- Gorantla       03/12/2019 G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    
    p_in_locale VARCHAR2(10):=locale;
    v_pattern    VARCHAR2(15);
    
    l_cursor  SYS_REFCURSOR;  
    
BEGIN

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;
 
IF p_file_name IS NULL THEN         
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||node_name||c2_delimiter||c_delimiter||
         c2_delimiter||om_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||Codes_Issued||c2_delimiter||c_delimiter||
         c2_delimiter||codes_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||perc_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||Codes_Unredeemed||c2_delimiter||c_delimiter||
         c2_delimiter||perc_Unredeemed||c2_delimiter||c_delimiter||
         c2_delimiter||Codes_Expired||c2_delimiter||c_delimiter||
         c2_delimiter||perc_Expired||c2_delimiter
    FROM (SELECT rh.node_name,
        om_level_name,
        Codes_Issued,
        DECODE(p_in_awardstatus,'expired',0,'unredeemed',0,Codes_Redeemed) codes_redeemed,
        DECODE(p_in_awardstatus,'expired',0,'unredeemed',0,perc_redeemed)  perc_redeemed,
        DECODE(p_in_awardstatus,'expired',0,'redeemed',0,codes_unredeemed) Codes_Unredeemed,
        DECODE(p_in_awardstatus,'expired',0,'redeemed',0,perc_unredeemed)  perc_Unredeemed,
        DECODE(p_in_awardstatus,'redeemed',0,'unredeemed',0,codes_expired) Codes_Expired,
        DECODE(p_in_awardstatus,'redeemed',0,'unredeemed',0,perc_expired)  perc_expired
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
        ,rh.path --12/18/2014
FROM  (SELECT node_id,
               om_level_name,
               NVL(SUM(tot_num_issued),0)   Codes_Issued,    
               NVL(SUM(tot_num_redeemed),0) Codes_Redeemed,    
               DECODE(NVL(SUM(tot_num_issued),0) ,0,0,ROUND(( NVL(SUM(tot_num_redeemed),0)/SUM(tot_num_issued))*100,2)) perc_redeemed,    
               NVL(SUM(tot_num_unredeemed),0) Codes_Unredeemed,   
               DECODE(NVL(SUM(tot_num_issued),0) ,0,0,ROUND(( NVL(SUM(tot_num_unredeemed),0)/SUM(tot_num_issued))*100,2)) perc_Unredeemed,    
               NVL(SUM(tot_num_expired),0) Codes_Expired,    
               DECODE(NVL(SUM(tot_num_issued),0) ,0,0,ROUND((NVL(SUM(tot_num_expired),0)/SUM(tot_num_issued))*100,2))  perc_expired     
      FROM rpt_award_item_activity  
     WHERE 
        ((p_in_promotion_Id IS NULL) OR (p_in_promotion_Id is NOT NULL AND promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))))
       AND ((p_in_award_level IS NULL) OR (p_in_award_level is NOT NULL AND om_level_name IN (SELECT * FROM TABLE(get_array_varchar(p_in_award_level)))))
       --AND ((p_in_awardstatus='expired' AND tot_num_expired >0) OR (p_in_awardstatus='redeemed' AND tot_num_redeemed >0) OR
       --  (p_in_awardstatus='unredeemed' AND tot_num_unredeemed >0) OR (p_in_awardstatus IS NULL))  --10/01/2013
       AND NVL(award_date, TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
       AND (NVL(is_Team,0)=0 AND NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))))
                             OR
                           (  is_Team=1 AND NODE_ID=parentNodeId))
     GROUP BY om_level_name,node_id ) dtl,
      rpt_hierarchy rh
WHERE rh.node_id = dtl.node_id 
order by node_name_sort,path --12/18/2014
));

p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
 SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||node_name||c2_delimiter||c_delimiter||
         c2_delimiter||om_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||Codes_Issued||c2_delimiter||c_delimiter||
         c2_delimiter||codes_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||perc_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||Codes_Unredeemed||c2_delimiter||c_delimiter||
         c2_delimiter||perc_Unredeemed||c2_delimiter||c_delimiter||
         c2_delimiter||Codes_Expired||c2_delimiter||c_delimiter||
         c2_delimiter||perc_Expired||c2_delimiter
    FROM (SELECT rh.node_name,
        om_level_name,
        Codes_Issued,
        DECODE(p_in_awardstatus,'expired',0,'unredeemed',0,Codes_Redeemed) codes_redeemed,
        DECODE(p_in_awardstatus,'expired',0,'unredeemed',0,perc_redeemed)  perc_redeemed,
        DECODE(p_in_awardstatus,'expired',0,'redeemed',0,codes_unredeemed) Codes_Unredeemed,
        DECODE(p_in_awardstatus,'expired',0,'redeemed',0,perc_unredeemed)  perc_Unredeemed,
        DECODE(p_in_awardstatus,'redeemed',0,'unredeemed',0,codes_expired) Codes_Expired,
        DECODE(p_in_awardstatus,'redeemed',0,'unredeemed',0,perc_expired)  perc_expired
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (rh.PATH, '/') = 1
            THEN
               rh.node_name
            WHEN REGEXP_COUNT (rh.PATH, '/') = 2
            THEN
               SUBSTR (rh.PATH, 3, LENGTH (TRIM (rh.PATH)))
            ELSE
               SUBSTR (rh.PATH,3,INSTR (rh.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
        ,rh.path --12/18/2014
FROM  (SELECT node_id,
               om_level_name,
               NVL(SUM(tot_num_issued),0)   Codes_Issued,    
               NVL(SUM(tot_num_redeemed),0) Codes_Redeemed,    
               DECODE(NVL(SUM(tot_num_issued),0) ,0,0,ROUND(( NVL(SUM(tot_num_redeemed),0)/SUM(tot_num_issued))*100,2)) perc_redeemed,    
               NVL(SUM(tot_num_unredeemed),0) Codes_Unredeemed,   
               DECODE(NVL(SUM(tot_num_issued),0) ,0,0,ROUND(( NVL(SUM(tot_num_unredeemed),0)/SUM(tot_num_issued))*100,2)) perc_Unredeemed,    
               NVL(SUM(tot_num_expired),0) Codes_Expired,    
               DECODE(NVL(SUM(tot_num_issued),0) ,0,0,ROUND((NVL(SUM(tot_num_expired),0)/SUM(tot_num_issued))*100,2))  perc_expired     
      FROM rpt_award_item_activity  
     WHERE 
        ((p_in_promotion_Id IS NULL) OR (p_in_promotion_Id is NOT NULL AND promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))))
       AND ((p_in_award_level IS NULL) OR (p_in_award_level is NOT NULL AND om_level_name IN (SELECT * FROM TABLE(get_array_varchar(p_in_award_level)))))
       --AND ((p_in_awardstatus='expired' AND tot_num_expired >0) OR (p_in_awardstatus='redeemed' AND tot_num_redeemed >0) OR
       --  (p_in_awardstatus='unredeemed' AND tot_num_unredeemed >0) OR (p_in_awardstatus IS NULL))  --10/01/2013
       AND NVL(award_date, TRUNC(SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
       AND (NVL(is_Team,0)=0 AND NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))))
                             OR
                           (  is_Team=1 AND NODE_ID=parentNodeId))
     GROUP BY om_level_name,node_id ) dtl,
      rpt_hierarchy rh
WHERE rh.node_id = dtl.node_id 
order by node_name_sort,path --12/18/2014
));

-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019   
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);           
      
END LOOP;

    UTL_FILE.fclose(file_handler);
--start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
 END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_AWARDLEVEL_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||Is_team||': '||'Is_team'||p_in_promotion_Id||': '||'p_in_promotion_Id'|| --07/16/2014 Bug # 54917
        p_in_award_level||': '||'p_in_award_level'||p_in_awardstatus||': '||'p_in_awardstatus'||p_in_from_date||': '||'p_in_from_date'||
        p_in_to_date||': '||'p_in_to_date'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_AWARDLEVEL_EXTRACT;

  PROCEDURE PRC_AWARD_ACTIVITY_EXTRACT
   (parentNodeId      IN VARCHAR2,   
    Is_team      IN NUMBER,
    p_in_promotion_Id IN VARCHAR2,   
    p_in_award_level IN VARCHAR2,   
    p_in_status IN VARCHAR2,
    p_in_from_date       IN VARCHAR2,
    p_in_to_date       IN VARCHAR2,  
    p_country_id   IN NUMBER, 
    locale IN VARCHAR2,
    p_file_name IN VARCHAR2,
    p_header    IN VARCHAR2,
    p_out_return_code  OUT varchar2,
    p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Login Activity Extract'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 03/06/2013  Initial Version  
--Suresh J       04/01/2014  Added temp table temp_table_session to fetch the CM data to fix performance issue.
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
--Suresh J       09/13/2014  Bug Fix#56522 - Award Code display format issue 
--nagarajs       11/11/2015  Bug 64499 - GoalQuest with Plateau - Plateau Item Selection - Participation by Organization
                             extract not extracting any data
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--Gorantla       03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
     p_in_locale VARCHAR2(10) :=locale;
     v_pattern    VARCHAR2(15);

BEGIN
   
DELETE temp_table_session;

INSERT INTO temp_table_session
SELECT asset_code,cms_name,cms_code
FROM vw_cms_code_value E
WHERE asset_code in ( 'picklist.statetype.items') and e.locale=p_in_locale
UNION
SELECT asset_code,cms_value,key FROM vw_cms_asset_value WHERE key='COUNTRY_NAME' and locale = p_in_locale --04/01/2014
UNION--05/29/2014 Bug # 53480
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                    WHERE upper(p.award_type) = upper('merchandise'))
AND locale = p_in_locale;

   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
EXCEPTION WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||award_level||c2_delimiter||c_delimiter||
         c2_delimiter||reference_number||c2_delimiter||c_delimiter||
         c2_delimiter||Award_Code||c2_delimiter||c_delimiter||
         c2_delimiter||status||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||org_name||c2_delimiter||c_delimiter||         
          c2_delimiter||item_value||c2_delimiter||c_delimiter||
         c2_delimiter||date_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||date_issued||c2_delimiter||c_delimiter||
         c2_delimiter||expiration_date||c2_delimiter||c_delimiter||  
         c2_delimiter||item_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||email_address||c2_delimiter||c_delimiter||
         c2_delimiter||Country||c2_delimiter||c_delimiter||
         c2_delimiter||State||c2_delimiter||c_delimiter||
         c2_delimiter||addr1||c2_delimiter||c_delimiter||
         c2_delimiter||addr2||c2_delimiter||c_delimiter||
         c2_delimiter||city||c2_delimiter||c_delimiter||
         c2_delimiter||zip||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
(SELECT rpt.first_name,
       a.middle_name,   
       rpt.last_name,
       rpt.award_level,
       rpt.reference_number,
       '#'||fnc_java_decrypt(gift_code)||fnc_java_decrypt(gift_code_key) Award_Code,  --09/13/2014
       CASE 
         WHEN rpt.date_redeemed IS NOT NULL THEN 'Redeemed'
         WHEN m.expiration_date < SYSDATE THEN 'Expired'
         ELSE 'Issued'                      
       END Status,    
       --p.promotion_name, 
        (select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480
        n.node_name org_name,    
        rpt.item_value,    
        rpt.date_redeemed,    
        rpt.date_issued,    
        m.expiration_date,
        rpt.item_redeemed,    
        rpt.email_address,    
--        fnc_cms_asset_code_val_extr(c.cm_asset_code,
--                                    c.name_cm_key,
--                                    locale) Country,
        (select cms_name from temp_table_session where asset_code=c.cm_asset_code) Country, --04/01/2014
--        fnc_cms_picklist_value('picklist.statetype.items',
--                                rpt.state,
--                                locale) State,
        (select cms_name from temp_table_session where asset_code='picklist.statetype.items' and cms_code= rpt.state) as State, --04/01/2014  
        rpt.addr1,
        rpt.addr2,
        rpt.city,
        rpt.zip,
          (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End           
  FROM rpt_award_earnings rpt,
       application_user a,
       merch_order m,
       promotion p,
       user_node un,
       rpt_hierarchy n,
       rpt_characteristic rch,
       country c
 WHERE rpt.login_id = a.user_name 
   AND a.user_id  = un.user_id
   AND un.node_id = n.node_id
   AND un.is_primary = 1  
    AND rpt.user_id = rch.user_nt_id(+)
   AND rpt.reference_number = m.reference_number
   AND rpt.promotion_id = p.promotion_id
   AND NVL(rpt.country_id,0) = NVL(c.country_id,0) --11/11/2015
   AND ((p_in_promotion_Id IS NULL) OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))))
   AND NVL (TRUNC (rpt.date_issued),TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
   AND NVL(c.country_id,0) = NVL(p_country_id,NVL(c.country_id,0)) --11/11/2015
   AND rpt.award_level = NVL(p_in_award_level,rpt.award_level)
   AND (NVL(is_Team,0)=0 AND n.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))))
                             OR
                           (  is_Team=1 AND n.NODE_ID=parentNodeId))
order by rpt.award_level asc --12/18/2014
)
WHERE status = NVL(p_in_status,status));

p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||award_level||c2_delimiter||c_delimiter||
         c2_delimiter||reference_number||c2_delimiter||c_delimiter||
         c2_delimiter||Award_Code||c2_delimiter||c_delimiter||
         c2_delimiter||status||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||org_name||c2_delimiter||c_delimiter||         
          c2_delimiter||item_value||c2_delimiter||c_delimiter||
         c2_delimiter||date_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||date_issued||c2_delimiter||c_delimiter||
         c2_delimiter||expiration_date||c2_delimiter||c_delimiter||  
         c2_delimiter||item_redeemed||c2_delimiter||c_delimiter||
         c2_delimiter||email_address||c2_delimiter||c_delimiter||
         c2_delimiter||Country||c2_delimiter||c_delimiter||
         c2_delimiter||State||c2_delimiter||c_delimiter||
         c2_delimiter||addr1||c2_delimiter||c_delimiter||
         c2_delimiter||addr2||c2_delimiter||c_delimiter||
         c2_delimiter||city||c2_delimiter||c_delimiter||
         c2_delimiter||zip||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
(SELECT rpt.first_name,
       a.middle_name,   
       rpt.last_name,
       rpt.award_level,
       rpt.reference_number,
       '#'||fnc_java_decrypt(gift_code)||fnc_java_decrypt(gift_code_key) Award_Code,  --09/13/2014
       CASE 
         WHEN rpt.date_redeemed IS NOT NULL THEN 'Redeemed'
         WHEN m.expiration_date < SYSDATE THEN 'Expired'
         ELSE 'Issued'                      
       END Status,    
       --p.promotion_name, 
        (select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480
        n.node_name org_name,    
        rpt.item_value,    
        rpt.date_redeemed,    
        rpt.date_issued,    
        m.expiration_date,
        rpt.item_redeemed,    
        rpt.email_address,    
--        fnc_cms_asset_code_val_extr(c.cm_asset_code,
--                                    c.name_cm_key,
--                                    locale) Country,
        (select cms_name from temp_table_session where asset_code=c.cm_asset_code) Country, --04/01/2014
--        fnc_cms_picklist_value('picklist.statetype.items',
--                                rpt.state,
--                                locale) State,
        (select cms_name from temp_table_session where asset_code='picklist.statetype.items' and cms_code= rpt.state) as State, --04/01/2014  
        rpt.addr1,
        rpt.addr2,
        rpt.city,
        rpt.zip,
          (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                      
  FROM rpt_award_earnings rpt,
       application_user a,
       merch_order m,
       promotion p,
       user_node un,
       rpt_hierarchy n,
       rpt_characteristic rch,
       country c
 WHERE rpt.login_id = a.user_name 
   AND a.user_id  = un.user_id
   AND un.node_id = n.node_id
   AND un.is_primary = 1  
    AND rpt.user_id = rch.user_nt_id(+)
   AND rpt.reference_number = m.reference_number
   AND rpt.promotion_id = p.promotion_id
   AND NVL(rpt.country_id,0) = NVL(c.country_id,0) --11/11/2015
   AND ((p_in_promotion_Id IS NULL) OR (p_in_promotion_Id is NOT NULL AND p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id)))))
   AND NVL (TRUNC (rpt.date_issued),TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) --12/18/2013
   AND NVL(c.country_id,0) = NVL(p_country_id,NVL(c.country_id,0)) --11/11/2015
   AND rpt.award_level = NVL(p_in_award_level,rpt.award_level)
   AND (NVL(is_Team,0)=0 AND n.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))))
                             OR
                           (  is_Team=1 AND n.NODE_ID=parentNodeId))
order by rpt.award_level asc --12/18/2014
)
WHERE status = NVL(p_in_status,status));

 -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019 
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);
  
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
       
 END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_AWARD_ACTIVITY_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||Is_team||': '||'Is_team'||p_in_promotion_Id||': '||'p_in_promotion_Id'|| --07/16/2014 Bug # 54917
        p_in_award_level||': '||'p_in_award_level'||p_in_status||': '||'p_in_status'||p_in_from_date||': '||'p_in_from_date'||
        p_in_to_date||': '||'p_in_to_date'||p_country_id||': '||'p_country_id'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_AWARD_ACTIVITY_EXTRACT;

PROCEDURE PRC_GQ_PAX_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
-- Ravi Dhanekula     08/22/2013     Initial Version
                      04/01/2014     Added temp_table_session to fetch data from CM to avoid performance issues.
-- Swati              05/29/2014     Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated    
-- nagarajs           07/15/2014     Fixed the Bug # 54789 - Participant status Needs to be Translated
-- nagarajs           07/16/2014     Bug # 54917 - close the file and include parms value when OTHER exception     
-- Ravi Dhanekula     08/15/2014     Fixed the bug # 55415 
-- Swati              04/07/2015     Bug 61132 - Report: GoalQuest Participant Achievement - '0' value not getting displayed in the export  
--nagarajs           09/30/2015     G5E-25 - Remove Points column if plateau.platform.only enabled    
--nagarajs          11/26/2015     Bug 64819 - Points column value not showing in Extracts             
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics   
--Gorantla           03/12/2019     G6-1446  AWS - Enable Large Audience functionality.        
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
     l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=locale;
    v_plateau_enable  NUMBER(1); --09/30/2015
    
    
BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key IN ('COUNTRY_NAME','GOALS') and locale = p_in_locale --04/01/2014
UNION --05/29/2014 Bug # 53480
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                    WHERE upper(promotion_type) = upper('goalquest'))
AND locale = p_in_locale
UNION --07/15/2014 Bug # 54789
SELECT asset_code,cms_name,cms_code
  FROM vw_cms_code_value 
 WHERE asset_code = 'picklist.participantstatus.items'
   AND locale = p_in_locale;
   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

BEGIN  --09/30/2015
SELECT boolean_val INTO v_plateau_enable FROM os_propertyset WHERE entity_name = 'drive.enabled';
EXCEPTION WHEN no_data_found THEN 
v_plateau_enable := 0;
END;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
         c2_delimiter||path||c2_delimiter||c_delimiter||
         --c2_delimiter||participant_status||c2_delimiter||c_delimiter|| -07/15/2014 Bug # 54789
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code='picklist.participantstatus.items' AND cms_code = participant_status)||c2_delimiter||c_delimiter|| --07/15/2014 Bug # 54789
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter||         
         c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(baseline,0)||c2_delimiter||c_delimiter|| --04/07/2015 Bug 61132 
         c2_delimiter||nvl(goal,0)||c2_delimiter||c_delimiter||--04/07/2015 Bug 61132
         c2_delimiter||nvl(actual_result,0)||c2_delimiter||c_delimiter||--04/07/2015 Bug 61132
         c2_delimiter||nvl(Perc_of_Goal,0)||c2_delimiter||c_delimiter||--04/07/2015 Bug 61132
         c2_delimiter||Achieved||c2_delimiter||c_delimiter||
         CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||nvl(Points,0)||c2_delimiter||c_delimiter ELSE NULL END||--04/07/2015 Bug 61132 --09/30/2015 --11/26/2015
         c2_delimiter||Plateau_earned||c2_delimiter||c_delimiter||             
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
        uea.email_addr,     
        c.cm_asset_code,
        c.name_cm_key, 
        gsd.user_status Participant_status,        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480
        hier.node_name Primary_org_unit, 
        hier.path,
        gsd.job_position,
        gsd.department,
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale)  goal_level_name,          
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014       
        ROUND((gsd.current_value/gsd.amount_to_achieve)*100,2) perc_of_goal, --08/15/2014
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        CASE WHEN
        gsd.achieved=1 THEN 'Yes'
        ELSE 'No'
        END Achieved,
        gsd.calculated_payout points,
        gsd.plateau_earned,
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,            
        rpt_goal_selection_detail gsd
      LEFT OUTER JOIN rpt_hierarchy hier
      ON gsd.node_id = hier.node_id
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_email_address uea
      ON gsd.user_id = uea.user_id
      AND uea.is_primary = 1
      WHERE 
       ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)      
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)          
      AND gsd.country_id = c.country_id   
      AND gsd.user_id = au.user_id      
      order by node_name_sort asc, hier.path asc   --12/18/2014
      )); 
      p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
         c2_delimiter||path||c2_delimiter||c_delimiter||
         --c2_delimiter||participant_status||c2_delimiter||c_delimiter|| -07/15/2014 Bug # 54789
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code='picklist.participantstatus.items' AND cms_code = participant_status)||c2_delimiter||c_delimiter|| --07/15/2014 Bug # 54789
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter||         
         c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(baseline,0)||c2_delimiter||c_delimiter|| --04/07/2015 Bug 61132 
         c2_delimiter||nvl(goal,0)||c2_delimiter||c_delimiter||--04/07/2015 Bug 61132
         c2_delimiter||nvl(actual_result,0)||c2_delimiter||c_delimiter||--04/07/2015 Bug 61132
         c2_delimiter||nvl(Perc_of_Goal,0)||c2_delimiter||c_delimiter||--04/07/2015 Bug 61132
         c2_delimiter||Achieved||c2_delimiter||c_delimiter||
         CASE WHEN v_plateau_enable = 0 THEN c2_delimiter||nvl(Points,0)||c2_delimiter||c_delimiter ELSE NULL END||--04/07/2015 Bug 61132 --09/30/2015 --11/26/2015
         c2_delimiter||Plateau_earned||c2_delimiter||c_delimiter||             
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
        uea.email_addr,     
        c.cm_asset_code,
        c.name_cm_key, 
        gsd.user_status Participant_status,        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480
        hier.node_name Primary_org_unit, 
        hier.path,
        gsd.job_position,
        gsd.department,
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale)  goal_level_name,          
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014       
        ROUND((gsd.current_value/gsd.amount_to_achieve)*100,2) perc_of_goal, --08/15/2014
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        CASE WHEN
        gsd.achieved=1 THEN 'Yes'
        ELSE 'No'
        END Achieved,
        gsd.calculated_payout points,
        gsd.plateau_earned,
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,            
        rpt_goal_selection_detail gsd
      LEFT OUTER JOIN rpt_hierarchy hier
      ON gsd.node_id = hier.node_id
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_email_address uea
      ON gsd.user_id = uea.user_id
      AND uea.is_primary = 1
      WHERE 
       ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)      
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)          
      AND gsd.country_id = c.country_id   
      AND gsd.user_id = au.user_id      
      order by node_name_sort asc, hier.path asc   --12/18/2014
      )); 
-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);
 --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_GQ_PAX_ACHIEVE_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||is_Team ||': '||'is_Team '||p_in_promotion_Id ||': '||'p_in_promotion_Id '||  --07/16/2014 Bug # 54917
        p_in_status||': '||'p_in_status'||p_in_promo_status||': '||'p_in_promo_status'||p_country_id||': '||'p_country_id'||locale||': '||'locale'||
        p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_GQ_PAX_ACHIEVE_EXTRACT;

PROCEDURE PRC_CP_PAX_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
-- Ravi Dhanekula     08/29/2013  Initial Version
                    04/01/2014     Added temp_table_session to fetch data from CM to avoid performance issues.
-- Swati              05/29/2014     Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated  
-- nagarajs           07/15/2014     Fixed the Bug # 54789 - Achieved status Needs to be Translated 
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception    
--Suresh J        09/18/2014  Bug #56666  - Department, Job code name translation issue     
--Suresh J        10/17/2014       Bug 57494  - Pax Achievement Base Value not matching
--Suresh J        04/16/2015   Bug # 61510 - Fixed CP Points Earned to not include base award points                   
--nagarajs       03/03/2016    Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics                   
--chidamba       08/24/2017    G6-2895 Challengepoint % Goal should display according to achievement precision   
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.                
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
     l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=locale;
    
BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
    select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key IN ('COUNTRY_NAME','GOALS') and locale = p_in_locale --04/01/2014
    UNION --05/29/2014 Bug # 53480
    SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion
                        WHERE upper(promotion_type) = upper('challengepoint'))
    AND locale = p_in_locale
UNION --07/15/2014 Bug # 54789
SELECT asset_code,cms_name,cms_code
  FROM vw_cms_code_value 
 WHERE asset_code = 'picklist.yesno.items'
   AND locale = p_in_locale
UNION   --09/18/2014 
SELECT asset_code,cms_name,cms_code
FROM vw_cms_code_value E
WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items','picklist.participantstatus.items') 
and e.locale=p_in_locale ;
   

DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
         c2_delimiter||path||c2_delimiter||c_delimiter||                              
         c2_delimiter||participant_status||c2_delimiter||c_delimiter||
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter||         
          c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||baseline||c2_delimiter||c_delimiter||  
         c2_delimiter||goal||c2_delimiter||c_delimiter||
         c2_delimiter||actual_result||c2_delimiter||c_delimiter||
         c2_delimiter||Perc_of_Goal||c2_delimiter||c_delimiter||
         --c2_delimiter||Achieved||c2_delimiter||c_delimiter|| --07/15/2014 Bug # 54789
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code = 'picklist.yesno.items' AND cms_code = achieved)||c2_delimiter||c_delimiter|| --07/15/2014 Bug # 54789
         c2_delimiter||Points||c2_delimiter||c_delimiter||                  
         c2_delimiter||basic_award_deposited||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
--        gsd.user_status Participant_status,  09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and cms_code= gsd.user_status) AS Participant_status,   --09/18/2014        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480
        hier.node_name Primary_org_unit,
        hier.path,
--        gsd.job_position,   09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= gsd.job_position) AS job_position,  --09/18/2014 
--        gsd.department,    09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= gsd.department)  AS department,    --09/18/2014
        up.phone_nbr, 
        uea.email_addr,     
        c.cm_asset_code,
        c.name_cm_key,              
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale)  goal_level_name,
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014
         CASE 
         WHEN NVL (gsd.amount_to_achieve, 0) = 0
           THEN 0 
         ELSE
           --ROUND (  (  NVL (gsd.current_value, 0) / gsd.amount_to_achieve)  * 100, 2) --08/24/2017 G6-2895 commented
           gsd.progress_challengepoint  --08/24/2017 G6-2895
        END as perc_of_goal,
        --(gsd.achieved/gsd.amount_to_achieve)*100 perc_of_goal,
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        CASE WHEN
        gsd.achieved=1 THEN 'true' --'Yes'  --07/15/2014 Bug # 54789
        ELSE 'false' --'No'  --07/15/2014 Bug # 54789
        END Achieved,
--        gsd.calculated_payout points,  --04/16/2015
        CASE WHEN gsd.achieved=1 THEN (gsd.calculated_payout - basic_award_deposited ) END as points,   --04/16/2015
        gsd.basic_award_deposited,       
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15, 
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20,     --03/03/2016 End                      
         CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,            
        rpt_cp_selection_detail gsd        
      LEFT OUTER JOIN rpt_hierarchy hier 
      ON gsd.node_id = hier.node_id 
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_phone up 
      ON gsd.user_id      = up.user_id
      AND up.is_primary = 1
      LEFT OUTER JOIN user_email_address uea 
      ON gsd.user_id = uea.user_id
      AND uea.is_primary = 1
      WHERE 
      ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)  
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)          
      AND gsd.country_id = c.country_id      
      AND gsd.user_id = au.user_id   
      AND pg.goallevel_id is not null   --10/17/2014
      ORDER BY node_name_sort asc,hier.path asc --12/18/2014
  ));  
      p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
         c2_delimiter||path||c2_delimiter||c_delimiter||                              
         c2_delimiter||participant_status||c2_delimiter||c_delimiter||
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter||         
          c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||baseline||c2_delimiter||c_delimiter||  
         c2_delimiter||goal||c2_delimiter||c_delimiter||
         c2_delimiter||actual_result||c2_delimiter||c_delimiter||
         c2_delimiter||Perc_of_Goal||c2_delimiter||c_delimiter||
         --c2_delimiter||Achieved||c2_delimiter||c_delimiter|| --07/15/2014 Bug # 54789
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code = 'picklist.yesno.items' AND cms_code = achieved)||c2_delimiter||c_delimiter|| --07/15/2014 Bug # 54789
         c2_delimiter||Points||c2_delimiter||c_delimiter||                  
         c2_delimiter||basic_award_deposited||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
--        gsd.user_status Participant_status,  09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and cms_code= gsd.user_status) AS Participant_status,   --09/18/2014        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480
        hier.node_name Primary_org_unit,
        hier.path,
--        gsd.job_position,   09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= gsd.job_position) AS job_position,  --09/18/2014 
--        gsd.department,    09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= gsd.department)  AS department,    --09/18/2014
        up.phone_nbr, 
        uea.email_addr,     
        c.cm_asset_code,
        c.name_cm_key,              
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale)  goal_level_name,
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014
         CASE 
         WHEN NVL (gsd.amount_to_achieve, 0) = 0
           THEN 0 
         ELSE
           --ROUND (  (  NVL (gsd.current_value, 0) / gsd.amount_to_achieve)  * 100, 2)  --08/24/2017 G6-2895 commented
           gsd.progress_challengepoint  --08/24/2017 G6-2895
        END as perc_of_goal,
        --(gsd.achieved/gsd.amount_to_achieve)*100 perc_of_goal,
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        CASE WHEN
        gsd.achieved=1 THEN 'true' --'Yes'  --07/15/2014 Bug # 54789
        ELSE 'false' --'No'  --07/15/2014 Bug # 54789
        END Achieved,
--        gsd.calculated_payout points,  --04/16/2015
        CASE WHEN gsd.achieved=1 THEN (gsd.calculated_payout - basic_award_deposited ) END as points,   --04/16/2015
        gsd.basic_award_deposited,       
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20,     --03/03/2016 End                      
         CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,            
        rpt_cp_selection_detail gsd        
      LEFT OUTER JOIN rpt_hierarchy hier 
      ON gsd.node_id = hier.node_id 
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_phone up 
      ON gsd.user_id      = up.user_id
      AND up.is_primary = 1
      LEFT OUTER JOIN user_email_address uea 
      ON gsd.user_id = uea.user_id
      AND uea.is_primary = 1
      WHERE 
      ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)  
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)          
      AND gsd.country_id = c.country_id      
      AND gsd.user_id = au.user_id   
      AND pg.goallevel_id is not null   --10/17/2014
      ORDER BY node_name_sort asc,hier.path asc --12/18/2014
  ));  

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019  
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);

	  
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket; 
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_CP_PAX_ACHIEVE_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||is_Team ||': '||'is_Team '||p_in_promotion_Id ||': '||'p_in_promotion_Id '|| --07/16/2014 Bug # 54917
        p_in_status||': '||'p_in_status'||p_in_promo_status||': '||'p_in_promo_status'||p_country_id||': '||'p_country_id'||
        locale||': '||'locale'||p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_CP_PAX_ACHIEVE_EXTRACT;

PROCEDURE PRC_GQ_SELECTION_EXTRACT
    (parentNodeId       IN VARCHAR2,
     is_Team            IN NUMBER,
     p_in_promotion_Id  IN VARCHAR2, 
     p_in_status        IN VARCHAR2,
     p_in_promo_status  IN VARCHAR2,
     p_country_id       IN NUMBER,
     locale             IN VARCHAR2,
     p_in_position_type IN VARCHAR2,
     p_in_department    IN VARCHAR2,
     p_in_has_select    IN VARCHAR2, 
     p_file_name        IN VARCHAR2,
     p_header           IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest Selection Extract'
-- Person              Date          Comments
-- ---------           ----------    -----------------------------------------------------
--  nagarajs           05/24/2017    Initial Creation - Added have/Have not selected filter and
--                                   G6.3 Query redesign for perfomance changes   
--  Gorantla           03/12/2019    G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter                  CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter                 CONSTANT VARCHAR2(1) := '"' ;
   c_process_name               CONSTANT execution_log.process_name%TYPE := 'PRC_GQ_SELECTION_EXTRACT';

   -- local variables
   file_handler                UTL_FILE.file_type;
   v_extract                   VARCHAR2(4000);
   v_file_location             VARCHAR2(1000);
   v_directory_name            all_directories.directory_name%TYPE; 
   directory_error             EXCEPTION;
   v_parm_list                 execution_log.text_line%TYPE;
   v_pattern                   VARCHAR2(15);
   v_recog_comment_enable      NUMBER(1);  
   v_stage                     VARCHAR2(1000);
   v_is_all_audience_giver     NUMBER; 
   v_locale                    VARCHAR2(15);
    
BEGIN
-- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': parentNodeId >' || parentNodeId
      || '<, is_Team >' || is_Team   
      || '<, p_in_promotion_Id >' || p_in_promotion_Id     
      || '<, p_in_status >' || p_in_status   
      || '<, p_in_promo_status >' || p_in_promo_status 
      || '<, p_country_id >' || p_country_id  
      || '<, locale >' || locale  
      || '<, p_in_position_type >' || p_in_position_type
      || '<, p_in_department >' || p_in_department  
      || '<, p_in_has_select >' || p_in_has_select 
      || '<, p_file_name >' || p_file_name;

    
  v_locale := NVL(locale, pkg_report_common.f_get_default_locale); 
 
BEGIN
    SELECT pattern 
      INTO v_pattern 
      FROM locale_date_pattern 
     WHERE locale= v_locale;
  EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
      v_pattern :='MM/DD/YYYY';
  END;

  -- stage input lists
   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department, gc_search_all_values),  gc_ref_text_department_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_position_type, gc_search_all_values),  gc_ref_text_position_type);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id, gc_search_all_values),  gc_ref_text_promotion_id, 1);


  v_stage := 'Open p_out_result_set';
  OPEN p_out_result_set FOR
   WITH w_node AS
   (  -- get query node(s)
      SELECT DISTINCT
             DECODE(is_Team, 1, hr.node_id, hr.child_node_id) AS node_id
        FROM gtt_id_list gil,
             rpt_hierarchy_rollup hr
       WHERE gil.ref_text_1 = gc_ref_text_parent_node_id
         AND gil.id = hr.node_id
   )
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
       UNION ALL
      SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||   
         c2_delimiter||email_type||c2_delimiter||c_delimiter||           
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||      
         c2_delimiter||country_name||c2_delimiter||c_delimiter||                                              
         c2_delimiter||participant_status||c2_delimiter||c_delimiter||
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter||         
         c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||   
         c2_delimiter||addr1||c2_delimiter||c_delimiter||
         c2_delimiter||addr2||c2_delimiter||c_delimiter||
         c2_delimiter||addr3||c2_delimiter||c_delimiter||
         c2_delimiter||city||c2_delimiter||c_delimiter||
         c2_delimiter||state||c2_delimiter||c_delimiter||
         c2_delimiter||postal_code||c2_delimiter||c_delimiter||
         c2_delimiter||phone_type||c2_delimiter||c_delimiter||      
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||baseline||c2_delimiter||c_delimiter||         
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter               
    FROM (SELECT gsd.last_name,        
                gsd.first_name,
                gsd.middle_init middle_name, 
                au.user_name login_id,
                uea.email_type,        
                uea.email_addr,   
                ua.addr1,
                ua.addr2,
                ua.addr3,
                ua.city,
                ua.state,
                ua.postal_code,      
                cav_cn.cms_value AS Country_name, 
                up.phone_type,     
                up.phone_nbr, 
                ccv_ps.cms_name AS Participant_status,  
                cav_pn.cms_value promotion_name, 
                hier.node_name Primary_org_unit,
                hier.path,
                ccv_pt.cms_name AS job_position,  
                ccv_dt.cms_name AS department,  
                cav_gl.cms_value AS goal_level_name,   
                gsd.base_quantity baseline,         
                cuc_r.pax_char1 AS characteristic_value1,
                cuc_r.pax_char2 AS characteristic_value2,
                cuc_r.pax_char3 AS characteristic_value3,
                cuc_r.pax_char4 AS characteristic_value4,
                cuc_r.pax_char5 AS characteristic_value5,
                cuc_r.pax_char6 AS characteristic_value6,
                cuc_r.pax_char7 AS characteristic_value7,
                cuc_r.pax_char8 AS characteristic_value8,
                cuc_r.pax_char9 AS characteristic_value9,
                cuc_r.pax_char10 AS characteristic_value10,
                cuc_r.pax_char11 AS characteristic_value11,
                cuc_r.pax_char12 AS characteristic_value12,
                cuc_r.pax_char13 AS characteristic_value13,
                cuc_r.pax_char14 AS characteristic_value14,
                cuc_r.pax_char15 AS characteristic_value15,
                cuc_r.pax_char16 AS characteristic_value16,
                cuc_r.pax_char17 AS characteristic_value17,
                cuc_r.pax_char18 AS characteristic_value18,
                cuc_r.pax_char19 AS characteristic_value19,
                cuc_r.pax_char20 AS characteristic_value20,                        
                 CASE  
                    WHEN REGEXP_COUNT (hier.PATH, '/') = 1
                    THEN
                       hier.node_name
                    WHEN REGEXP_COUNT (hier.PATH, '/') = 2
                    THEN
                       SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
                    ELSE
                       SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
                 END node_name_sort   
          FROM w_node wn,
               rpt_goal_selection_detail gsd,
               promotion promo,
               gtt_id_list gil_p,  -- promotion
               gtt_id_list gil_dt,  -- department
               gtt_id_list gil_pt,  -- position type
               goalquest_paxgoal pg ,
               goalquest_goallevel gl,
               rpt_hierarchy hier,
               user_address ua,
               user_phone up,
               user_email_address uea,
               country c, 
               application_user au,
               mv_cms_asset_value cav_cn,   --country
               mv_cms_asset_value cav_pn,   -- promotion name
               mv_cms_asset_value cav_gl,    --goal_level_name
               mv_cms_code_value ccv_ps,    -- pax status
               mv_cms_code_value ccv_dt,  -- department type 
               mv_cms_code_value ccv_pt,  -- position type
               mv_cms_user_characteristic cuc_r   -- characteristics receiver
         WHERE wn.node_id = gsd.node_id
           AND gsd.promotion_id = promo.promotion_id 
           AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)  
            -- restrict by optional fields
           AND gil_p.ref_text_1 = gc_ref_text_promotion_id
           AND (  gil_p.ref_text_2 = gc_search_all_values
                OR gil_p.id = gsd.promotion_id )
           AND gil_dt.ref_text_1 = gc_ref_text_department_type
           AND (  gil_dt.ref_text_2 = gc_search_all_values
                OR gil_dt.ref_text_2 = gsd.department )
           AND gil_pt.ref_text_1 = gc_ref_text_position_type
           AND (  gil_pt.ref_text_2 = gc_search_all_values
                OR gil_pt.ref_text_2 = gsd.job_position )
           AND (  p_in_status IS NULL
                OR p_in_status = user_status ) 
           AND gsd.pax_goal_id = pg.pax_goal_id (+)
           AND pg.goallevel_id      = gl.goallevel_id (+)
           AND gsd.node_id = hier.node_id  (+)
           AND gsd.user_id      = ua.user_id (+)
           AND ua.is_primary (+)= 1
           AND gsd.user_id      = up.user_id (+)
           AND up.is_primary (+)= 1
           AND gsd.user_id      = uea.user_id (+)
           AND uea.is_primary (+)= 1 
           AND gsd.country_id = c.country_id      
           AND gsd.user_id = au.user_id  
           AND c.name_cm_key   = cav_cn.key (+)
           AND c.cm_asset_code = cav_cn.asset_code (+)
           AND v_locale          = cav_cn.locale (+)
           AND gc_cms_key_fld_goal_level_name = cav_gl.key (+)
           AND gl.goal_level_cm_asset_code        = cav_gl.asset_code (+)
           AND v_locale                    = cav_gl.locale (+)
           AND gc_cms_list_pax_status = ccv_ps.asset_code (+)
           AND gsd.user_status        = ccv_ps.cms_code (+)
           AND v_locale                    = ccv_ps.locale (+)
           AND promo.promo_name_asset_code       = cav_pn.asset_code (+)
           AND gc_cms_key_fld_promotion_name = cav_pn.key (+)
           AND v_locale                      = cav_pn.locale (+)
           AND gc_cms_list_department_type = ccv_dt.asset_code (+)
           AND gsd.department    = ccv_dt.cms_code (+)
           AND v_locale                    = ccv_dt.locale (+)
           AND gc_cms_list_position_type = ccv_pt.asset_code (+)
           AND gsd.job_position    = ccv_pt.cms_code (+)
           AND v_locale                  = ccv_pt.locale (+)
           AND gsd.user_id = cuc_r.user_id (+)
           AND v_locale         = cuc_r.locale (+)
           AND ((p_in_has_select = 'select' AND gsd.level_id IS NOT NULL)
           OR (p_in_has_select = 'not_select' AND gsd.level_id IS NULL))
         ORDER BY node_name_sort asc,hier.path asc
         )
     );          
  
  -- write result set to file
   IF (p_file_name IS NOT NULL) THEN     
     -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
         UTL_FILE.put_line(file_handler, v_extract);           
      END LOOP;

      UTL_FILE.fclose(file_handler);
    --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019  
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

   COMMIT;  -- release DML locks on temp table
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN 
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;
END PRC_GQ_SELECTION_EXTRACT;

PROCEDURE PRC_CP_SELECTION_EXTRACT
    (parentNodeId       IN VARCHAR2,
     is_Team            IN NUMBER,
     p_in_promotion_Id  IN VARCHAR2, 
     p_in_status        IN VARCHAR2,
     p_in_promo_status  IN VARCHAR2,
     p_country_id       IN NUMBER,
     locale        IN VARCHAR2,
     p_in_position_type IN VARCHAR2,
     p_in_department    IN VARCHAR2,
     p_in_has_select    IN VARCHAR2, 
     p_file_name        IN VARCHAR2,
     p_header           IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor)
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Challengepoint Selection Extract'
-- Person              Date          Comments
-- ---------           ----------    -----------------------------------------------------
--  nagarajs           05/24/2017    Initial Creation - Added have/Have not selected filter and
--                                   G6.3 Query redesign for perfomance changes  
--  Gorantla    	   03/12/2019    G6-1446  AWS - Enable Large Audience functionality.                                   
*******************************************************************************/

   -- constants
   c_delimiter                  CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter                 CONSTANT VARCHAR2(1) := '"' ;
   c_process_name               CONSTANT execution_log.process_name%TYPE := 'PRC_CP_SELECTION_EXTRACT';

   -- local variables
   file_handler                UTL_FILE.file_type;
   v_extract                   VARCHAR2(4000);
   v_file_location             VARCHAR2(1000);
   v_directory_name            all_directories.directory_name%TYPE; 
   directory_error             EXCEPTION;
   v_parm_list                 execution_log.text_line%TYPE;
   v_pattern                   VARCHAR2(15);
   v_recog_comment_enable      NUMBER(1);  
   v_stage                     VARCHAR2(1000);
   v_is_all_audience_giver     NUMBER; 
   v_locale VARCHAR2(10);
   
BEGIN
-- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      ||  ': parentNodeId >' || parentNodeId
      || '<, is_Team >' || is_Team   
      || '<, p_in_promotion_Id >' || p_in_promotion_Id     
      || '<, p_in_status >' || p_in_status   
      || '<, p_in_promo_status >' || p_in_promo_status 
      || '<, p_country_id >' || p_country_id  
      || '<, v_locale >' || v_locale  
      || '<, p_in_position_type >' || p_in_position_type
      || '<, p_in_department >' || p_in_department  
      || '<, p_in_has_select >' || p_in_has_select 
      || '<, p_file_name >' || p_file_name;
  

  v_locale := NVL(locale, pkg_report_common.f_get_default_locale); 
 
  BEGIN
    SELECT pattern 
      INTO v_pattern 
      FROM locale_date_pattern 
     WHERE locale= v_locale;
  EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
      v_pattern :='MM/DD/YYYY';
  END;
  -- stage input lists
   v_stage := 'stage input lists';
   DELETE gtt_id_list;
      
   pkg_report_common.p_stage_search_criteria(NVL(parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
      
   pkg_report_common.p_stage_search_criteria(NVL(p_in_department, gc_search_all_values),  gc_ref_text_department_type);
      
   pkg_report_common.p_stage_search_criteria(NVL(p_in_position_type, gc_search_all_values),  gc_ref_text_position_type);
      
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotion_id, gc_search_all_values),  gc_ref_text_promotion_id, 1);
      


  v_stage := 'Open p_out_result_set';
  OPEN p_out_result_set FOR
   WITH w_node AS
   (  -- get query node(s)
      SELECT DISTINCT
             DECODE(is_Team, 1, hr.node_id, hr.child_node_id) AS node_id
        FROM gtt_id_list gil,
             rpt_hierarchy_rollup hr
       WHERE gil.ref_text_1 = gc_ref_text_parent_node_id
         AND gil.id = hr.node_id
   )
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
       UNION ALL
      SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||            
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||      
         c2_delimiter||country_name||c2_delimiter||c_delimiter||                                              
         c2_delimiter||participant_status||c2_delimiter||c_delimiter||
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter||         
         c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||         
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||baseline||c2_delimiter||c_delimiter||         
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter               
    FROM (SELECT gsd.last_name,        
                gsd.first_name,
                gsd.middle_init middle_name, 
                au.user_name login_id,        
                uea.email_addr,         
                cav_cn.cms_value AS Country_name,      
                up.phone_nbr, 
                ccv_ps.cms_name AS Participant_status,  
                cav_pn.cms_value promotion_name, 
                hier.node_name Primary_org_unit,
                hier.path,
                ccv_pt.cms_name AS job_position,  
                ccv_dt.cms_name AS department,  
                cav_gl.cms_value AS goal_level_name,   
                gsd.base_quantity baseline,         
                cuc_r.pax_char1 AS characteristic_value1,
                cuc_r.pax_char2 AS characteristic_value2,
                cuc_r.pax_char3 AS characteristic_value3,
                cuc_r.pax_char4 AS characteristic_value4,
                cuc_r.pax_char5 AS characteristic_value5,
                cuc_r.pax_char6 AS characteristic_value6,
                cuc_r.pax_char7 AS characteristic_value7,
                cuc_r.pax_char8 AS characteristic_value8,
                cuc_r.pax_char9 AS characteristic_value9,
                cuc_r.pax_char10 AS characteristic_value10,
                cuc_r.pax_char11 AS characteristic_value11,
                cuc_r.pax_char12 AS characteristic_value12,
                cuc_r.pax_char13 AS characteristic_value13,
                cuc_r.pax_char14 AS characteristic_value14,
                cuc_r.pax_char15 AS characteristic_value15,
                cuc_r.pax_char16 AS characteristic_value16,
                cuc_r.pax_char17 AS characteristic_value17,
                cuc_r.pax_char18 AS characteristic_value18,
                cuc_r.pax_char19 AS characteristic_value19,
                cuc_r.pax_char20 AS characteristic_value20,                        
                 CASE  
                    WHEN REGEXP_COUNT (hier.PATH, '/') = 1
                    THEN
                       hier.node_name
                    WHEN REGEXP_COUNT (hier.PATH, '/') = 2
                    THEN
                       SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
                    ELSE
                       SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
                 END node_name_sort   
          FROM w_node wn,
               rpt_cp_selection_detail gsd,
               promotion promo,
               gtt_id_list gil_p,  -- promotion
               gtt_id_list gil_dt,  -- department
               gtt_id_list gil_pt,  -- position type
               goalquest_paxgoal pg ,
               goalquest_goallevel gl,
               rpt_hierarchy hier,
               user_phone up,
               user_email_address uea,
               country c, 
               application_user au,
               mv_cms_asset_value cav_cn,   --country
               mv_cms_asset_value cav_pn,   -- promotion name
               mv_cms_asset_value cav_gl,    --goal_level_name
               mv_cms_code_value ccv_ps,    -- pax status
               mv_cms_code_value ccv_dt,  -- department type 
               mv_cms_code_value ccv_pt,  -- position type
               mv_cms_user_characteristic cuc_r   -- characteristics receiver
         WHERE wn.node_id = gsd.node_id
           AND gsd.promotion_id = promo.promotion_id 
           AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)  
            -- restrict by optional fields
           AND gil_p.ref_text_1 = gc_ref_text_promotion_id
           AND (  gil_p.ref_text_2 = gc_search_all_values
                OR gil_p.id = gsd.promotion_id )
           AND gil_dt.ref_text_1 = gc_ref_text_department_type
           AND (  gil_dt.ref_text_2 = gc_search_all_values
                OR gil_dt.ref_text_2 = gsd.department )
           AND gil_pt.ref_text_1 = gc_ref_text_position_type
           AND (  gil_pt.ref_text_2 = gc_search_all_values
                OR gil_pt.ref_text_2 = gsd.job_position )
           AND (  p_in_status IS NULL
                OR p_in_status = user_status ) 
           AND gsd.pax_goal_id = pg.pax_goal_id (+)
           AND pg.goallevel_id      = gl.goallevel_id (+)
           AND gsd.node_id = hier.node_id  (+)
           AND gsd.user_id      = up.user_id (+)
           AND up.is_primary (+)= 1
           AND gsd.user_id      = uea.user_id (+)
           AND uea.is_primary (+)= 1 
           AND gsd.country_id = c.country_id      
           AND gsd.user_id = au.user_id  
           AND c.name_cm_key   = cav_cn.key (+)
           AND c.cm_asset_code = cav_cn.asset_code (+)
           AND v_locale          = cav_cn.locale (+)
           AND gc_cms_key_fld_goal_level_name = cav_gl.key (+)
           AND gl.goal_level_cm_asset_code        = cav_gl.asset_code (+)
           AND v_locale                    = cav_gl.locale (+)
           AND gc_cms_list_pax_status = ccv_ps.asset_code (+)
           AND gsd.user_status        = ccv_ps.cms_code (+)
           AND v_locale                    = ccv_ps.locale (+)
           AND promo.promo_name_asset_code       = cav_pn.asset_code (+)
           AND gc_cms_key_fld_promotion_name = cav_pn.key (+)
           AND v_locale                      = cav_pn.locale (+)
           AND gc_cms_list_department_type = ccv_dt.asset_code (+)
           AND gsd.department    = ccv_dt.cms_code (+)
           AND v_locale                    = ccv_dt.locale (+)
           AND gc_cms_list_position_type = ccv_pt.asset_code (+)
           AND gsd.job_position    = ccv_pt.cms_code (+)
           AND v_locale                  = ccv_pt.locale (+)
           AND gsd.user_id = cuc_r.user_id (+)
           AND v_locale         = cuc_r.locale (+)
           AND ((p_in_has_select = 'select' AND gsd.level_id IS NOT NULL)
           OR (p_in_has_select = 'not_select' AND gsd.level_id IS NULL))
         ORDER BY node_name_sort asc,hier.path asc
         )
     );          
  -- write result set to file
   IF (p_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
         UTL_FILE.put_line(file_handler, v_extract);           
      END LOOP;

      UTL_FILE.fclose(file_handler);

      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket; 
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019  
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

   COMMIT;  -- release DML locks on temp table
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN 
         UTL_FILE.fclose(file_handler);
      END IF;

      OPEN p_out_result_set FOR SELECT NULL FROM dual;
END PRC_CP_SELECTION_EXTRACT;

PROCEDURE PRC_GQ_PROGRESS_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor)    IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 09/03/2013 Initial Version
                  04/01/2014 Added temp_table_session to fetch data from CM to avoid performance issues.
-- Swati          05/29/2014 Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated  
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception     
-- Swati          09/18/2014 Bug 56632 - GoalQuest Progress Report: Primary Orgunit column is not available in the extract     
-- Swati          04/09/2015 Bug 61203 - GoalQuest Progress - Zero values are not getting displayed in both summary and in export output                   
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics  
--Gorantla        03/12/2019 G6-1446  AWS - Enable Large Audience functionality.  
--Murugeswari.A   04/09/2019  Bug 77047 - GQ Progress export extract displays html content when GQ promotion setup has zero achievement amount for any one of the levels  
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;

    p_in_locale VARCHAR2(10) :=locale;
          

BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key IN ('COUNTRY_NAME','GOALS') and locale = p_in_locale --04/01/2014
UNION --05/29/2014 Bug # 53480
    SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion
                        WHERE upper(promotion_type) = upper('goalquest'))
    AND locale = p_in_locale;
   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_type||c2_delimiter||c_delimiter||         
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
         c2_delimiter||participant_status||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter||         
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter|| --09/18/2014 Bug 56632
          c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||addr1||c2_delimiter||c_delimiter||
         c2_delimiter||addr2||c2_delimiter||c_delimiter||
         c2_delimiter||addr3||c2_delimiter||c_delimiter||
         c2_delimiter||city||c2_delimiter||c_delimiter||
         c2_delimiter||state||c2_delimiter||c_delimiter||
         c2_delimiter||postal_code||c2_delimiter||c_delimiter||
         c2_delimiter||phone_type||c2_delimiter||c_delimiter||
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(baseline,0)||c2_delimiter||c_delimiter|| --04/09/2015 Bug 61203 Added NVL 
         c2_delimiter||nvl(goal,0)||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(actual_result,0)||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(Perc_of_Goal,0)||c2_delimiter||c_delimiter||
         c2_delimiter||Points||c2_delimiter||c_delimiter||        
         c2_delimiter||nvl(characteristic_value1,0)||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
        uea.email_type,
        uea.email_addr,
        ua.addr1,
        ua.addr2,
        ua.addr3,
        ua.city,
        ua.state,
        ua.postal_code,     
        c.cm_asset_code,
        c.name_cm_key,
        up.phone_type,
        up.phone_nbr, 
        gsd.user_status Participant_status,        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480                    
        hier.path, 
        hier.node_name Primary_org_unit,--09/18/2014 Bug 56632
        gsd.job_position,
        gsd.department,
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale) goal_level_name,
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014 
        --ROUND((gsd.current_value/gsd.amount_to_achieve)*100,2) perc_of_goal,
        CASE when gsd.current_value=0 then null  -- 04/09/2019  Bug 77047 starts
        when gsd.amount_to_achieve=0 then null
        else
        ROUND((gsd.current_value/gsd.amount_to_achieve)*100,2) end as perc_of_goal,-- 04/09/2019  Bug 77047 ends
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        gsd.calculated_payout points,
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15, 
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
        ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,
            user_address ua,                        
        rpt_goal_selection_detail gsd
      LEFT OUTER JOIN rpt_hierarchy hier
      ON gsd.node_id = hier.node_id
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_phone up 
      ON gsd.user_id      = up.user_id
      AND up.is_primary = 1
      LEFT OUTER JOIN user_email_address uea 
      ON gsd.user_id      = uea.user_id
      AND uea.is_primary = 1      
      WHERE 
      ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)      
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)
      AND gsd.user_id = ua.user_id
      AND ua.is_primary = 1
      AND gsd.country_id = c.country_id   
      AND gsd.user_id = au.user_id      
      ORDER BY node_name_sort asc,hier.path asc  --12/18/2014      
      ));
      p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_type||c2_delimiter||c_delimiter||         
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014
         c2_delimiter||participant_status||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter||         
         c2_delimiter||Primary_org_unit||c2_delimiter||c_delimiter|| --09/18/2014 Bug 56632
          c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||addr1||c2_delimiter||c_delimiter||
         c2_delimiter||addr2||c2_delimiter||c_delimiter||
         c2_delimiter||addr3||c2_delimiter||c_delimiter||
         c2_delimiter||city||c2_delimiter||c_delimiter||
         c2_delimiter||state||c2_delimiter||c_delimiter||
         c2_delimiter||postal_code||c2_delimiter||c_delimiter||
         c2_delimiter||phone_type||c2_delimiter||c_delimiter||
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(baseline,0)||c2_delimiter||c_delimiter|| --04/09/2015 Bug 61203 Added NVL 
         c2_delimiter||nvl(goal,0)||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(actual_result,0)||c2_delimiter||c_delimiter||
         c2_delimiter||nvl(Perc_of_Goal,0)||c2_delimiter||c_delimiter||
         c2_delimiter||Points||c2_delimiter||c_delimiter||        
         c2_delimiter||nvl(characteristic_value1,0)||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
        uea.email_type,
        uea.email_addr,
        ua.addr1,
        ua.addr2,
        ua.addr3,
        ua.city,
        ua.state,
        ua.postal_code,     
        c.cm_asset_code,
        c.name_cm_key,
        up.phone_type,
        up.phone_nbr, 
        gsd.user_status Participant_status,        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480                    
        hier.path, 
        hier.node_name Primary_org_unit,--09/18/2014 Bug 56632
        gsd.job_position,
        gsd.department,
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale) goal_level_name,
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014 
        ROUND((gsd.current_value/gsd.amount_to_achieve)*100,2) perc_of_goal,
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        gsd.calculated_payout points,
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
         ,CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,
            user_address ua,                        
        rpt_goal_selection_detail gsd
      LEFT OUTER JOIN rpt_hierarchy hier
      ON gsd.node_id = hier.node_id
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_phone up 
      ON gsd.user_id      = up.user_id
      AND up.is_primary = 1
      LEFT OUTER JOIN user_email_address uea 
      ON gsd.user_id      = uea.user_id
      AND uea.is_primary = 1      
      WHERE 
      ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)      
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)
      AND gsd.user_id = ua.user_id
      AND ua.is_primary = 1
      AND gsd.country_id = c.country_id   
      AND gsd.user_id = au.user_id      
      ORDER BY node_name_sort asc,hier.path asc  --12/18/2014      
      ));

 -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);

  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_GQ_PROGRESS_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||is_Team ||': '||'is_Team '||p_in_promotion_Id ||': '||'p_in_promotion_Id '|| --07/16/2014 Bug # 54917
        p_in_status||': '||'p_in_status'||p_in_promo_status||': '||'p_in_promo_status'||p_country_id||': '||'p_country_id'||
        locale||': '||'locale'||p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_GQ_PROGRESS_EXTRACT;

PROCEDURE PRC_CP_PROGRESS_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     is_Team IN NUMBER,
     p_in_promotion_Id IN VARCHAR2, 
     p_in_status IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     p_country_id   IN NUMBER,
     locale IN VARCHAR2,
     p_in_position_type     IN VARCHAR2,
     p_in_department   IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person         Date        Comments
-- ---------         ----------  -----------------------------------------------------
-- Ravi Dhanekula 08/29/2013  Initial Version  
-- Gorantla       09/30/2013  Bug #4720 fix
-- Chidamba       10/07/2013  Defect#4720 Removed unwanted columns with respect to requirement     
-- Ravi Dhanekula 04/01/2014  Added temp_table_session to fetch data from CM to avoid performace issues.
-- Swati          05/29/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated    
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
--Suresh J        09/18/2014  Bug #56666  - Department, Job code name translation issue
--Suresh J        09/25/2014  Bug #56779 - Rounding off pct column
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--chidamba        08/23/2017   G6-2898 Challengepoint Progress "Percentage of Goal" is rounding the half up
--Gorantla        03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
******************************************************************************/


   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  

    p_in_locale VARCHAR2(10) :=locale;
    

BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key IN ('COUNTRY_NAME','GOALS') and locale = p_in_locale --04/01/2014
UNION --05/29/2014 Bug # 53480
    SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion
                        WHERE upper(promotion_type) = upper('challengepoint'))
    AND locale = p_in_locale
UNION   --09/18/2014 
SELECT asset_code,cms_name,cms_code
FROM vw_cms_code_value E
WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items') 
and e.locale=p_in_locale ;
   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||         
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||     
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014           
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter|| 
         c2_delimiter||parent_node_name||c2_delimiter||c_delimiter||     --09/30/2013         
          c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||baseline||c2_delimiter||c_delimiter||  
         c2_delimiter||goal||c2_delimiter||c_delimiter||
         c2_delimiter||actual_result||c2_delimiter||c_delimiter||
         c2_delimiter||Perc_of_Goal||c2_delimiter||c_delimiter||
         --c2_delimiter||Points||c2_delimiter||c_delimiter||             --09/30/2013 
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
        uea.email_type,
        uea.email_addr,
        ua.addr1,
        ua.addr2,
        ua.addr3,
        ua.city,
        substr( ua.state,instr( ua.state,'_',1)+1) state,  --09/30/2013
        ua.postal_code,     
        c.cm_asset_code,
        c.name_cm_key,
        up.phone_type,
        up.phone_nbr, 
        gsd.user_status Participant_status,        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480    
        hier.node_name parent_node_name,   --09/30/2013
        hier.path, 
--        gsd.job_position,  --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= gsd.job_position) AS job_position,  --09/18/2014        
--        gsd.department,     --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= gsd.department) AS department,    --09/18/2014            
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale) goal_level_name,
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014        
        gsd.progress_challengepoint perc_of_goal,  --09/30/2013 replaced gsd.Achieved with gsd.current_value  --09/25/2014 --08/23/2017 G6-2898
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        gsd.calculated_payout points,       
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20,     --03/03/2016 End                      
         CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,
            user_address ua,            
        rpt_cp_selection_detail gsd        
      LEFT OUTER JOIN rpt_hierarchy hier 
      ON gsd.node_id = hier.node_id 
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_phone up 
      ON gsd.user_id      = up.user_id
      AND up.is_primary = 1
      LEFT OUTER JOIN user_email_address uea
      ON gsd.user_id      = uea.user_id
      AND uea.is_primary = 1
      WHERE 
      ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)  
      AND gsd.level_id IS NOT NULL   
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)
      AND gsd.user_id = ua.user_id
      AND ua.is_primary = 1
      AND gsd.country_id = c.country_id      
      AND gsd.user_id = au.user_id     
      ORDER BY node_name_sort asc,hier.path  asc --12/18/2014      
       ));  
      p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||
         c2_delimiter||email_addr||c2_delimiter||c_delimiter||         
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||     
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE cms_code = 'COUNTRY_NAME' AND asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014           
         c2_delimiter||phone_nbr||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter|| 
         c2_delimiter||parent_node_name||c2_delimiter||c_delimiter||     --09/30/2013         
          c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||goal_level_name||c2_delimiter||c_delimiter||
         c2_delimiter||baseline||c2_delimiter||c_delimiter||  
         c2_delimiter||goal||c2_delimiter||c_delimiter||
         c2_delimiter||actual_result||c2_delimiter||c_delimiter||
         c2_delimiter||Perc_of_Goal||c2_delimiter||c_delimiter||
         --c2_delimiter||Points||c2_delimiter||c_delimiter||             --09/30/2013 
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT gsd.last_name,        
        gsd.first_name,
        gsd.middle_init middle_name, 
        au.user_name login_id,
        uea.email_type,
        uea.email_addr,
        ua.addr1,
        ua.addr2,
        ua.addr3,
        ua.city,
        substr( ua.state,instr( ua.state,'_',1)+1) state,  --09/30/2013
        ua.postal_code,     
        c.cm_asset_code,
        c.name_cm_key,
        up.phone_type,
        up.phone_nbr, 
        gsd.user_status Participant_status,        
        --gsd.promotion_name,
        (select cms_name from temp_table_session where asset_code = promo.promo_name_asset_code) promotion_name, --05/29/2014 Bug # 53480    
        hier.node_name parent_node_name,   --09/30/2013
        hier.path, 
--        gsd.job_position,  --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= gsd.job_position) AS job_position,  --09/18/2014        
--        gsd.department,     --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= gsd.department) AS department,    --09/18/2014            
--        FNC_CMS_ASSET_CODE_VAL_EXTR(gl.goal_level_cm_asset_code,'GOALS',p_in_locale) goal_level_name,
        (SELECT cms_name FROM temp_table_session WHERE cms_code = 'GOALS' AND asset_code=gl.goal_level_cm_asset_code) goal_level_name, --04/01/2014        
        gsd.progress_challengepoint perc_of_goal,  --09/30/2013 replaced gsd.Achieved with gsd.current_value  --09/25/2014 --08/23/2017  G6-2898
        gsd.base_quantity baseline, 
        gsd.amount_to_achieve goal, 
        gsd.current_value actual_result,
        gsd.calculated_payout points,       
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20,     --03/03/2016 End                      
         CASE  --12/18/2014
            WHEN REGEXP_COUNT (hier.PATH, '/') = 1
            THEN
               hier.node_name
            WHEN REGEXP_COUNT (hier.PATH, '/') = 2
            THEN
               SUBSTR (hier.PATH, 3, LENGTH (TRIM (hier.PATH)))
            ELSE
               SUBSTR (hier.PATH,3,INSTR (hier.PATH,'/',1,3)-3)
         END node_name_sort   --12/18/2014
       FROM promo_goalquest promoGoal,
            application_user au,
            country c,
            user_address ua,            
        rpt_cp_selection_detail gsd        
      LEFT OUTER JOIN rpt_hierarchy hier 
      ON gsd.node_id = hier.node_id 
      LEFT OUTER JOIN promotion promo 
      ON gsd.promotion_id = promo.promotion_id 
      RIGHT OUTER JOIN goalquest_paxgoal pg 
      ON gsd.pax_goal_id = pg.pax_goal_id 
      LEFT OUTER JOIN goalquest_goallevel gl 
      ON pg.goallevel_id      = gl.goallevel_id
      LEFT OUTER JOIN rpt_characteristic rch 
      ON gsd.user_id      = rch.user_nt_id
      LEFT OUTER JOIN user_phone up 
      ON gsd.user_id      = up.user_id
      AND up.is_primary = 1
      LEFT OUTER JOIN user_email_address uea
      ON gsd.user_id      = uea.user_id
      AND uea.is_primary = 1
      WHERE 
      ( (NVL(is_Team,0)=0 AND gsd.NODE_ID IN (    SELECT child_node_id
                                         FROM rpt_hierarchy_rollup N2
                                   WHERE node_id IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId)))))
                             OR
                           (  is_Team=1 AND gsd.NODE_ID=parentNodeId)) 
      AND gsd.promotion_id                                = promoGoal.promotion_id
      AND gsd.user_status                                 = NVL(p_in_status,gsd.user_status)
      AND promo.promotion_status = NVL(p_in_promo_status,promo.promotion_status)  
      AND gsd.level_id IS NOT NULL   
      AND (gsd.job_position IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_position_type) AS ARRAY_VARCHAR))) OR p_in_position_type IS NULL)
      AND (gsd.department IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_department) AS ARRAY_VARCHAR))) OR p_in_department IS NULL)     
      AND (gsd.promotion_id IN (SELECT * FROM TABLE(CAST(get_array_varchar(p_in_promotion_Id) AS ARRAY_VARCHAR))) OR p_in_promotion_Id IS NULL)
      AND gsd.user_id = ua.user_id
      AND ua.is_primary = 1
      AND gsd.country_id = c.country_id      
      AND gsd.user_id = au.user_id     
      ORDER BY node_name_sort asc,hier.path  asc --12/18/2014      
       ));  
	   
 -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019  
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);
  
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_CP_PROGRESS_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||is_Team ||': '||'is_Team '||p_in_promotion_Id ||': '||'p_in_promotion_Id '|| --07/16/2014 Bug # 54917
        p_in_status||': '||'p_in_status'||p_in_promo_status||': '||'p_in_promo_status'||p_country_id||': '||'p_country_id'||
        locale||': '||'locale'||p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_CP_PROGRESS_EXTRACT;

PROCEDURE PRC_GQ_MGR_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person              Date        Comments
-- ---------           ----------  -----------------------------------------------------
-- Ravi Dhanekula     09/03/2013  Initial Version  
                    04/01/2014     Added temp_table_session to fetch data from CM to avoid performace issues.
-- Swati              06/02/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated
-- nagarajs           07/16/2014  Bug # 54917 - close the file and include parms value when OTHER exception 
-- Ravi Dhanekula    09/03/2014     Fixed the bug # 56336...Had to re-write the extract query.
-- Swati              09/11/2014  Bug 56461 - GoalQuest Manager Achievement Report Extract does not have data  
--nagarajs            02/15/2016  Bug 65740 and 65763 - fixes   
--nagarajs            02/15/2016  Bug 65740 - Admin View/Reports/Manager/Goal Quest Manager Achievement Report : 
                                 "Total Manager Points" total mismatches between the summary table and the extracted sheet.              
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--Gorantla          03/12/2019   G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/
 -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=locale;
    
BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key = 'COUNTRY_NAME' and locale = p_in_locale --04/01/2014
UNION --06/02/2014 Bug # 53480
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                            WHERE upper(promotion_type) = upper('goalquest')
                        )
    AND locale = p_in_locale; 
   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
        UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||user_name||c2_delimiter||c_delimiter||
         c2_delimiter||status||c2_delimiter||c_delimiter||         
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code=ex.cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014       
         c2_delimiter||department||c2_delimiter||c_delimiter||         
         --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p 
                            WHERE p.promotion_id = ex.promotion_id))||c2_delimiter||c_delimiter||--06/02/2014 Bug # 53480
         c2_delimiter||total_pax||c2_delimiter||c_delimiter||  
         c2_delimiter||total_pax_goal_selected||c2_delimiter||c_delimiter||
         c2_delimiter||total_pax_achieved||c2_delimiter||c_delimiter||
         c2_delimiter||percent_sel_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||percent_tot_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||manage_override_percentage||c2_delimiter||c_delimiter||         
         c2_delimiter||total_points||c2_delimiter||c_delimiter|| 
         c2_delimiter||managr_payout_per_achiever||c2_delimiter||c_delimiter||
         c2_delimiter||total_mgr_points||c2_delimiter||c_delimiter||     
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT
         gs.total_nbr_pax TOTAL_PAX, 
         gs.pax_sel_goal TOTAL_PAX_GOAL_SELECTED, 
         gs.nbr_pax_achieving TOTAL_PAX_ACHIEVED, 
         --ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.pax_sel_goal     /gs.total_nbr_pax) * 100),2) PERCENT_SEL_PAX_ACHIEVING, 
         NVL(ROUND (DECODE (gs.pax_sel_goal,0, 0,(  gs.nbr_pax_achieving/ gs.pax_sel_goal)* 100),2),0) PERCENT_SEL_PAX_ACHIEVING, -- 09/12/2014 Bug 56461
         ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.nbr_pax_achieving/gs.total_nbr_pax) * 100),2) PERCENT_TOT_PAX_ACHIEVING, 
         gs.team_points TOTAL_POINTS, 
        gs.manager_points TOTAL_MGR_POINTS, 
       DECODE(gs.nbr_pax_achieving,0,0,(gs.manager_points/gs.nbr_pax_achieving)) MANAGR_PAYOUT_PER_ACHIEVER,
        ROUND(DECODE(gs.team_points,0,0,(gs.manager_points/gs.team_points) * 100),2) MANAGE_OVERRIDE_PERCENTAGE,
         au.first_name,
         au.middle_name,
         au.last_name,
         au.user_name,
         c.cm_asset_code,
        c.name_cm_key,
        p.status,
        pe.department_type department,
        gs.promotion_name, 
        gs.promotion_id,--06/02/2014 Bug # 53480        
        gs.path org_path,     
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
       FROM 
         (         
         SELECT mgr_user_id,  --02/17/2016
         rh.node_name org_unit,rh.node_id, 
           SUM(rpt.total_participants) total_nbr_pax, 
           SUM(DECODE (rpt.goal_level, NULL, 0, rpt.total_participants)) pax_sel_goal, 
           SUM(rpt.nbr_goal_achieved) nbr_pax_achieving, 
           NVL(SUM(rpt.calculated_payout), 0) team_points,
           promo.promotion_name,
           promo.promotion_id,--06/02/2014 Bug # 53480
           rh.path,           
           NVL (override.manager_points, 0) manager_points
         FROM rpt_hierarchy rh, 
           promo_goalquest promoGoal, 
           promotion promo, 
           user_node un, 
           (SELECT mgr_user_id, 
             rpt.mgr_last_name 
             || ',' 
             || rpt.mgr_first_name AS manager_name, 
             rpt.promotion_id, 
             SUM (override_amount) manager_points 
           FROM rpt_goal_manager_override rpt, 
             promotion promo 
           WHERE rpt.promotion_id = promo.promotion_id            
           AND ( ( p_in_promotion_Id IS NULL) 
           OR ( p_in_promotion_Id    IS NOT NULL 
           AND rpt.promotion_id  IN 
             (SELECT * FROM TABLE ( get_array ( p_in_promotion_Id)) 
             ))) 
           AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
           GROUP BY rpt.mgr_last_name, 
             rpt.mgr_first_name, 
             mgr_user_id, 
             rpt.promotion_id 
           ) override, 
           rpt_goal_selection_summary rpt,  
           goalquest_goallevel gl      
         WHERE rpt.goal_level       = gl.goallevel_id (+)  
         AND rpt.detail_node_id     = rh.node_id 
         AND rpt.promotion_id       = promoGoal.promotion_id 
         AND promogoal.promotion_id = promo.promotion_id 
         AND rpt.detail_node_id    IN 
          (SELECT child_node_id 
           FROM rpt_hierarchy_rollup 
           WHERE node_id = parentNodeId 
           )    
         AND rpt.record_type LIKE '%node%'  
         AND ( rpt.promotion_id IN 
           (SELECT               * 
           FROM TABLE ( CAST ( get_array_varchar ( p_in_promotion_Id) AS ARRAY_VARCHAR)) 
           ) 
         OR p_in_promotion_Id          IS NULL) 
         AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
         AND rh.node_id             = un.node_id 
         AND un.user_id             = override.mgr_user_id 
         AND promo.promotion_id     = override.promotion_id 
         AND un.role                = 'own' 
         AND un.is_primary = 1                  --02/15/2016
         GROUP BY rh.node_name, rh.node_id,promo.promotion_name,rh.path,manager_points,promo.promotion_id, --06/02/2014 Bug # 53480
         mgr_user_id  --02/17/2016
         ) gs, user_node un,application_user au,user_address uea,country c,rpt_characteristic rch,participant p,vw_curr_pax_employer pe       
         WHERE
         gs.node_id = un.node_id
         AND gs.mgr_user_id = un.user_id    --02/17/2016
         AND un.role ='own'
         AND un.is_primary = 1                  --02/15/2016
         AND un.user_id = au .user_id
         AND au.user_id = uea.user_id(+)
         AND uea.is_primary = 1
         AND uea.country_id = c.country_id
         AND au.user_id      = rch.user_nt_id(+)
         AND rch.characteristic_type(+) = 'USER' -- 09/12/2014 Bug 56461 
         AND au.user_id = p.user_id
         AND p.user_id = pe.user_id(+)         
    ORDER BY 
--    gs.promotion_name asc  --12/18/2014
      last_name asc   --12/18/2014    
 )ex --09/12/2014 Bug 56461   added alias name
 );
p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
        UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||user_name||c2_delimiter||c_delimiter||
         c2_delimiter||status||c2_delimiter||c_delimiter||         
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code=ex.cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014       
         c2_delimiter||department||c2_delimiter||c_delimiter||         
         --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p 
                            WHERE p.promotion_id = ex.promotion_id))||c2_delimiter||c_delimiter||--06/02/2014 Bug # 53480
         c2_delimiter||total_pax||c2_delimiter||c_delimiter||  
         c2_delimiter||total_pax_goal_selected||c2_delimiter||c_delimiter||
         c2_delimiter||total_pax_achieved||c2_delimiter||c_delimiter||
         c2_delimiter||percent_sel_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||percent_tot_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||manage_override_percentage||c2_delimiter||c_delimiter||         
         c2_delimiter||total_points||c2_delimiter||c_delimiter||                
         c2_delimiter||managr_payout_per_achiever||c2_delimiter||c_delimiter||
         c2_delimiter||total_mgr_points||c2_delimiter||c_delimiter||              
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT
         gs.total_nbr_pax TOTAL_PAX, 
         gs.pax_sel_goal TOTAL_PAX_GOAL_SELECTED, 
         gs.nbr_pax_achieving TOTAL_PAX_ACHIEVED, 
         --ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.pax_sel_goal     /gs.total_nbr_pax) * 100),2) PERCENT_SEL_PAX_ACHIEVING, 
         NVL(ROUND (DECODE (gs.pax_sel_goal,0, 0,(  gs.nbr_pax_achieving/ gs.pax_sel_goal)* 100),2),0) PERCENT_SEL_PAX_ACHIEVING, -- 09/12/2014 Bug 56461
         ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.nbr_pax_achieving/gs.total_nbr_pax) * 100),2) PERCENT_TOT_PAX_ACHIEVING, 
         gs.team_points TOTAL_POINTS, 
        gs.manager_points TOTAL_MGR_POINTS, 
       DECODE(gs.nbr_pax_achieving,0,0,(gs.manager_points/gs.nbr_pax_achieving)) MANAGR_PAYOUT_PER_ACHIEVER,
        ROUND(DECODE(gs.team_points,0,0,(gs.manager_points/gs.team_points) * 100),2) MANAGE_OVERRIDE_PERCENTAGE,
         au.first_name,
         au.middle_name,
         au.last_name,
         au.user_name,
         c.cm_asset_code,
        c.name_cm_key,
        p.status,
        pe.department_type department,
        gs.promotion_name, 
        gs.promotion_id,--06/02/2014 Bug # 53480        
        gs.path org_path,     
        (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
       (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
       (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
       FROM 
         (         
         SELECT mgr_user_id,  --02/17/2016
         rh.node_name org_unit,rh.node_id, 
           SUM(rpt.total_participants) total_nbr_pax, 
           SUM(DECODE (rpt.goal_level, NULL, 0, rpt.total_participants)) pax_sel_goal, 
           SUM(rpt.nbr_goal_achieved) nbr_pax_achieving, 
           NVL(SUM(rpt.calculated_payout), 0) team_points,
           promo.promotion_name,
           promo.promotion_id,--06/02/2014 Bug # 53480
           rh.path,           
           NVL (override.manager_points, 0) manager_points
         FROM rpt_hierarchy rh, 
           promo_goalquest promoGoal, 
           promotion promo, 
           user_node un, 
           (SELECT mgr_user_id, 
             rpt.mgr_last_name 
             || ',' 
             || rpt.mgr_first_name AS manager_name, 
             rpt.promotion_id, 
             SUM (override_amount) manager_points 
           FROM rpt_goal_manager_override rpt, 
             promotion promo 
           WHERE rpt.promotion_id = promo.promotion_id            
           AND ( ( p_in_promotion_Id IS NULL) 
           OR ( p_in_promotion_Id    IS NOT NULL 
           AND rpt.promotion_id  IN 
             (SELECT * FROM TABLE ( get_array ( p_in_promotion_Id)) 
             ))) 
           AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
           GROUP BY rpt.mgr_last_name, 
             rpt.mgr_first_name, 
             mgr_user_id, 
             rpt.promotion_id 
           ) override, 
           rpt_goal_selection_summary rpt,  
           goalquest_goallevel gl      
         WHERE rpt.goal_level       = gl.goallevel_id (+)  
         AND rpt.detail_node_id     = rh.node_id 
         AND rpt.promotion_id       = promoGoal.promotion_id 
         AND promogoal.promotion_id = promo.promotion_id 
         AND rpt.detail_node_id    IN 
          (SELECT child_node_id 
           FROM rpt_hierarchy_rollup 
           WHERE node_id = parentNodeId 
           )    
         AND rpt.record_type LIKE '%node%'  
         AND ( rpt.promotion_id IN 
           (SELECT               * 
           FROM TABLE ( CAST ( get_array_varchar ( p_in_promotion_Id) AS ARRAY_VARCHAR)) 
           ) 
         OR p_in_promotion_Id          IS NULL) 
         AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
         AND rh.node_id             = un.node_id 
         AND un.user_id             = override.mgr_user_id 
         AND promo.promotion_id     = override.promotion_id 
         AND un.role                = 'own' 
         AND un.is_primary = 1                  --02/15/2016
         GROUP BY rh.node_name, rh.node_id,promo.promotion_name,rh.path,manager_points,promo.promotion_id, --06/02/2014 Bug # 53480
         mgr_user_id  --02/17/2016
         ) gs, user_node un,application_user au,user_address uea,country c,rpt_characteristic rch,participant p,vw_curr_pax_employer pe       
         WHERE
         gs.node_id = un.node_id
         AND gs.mgr_user_id = un.user_id  --02/17/2016
         AND un.role ='own'
         AND un.is_primary = 1                  --02/15/2016
         AND un.user_id = au .user_id
         AND au.user_id = uea.user_id(+)
         AND uea.is_primary = 1
         AND uea.country_id = c.country_id
         AND au.user_id      = rch.user_nt_id(+)
         AND rch.characteristic_type(+) = 'USER' -- 09/12/2014 Bug 56461 
         AND au.user_id = p.user_id
         AND p.user_id = pe.user_id(+)         
    ORDER BY 
--    gs.promotion_name asc  --12/18/2014
      last_name asc   --12/18/2014    
 )ex --09/12/2014 Bug 56461   added alias name
 );
 
-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019  
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);
  
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_GQ_MGR_ACHIEVE_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_promo_status||': '||'p_in_promo_status'|| --07/16/2014 Bug # 54917
        locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_GQ_MGR_ACHIEVE_EXTRACT;

PROCEDURE PRC_CP_MGR_ACHIEVE_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_promo_status IN VARCHAR2,
     locale IN VARCHAR2,
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 09/03/2013  Initial Version
                  04/01/2014  Added temp_table_session to fetch data from CM to avoid performance issues.
-- Swati          06/02/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated     
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception 
-- nagarajs       09/10/2014 Bug #56465 fix                    
--Suresh J        09/15/2014 Bug Fix #56557 - Extract is not matching with Summary and Chart 
--nagarajs        09/16/2014 Bug Fix #56381 - "% of Goal Selecting participants achieving" not matching with Summary
--Suresh J        09/18/2014  Bug #56666  - Department, Job code name translation issue
--Suresh J        09/23/2014  Bug #56839  - Manager Payout per achiever column value displayed more then 2 digits 
--Suresh J        09/29/2014  Bug #57015  -  In Asynchronous Challengepoint Manager Achievement report extract is displaying blank
--Suresh J        10/17/2014  Bug 57497  - Summary and extract is not matching.  
--nagarajs        02/15/2016  Bug 65751,65750 fixes
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--Gorantla        03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

-- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=locale;
    
BEGIN

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key = 'COUNTRY_NAME' and locale = p_in_locale --04/01/2014
UNION --06/02/2014 Bug # 53480
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                        WHERE upper(promotion_type) = upper('challengepoint')
                    )
AND locale = p_in_locale
UNION   --09/18/2014 
SELECT asset_code,cms_name,cms_code
FROM vw_cms_code_value E
WHERE asset_code in ('picklist.department.type.items','picklist.participantstatus.items') 
and e.locale=p_in_locale ;

    

   
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
        UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||user_name||c2_delimiter||c_delimiter||
         c2_delimiter||status||c2_delimiter||c_delimiter||         
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014       
          --c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||         
         --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p WHERE p.promotion_id = t.promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480 ----09/10/2014 Bug #56465 added alias
         c2_delimiter||total_pax||c2_delimiter||c_delimiter||  
         c2_delimiter||total_pax_goal_selected||c2_delimiter||c_delimiter||
         c2_delimiter||total_pax_achieved||c2_delimiter||c_delimiter||
         c2_delimiter||percent_sel_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||percent_tot_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||manage_override_percentage||c2_delimiter||c_delimiter||         
         c2_delimiter||total_points||c2_delimiter||c_delimiter||
         c2_delimiter||managr_payout_per_achiever||c2_delimiter||c_delimiter||
         c2_delimiter||total_mgr_points||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT
         au.first_name,
         au.middle_name,
         au.last_name,
         au.user_name,
--         p.status, --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and cms_code= p.status) AS status,   --09/18/2014
         c.cm_asset_code,
         c.name_cm_key,
--         pe.department_type department,  --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= pe.department_type) AS department,  --09/18/2014
         gs.promotion_name,  
         gs.promotion_id,
         gs.total_nbr_pax TOTAL_PAX,
         gs.pax_sel_goal TOTAL_PAX_GOAL_SELECTED, 
         gs.nbr_pax_achieving TOTAL_PAX_ACHIEVED, 
         --ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.pax_sel_goal     /gs.total_nbr_pax) * 100),2) PERCENT_SEL_PAX_ACHIEVING,  --09/16/2014 
         ROUND(DECODE(gs.pax_sel_goal,0,0,(gs.nbr_pax_achieving/gs.pax_sel_goal) * 100),2) PERCENT_SEL_PAX_ACHIEVING,  --09/16/2014 
         ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.nbr_pax_achieving/gs.total_nbr_pax) * 100),2) PERCENT_TOT_PAX_ACHIEVING,
         ROUND(DECODE(gs.team_points,0,0,(gs.manager_points/gs.team_points) * 100),2) MANAGE_OVERRIDE_PERCENTAGE, 
         gs.team_points TOTAL_POINTS,
         DECODE(gs.nbr_pax_achieving,0,0,ROUND((gs.manager_points/gs.nbr_pax_achieving),2)) MANAGR_PAYOUT_PER_ACHIEVER,   --09/23/2014
         gs.manager_points TOTAL_MGR_POINTS,
         (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
         (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
       FROM 
         (         --09/15/2014
         SELECT 
         rh.node_name org_unit,rh.node_id, 
           SUM(rpt.total_participants) total_nbr_pax, 
           SUM(DECODE (rpt.level_id, NULL, 0, rpt.total_participants)) pax_sel_goal, 
           SUM(rpt.nbr_challengepoint_achieved) nbr_pax_achieving, 
           NVL(SUM(rpt.calculated_payout), 0) team_points,
           promo.promotion_name,
           promo.promotion_id,
           rh.path,           
           NVL (override.manager_points, 0) manager_points
         FROM rpt_hierarchy rh, 
           promo_goalquest promoGoal, 
           promotion promo, 
           user_node un, 
           (SELECT mgr_user_id, 
             rpt.mgr_last_name 
             || ',' 
             || rpt.mgr_first_name AS manager_name, 
             rpt.promotion_id, 
             SUM (override_amount) manager_points 
           FROM rpt_cp_manager_override rpt, 
             promotion promo 
           WHERE rpt.promotion_id = promo.promotion_id            
           AND ( ( p_in_promotion_Id IS NULL) 
           OR ( p_in_promotion_Id    IS NOT NULL 
           AND rpt.promotion_id  IN 
             (SELECT * FROM TABLE ( get_array ( p_in_promotion_Id)) 
             ))) 
           AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
           GROUP BY rpt.mgr_last_name, 
             rpt.mgr_first_name, 
             mgr_user_id, 
             rpt.promotion_id 
           ) override, 
           rpt_cp_selection_summary rpt,  
           goalquest_goallevel gl      
         WHERE rpt.level_id       = gl.goallevel_id (+)  
         AND rpt.detail_node_id     = rh.node_id 
         AND rpt.promotion_id       = promoGoal.promotion_id 
         AND promogoal.promotion_id = promo.promotion_id 
         AND rpt.detail_node_id    IN 
          (SELECT child_node_id 
           FROM rpt_hierarchy_rollup 
           WHERE node_id = parentNodeId 
           )    
         AND rpt.record_type LIKE '%node%'  
         AND ( rpt.promotion_id IN 
           (SELECT               * 
           FROM TABLE ( CAST ( get_array_varchar ( p_in_promotion_Id) AS ARRAY_VARCHAR)) 
           ) 
         OR p_in_promotion_Id          IS NULL) 
         AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
         AND rh.node_id             = un.node_id 
         AND un.user_id             = override.mgr_user_id 
         AND promo.promotion_id     = override.promotion_id 
         AND un.role                = 'own' 
         AND un.is_primary = 1                  --02/15/2016
         GROUP BY rh.node_name, rh.node_id,promo.promotion_name,rh.path,manager_points,promo.promotion_id 
         ) gs, user_node un,application_user au,user_address uea,country c,rpt_characteristic rch,participant p,vw_curr_pax_employer pe       
         WHERE
         gs.node_id = un.node_id
         AND un.role ='own'
         AND un.is_primary = 1                  --02/15/2016
         AND un.user_id = au .user_id
         AND au.user_id = uea.user_id(+)
         AND uea.is_primary = 1
         AND uea.country_id = c.country_id
         AND au.user_id      = rch.user_nt_id(+)
         AND rch.characteristic_type(+) = 'USER'    --10/17/2014         
         AND au.user_id = p.user_id
         AND p.user_id = pe.user_id(+)         
    ORDER BY last_name asc   ) t --09/10/2014 Bug #56465  --12/18/2014
 );
p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
        UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||user_name||c2_delimiter||c_delimiter||
         c2_delimiter||status||c2_delimiter||c_delimiter||         
--         c2_delimiter||fnc_cms_asset_code_val_extr (cm_asset_code,
--                                       name_cm_key,
--                                       p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(SELECT cms_name FROM temp_table_session WHERE asset_code=cm_asset_code)||c2_delimiter||c_delimiter|| --04/01/2014       
          --c2_delimiter||job_position||c2_delimiter||c_delimiter||
         c2_delimiter||department||c2_delimiter||c_delimiter||         
         --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p WHERE p.promotion_id = t.promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480 ----09/10/2014 Bug #56465 added alias
         c2_delimiter||total_pax||c2_delimiter||c_delimiter||  
         c2_delimiter||total_pax_goal_selected||c2_delimiter||c_delimiter||
         c2_delimiter||total_pax_achieved||c2_delimiter||c_delimiter||
         c2_delimiter||percent_sel_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||percent_tot_pax_achieving||c2_delimiter||c_delimiter||
         c2_delimiter||manage_override_percentage||c2_delimiter||c_delimiter||         
         c2_delimiter||total_points||c2_delimiter||c_delimiter||
         c2_delimiter||managr_payout_per_achiever||c2_delimiter||c_delimiter||
         c2_delimiter||total_mgr_points||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value1||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value2||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value3||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value4||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value5||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value6||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value7||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value8||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value9||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value10||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value11||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value12||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value13||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value14||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value15||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value16||c2_delimiter||c_delimiter||  --03/03/2016 Start
         c2_delimiter||characteristic_value17||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value18||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value19||c2_delimiter||c_delimiter||
         c2_delimiter||characteristic_value20||c2_delimiter                 --03/03/2016 End
    FROM 
    (SELECT
         au.first_name,
         au.middle_name,
         au.last_name,
         au.user_name,
--         p.status, --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.participantstatus.items' and cms_code= p.status) AS status,   --09/18/2014
         c.cm_asset_code,
         c.name_cm_key,
--         pe.department_type department,  --09/18/2014
        (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= pe.department_type) AS department,  --09/18/2014
         gs.promotion_name,  
         gs.promotion_id,
         gs.total_nbr_pax TOTAL_PAX,
         gs.pax_sel_goal TOTAL_PAX_GOAL_SELECTED, 
         gs.nbr_pax_achieving TOTAL_PAX_ACHIEVED, 
         --ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.pax_sel_goal     /gs.total_nbr_pax) * 100),2) PERCENT_SEL_PAX_ACHIEVING,  --09/16/2014 
         ROUND(DECODE(gs.pax_sel_goal,0,0,(gs.nbr_pax_achieving/gs.pax_sel_goal) * 100),2) PERCENT_SEL_PAX_ACHIEVING,  --09/16/2014 
         ROUND(DECODE(gs.total_nbr_pax,0,0,(gs.nbr_pax_achieving/gs.total_nbr_pax) * 100),2) PERCENT_TOT_PAX_ACHIEVING,
         ROUND(DECODE(gs.team_points,0,0,(gs.manager_points/gs.team_points) * 100),2) MANAGE_OVERRIDE_PERCENTAGE, 
         gs.team_points TOTAL_POINTS,
         DECODE(gs.nbr_pax_achieving,0,0,ROUND((gs.manager_points/gs.nbr_pax_achieving),2)) MANAGR_PAYOUT_PER_ACHIEVER,   --09/23/2014
         gs.manager_points TOTAL_MGR_POINTS,
         (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS characteristic_value1,
         (select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS characteristic_value2,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS characteristic_value3,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS characteristic_value4,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS characteristic_value5,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS characteristic_value6,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS characteristic_value7,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS characteristic_value8,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS characteristic_value9,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS characteristic_value10,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS characteristic_value11,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS characteristic_value12,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS characteristic_value13,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS characteristic_value14,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS characteristic_value15,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as characteristic_value16,     --03/03/2016 Start
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as characteristic_value17,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as characteristic_value18,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as characteristic_value19,
         (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as characteristic_value20     --03/03/2016 End                       
       FROM 
         (         --09/15/2014
         SELECT 
         rh.node_name org_unit,rh.node_id, 
           SUM(rpt.total_participants) total_nbr_pax, 
           SUM(DECODE (rpt.level_id, NULL, 0, rpt.total_participants)) pax_sel_goal, 
           SUM(rpt.nbr_challengepoint_achieved) nbr_pax_achieving, 
           NVL(SUM(rpt.calculated_payout), 0) team_points,
           promo.promotion_name,
           promo.promotion_id,
           rh.path,           
           NVL (override.manager_points, 0) manager_points
         FROM rpt_hierarchy rh, 
           promo_goalquest promoGoal, 
           promotion promo, 
           user_node un, 
           (SELECT mgr_user_id, 
             rpt.mgr_last_name 
             || ',' 
             || rpt.mgr_first_name AS manager_name, 
             rpt.promotion_id, 
             SUM (override_amount) manager_points 
           FROM rpt_cp_manager_override rpt, 
             promotion promo 
           WHERE rpt.promotion_id = promo.promotion_id            
           AND ( ( p_in_promotion_Id IS NULL) 
           OR ( p_in_promotion_Id    IS NOT NULL 
           AND rpt.promotion_id  IN 
             (SELECT * FROM TABLE ( get_array ( p_in_promotion_Id)) 
             ))) 
           AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
           GROUP BY rpt.mgr_last_name, 
             rpt.mgr_first_name, 
             mgr_user_id, 
             rpt.promotion_id 
           ) override, 
           rpt_cp_selection_summary rpt,  
           goalquest_goallevel gl      
         WHERE rpt.level_id       = gl.goallevel_id (+)  
         AND rpt.detail_node_id     = rh.node_id 
         AND rpt.promotion_id       = promoGoal.promotion_id 
         AND promogoal.promotion_id = promo.promotion_id 
         AND rpt.detail_node_id    IN 
          (SELECT child_node_id 
           FROM rpt_hierarchy_rollup 
           WHERE node_id = parentNodeId 
           )    
         AND rpt.record_type LIKE '%node%'  
         AND ( rpt.promotion_id IN 
           (SELECT               * 
           FROM TABLE ( CAST ( get_array_varchar ( p_in_promotion_Id) AS ARRAY_VARCHAR)) 
           ) 
         OR p_in_promotion_Id          IS NULL) 
         AND promo.promotion_status = NVL ( p_in_promo_status, promo.promotion_status) 
         AND rh.node_id             = un.node_id 
         AND un.user_id             = override.mgr_user_id 
         AND promo.promotion_id     = override.promotion_id 
         AND un.role                = 'own' 
         AND un.is_primary = 1                  --02/15/2016
         GROUP BY rh.node_name, rh.node_id,promo.promotion_name,rh.path,manager_points,promo.promotion_id 
         ) gs, user_node un,application_user au,user_address uea,country c,rpt_characteristic rch,participant p,vw_curr_pax_employer pe       
         WHERE
         gs.node_id = un.node_id
         AND un.role ='own'
         AND un.is_primary = 1                  --02/15/2016
         AND un.user_id = au .user_id
         AND au.user_id = uea.user_id(+)
         AND uea.is_primary = 1
         AND uea.country_id = c.country_id
         AND au.user_id      = rch.user_nt_id(+)
         AND rch.characteristic_type(+) = 'USER'    --10/17/2014         
         AND au.user_id = p.user_id
         AND p.user_id = pe.user_id(+)         
    ORDER BY last_name asc   ) t --09/10/2014 Bug #56465  --12/18/2014
 );    
-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019  
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);

  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_CP_MGR_ACHIEVE_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_promo_status||': '||'p_in_promo_status'|| --07/16/2014 Bug # 54917
        locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

END PRC_CP_MGR_ACHIEVE_EXTRACT;

PROCEDURE PRC_GQ_PROGRAM_SUMMARY_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_status IN VARCHAR2, 
     p_in_promo_status IN VARCHAR2,     
     locale IN VARCHAR2,     
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 09/03/2013  Initial Version
-- Chidamba       09/11/2013  added extract query to the cursor   
-- Swati          06/02/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated
-- nagarajs       07/16/2014  Bug# 54917 - close the file and include parms value when OTHER exception
-- Chidamba       09/12/2014  Bug# 56314 - created alias name for pivoted result and selected pvt.promotion_id
-- Swati           09/29/2014  Bug 56965 - Reports - GQ Program Summary Report - Excel Issues
                  10/01/2014  Bug 56965 - Mismatching non-achiever count
--Suresh J     10/08/2014     Bug 57309 - Fixed Goal Not Achieved to exclue pax who are not selected Goal at all         
--KrishnaDeepika  10/27/2014  Bug 57600 - In the GoalQuest Program Summary report the extract is not displaying the complete name. 
--Gorantla          03/12/2019     G6-1446  AWS - Enable Large Audience functionality.       
*******************************************************************************/

-- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
   p_in_locale VARCHAR2(10) :=locale;
   
BEGIN
DELETE temp_table_session;

INSERT INTO temp_table_session --06/02/2014 Bug # 53480
    SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                            WHERE upper(promotion_type) = upper('goalquest')
                        )
    AND locale = p_in_locale;
    
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
       UNION  ALL --01/05/2015  
        SELECT (ROWNUM+1) row_num,team_result                 --09/11/2013
          FROM (SELECT --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
--                       c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p WHERE p.promotion_id = pvt.promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480 --09/12/2014  Bug# 56314        --10/27/2014  Bug 57600 fix
                       c2_delimiter||(SELECT (SELECT cms_name FROM temp_table_session WHERE asset_code = (SELECT p.promo_name_asset_code FROM promotion p WHERE p.promotion_id = pvt.promotion_id) ) ||' '|| TO_CHAR(p.promotion_start_date, 'MM/DD/YYYY')|| ' - '|| TO_CHAR(p.promotion_end_date, 'MM/DD/YYYY') FROM promotion p WHERE p.promotion_id = pvt.promotion_id)||c2_delimiter||c_delimiter|| --10/27/2014  Bug 57600 fix           
                       c2_delimiter||SUM(NVL(achived_goal_total_pax,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
                       ELSE ROUND((SUM(NVL(achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
                       END||c2_delimiter||c_delimiter||
                       c2_delimiter||SUM(NVL(achived_goal_base,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||NVL(SUM(NVL(achived_goal_actual_result,0)),0)||c2_delimiter||c_delimiter||              
                       --c2_delimiter||DECODE(NVL(SUM(achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(achived_goal_actual_result),0)-NVL(SUM(achived_goal_base),0)) /NVL(SUM(achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter|| --09/29/2014 Bug 56965
                       c2_delimiter||DECODE ( NVL(SUM (achived_goal_actual_result), 0),0, 0,DECODE(NVL (SUM (achived_goal_base), 0),0,NVL (SUM (achived_goal_actual_result), 0), 
                                                ROUND ((((NVL (SUM (achived_goal_actual_result), 0)- NVL (SUM (achived_goal_base), 0)) * 100)
                                                        / NVL (SUM (achived_goal_base), 0)),2)))||c2_delimiter||c_delimiter||--09/29/2014 Bug 56965
                       c2_delimiter||(NVL(SUM(achived_goal_actual_result),0) - NVL(SUM(achived_goal_base),0) )||c2_delimiter||c_delimiter||       
                       c2_delimiter||SUM(NVL(non_achived_goal_total_pax,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
                       ELSE ROUND((SUM(NVL(non_achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
                       END||c2_delimiter||c_delimiter||  
                       c2_delimiter||SUM(NVL(non_achived_goal_base,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||NVL(SUM(non_achived_goal_actual_result),0)||c2_delimiter||c_delimiter||             
                       --c2_delimiter||DECODE(NVL(SUM(non_achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(non_achived_goal_actual_result),0)-NVL(SUM(NVL(non_achived_goal_base,0)),0)) /NVL(SUM(non_achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter||--09/29/2014 Bug 56965
                       c2_delimiter||DECODE ( NVL(SUM (non_achived_goal_actual_result), 0),0, 0,DECODE(NVL (SUM (non_achived_goal_base), 0),0,NVL (SUM (non_achived_goal_actual_result), 0), 
                                                ROUND ((((NVL (SUM (non_achived_goal_actual_result), 0)- NVL (SUM (non_achived_goal_base), 0)) * 100)
                                                        / NVL (SUM (non_achived_goal_base), 0)),2)))||c2_delimiter||c_delimiter||--09/29/2014 Bug 56965
                       c2_delimiter||(NVL(SUM(non_achived_goal_actual_result),0) - NVL(SUM(NVL(non_achived_goal_base,0)),0) )||c2_delimiter team_result 
                 FROM (WITH pivot_result AS(SELECT p.promotion_name,p.promotion_id,--06/02/2014 Bug # 53480
                                            COUNT (user_id) total_pax,
                                            NVL(SUM (achieved),0) goal_achieved,
                                            NVL(sum (current_value),0) actual_result, 
                                            NVL(sum (amount_to_achieve),0) goal_value,
                                            NVL(sum (base_quantity),0) base,
                                            achieved achieved--10/01/2014  Bug 56965
                                       FROM rpt_goal_selection_detail rpt,                     
                                            promotion p, 
                                            promo_goalquest promoGoal 
                                      WHERE rpt.level_id is not null    --10/08/2014  
                                        AND rpt.promotion_id                            = promoGoal.promotion_id (+)
                                        AND rpt.promotion_id                            = p.promotion_id (+)
                                        AND NVL(rpt.node_id,0) IN 
        (SELECT child_node_id 
         FROM rpt_hierarchy_rollup 
           WHERE node_id       IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))) 
        ) 
                                        AND (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
                                             OR (p_in_promotion_id is NULL))
                                        AND rpt.user_status = NVL(p_in_status,rpt.user_status)
                                        AND NVL(p.promotion_status,' ')                    = NVL(p_in_promo_status,NVL(p.promotion_status,' '))                                          
                                      GROUP BY  achieved, --10/01/2014  Bug 56965
                                      p.promotion_name,p.promotion_id)--06/02/2014 Bug # 53480
            SELECT *     
              FROM pivot_result
             PIVOT (SUM(total_pax) as total_pax, SUM(base) as base , SUM(goal_value) as goal_value , SUM(actual_result) as actual_result, 
                 SUM(goal_achieved) as goal_achieved FOR achieved IN(1 as achived_goal, 0 as non_achived_goal))) pvt  --09/12/2014  Bug# 56314
         GROUP BY pvt.promotion_id,promotion_name   --01/05/2015
         ORDER BY promotion_name   --01/05/2015
         ));
p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
       UNION  ALL --01/05/2015  
        SELECT (ROWNUM+1) row_num,team_result                 --09/11/2013
          FROM (SELECT --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
--                       c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p WHERE p.promotion_id = pvt.promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480 --09/12/2014  Bug# 56314        --10/27/2014  Bug 57600 fix
                       c2_delimiter||(SELECT (SELECT cms_name FROM temp_table_session WHERE asset_code = (SELECT p.promo_name_asset_code FROM promotion p WHERE p.promotion_id = pvt.promotion_id) ) ||' '|| TO_CHAR(p.promotion_start_date, 'MM/DD/YYYY')|| ' - '|| TO_CHAR(p.promotion_end_date, 'MM/DD/YYYY') FROM promotion p WHERE p.promotion_id = pvt.promotion_id)||c2_delimiter||c_delimiter|| --10/27/2014  Bug 57600 fix           
                       c2_delimiter||SUM(NVL(achived_goal_total_pax,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
                       ELSE ROUND((SUM(NVL(achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
                       END||c2_delimiter||c_delimiter||
                       c2_delimiter||SUM(NVL(achived_goal_base,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||NVL(SUM(NVL(achived_goal_actual_result,0)),0)||c2_delimiter||c_delimiter||              
                       --c2_delimiter||DECODE(NVL(SUM(achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(achived_goal_actual_result),0)-NVL(SUM(achived_goal_base),0)) /NVL(SUM(achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter|| --09/29/2014 Bug 56965
                       c2_delimiter||DECODE ( NVL(SUM (achived_goal_actual_result), 0),0, 0,DECODE(NVL (SUM (achived_goal_base), 0),0,NVL (SUM (achived_goal_actual_result), 0), 
                                                ROUND ((((NVL (SUM (achived_goal_actual_result), 0)- NVL (SUM (achived_goal_base), 0)) * 100)
                                                        / NVL (SUM (achived_goal_base), 0)),2)))||c2_delimiter||c_delimiter||--09/29/2014 Bug 56965
                       c2_delimiter||(NVL(SUM(achived_goal_actual_result),0) - NVL(SUM(achived_goal_base),0) )||c2_delimiter||c_delimiter||       
                       c2_delimiter||SUM(NVL(non_achived_goal_total_pax,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
                       ELSE ROUND((SUM(NVL(non_achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
                       END||c2_delimiter||c_delimiter||  
                       c2_delimiter||SUM(NVL(non_achived_goal_base,0))||c2_delimiter||c_delimiter||
                       c2_delimiter||NVL(SUM(non_achived_goal_actual_result),0)||c2_delimiter||c_delimiter||             
                       --c2_delimiter||DECODE(NVL(SUM(non_achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(non_achived_goal_actual_result),0)-NVL(SUM(NVL(non_achived_goal_base,0)),0)) /NVL(SUM(non_achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter||--09/29/2014 Bug 56965
                       c2_delimiter||DECODE ( NVL(SUM (non_achived_goal_actual_result), 0),0, 0,DECODE(NVL (SUM (non_achived_goal_base), 0),0,NVL (SUM (non_achived_goal_actual_result), 0), 
                                                ROUND ((((NVL (SUM (non_achived_goal_actual_result), 0)- NVL (SUM (non_achived_goal_base), 0)) * 100)
                                                        / NVL (SUM (non_achived_goal_base), 0)),2)))||c2_delimiter||c_delimiter||--09/29/2014 Bug 56965
                       c2_delimiter||(NVL(SUM(non_achived_goal_actual_result),0) - NVL(SUM(NVL(non_achived_goal_base,0)),0) )||c2_delimiter team_result 
                 FROM (WITH pivot_result AS(SELECT p.promotion_name,p.promotion_id,--06/02/2014 Bug # 53480
                                            COUNT (user_id) total_pax,
                                            NVL(SUM (achieved),0) goal_achieved,
                                            NVL(sum (current_value),0) actual_result, 
                                            NVL(sum (amount_to_achieve),0) goal_value,
                                            NVL(sum (base_quantity),0) base,
                                            achieved achieved--10/01/2014  Bug 56965
                                       FROM rpt_goal_selection_detail rpt,                     
                                            promotion p, 
                                            promo_goalquest promoGoal 
                                      WHERE rpt.level_id is not null    --10/08/2014  
                                        AND rpt.promotion_id                            = promoGoal.promotion_id (+)
                                        AND rpt.promotion_id                            = p.promotion_id (+)
                                        AND NVL(rpt.node_id,0) IN 
        (SELECT child_node_id 
         FROM rpt_hierarchy_rollup 
           WHERE node_id       IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))) 
        ) 
                                        AND (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
                                             OR (p_in_promotion_id is NULL))
                                        AND rpt.user_status = NVL(p_in_status,rpt.user_status)
                                        AND NVL(p.promotion_status,' ')                    = NVL(p_in_promo_status,NVL(p.promotion_status,' '))                                          
                                      GROUP BY  achieved, --10/01/2014  Bug 56965
                                      p.promotion_name,p.promotion_id)--06/02/2014 Bug # 53480
            SELECT *     
              FROM pivot_result
             PIVOT (SUM(total_pax) as total_pax, SUM(base) as base , SUM(goal_value) as goal_value , SUM(actual_result) as actual_result, 
                 SUM(goal_achieved) as goal_achieved FOR achieved IN(1 as achived_goal, 0 as non_achived_goal))) pvt  --09/12/2014  Bug# 56314
         GROUP BY pvt.promotion_id,promotion_name   --01/05/2015
         ORDER BY promotion_name   --01/05/2015
         ));
-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019  
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);

  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_GQ_PROGRAM_SUMMARY_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_status ||': '||'p_in_status '|| --07/16/2014 Bug # 54917
        p_in_promo_status||': '||'p_in_promo_status'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

END PRC_GQ_PROGRAM_SUMMARY_EXTRACT;
   
     PROCEDURE PRC_CP_PROGRAM_SUMMARY_EXTRACT
   ( parentNodeId      IN VARCHAR2,
     p_in_promotion_Id IN VARCHAR2,
     p_in_status IN VARCHAR2,  
     p_in_promo_status IN VARCHAR2,    
     locale IN VARCHAR2,     
     p_file_name IN VARCHAR2,
     p_header    IN VARCHAR2,
     p_out_return_code  OUT varchar2,
     p_out_result_set   OUT sys_refcursor) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Goalquest pax achievement Extract'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 09/03/2013  Initial Version  
-- Chidamba       10/04/2013  Fix Defect #4643 mismatch in columns
                              % of pax achieved
                              Participants not achieving CP
                              % of participants not achieving CP  
-- Swati          06/02/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated  
-- nagarajs       07/16/2014  Bug # 54917 - close the file and include parms value when OTHER exception
-- Chidamba       09/12/2014  Bug#56430 - created alias name for pivoted result and selected pvt.promotion_id   
--Suresh J       09/29/2014  Bug#56980 --  Reports - CP Program Summary Report - Excel Issues
--Gorantla       03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

-- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=locale;
    
BEGIN

DELETE temp_table_session;

INSERT INTO temp_table_session --06/02/2014 Bug # 53480
    SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                            WHERE upper(promotion_type) = upper('challengepoint')
                        )
    AND locale = p_in_locale;
      
DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
           UNION ALL --01/05/2015   
        SELECT (ROWNUM+1) row_num,team_result                 --09/11/2013
          FROM (SELECT --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
               c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p WHERE p.promotion_id = pvt.promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480 --09/12/2014  Bug#56430 
               c2_delimiter||SUM(NVL(achived_goal_total_pax,0))||c2_delimiter||c_delimiter||
               c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
               ELSE ROUND((SUM(NVL(achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
               END||c2_delimiter||c_delimiter||
               c2_delimiter||SUM(NVL(achived_goal_base,0))||c2_delimiter||c_delimiter||
               c2_delimiter||NVL(SUM(NVL(achived_goal_actual_result,0)),0)||c2_delimiter||c_delimiter||              
--               c2_delimiter||DECODE(NVL(SUM(achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(achived_goal_actual_result),0)-NVL(SUM(achived_goal_base),0)) /NVL(SUM(achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter||  --09/29/2014
               c2_delimiter||DECODE(NVL(SUM(achived_goal_base),0),0 ,NVL(SUM(achived_goal_actual_result),0) ,ROUND(((NVL(SUM(achived_goal_actual_result),0)-NVL(SUM(achived_goal_base),0))* 100)/NVL(SUM(achived_goal_base),0),2))||c2_delimiter||c_delimiter||  --09/29/2014
               c2_delimiter||(NVL(SUM(achived_goal_actual_result),0) - NVL(SUM(achived_goal_base),0) )||c2_delimiter||c_delimiter||       
               c2_delimiter||SUM(NVL(non_achived_goal_goal_achieved,0))||c2_delimiter||c_delimiter||
               c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
               ELSE ROUND((SUM(NVL(non_achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
               END||c2_delimiter||c_delimiter||               
               c2_delimiter||SUM(NVL(non_achived_goal_base,0))||c2_delimiter||c_delimiter||
               c2_delimiter||NVL(SUM(non_achived_goal_actual_result),0)||c2_delimiter||c_delimiter||             
--               c2_delimiter||DECODE(NVL(SUM(non_achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(non_achived_goal_actual_result),0)-NVL(SUM(NVL(non_achived_goal_base,0)),0)) /NVL(SUM(non_achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter||    --09/29/2014
               c2_delimiter||DECODE(NVL(SUM(non_achived_goal_base),0),0 ,NVL(SUM(non_achived_goal_actual_result),0) ,ROUND(((NVL(SUM(non_achived_goal_actual_result),0)-NVL(SUM(non_achived_goal_base),0))* 100)/NVL(SUM(non_achived_goal_base),0),2))||c2_delimiter||c_delimiter||  --09/29/2014
               c2_delimiter||(NVL(SUM(non_achived_goal_actual_result),0) - NVL(SUM(NVL(non_achived_goal_base,0)),0) )||c2_delimiter team_result
          FROM (WITH pivot_result AS(SELECT p.promotion_name,p.promotion_id, --06/02/2014 Bug # 53480
                                            SUM (decode(achieved,0,1,1,1)) total_pax,               --10/04/2013
                                            NVL(SUM (decode(achieved,0,1,1,1)),0) goal_achieved,    --10/04/2013
                                            NVL(sum (current_value),0) actual_result, 
                                            NVL(sum (amount_to_achieve),0) goal_value,
                                            NVL(sum (base_quantity),0) base,
                                            NVL(achieved,0) achieved
                                       FROM rpt_cp_selection_detail rpt,                     
                                            promotion p, 
                                            promo_challengepoint promoGoal 
                                      WHERE rpt.promotion_id                            = promoGoal.promotion_id (+)
                                        AND rpt.promotion_id                            = p.promotion_id (+)
                                        AND NVL(rpt.node_id,0) IN 
        (SELECT child_node_id 
         FROM rpt_hierarchy_rollup 
           WHERE node_id       IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))) 
        ) 
                                        AND (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
                                             OR (p_in_promotion_id is NULL))
                                         AND rpt.user_status = NVL(p_in_status,rpt.user_status)
                                        AND NVL(p.promotion_status,' ')                    = NVL(p_in_promo_status,NVL(p.promotion_status,' '))                                        
                                      GROUP BY  NVL(achieved,0),p.promotion_name,p.promotion_id) --06/02/2014 Bug # 53480
        SELECT *      
          FROM pivot_result 
          PIVOT (SUM(total_pax) as total_pax, SUM(base) as base , SUM(goal_value) as goal_value , SUM(actual_result) as actual_result, 
                 SUM(goal_achieved) as goal_achieved FOR achieved IN(1 as achived_goal, 0 as non_achived_goal))
                 ) pvt    --09/12/2014  Bug#56430 added alias "pvt"  
        GROUP BY promotion_id,promotion_name  --01/05/2015 
        ORDER BY promotion_name  --01/05/2015        
         ) 
         );  
p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
  SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
           UNION ALL --01/05/2015   
        SELECT (ROWNUM+1) row_num,team_result                 --09/11/2013
          FROM (SELECT --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
               c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT p.promo_name_asset_code from promotion p WHERE p.promotion_id = pvt.promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480 --09/12/2014  Bug#56430 
               c2_delimiter||SUM(NVL(achived_goal_total_pax,0))||c2_delimiter||c_delimiter||
               c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
               ELSE ROUND((SUM(NVL(achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
               END||c2_delimiter||c_delimiter||
               c2_delimiter||SUM(NVL(achived_goal_base,0))||c2_delimiter||c_delimiter||
               c2_delimiter||NVL(SUM(NVL(achived_goal_actual_result,0)),0)||c2_delimiter||c_delimiter||              
--               c2_delimiter||DECODE(NVL(SUM(achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(achived_goal_actual_result),0)-NVL(SUM(achived_goal_base),0)) /NVL(SUM(achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter||  --09/29/2014
               c2_delimiter||DECODE(NVL(SUM(achived_goal_base),0),0 ,NVL(SUM(achived_goal_actual_result),0) ,ROUND(((NVL(SUM(achived_goal_actual_result),0)-NVL(SUM(achived_goal_base),0))* 100)/NVL(SUM(achived_goal_base),0),2))||c2_delimiter||c_delimiter||  --09/29/2014
               c2_delimiter||(NVL(SUM(achived_goal_actual_result),0) - NVL(SUM(achived_goal_base),0) )||c2_delimiter||c_delimiter||       
               c2_delimiter||SUM(NVL(non_achived_goal_goal_achieved,0))||c2_delimiter||c_delimiter||
               c2_delimiter||CASE WHEN SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0)) = 0 THEN 0
               ELSE ROUND((SUM(NVL(non_achived_goal_total_pax,0))/(SUM(NVL(achived_goal_total_pax,0))+SUM(NVL(non_achived_goal_total_pax,0))))*100,2)
               END||c2_delimiter||c_delimiter||               
               c2_delimiter||SUM(NVL(non_achived_goal_base,0))||c2_delimiter||c_delimiter||
               c2_delimiter||NVL(SUM(non_achived_goal_actual_result),0)||c2_delimiter||c_delimiter||             
--               c2_delimiter||DECODE(NVL(SUM(non_achived_goal_actual_result),0),0 ,0 ,ROUND((((NVL(SUM(non_achived_goal_actual_result),0)-NVL(SUM(NVL(non_achived_goal_base,0)),0)) /NVL(SUM(non_achived_goal_actual_result),0)) * 100),2))||c2_delimiter||c_delimiter||    --09/29/2014
               c2_delimiter||DECODE(NVL(SUM(non_achived_goal_base),0),0 ,NVL(SUM(non_achived_goal_actual_result),0) ,ROUND(((NVL(SUM(non_achived_goal_actual_result),0)-NVL(SUM(non_achived_goal_base),0))* 100)/NVL(SUM(non_achived_goal_base),0),2))||c2_delimiter||c_delimiter||  --09/29/2014
               c2_delimiter||(NVL(SUM(non_achived_goal_actual_result),0) - NVL(SUM(NVL(non_achived_goal_base,0)),0) )||c2_delimiter team_result
          FROM (WITH pivot_result AS(SELECT p.promotion_name,p.promotion_id, --06/02/2014 Bug # 53480
                                            SUM (decode(achieved,0,1,1,1)) total_pax,               --10/04/2013
                                            NVL(SUM (decode(achieved,0,1,1,1)),0) goal_achieved,    --10/04/2013
                                            NVL(sum (current_value),0) actual_result, 
                                            NVL(sum (amount_to_achieve),0) goal_value,
                                            NVL(sum (base_quantity),0) base,
                                            NVL(achieved,0) achieved
                                       FROM rpt_cp_selection_detail rpt,                     
                                            promotion p, 
                                            promo_challengepoint promoGoal 
                                      WHERE rpt.promotion_id                            = promoGoal.promotion_id (+)
                                        AND rpt.promotion_id                            = p.promotion_id (+)
                                        AND NVL(rpt.node_id,0) IN 
        (SELECT child_node_id 
         FROM rpt_hierarchy_rollup 
           WHERE node_id       IN (SELECT *
                                 FROM TABLE (
                                         get_array_varchar (
                                           parentNodeId))) 
        ) 
                                        AND (p.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_id)))
                                             OR (p_in_promotion_id is NULL))
                                         AND rpt.user_status = NVL(p_in_status,rpt.user_status)
                                        AND NVL(p.promotion_status,' ')                    = NVL(p_in_promo_status,NVL(p.promotion_status,' '))                                        
                                      GROUP BY  NVL(achieved,0),p.promotion_name,p.promotion_id) --06/02/2014 Bug # 53480
        SELECT *      
          FROM pivot_result 
          PIVOT (SUM(total_pax) as total_pax, SUM(base) as base , SUM(goal_value) as goal_value , SUM(actual_result) as actual_result, 
                 SUM(goal_achieved) as goal_achieved FOR achieved IN(1 as achived_goal, 0 as non_achived_goal))
                 ) pvt    --09/12/2014  Bug#56430 added alias "pvt"  
        GROUP BY promotion_id,promotion_name  --01/05/2015 
        ORDER BY promotion_name  --01/05/2015        
         ) 
         );
 -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);
 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;

EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_CP_PROGRAM_SUMMARY_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_promotion_Id||': '||'p_in_promotion_Id'||p_in_status||': '||'p_in_status'|| --07/16/2014 Bug # 54917
        p_in_promo_status ||': '||'p_in_promo_status '||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

END PRC_CP_PROGRAM_SUMMARY_EXTRACT;

PROCEDURE prc_claim_report_extract
 (p_in_promotionId      IN  VARCHAR2,
  p_in_promotion_status IN  VARCHAR2,  
  p_in_claim_status     IN  VARCHAR2,
  p_in_submitted        IN  VARCHAR,     -- (Show All/Have/Have Not)
  p_in_fromdate         IN  VARCHAR,
  p_in_todate           IN  VARCHAR,
  p_in_organization_id  IN  VARCHAR2,
  p_in_filterpromo      IN  VARCHAR,
  p_in_languageCode     IN  VARCHAR,
  p_in_country_id       IN  NUMBER,
  p_in_participant_status IN VARCHAR2,
  p_in_job_position     IN     VARCHAR2,
  p_in_department       IN     VARCHAR2,
  p_file_name             IN     VARCHAR2,
  p_header                IN     VARCHAR2,
  p_out_return_code       OUT NUMBER,
  p_out_result_set       OUT sys_refcursor
) IS
 /*
    Purpost : Created Dynamic product columns with respect to Orgnization.  
      
    Chidamba             10/15/2012       Initial Creation
    Ravi Dhanekula      01/13/2014       Fixed the bug # 51007
    Swati                05/21/2014        Fixed the bug # 51007 - Asynchronous Report
    Swati                05/22/2014        Fixed the bug # 53542 - Claims Activity - Items Claimed Extract is not pulling any data
    nagarajs              07/16/2014        Bug # 54917 - close the file and include parms value when OTHER exception
    Ravi Dhanekula   04/23/2015    Bug # 61642  - Claims Activity - List of Participants Report - "Items Claimed" extract is throwing error
	Gorantla              03/12/2019       G6-1446  AWS - Enable Large Audience functionality.
  */
-- ref_cursor SYS_REFCURSOR;  
    l_query             long := 'select replace(h.node_name,''_'',NULL) Org_Unit ';
    file_handler        UTL_FILE.file_type;
    v_extract             varchar2(4000);
    v_file_location     VARCHAR2(1000);
    directory_error     exception;
    l_cursor              SYS_REFCURSOR;  

    p_in_locale         VARCHAR2(10) := p_in_languageCode;
    v_pattern            VARCHAR2(15);
    
    --05/21/2014 Bug # 51007
    l_theCursor         INTEGER DEFAULT dbms_sql.open_cursor;
    l_columnValue       VARCHAR2(2000);
    l_colCnt            NUMBER DEFAULT 0;    
    l_separator         VARCHAR2(10) default '';
    p_separator         VARCHAR2(2) := ',';
    l_status            INTEGER;
    l_descTbl           dbms_sql.desc_tab; 
    
BEGIN
    
    BEGIN
    SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
    EXCEPTION WHEN no_data_found THEN 
    v_pattern :='MM/DD/YYYY';
    END;
  -- Create dynamic SQL statement.  
  for x in (SELECT distinct product_name FROM rpt_claim_product order by 1)
    loop
        l_query := l_query ||
              replace(
              replace( q'|, NVL(sum(decode(product_name,$1$,product_qty)),0) $2$|',
                     '$1$',
                     dbms_assert.enquote_literal(x.product_name) ),
                     '$2$',
                     dbms_assert.simple_sql_name( '"' || SUBSTR(x.product_name,1,30) || '"' ) ); --01/14/2014
    end loop;
   
   l_query :=l_query ||'  ,'||'NVL(sum(product_qty),0)'||' Total 
                         FROM rpt_claim_detail d
                          ,rpt_claim_product p
                          ,promotion pr
                          ,rpt_hierarchy h
                    WHERE d.claim_id          = p.claim_id
                      AND h.node_id           = d.node_id
                      AND pr.promotion_id     = d.promotion_id
                      AND (('||NVL(p_in_promotionId,'NULL')||' IS NULL) OR ('||NVL(p_in_promotionId,'NULL')||' IS NOT NULL 
                                AND pr.promotion_id IN (SELECT * FROM TABLE(get_array('||NVL(p_in_promotionId,'NULL')||')))))   --multiple selections
                      AND pr.promotion_status = NVL('''||p_in_promotion_status||''',pr.promotion_status) --04/23/2015 Bug # 61642
                      AND d.claim_status      = NVL('''||p_in_claim_status||''',d.claim_status)
                      AND NVL(TRUNC(d.date_submitted),TRUNC(sysdate)) BETWEEN TO_DATE('''||p_in_fromDate||''','''||v_pattern||''') 
                                                                   AND TO_DATE('''||p_in_toDate||''','''||v_pattern||''')
                      --AND NVL(d.node_id,0)         = NVL('||NVL(to_char(p_in_organization_id),'''''')||',NVL(d.node_id,0)) 05/22/2014 bug # 53542
                      AND (('||NVL(p_in_organization_id,'NULL')||' IS NULL) OR ('||NVL(p_in_organization_id,'NULL')||' IS NOT NULL 
                            AND d.node_id IN (SELECT child_node_id 
                                                 FROM rpt_hierarchy_rollup 
                                                   WHERE node_id IN 
                                                   (SELECT * FROM TABLE(get_array('||NVL(p_in_organization_id,'NULL')||'))))))                      
                      AND d.submitter_country_id   = NVL('||NVL(to_char(p_in_country_id),'''''')||',d.submitter_country_id) 
                      AND d.submitter_job_position = NVL('||NVL(p_in_job_position,'''''')||',d.submitter_job_position)                                            
                      AND (('||NVL(p_in_department,'NULL')||' IS NULL) OR ('||NVL(p_in_department,'NULL')||' IS NOT NULL 
                                AND d.submitter_department IN (SELECT * FROM TABLE(get_array('||NVL(p_in_department,'NULL')||')))))   --multiple selections
              AND (('''||p_in_submitted||''' = ''show_all'' AND  1 = 1)
                    OR ('''||p_in_submitted||''' = ''have'' AND  1 = 1)
                OR ('''||p_in_submitted||''' = ''have_not'' AND  0 = 1))';                    
                    

IF p_file_name IS NULL THEN  
    l_query := l_query || ' GROUP BY h.node_name';
--l_query := 'SELECT ' ||p_header||
--        'FROM dual UNION ' || l_query; --Bug # 51007
             --prc_execution_log_entry('PRC_CLAIM_REPORT_EXTRACT',1,'INFO',l_query,null);  05/22/2014 bug # 53542
--             DBMS_OUTPUT.PUT_LINE(l_query);
 OPEN p_out_result_set FOR  l_query ;
 
p_out_return_code :=  '00' ; 

ELSE
    --05/21/2014 Bug # 51007
    l_query := l_query || ' GROUP BY ROLLUP(h.node_name)';
    p_out_return_code :=  '00' ;
    OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
    
    --l_query := 'SELECT p_header        
    --        FROM dual UNION ' || l_query;


    --OPEN l_cursor FOR  l_query ;
    
    prc_execution_log_entry('PRC_CLAIM_REPORT_EXTRACT',1,'INFO',SQLERRM --||l_query 05/22/2014 bug # 53542
              ,null);  

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019  
    file_handler := utl_file.fopen( v_file_location, p_file_name, 'w' ,4096);

    dbms_sql.parse(  l_theCursor,  l_query, dbms_sql.native );
    dbms_sql.describe_columns( l_theCursor, l_colCnt, l_descTbl);

    FOR i in 1 .. 255 LOOP
        BEGIN
            dbms_sql.define_column( l_theCursor, i, 
                                    l_columnValue, 2000 );
            l_colCnt := i;
        EXCEPTION
            WHEN OTHERS THEN
                IF ( SQLCODE = -1007 ) THEN EXIT;
                ELSE
                    p_out_return_code :=  '99' ;
                    prc_execution_log_entry('PRC_CLAIM_REPORT_EXTRACT',1,'INFO',SQLERRM --||l_query 05/22/2014 bug # 53542
                    ,null);  
                END IF;
        END;
    END LOOP;

    dbms_sql.define_column( l_theCursor, 1, l_columnValue, 
                            2000 );

    l_status := dbms_sql.EXECUTE(l_theCursor);
    
    for i in 1 .. l_colCnt 
        LOOP            
            utl_file.put( file_handler, l_separator || l_descTbl(i).col_name);            
            l_separator := p_separator;
        END LOOP;
    utl_file.new_line( file_handler );  
    
    LOOP
        EXIT WHEN ( dbms_sql.fetch_rows(l_theCursor) <= 0 );
        l_separator := '';          
        for i in 1 .. l_colCnt LOOP
            dbms_sql.column_value( l_theCursor, i, 
                                   l_columnValue );                
            utl_file.put( file_handler, l_separator ||  
                                    l_columnValue );
            l_separator := p_separator;
        END LOOP;
        utl_file.new_line( file_handler );        
    END LOOP;
    dbms_sql.close_cursor(l_theCursor);

    utl_file.fclose( file_handler );     

  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019	
/* 05/21/2014 commented as a part of Bug # 51007
    file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

    prc_execution_log_entry('PRC_CLAIM_REPORT_EXTRACT',1,'INFO',SQLERRM ||v_extract 
              ,null);  

    LOOP  
    fetch l_cursor into  v_extract;
    exit when l_cursor%notfound;
    UTL_FILE.put_line(file_handler, v_extract);             

    OPEN l_cursor FOR  l_query ;
    --prc_execution_log_entry('PRC_CLAIM_REPORT_EXTRACT',1,'INFO',SQLERRM ||v_extract 
    --                          ,null);  
    END LOOP;

    UTL_FILE.fclose(file_handler);*/
END IF;
 
 p_out_return_code :=  '00' ;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
           prc_execution_log_entry('PRC_CLAIM_REPORT_EXTRACT',1,'INFO',  --07/16/2014 Bug # 54917
           p_in_promotionId||': '||'p_in_promotionId'||p_in_promotion_status ||': '||'p_in_promotion_status '||p_in_claim_status||': '||'p_in_claim_status'||
            p_in_submitted||': '||'p_in_submitted'||p_in_fromdate||': '||'p_in_fromdate'||p_in_todate||': '||'p_in_todate'||
            p_in_organization_id||': '||'p_in_organization_id'||p_in_filterpromo||': '||'p_in_filterpromo'||p_in_languageCode||': '||'p_in_languageCode'||
            p_in_country_id||': '||'p_in_country_id,'||p_in_participant_status||': '||'p_in_participant_status'||p_in_job_position||': '||'p_in_job_position'||p_in_department ||': '||'p_in_department '||CHR(10)||SQLERRM
                          ,null);  
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_CLAIM_REPORT_EXTRACT;

PROCEDURE prc_throwdown_extract
 (p_in_promotionId      IN  VARCHAR2,
  p_in_promotion_status IN  VARCHAR2,    
  p_in_organization_id  IN  VARCHAR2,  
  p_in_round_number   IN   NUMBER,
  p_in_languageCode     IN  VARCHAR,  
  p_in_participant_status IN VARCHAR2,
  p_in_job_position     IN   VARCHAR2,
  p_in_department       IN   VARCHAR2,
  p_file_name IN VARCHAR2,
  p_header    IN VARCHAR2,
  p_out_return_code   OUT VARCHAR2,
  p_out_result_set   OUT sys_refcursor
) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Throwdown activity extract'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 10/24/2013  Initial Version  
                  03/31/2014  Fixed the bug # 52253
-- Swati          06/02/2014  Fixed the Bug # 53480 Recognition Reports Promotion Name Needs to be Translated 
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception                     
--Ravi Dhanekula 10/8/2014 Bug # 57322     
                       12/8/2014    Bug # 58555 Department and job_position were not translated.
--nagarajs      01/05/2016  Bug 65032 - Admin View/Throwdown Activity Report : Mismatch of values when summary table 
                            and the extracted sheet are compared after extracting.              
--nagarajs       03/03/2016   Bug 65699 - All report extracts which contains pax characteristics should show all 20 characteristics
--Gorantla        03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=p_in_languageCode;
    
   BEGIN
   
   DELETE FROM temp_table_session; --03/31/2014

INSERT INTO temp_table_session   
select asset_code,cms_value,key from VW_CMS_ASSET_VALUE where key='COUNTRY_NAME' and locale = p_in_locale
UNION --06/02/2014 Bug # 53480
SELECT asset_code,cms_value,key FROM VW_CMS_ASSET_VALUE 
WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                        WHERE upper(promotion_type) = upper('throwdown')
                    )
AND locale = p_in_locale
UNION --12/8/2014
SELECT asset_code,cms_name,cms_code
FROM vw_cms_code_value E
WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items') 
and e.locale=p_in_locale;

DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
                                           select c.characteristic_id,vw.cms_name,vw.cms_code from characteristic c,vw_cms_code_value vw where pl_name is not null 
and vw.asset_code = c.pl_name and locale = p_in_locale
UNION --Bug # 50969
select characteristic_id,characteristic_value cms_name,characteristic_value cms_code from user_characteristic where characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
select characteristic_id,cms_name,cms_code from rpt_user_characteristic
WHERE locale = p_in_locale;

IF p_file_name IS NULL THEN     

OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION ALL   --12/18/2014
       SELECT   rno,  --12/18/2014
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||         
         c2_delimiter||country||c2_delimiter||c_delimiter|| --03/31/2014
         c2_delimiter||user_status||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter||         
         c2_delimiter||node_name||c2_delimiter||c_delimiter||         
         c2_delimiter||job_position||c2_delimiter||c_delimiter||  --12/8/2014        
         c2_delimiter||department||c2_delimiter||c_delimiter||    --12/8/2014  
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480--10/8/2014 Bug # 57322
         c2_delimiter||round_number||c2_delimiter||c_delimiter||
         c2_delimiter||round_start_date||c2_delimiter||c_delimiter||
         c2_delimiter||round_end_date||c2_delimiter||c_delimiter||        
         c2_delimiter||Wins||c2_delimiter||c_delimiter|| 
         c2_delimiter||losses||c2_delimiter||c_delimiter||  --01/05/2016 
         c2_delimiter||Ties||c2_delimiter||c_delimiter||
         --c2_delimiter||losses||c2_delimiter||c_delimiter|| --01/05/2016 
         c2_delimiter||Activity||c2_delimiter||c_delimiter||
         c2_delimiter||Rank||c2_delimiter||c_delimiter||
         c2_delimiter||payout||c2_delimiter||c_delimiter||        
         c2_delimiter||Participant_Char_1||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_2||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_3||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_4||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_5||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_6||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_7||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_8||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_9||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_10||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_11||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_12||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_13||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_14||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_15||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
         c2_delimiter||participant_char_17||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_18||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_19||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_20||c2_delimiter     --03/03/2016 End  
From  --12/18/2014
(select  2 as rno,    --12/18/2014
         first_name,
         middle_name,
         last_name,
         login_id,         
         --fnc_cms_asset_code_val_extr (throw.cm_asset_code,
         --                              throw.name_cm_key,
         --                              p_in_locale),
         (select cms_name from temp_table_session where asset_code=throw.cm_asset_code) as country, --03/31/2014
         user_status,
         rh.path,         
         rh.node_name,         
      --         job_position,
--         department,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= throw.job_position) as Job_Position,  --12/8/2014        
         (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= throw.department) as Department,    --12/8/2014  
         --promotion_name,         
         (select cms_name from temp_table_session where asset_code = (SELECT promo_name_asset_code from promotion  WHERE throw.promotion_id = promotion_id)) as promotion_name, --06/02/2014 Bug # 53480--10/8/2014 Bug # 57322
         round_number,
         round_start_date,
         round_end_date,        
         Wins,  
         Ties,
         losses,
         Activity,
         Rank,
         NVL(payout,0) as payout        
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) as Participant_Char_1
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) as Participant_Char_2
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) as Participant_Char_3
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) as Participant_Char_4
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) as Participant_Char_5
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) as Participant_Char_6
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) as Participant_Char_7
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) as Participant_Char_8
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) as Participant_Char_9
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) as Participant_Char_10
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) as Participant_Char_11
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) as Participant_Char_12
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) as Participant_Char_13
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) as Participant_Char_14
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) as Participant_Char_15
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as Participant_Char_16     --03/03/2016 Start
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as Participant_Char_17
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as Participant_Char_18
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as Participant_Char_19
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as Participant_Char_20     --03/03/2016 End
    FROM 
   rpt_hierarchy rh,
(WITH pax_rank AS
(SELECT 
ts.promotion_id,ts.round_number,tsp.user_id,tsp.rank 
FROM 
throwdown_stackrank ts,
throwdown_stackrank_node tsn,
throwdown_stackrank_pax tsp
WHERE
((p_in_promotionId             IS NULL)   OR ( ts.promotion_id   IN  (SELECT * FROM TABLE(get_array_varchar(p_in_promotionId)))))
AND tsn.node_id IS NULL
AND ts.stackrank_id = tsn.stackrank_id
AND ts.is_active =1
AND tsn.stackrank_node_id = tsp.stackrank_node_id)
SELECT rpt.user_id,rpt.first_name,rpt.middle_name,rpt.last_name,rpt.login_id,c.cm_asset_code, c.name_cm_key,
rpt.user_status,rpt.node_id,rpt.node_name,rpt.job_position,rpt.department,rpt.promotion_name,rpt.promotion_id,--06/02/2014 Bug # 53480
rpt.round_number,rpt.round_start_date,rpt.round_end_date,SUM (DECODE(outcome,'win',1,0)) Wins,SUM (DECODE(outcome,'tie',1,0)) Ties,SUM (DECODE(outcome,'loss',1,0)) Losses,SUM (current_value) activity,pax_rank.RANK,SUM(payout) AS payout
  FROM rpt_throwdown_activity rpt, promotion p,
  country c,pax_rank
WHERE rpt.promotion_id = p.promotion_id
AND p.promotion_status = NVL (p_in_promotion_status,p.promotion_status)
AND rpt.user_status = NVL (p_in_participant_status,rpt.user_status)
AND rpt.round_number <= NVL(p_in_round_number,rpt.round_number)
AND NVl(rpt.job_position,'JOB') = NVL (p_in_job_position,NVL(rpt.job_position,'JOB'))
AND rpt.country_id = c.country_id
AND  ((p_in_department             IS NULL)   OR ( rpt.department            IN  (SELECT * FROM TABLE(get_array_varchar(p_in_department)))))
AND  ((p_in_promotionId             IS NULL)   OR ( p.promotion_id   IN  (SELECT * FROM TABLE(get_array_varchar(p_in_promotionId)))))
AND rpt.node_id IN (SELECT child_node_id FROM rpt_hierarchy_rollup WHERE node_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_organization_id))))
AND rpt.promotion_id = pax_rank.promotion_id(+)
AND rpt.round_number = pax_rank.round_number(+)
AND rpt.user_id = pax_rank.user_id(+) --03/31/2014
GROUP BY rpt.user_id,last_name,first_name,rpt.middle_name,rpt.login_id,c.cm_asset_code, c.name_cm_key,
rpt.user_status,rpt.node_name,rpt.job_position,rpt.department
,rpt.promotion_name,rpt.promotion_id,rpt.node_id,rpt.round_number,rpt.round_start_date,rpt.round_end_date,pax_rank.rank) throw,--06/02/2014 Bug # 53480
rpt_characteristic rch
WHERE throw.node_id = rh.node_id
AND throw.user_id = rch.user_nt_id(+) order by first_name asc));     --12/18/2014

p_out_return_code :=  '00' ;
ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION ALL   --12/18/2014
       SELECT   rno,  --12/18/2014
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||         
         c2_delimiter||country||c2_delimiter||c_delimiter|| --03/31/2014
         c2_delimiter||user_status||c2_delimiter||c_delimiter||
         c2_delimiter||path||c2_delimiter||c_delimiter||         
         c2_delimiter||node_name||c2_delimiter||c_delimiter||         
         c2_delimiter||job_position||c2_delimiter||c_delimiter||  --12/8/2014        
         c2_delimiter||department||c2_delimiter||c_delimiter||    --12/8/2014  
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480--10/8/2014 Bug # 57322
         c2_delimiter||round_number||c2_delimiter||c_delimiter||
         c2_delimiter||round_start_date||c2_delimiter||c_delimiter||
         c2_delimiter||round_end_date||c2_delimiter||c_delimiter||        
         c2_delimiter||Wins||c2_delimiter||c_delimiter|| 
         c2_delimiter||losses||c2_delimiter||c_delimiter||   --01/05/2016 
         c2_delimiter||Ties||c2_delimiter||c_delimiter||
         --c2_delimiter||losses||c2_delimiter||c_delimiter|| --01/05/2016 
         c2_delimiter||Activity||c2_delimiter||c_delimiter||
         c2_delimiter||Rank||c2_delimiter||c_delimiter||
         c2_delimiter||payout||c2_delimiter||c_delimiter||        
         c2_delimiter||Participant_Char_1||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_2||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_3||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_4||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_5||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_6||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_7||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_8||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_9||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_10||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_11||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_12||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_13||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_14||c2_delimiter||c_delimiter||
         c2_delimiter||Participant_Char_15||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_16||c2_delimiter||c_delimiter||      --03/03/2016 Start 
         c2_delimiter||participant_char_17||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_18||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_19||c2_delimiter||c_delimiter||
         c2_delimiter||participant_char_20||c2_delimiter     --03/03/2016 End 
From  --12/18/2014
(select  2 as rno,    --12/18/2014
         first_name,
         middle_name,
         last_name,
         login_id,         
         --fnc_cms_asset_code_val_extr (throw.cm_asset_code,
         --                              throw.name_cm_key,
         --                              p_in_locale),
         (select cms_name from temp_table_session where asset_code=throw.cm_asset_code) as country, --03/31/2014
         user_status,
         rh.path,         
         rh.node_name,         
      --         job_position,
--         department,
         (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= throw.job_position) as Job_Position,  --12/8/2014        
         (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= throw.department) as Department,    --12/8/2014  
         --promotion_name,         
         (select cms_name from temp_table_session where asset_code = (SELECT promo_name_asset_code from promotion  WHERE throw.promotion_id = promotion_id)) as promotion_name, --06/02/2014 Bug # 53480--10/8/2014 Bug # 57322
         round_number,
         round_start_date,
         round_end_date,        
         Wins,  
         Ties,
         losses,
         Activity,
         Rank,
         NVL(payout,0) as payout        
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) as Participant_Char_1
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) as Participant_Char_2
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) as Participant_Char_3
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) as Participant_Char_4
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) as Participant_Char_5
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) as Participant_Char_6
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) as Participant_Char_7
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) as Participant_Char_8
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) as Participant_Char_9
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) as Participant_Char_10
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) as Participant_Char_11
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) as Participant_Char_12
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) as Participant_Char_13
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) as Participant_Char_14
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) as Participant_Char_15
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id16 and cms_code=rch.characteristic_charvalue16) as Participant_Char_16     --03/03/2016 Start
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id17 and cms_code=rch.characteristic_charvalue17) as Participant_Char_17
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id18 and cms_code=rch.characteristic_charvalue18) as Participant_Char_18
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id19 and cms_code=rch.characteristic_charvalue19) as Participant_Char_19
        ,(select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id20 and cms_code=rch.characteristic_charvalue20) as Participant_Char_20     --03/03/2016 End
    FROM 
   rpt_hierarchy rh,
(WITH pax_rank AS
(SELECT 
ts.promotion_id,ts.round_number,tsp.user_id,tsp.rank 
FROM 
throwdown_stackrank ts,
throwdown_stackrank_node tsn,
throwdown_stackrank_pax tsp
WHERE
((p_in_promotionId             IS NULL)   OR ( ts.promotion_id   IN  (SELECT * FROM TABLE(get_array_varchar(p_in_promotionId)))))
AND tsn.node_id IS NULL
AND ts.stackrank_id = tsn.stackrank_id
AND ts.is_active =1
AND tsn.stackrank_node_id = tsp.stackrank_node_id)
SELECT rpt.user_id,rpt.first_name,rpt.middle_name,rpt.last_name,rpt.login_id,c.cm_asset_code, c.name_cm_key,
rpt.user_status,rpt.node_id,rpt.node_name,rpt.job_position,rpt.department,rpt.promotion_name,rpt.promotion_id,--06/02/2014 Bug # 53480
rpt.round_number,rpt.round_start_date,rpt.round_end_date,SUM (DECODE(outcome,'win',1,0)) Wins,SUM (DECODE(outcome,'tie',1,0)) Ties,SUM (DECODE(outcome,'loss',1,0)) Losses,SUM (current_value) activity,pax_rank.RANK,SUM(payout) AS payout
  FROM rpt_throwdown_activity rpt, promotion p,
  country c,pax_rank
WHERE rpt.promotion_id = p.promotion_id
AND p.promotion_status = NVL (p_in_promotion_status,p.promotion_status)
AND rpt.user_status = NVL (p_in_participant_status,rpt.user_status)
AND rpt.round_number <= NVL(p_in_round_number,rpt.round_number)
AND NVl(rpt.job_position,'JOB') = NVL (p_in_job_position,NVL(rpt.job_position,'JOB'))
AND rpt.country_id = c.country_id
AND  ((p_in_department             IS NULL)   OR ( rpt.department            IN  (SELECT * FROM TABLE(get_array_varchar(p_in_department)))))
AND  ((p_in_promotionId             IS NULL)   OR ( p.promotion_id   IN  (SELECT * FROM TABLE(get_array_varchar(p_in_promotionId)))))
AND rpt.node_id IN (SELECT child_node_id FROM rpt_hierarchy_rollup WHERE node_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_organization_id))))
AND rpt.promotion_id = pax_rank.promotion_id(+)
AND rpt.round_number = pax_rank.round_number(+)
AND rpt.user_id = pax_rank.user_id(+) --03/31/2014
GROUP BY rpt.user_id,last_name,first_name,rpt.middle_name,rpt.login_id,c.cm_asset_code, c.name_cm_key,
rpt.user_status,rpt.node_name,rpt.job_position,rpt.department
,rpt.promotion_name,rpt.promotion_id,rpt.node_id,rpt.round_number,rpt.round_start_date,rpt.round_end_date,pax_rank.rank) throw,--06/02/2014 Bug # 53480
rpt_characteristic rch
WHERE throw.node_id = rh.node_id
AND throw.user_id = rch.user_nt_id(+) order by first_name asc));     --12/18/2014

/*
SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||first_name||c2_delimiter||c_delimiter||
         c2_delimiter||middle_name||c2_delimiter||c_delimiter||
         c2_delimiter||last_name||c2_delimiter||c_delimiter||
         c2_delimiter||login_id||c2_delimiter||c_delimiter||         
         --c2_delimiter||fnc_cms_asset_code_val_extr (throw.cm_asset_code,
         --                              throw.name_cm_key,
         --                              p_in_locale)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code=throw.cm_asset_code)||c2_delimiter||c_delimiter|| --03/31/2014
         c2_delimiter||user_status||c2_delimiter||c_delimiter||
         c2_delimiter||rh.path||c2_delimiter||c_delimiter||         
         c2_delimiter||rh.node_name||c2_delimiter||c_delimiter||         
          --         c2_delimiter||job_position||c2_delimiter||c_delimiter||
--         c2_delimiter||department||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= throw.job_position)||c2_delimiter||c_delimiter||  --12/8/2014        
         c2_delimiter||(select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= throw.department)||c2_delimiter||c_delimiter||    --12/8/2014  
         --c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name from temp_table_session where asset_code = (SELECT promo_name_asset_code from promotion  WHERE throw.promotion_id = promotion_id))||c2_delimiter||c_delimiter|| --06/02/2014 Bug # 53480--10/8/2014 Bug # 57322
         c2_delimiter||round_number||c2_delimiter||c_delimiter||
         c2_delimiter||round_start_date||c2_delimiter||c_delimiter||
         c2_delimiter||round_end_date||c2_delimiter||c_delimiter||        
         c2_delimiter||Wins||c2_delimiter||c_delimiter||  
         c2_delimiter||Ties||c2_delimiter||c_delimiter||
         c2_delimiter||losses||c2_delimiter||c_delimiter||
         c2_delimiter||Activity||c2_delimiter||c_delimiter||
         c2_delimiter||Rank||c2_delimiter||c_delimiter||
         c2_delimiter||NVL(payout,0)||c2_delimiter||c_delimiter||        
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14)||c2_delimiter||c_delimiter||
         c2_delimiter||(select cms_name  from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15)||c2_delimiter
    FROM 
   rpt_hierarchy rh,
(WITH pax_rank AS
(SELECT 
ts.promotion_id,ts.round_number,tsp.user_id,tsp.rank 
FROM 
throwdown_stackrank ts,
throwdown_stackrank_node tsn,
throwdown_stackrank_pax tsp
WHERE
((p_in_promotionId             IS NULL)   OR ( ts.promotion_id   IN  (SELECT * FROM TABLE(get_array_varchar(p_in_promotionId)))))
AND tsn.node_id IS NULL
AND ts.stackrank_id = tsn.stackrank_id
AND ts.is_active =1
AND tsn.stackrank_node_id = tsp.stackrank_node_id)
SELECT rpt.user_id,rpt.first_name,rpt.middle_name,rpt.last_name,rpt.login_id,c.cm_asset_code, c.name_cm_key,
rpt.user_status,rpt.node_id,rpt.node_name,rpt.job_position,rpt.department,rpt.promotion_name,rpt.promotion_id, --06/02/2014 Bug # 53480
rpt.round_number,rpt.round_start_date,rpt.round_end_date,SUM (DECODE(outcome,'win',1,0)) Wins,SUM (DECODE(outcome,'tie',1,0)) Ties,SUM (DECODE(outcome,'loss',1,0)) Losses,SUM (current_value) activity,pax_rank.RANK,SUM(payout) AS payout
  FROM rpt_throwdown_activity rpt, promotion p,
  country c,pax_rank
WHERE rpt.promotion_id = p.promotion_id
AND p.promotion_status = NVL (p_in_promotion_status,p.promotion_status)
AND rpt.user_status = NVL (p_in_participant_status,rpt.user_status)
AND rpt.round_number <= NVL(p_in_round_number,rpt.round_number)
AND NVl(rpt.job_position,'JOB') = NVL (p_in_job_position,NVL(rpt.job_position,'JOB'))
AND rpt.country_id = c.country_id
AND  ((p_in_department             IS NULL)   OR ( rpt.department            IN  (SELECT * FROM TABLE(get_array_varchar(p_in_department)))))
AND  ((p_in_promotionId             IS NULL)   OR ( p.promotion_id   IN  (SELECT * FROM TABLE(get_array_varchar(p_in_promotionId)))))
AND rpt.node_id IN (SELECT child_node_id FROM rpt_hierarchy_rollup WHERE node_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_organization_id))))
AND rpt.promotion_id = pax_rank.promotion_id(+)
AND rpt.round_number = pax_rank.round_number(+)
AND rpt.user_id = pax_rank.user_id(+) --03/31/2014
GROUP BY rpt.user_id,last_name,first_name,rpt.middle_name,rpt.login_id,c.cm_asset_code, c.name_cm_key,
rpt.user_status,rpt.node_name,rpt.job_position,rpt.department
,rpt.promotion_name,rpt.promotion_id, --06/02/2014 Bug # 53480
rpt.node_id,rpt.round_number,rpt.round_start_date,rpt.round_end_date,pax_rank.rank) throw,
rpt_characteristic rch
WHERE throw.node_id = rh.node_id
AND throw.user_id = rch.user_nt_id(+)); 
*/

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019   
file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);

  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_THROWDOWN_EXTRACT',1,'ERROR',
         p_in_promotionId||': '||'p_in_promotionId'||p_in_promotion_status  ||': '||'p_in_promotion_status  '||p_in_organization_id||': '||'p_in_organization_id'|| --07/16/2014 Bug # 54917
        p_in_round_number||': '||'p_in_round_number'||p_in_languageCode||': '||'p_in_languageCode'||p_in_participant_status||': '||'p_in_participant_status'||
        p_in_job_position||': '||'p_in_job_position'||p_in_department ||': '||'p_in_department '||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_THROWDOWN_EXTRACT;

PROCEDURE prc_survey_openend_extract
 (p_in_organization_id      IN VARCHAR2,
  p_in_promotionId      IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name IN VARCHAR2,
  p_header    IN VARCHAR2,
  p_out_return_code   OUT VARCHAR2,
  p_out_result_set   OUT sys_refcursor
) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Survey Responses(Open Ended extract)'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- Ravi Dhanekula 12/16/2013  Initial Version  
-- Chidamba       01/03/2014  Fixed issue by adding join(rh.node_id = rpt.node_id) to handle cartition product  
--Ravi Dhanekula 05/12/2014  Added Slider responses to the open ended extract.
-- nagarajs       07/16/2014 Bug # 54917 - close the file and include parms value when OTHER exception
--Gorantla        03/12/2019     G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;  
    file_handler           UTL_FILE.file_type;
    v_extract varchar2(4000);
    v_file_location VARCHAR2(1000);
    directory_error exception;
    l_cursor  SYS_REFCURSOR;  
     
    p_in_locale VARCHAR2(10) :=p_in_languageCode;
     
   BEGIN
   
DELETE temp_table_session;

INSERT INTO temp_table_session
                                           select asset_code,cms_value,key from vw_cms_asset_value where key='QUESTION_NAME' and locale = p_in_locale;

IF p_file_name IS NULL THEN     
OPEN p_out_result_set FOR   
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||node_name||c2_delimiter||c_delimiter||
         c2_delimiter||Question_Asked||c2_delimiter||c_delimiter||
         c2_delimiter||Response||c2_delimiter
    FROM 
    (SELECT rh.node_name,
    NVL(tts.cms_name,rpt.survey_question) AS Question_Asked,
    rpt.open_end_response response
    FROM
   rpt_hierarchy rh,
   rpt_survey_openend_response rpt,
   temp_table_session tts
WHERE rpt.node_id IN (SELECT child_node_id FROM rpt_hierarchy_rollup WHERE node_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_organization_id))))
--AND EXISTS (SELECT * FROM rpt_survey_minimum_response WHERE promotion_id=rpt.promotion_id AND node_id = rh.node_id AND is_leaf=0)
AND rh.node_id          = rpt.node_id           --01/03/2014
AND rpt.promotion_id    = p_in_promotionId
AND rpt.survey_question = tts.asset_code(+) order by node_name asc));    --12/18/2014
      p_out_return_code :=  '00' ; 

ELSE

p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

OPEN l_cursor FOR
     SELECT textline FROM (
        SELECT 1,p_header
         Textline
        FROM dual
      UNION
       SELECT   (ROWNUM+1),
         c2_delimiter||node_name||c2_delimiter||c_delimiter||
         c2_delimiter||Question_Asked||c2_delimiter||c_delimiter||
         c2_delimiter||Response||c2_delimiter
    FROM 
    (SELECT rh.node_name,
    NVL(tts.cms_name,rpt.survey_question) AS Question_Asked,
    rpt.open_end_response response
    FROM
   rpt_hierarchy rh,
   rpt_survey_openend_response rpt,
   temp_table_session tts
WHERE rpt.node_id IN (SELECT child_node_id FROM rpt_hierarchy_rollup WHERE node_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_organization_id))))
--AND EXISTS (SELECT * FROM rpt_survey_minimum_response WHERE promotion_id=rpt.promotion_id AND node_id = rh.node_id AND is_leaf=0)
AND rh.node_id          = rpt.node_id           --01/03/2014
AND rpt.promotion_id    = p_in_promotionId
AND rpt.survey_question = tts.asset_code(+) order by node_name asc));    --12/18/2014
     
  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019 
file_handler := UTL_FILE.FOPEN(v_file_location, p_file_name, 'w',4096);

LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);

  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_SURVEY_OPENEND_EXTRACT',1,'ERROR',
        p_in_organization_id||': '||'p_in_organization_id'||p_in_promotionId||': '||'p_in_promotionId'|| --07/16/2014 Bug # 54917
        p_in_languageCode ||': '||'p_in_languageCode '||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END prc_survey_openend_extract;

PROCEDURE prc_survey_extract
(p_in_organization_id  IN VARCHAR2,
  p_in_promotionId      IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name           IN VARCHAR2,
  p_header              IN VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Survey Responses(Open Ended extract)'
-- Person         Date        Comments
-- ---------      ----------  -----------------------------------------------------
-- Ravi Dhanekula 12/16/2013  Initial Version  
-- Chidamba       12/26/2013  implemented cursor query   
                  04/08/2014  CR-Bug fix : 52209     
-- nagarajs       07/16/2014  Bug # 54917 - close the file and include parms value when OTHER exception    
-- Suresh J       09/09/2014  Bug # 56377 - Fixed header field count and diviser zero error
                  09/10/2014              - Fixed issue with the above fix  
-- nagarajs       09/29/2015  Bug 64084 - Fixed to return repsonse columns dynmacially(like online report) based on number of responses. 
                                  Mean and standard deviation will be caculated based on the  dynamic response column. 
-- Sherif Basha   11/09/2016  Bug 70009 -- Dynamic SQL Erroring out when survey other than standard resp. type is extracted.
                                         It should return no data instead of error 
--Gorantla        03/12/2019  G6-1446  AWS - Enable Large Audience functionality.										 
  *******************************************************************************/
-- constants
c_delimiter      CONSTANT VARCHAR2(10) := ''',''||' ;
c2_delimiter     CONSTANT VARCHAR2(10) := '''"''||' ;  
 file_handler     UTL_FILE.file_type;
v_extract        VARCHAR2(4000);
v_file_location  VARCHAR2(1000);
directory_error  EXCEPTION;
l_cursor         SYS_REFCURSOR;  
 v_org_name       VARCHAR2(50);  
 p_in_locale      VARCHAR2(10) := p_in_languageCode;
--v_number         NUMBER := ((REGEXP_COUNT(p_header,',')+1)-7)/2;  09/09/2014
v_number         NUMBER := 10;  --09/10/2014
v_column_string  VARCHAR2(4000);
v_stage         VARCHAR2(200);
v_min_survey    NUMBER := 0;
         
 v_query  CLOB ; 
 
    list_column_count           VARCHAR2(32767); --09/29/2015 start
    v_response_result           VARCHAR2(4000);
    v_mean_result               VARCHAR2(4000);
    v_mean_result1              VARCHAR2(4000);
    v_mean_result2              VARCHAR2(4000);
    v_column_count              NUMBER(10);
    v_response_result_delim     VARCHAR2(4000);
    v_stdvion_result_delim      VARCHAR2(4000);
    v_total_avg                 VARCHAR2(4000); --09/29/2015 end
BEGIN

v_stage := '1';
SELECT int_val
  INTO v_min_survey 
  FROM OS_PROPERTYSET 
 WHERE entity_name = 'survey.report.response.count';

DELETE temp_table_session;
INSERT INTO temp_table_session SELECT asset_code,cms_value,key from vw_cms_asset_value where key IN ('QUESTION_NAME','QUESTION_RESPONSE') and locale = p_in_locale; --09/29/2015 Added QUESTION_RESPONSE

/*v_stage := '2';
dbms_output.put_line(v_stage);
FOR i IN 1 .. V_NUMBER LOOP
    v_column_string:= v_column_string||c_delimiter||c2_delimiter||'RESP_'||i||'_SELECTED||'||c2_delimiter||c_delimiter||
                                        c2_delimiter||'PERC_RESP_'||i||'_SELECTED||'||c2_delimiter;
END LOOP;
  
v_stage := '3';
dbms_output.put_line(v_stage);
v_query  := 'SELECT Textline FROM (
  SELECT 1,'''||p_header||''' Textline
   FROM dual
  UNION      
  SELECT (ROWNUM+1), '||c2_delimiter||'NODE_NAME||'||c2_delimiter||c_delimiter||'
        '||c2_delimiter||'SURVEYQUESTION||'||c2_delimiter||c_delimiter||'      
        '||c2_delimiter||'ELIGIBLE_PARTICIPANTS||'||c2_delimiter||c_delimiter||'     
        '||c2_delimiter||'SURVEYS_TAKEN||'||c2_delimiter||c_delimiter||'  
        '||c2_delimiter||'PERC_SURVEY_TAKEN||'||c2_delimiter||v_column_string||'  
        '||c_delimiter||c2_delimiter||'MEAN||'||c2_delimiter||c_delimiter||'
        '||c2_delimiter||'STANDARD_DEVIATION||'||'''"''    
FROM (SELECT (SELECT NODE_NAME FROM rpt_hierarchy WHERE node_id = '''||p_in_organization_id||''') NODE_NAME,
  SURVEYQUESTION,      
  ELIGIBLE_PARTICIPANTS,     
  SURVEYS_TAKEN   ,  
  PERC_SURVEY_TAKEN,
  RESP_1_SELECTED    ,   
  PERC_RESP_1_SELECTED,      
  RESP_2_SELECTED    ,   
  PERC_RESP_2_SELECTED,      
  RESP_3_SELECTED    ,   
  PERC_RESP_3_SELECTED,      
  RESP_4_SELECTED    ,   
  PERC_RESP_4_SELECTED,      
  RESP_5_SELECTED    ,   
  PERC_RESP_5_SELECTED,      
  RESP_6_SELECTED    ,   
  PERC_RESP_6_SELECTED,      
  RESP_7_SELECTED    ,   
  PERC_RESP_7_SELECTED,      
  RESP_8_SELECTED    ,   
  PERC_RESP_8_SELECTED,      
  RESP_9_SELECTED    ,   
  PERC_RESP_9_SELECTED,
  RESP_10_SELECTED    ,   
  PERC_RESP_10_SELECTED,  
  MEAN,  
  DECODE(NVL(TOT_X,0),0,0,DECODE((TOT_X-1),0,0,ROUND(SQRT(((TOT_X * (TOT_X+1)*((2*TOT_X)+1))/ 6) - ((TOT_X*(TOT_X+1)/2) * (TOT_X * (TOT_X+1)/2)/ TOT_X))/(TOT_X-1),2))) STANDARD_DEVIATION
FROM 
(WITH pivot_set AS
(SELECT ELIGIBLE_PARTICIPANTS
        ,SURVEYS_TAKEN
        ,SURVEYQUESTION
        ,ELIGIBLE_RESPONSES
        ,SEQUENCE_NUM
   FROM       
 (SELECT ELIGIBLE_PARTICIPANTS, SURVEYQUESTION,
       SURVEYQUESTIONRESPONSE,ELIGIBLE_RESPONSES,SURVEYS_TAKEN
FROM(SELECT rp.promotion_id promotion_id    
  ,NVL(rp.surveys_taken,0)  SURVEYS_TAKEN   
  ,rpc.SurveyQuestion
  ,INITCAP(rpc.SurveyQuestionResponse) SurveyQuestionResponse        
  ,rpc.eligible_responses
  FROM   
  (SELECT DISTINCT rh.node_id AS node_id,    
  rh.node_name node_name     
  FROM rpt_hierarchy rh  
  WHERE NVL(parent_node_id,0)                           IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))) rh,   
  (SELECT rh.node_id AS node_id, p.promotion_id  
  ,SUM(rpt.SURVEYS_TAKEN)  SURVEYS_TAKEN     
  FROM  rpt_survey_summary rpt,  
  rpt_hierarchy rh,      
  promotion p    
  WHERE  rpt.promotion_id    = p.promotion_id        
  AND detail_node_id      = rh.node_id       
  AND rpt.record_type LIKE ''%node%''      
  AND NVL(header_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))     
  AND rpt.promotion_id = '||p_in_promotionId||'
  GROUP BY rh.node_id, p.promotion_id) rp,   
  (SELECT rh.node_id AS node_id      
  ,rh.node_name node_name    
  ,FNC_CMS_ASSET_CODE_VALUE(Q.CM_ASSET_NAME) SurveyQuestion
  ,FNC_CMS_ASSET_CODE_VALUE(SQ.CM_ASSET_NAME)SurveyQuestionResponse  
  ,NVL(SUM(rpt.eligible_responses),0) eligible_responses
  FROM survey_question_response sq,  
  survey_question q,     
  rpt_survey_response_summary rpt,   
  rpt_hierarchy rh,      
  promotion p    
  WHERE sq.cm_asset_name = rpt.survey_question_response(+)   
  AND q.survey_question_id = sq.survey_question_id(+)    
  AND rpt.promotion_id    = p.promotion_id       
  AND detail_node_id      = rh.node_id       
  AND rpt.record_type LIKE ''%node%''      
  AND NVL(header_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))     
  AND rpt.promotion_id = '||p_in_promotionId||'
  GROUP BY rh.node_id, rh.node_name, FNC_CMS_ASSET_CODE_VALUE(Q.CM_ASSET_NAME),FNC_CMS_ASSET_CODE_VALUE(SQ.CM_ASSET_NAME)) rpc
  WHERE rh.node_id             = rpc.node_id (+)     
  AND rh.node_id             = rp.node_id (+)
  UNION  
 SELECT rp.promotion_id promotion_id     
  ,NVL(rp.surveys_taken,0)  SURVEYS_TAKEN   
  ,rpc.SurveyQuestion
  ,INITCAP(rpc.SurveyQuestionResponse) SurveyQuestionResponse        
  ,rpc.eligible_responses
  FROM   
  (SELECT DISTINCT rh.node_id AS node_id,    
  rh.node_name node_name     
  FROM rpt_hierarchy rh  
  WHERE NVL(node_id,0)                           IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))) rh,   
  (SELECT rh.node_id AS node_id , p.promotion_id     
  ,SUM(rpt.SURVEYS_TAKEN)  SURVEYS_TAKEN     
  FROM  rpt_survey_summary rpt,  
  rpt_hierarchy rh,      
  promotion p    
  WHERE  rpt.promotion_id    = p.promotion_id        
  AND detail_node_id      = rh.node_id       
  AND rpt.record_type LIKE ''%team%''      
  AND NVL(detail_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))     
  AND rpt.promotion_id = '||p_in_promotionId||'
  GROUP BY rh.node_id, p.promotion_id) rp,   
  (SELECT rh.node_id AS node_id      
  ,rh.node_name node_name    
  ,FNC_CMS_ASSET_CODE_VALUE(Q.CM_ASSET_NAME) SurveyQuestion
  ,FNC_CMS_ASSET_CODE_VALUE(SQ.CM_ASSET_NAME)SurveyQuestionResponse  
  ,NVL(SUM(rpt.eligible_responses),0) eligible_responses
  FROM survey_question_response sq,  
  survey_question q,     
  rpt_survey_response_summary rpt,   
  rpt_hierarchy rh,      
  promotion p    
  WHERE sq.cm_asset_name = rpt.survey_question_response(+)   
  AND q.survey_question_id = sq.survey_question_id(+)    
  AND rpt.promotion_id    = p.promotion_id       
  AND detail_node_id      = rh.node_id       
  AND rpt.record_type LIKE ''%team%''      
  AND NVL(detail_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))     
  AND rpt.promotion_id = '||p_in_promotionId||'
  GROUP BY rh.node_id, rh.node_name, FNC_CMS_ASSET_CODE_VALUE(Q.CM_ASSET_NAME),FNC_CMS_ASSET_CODE_VALUE(SQ.CM_ASSET_NAME)) rpc
  WHERE rh.node_id             = rpc.node_id (+)     
  AND rh.node_id             = rp.node_id (+)) rspn,
  (SELECT s.promotion_id , sum(s.ELIGIBLE_SURVEYS) ELIGIBLE_PARTICIPANTS
  FROM RPT_SURVEY_summary s,
       RPT_HIERARCHY_ROLLUP hr
WHERE hr.child_node_id = s.detail_node_id
  AND s.record_type like ''%team%''
  AND hr.node_id = '''||p_in_organization_id||'''
    group by s.promotion_id)elig
WHERE elig.promotion_id = rspn.promotion_id) res,
  (SELECT RESPONSE, ROWNUM sequence_num 
   FROM (SELECT INITCAP(response) RESPONSE,COUNT(NO_SURVEY_RESPONSES) NO_SURVEY_RESPONSES
   FROM (SELECT lower(fnc_cms_asset_code_val_extr(sqr.cm_asset_name,''QUESTION_RESPONSE'','''||p_in_languageCode||''')) response, 
                 PARTICIPANT_SURVEY_RESPONSE_ID NO_SURVEY_RESPONSES     
           FROM survey_question_response sqr, participant_survey_response psr, 
                survey_question sq,  
                promo_survey ps  
          WHERE ps.promotion_id = '||p_in_promotionId||'
            AND psr.survey_question_response_id(+) = sqr.survey_question_response_id 
            AND ps.survey_id = sq.survey_id  
            AND sq.RESPONSE_TYPE = ''standardResponse'' 
            AND sq.survey_question_id = sqr.survey_question_id)
  GROUP BY INITCAP(response) ORDER BY  NO_SURVEY_RESPONSES desc)) ref
  WHERE res.surveyquestionresponse = ref.response
    AND res.surveys_taken <> 0 
    ORDER BY ref.sequence_num)
SELECT SURVEYQUESTION,    
  NVL(ELIGIBLE_PARTICIPANTS,0) ELIGIBLE_PARTICIPANTS,   
  NVL(SUM(SURVEYS_TAKEN),0) SURVEYS_TAKEN,   
  DECODE( NVL(ELIGIBLE_PARTICIPANTS,0),0,0,ROUND(NVL(SUM(SURVEYS_TAKEN),0)/ NVL(ELIGIBLE_PARTICIPANTS,0) * 100,2)) PERC_SURVEY_TAKEN,
  NVL(SUM(RESP_1_SELECTED),0) RESP_1_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_1_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_1_SELECTED,     
  NVL(SUM(RESP_2_SELECTED),0) RESP_2_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_2_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_2_SELECTED,     
  NVL(SUM(RESP_3_SELECTED),0) RESP_3_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_3_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_3_SELECTED,     
  NVL(SUM(RESP_4_SELECTED),0) RESP_4_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_4_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_4_SELECTED,     
  NVL(SUM(RESP_5_SELECTED),0) RESP_5_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_5_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_5_SELECTED,     
  NVL(SUM(RESP_6_SELECTED),0) RESP_6_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_6_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_6_SELECTED,     
  NVL(SUM(RESP_7_SELECTED),0) RESP_7_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_7_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_7_SELECTED,     
  NVL(SUM(RESP_8_SELECTED),0) RESP_8_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_8_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_8_SELECTED,     
  NVL(SUM(RESP_9_SELECTED),0) RESP_9_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_9_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_9_SELECTED,
  NVL(SUM(RESP_10_SELECTED),0) RESP_10_SELECTED,   
  DECODE( NVL(SUM(SURVEYS_TAKEN),0),0,0,ROUND(NVL(SUM(RESP_10_SELECTED),0)/ NVL(SUM(SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_10_SELECTED,     
      CASE   --09/09/2014
      WHEN ( SUM((DECODE(RESP_1_SELECTED,NULL,0,1)+DECODE(RESP_2_SELECTED,NULL,0,1)+DECODE(RESP_3_SELECTED,NULL,0,1)+     
              DECODE(RESP_4_SELECTED,NULL,0,1)+DECODE(RESP_5_SELECTED,NULL,0,1)+DECODE(RESP_6_SELECTED,NULL,0,1)+    
              DECODE(RESP_7_SELECTED,NULL,0,1)+DECODE(RESP_8_SELECTED,NULL,0,1)+DECODE(RESP_9_SELECTED,NULL,0,1)+
              DECODE(RESP_10_SELECTED,NULL,0,1)))) = 0
      THEN 0
      ELSE   ROUND((NVL(SUM(RESP_1_SELECTED),0)+NVL(SUM(RESP_2_SELECTED),0)+NVL(SUM(RESP_3_SELECTED),0)+    
         NVL(SUM(RESP_4_SELECTED),0)+NVL(SUM(RESP_5_SELECTED),0)+NVL(SUM(RESP_6_SELECTED),0)+   
         NVL(SUM(RESP_7_SELECTED),0)+NVL(SUM(RESP_8_SELECTED),0)+NVL(SUM(RESP_9_SELECTED),0)+
         NVL(SUM(RESP_10_SELECTED),0))/
         SUM((DECODE(RESP_1_SELECTED,NULL,0,1)+DECODE(RESP_2_SELECTED,NULL,0,1)+DECODE(RESP_3_SELECTED,NULL,0,1)+     
              DECODE(RESP_4_SELECTED,NULL,0,1)+DECODE(RESP_5_SELECTED,NULL,0,1)+DECODE(RESP_6_SELECTED,NULL,0,1)+    
              DECODE(RESP_7_SELECTED,NULL,0,1)+DECODE(RESP_8_SELECTED,NULL,0,1)+DECODE(RESP_9_SELECTED,NULL,0,1)+
              DECODE(RESP_10_SELECTED,NULL,0,1))))
    END MEAN,
--  ROUND((NVL(SUM(RESP_1_SELECTED),0)+NVL(SUM(RESP_2_SELECTED),0)+NVL(SUM(RESP_3_SELECTED),0)+      --09/09/2014
--         NVL(SUM(RESP_4_SELECTED),0)+NVL(SUM(RESP_5_SELECTED),0)+NVL(SUM(RESP_6_SELECTED),0)+      --09/09/2014
--         NVL(SUM(RESP_7_SELECTED),0)+NVL(SUM(RESP_8_SELECTED),0)+NVL(SUM(RESP_9_SELECTED),0)+      --09/09/2014
--         NVL(SUM(RESP_10_SELECTED),0))/                                                            --09/09/2014
--         SUM((DECODE(RESP_1_SELECTED,NULL,0,1)+DECODE(RESP_2_SELECTED,NULL,0,1)+DECODE(RESP_3_SELECTED,NULL,0,1)+  --09/09/2014     
--              DECODE(RESP_4_SELECTED,NULL,0,1)+DECODE(RESP_5_SELECTED,NULL,0,1)+DECODE(RESP_6_SELECTED,NULL,0,1)+  --09/09/2014  
--              DECODE(RESP_7_SELECTED,NULL,0,1)+DECODE(RESP_8_SELECTED,NULL,0,1)+DECODE(RESP_9_SELECTED,NULL,0,1)+  --09/09/2014
--              DECODE(RESP_10_SELECTED,NULL,0,1)))) MEAN,                                                           --09/09/2014
  SUM(DECODE(RESP_1_SELECTED,NULL,0,1)+DECODE(RESP_2_SELECTED,NULL,0,1)+DECODE(RESP_3_SELECTED,NULL,0,1)+  
      DECODE(RESP_4_SELECTED,NULL,0,1)+DECODE(RESP_5_SELECTED,NULL,0,1)+DECODE(RESP_6_SELECTED,NULL,0,1)+    
      DECODE(RESP_7_SELECTED,NULL,0,1)+DECODE(RESP_8_SELECTED,NULL,0,1)+DECODE(RESP_9_SELECTED,NULL,0,1)+
      DECODE(RESP_10_SELECTED,NULL,0,1)) TOT_X  
  FROM pivot_set
  PIVOT (SUM(eligible_responses) AS SELECTED FOR sequence_num IN 
( 1 AS resp_1,   
  2 AS resp_2,   
  3 AS resp_3,   
  4 AS resp_4,   
  5 AS resp_5,   
  6 AS resp_6,   
  7 AS resp_7,   
  8 AS resp_8,   
  9 AS resp_9,
  10 AS resp_10))t
  GROUP BY SURVEYQUESTION,ELIGIBLE_PARTICIPANTS)
  WHERE SURVEYS_TAKEN >= '||v_min_survey||'
  ORDER BY SURVEYQUESTION) )';  */

 v_stage := 'Get Max Survey Response count';
 SELECT MAX(TO_NUMBER(survey_response_seq))
   INTO v_column_count
   FROM (SELECT ROWNUM survey_response_seq
          FROM
            (SELECT RANK() OVER (PARTITION BY pe.response ORDER BY pe.responseId,date_created) AS rec_rank,
              pe.*
            FROM
              (SELECT sqr.cm_asset_name response,
                sqr.survey_question_response_id responseId,
                psr.date_created
              FROM survey_question_response sqr,
                participant_survey_response psr,
                survey_question sq,
                promo_survey ps
              WHERE ps.promotion_id                  = p_in_promotionId
              AND psr.survey_question_response_id(+) = sqr.survey_question_response_id
              AND ps.survey_id                       = sq.survey_id
              AND psr.survey_question_response_id   IS NOT NULL
              AND sq.survey_question_id              = sqr.survey_question_id
              ) pe
            ) pe
          WHERE rec_rank=1
          AND ROWNUM <=10);
  
  v_stage := 'Get Survey Response count';
  -- 11/09/2016 Bug 70009 Added if condition as v_column_count return one record even if it is null or 0
  IF v_column_count IS NOT NULL THEN
      SELECT LISTAGG(in_number,' ,') WITHIN GROUP( ORDER BY in_number) column_count
        INTO list_column_count
        FROM (SELECT level||' as RESP_'||level in_number FROM dual
              CONNECT BY LEVEL <= v_column_count) ;
  END IF;
       
  v_stage := 'Form Response, Mean and Standard Deviation data';
  FOR rec IN (SELECT * FROM (SELECT ROWNUM sequence_num
                                  FROM
                                    (SELECT RANK() OVER (PARTITION BY pe.response ORDER BY pe.responseId,date_created) AS rec_rank,
                                      pe.*
                                    FROM
                                      (SELECT sqr.cm_asset_name response,
                                        sqr.survey_question_response_id responseId,
                                        psr.date_created
                                      FROM survey_question_response sqr,
                                        participant_survey_response psr,
                                        survey_question sq,
                                        promo_survey ps
                                      WHERE ps.promotion_id                  = p_in_promotionId
                                      AND psr.survey_question_response_id(+) = sqr.survey_question_response_id
                                      AND ps.survey_id                       = sq.survey_id
                                      AND psr.survey_question_response_id   IS NOT NULL
                                      AND sq.survey_question_id              = sqr.survey_question_id
                                      ) pe
                                    ) pe
                                  WHERE rec_rank=1)
                               WHERE ROWNUM <=10
                ORDER BY sequence_num ) LOOP
                
        v_stage := 'Form Response data';
        v_response_result := v_response_result||'NVL((RESP_'||rec.sequence_num||'_SELECTED),0) RESP_'||rec.sequence_num||'_SELECTED,'||
           'DECODE( NVL((SURVEYS_TAKEN),0),0,0,ROUND(NVL((RESP_'||rec.sequence_num||'_SELECTED),0)/ NVL((SURVEYS_TAKEN),0) * 100,2)) PERC_RESP_'||rec.sequence_num||'_SELECTED,';
        v_response_result_delim := v_response_result_delim||c2_delimiter||'NVL((RESP_'||rec.sequence_num||'_SELECTED),0)||'||c2_delimiter||c_delimiter||
          c2_delimiter||'DECODE( NVL((SURVEYS_TAKEN),0),0,0,ROUND(NVL((RESP_'||rec.sequence_num||'_SELECTED),0)/ NVL((SURVEYS_TAKEN),0) * 100,2))||'||c2_delimiter||c_delimiter;
        
        IF rec.sequence_num = 1 and rec.sequence_num = v_column_count THEN
                    v_stage := 'Form Data 1';
                    v_mean_result := 'CASE   
                                    WHEN ( ((DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1)))) = 0
                                    THEN 0
                                    ELSE   ROUND((NVL((RESP_'||rec.sequence_num||'_SELECTED),0)))/((DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1))) END';
                    v_stdvion_result_delim := 'DECODE (1,1,0)';
                    v_total_avg := '1';
        ELSIF rec.sequence_num = 1 THEN
                    v_stage := 'Form Data 2';
                    v_mean_result := 'CASE   
                                       WHEN ( ((DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1) ';
                    v_mean_result1:= ' ELSE   ROUND((NVL((RESP_'||rec.sequence_num||'_SELECTED),0)';
                    v_mean_result2:= '/((DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1)';
                    v_total_avg := '(DECODE((RESP_'||rec.sequence_num||'_SELECTED),NULL,0,1)'; 
                    v_stdvion_result_delim := 'DECODE(TOT_AVERAGE,1,0,0,0,ROUND(SQRT((POWER(DECODE(NVL((RESP_'||rec.sequence_num||'_SELECTED),0),0,0,((RESP_'||rec.sequence_num||'_SELECTED)-MEAN)),2)';        
        ELSIF rec.sequence_num = v_column_count THEN
                    v_stage := 'Form Data 3';
                    v_mean_result := v_mean_result||'+DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1)))) = 0 THEN 0';
                    v_mean_result1:= v_mean_result1||'+NVL((RESP_'||rec.sequence_num||'_SELECTED),0)))';
                    v_mean_result2:= v_mean_result2||'+DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1))) END';
                    v_total_avg   := v_total_avg||'+DECODE((RESP_'||rec.sequence_num||'_SELECTED),NULL,0,1))';
                    v_stdvion_result_delim := v_stdvion_result_delim||'+ POWER(DECODE(NVL((RESP_'||rec.sequence_num||'_SELECTED),0),0,0,((RESP_'||rec.sequence_num||'_SELECTED)-MEAN)),2) )/(TOT_AVERAGE-1)),2))';
        ELSIF rec.sequence_num <> 1 THEN
                    v_stage := 'Form Data 4';
                    v_mean_result := v_mean_result||'+DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1)';
                    v_mean_result1:= v_mean_result1||'+NVL((RESP_'||rec.sequence_num||'_SELECTED),0)';
                    v_mean_result2:= v_mean_result2||'+DECODE(RESP_'||rec.sequence_num||'_SELECTED,NULL,0,1)';
                    v_total_avg   := v_total_avg||'+DECODE((RESP_'||rec.sequence_num||'_SELECTED),NULL,0,1)';
                    v_stdvion_result_delim := v_stdvion_result_delim||'+ POWER(DECODE(NVL((RESP_'||rec.sequence_num||'_SELECTED),0),0,0,((RESP_'||rec.sequence_num||'_SELECTED)-MEAN)),2)';
        END IF;
        
                                            
  END LOOP; 
  
  v_stage := 'Form Data 5';
  v_mean_result := v_mean_result||v_mean_result1||v_mean_result2;  -- 11/09/2016 Bug 70009 Add MEAN keyword only if there is MEAN clause available
  v_mean_result:=CASE WHEN v_mean_result IS NULL THEN v_mean_result ELSE v_mean_result||' MEAN' END; -- 11/09/2016 Bug 70009
  v_total_avg   := CASE WHEN v_total_avg IS NULL THEN v_total_avg ELSE ','||v_total_avg||' TOT_AVERAGE' END; -- 11/09/2016 Bug 70009 Add TOT_AVERAGE keyword only if there is TOT_AVERAGE clause available

  v_stage := 'Genearate query';
  v_query  := 'SELECT Textline FROM (
  SELECT 1,'''||p_header||''' Textline
   FROM dual
  UNION    
  SELECT (ROWNUM+1), '||c2_delimiter||'NODE_NAME||'||c2_delimiter||c_delimiter||'
        '||c2_delimiter||'SURVEYQUESTION||'||c2_delimiter||c_delimiter||'      
        '||c2_delimiter||'ELIGIBLE_PARTICIPANTS||'||c2_delimiter||c_delimiter||'     
        '||c2_delimiter||'SURVEYS_TAKEN||'||c2_delimiter||c_delimiter||'  
        '||c2_delimiter||'PERC_SURVEY_TAKEN||'||c2_delimiter||c_delimiter
        ||v_response_result_delim  
        ||c2_delimiter||CASE WHEN v_mean_result IS NULL THEN 'NULL' ELSE 'MEAN' END ||'||'||c2_delimiter||c_delimiter  -- 11/09/2016 Bug 70009
        ||c2_delimiter||CASE WHEN v_mean_result IS NULL THEN 'NULL' ELSE v_stdvion_result_delim END ||'||'||'''"''     -- 11/09/2016 Bug 70009
FROM 
(WITH pivot_set AS     
                 (
                 SELECT ELIGIBLE_PARTICIPANTS      
                 ,SURVEYS_TAKEN     
                 ,SURVEYQUESTION    
                 ,ELIGIBLE_RESPONSES    
                 ,SEQUENCE_NUM 
                 ,survey_question_id      
                 FROM           
                 (
           SELECT ELIGIBLE_PARTICIPANTS, SURVEYQUESTION,survey_question_id,     
                 SURVEYQUESTIONRESPONSE,ELIGIBLE_RESPONSES,SURVEYS_TAKEN    
                 FROM(  
                 SELECT rp.promotion_id promotion_id            
                 ,NVL(rp.surveys_taken,0)  SURVEYS_TAKEN        
                 ,rpc.SurveyQuestion    
                 ,INITCAP(rpc.SurveyQuestionResponse) SurveyQuestionResponse, 
                 rpc.survey_question_id       
                 ,rpc.eligible_responses    
                 FROM       
                 (SELECT rh.node_id AS node_id,        
                 rh.node_name node_name         
                 FROM rpt_hierarchy rh      
                 WHERE NVL(parent_node_id,0)                           IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||'''  ) ))) rh,          
                 (SELECT rh.node_id AS node_id , p.promotion_id         
                 ,SUM(rpt.SURVEYS_TAKEN)  SURVEYS_TAKEN         
                 FROM  rpt_survey_summary rpt,      
                 rpt_hierarchy rh,          
                 promotion p        
                 WHERE  rpt.promotion_id    = p.promotion_id            
                 AND detail_node_id      = rh.node_id           
                 AND rpt.record_type LIKE ''%node%''         
                 AND NVL(header_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||'''  ) ))         
                 AND rpt.promotion_id = '||p_in_promotionId||'                 
                 GROUP BY rh.node_id, p.promotion_id) rp,       
                 (SELECT rh.node_id AS node_id          
                 ,rh.node_name node_name        
                 ,cm_q.cms_name SurveyQuestion 
                 ,q.survey_question_id     
                 ,cm_qr.cms_name SurveyQuestionResponse      
                 ,NVL(SUM(rpt.eligible_responses),0) eligible_responses     
                 FROM survey_question_response sq,      
                 survey_question q,         
                 rpt_survey_response_summary rpt,       
                 rpt_hierarchy rh,          
                 promotion p
                ,(SELECT asset_code,cms_name FROM temp_table_session where cms_code = ''QUESTION_RESPONSE'' ) cm_qr                  
                ,(SELECT asset_code,cms_name FROM temp_table_session where cms_code = ''QUESTION_NAME'' ) cm_q         
                 WHERE sq.cm_asset_name = rpt.survey_question_response(+)  
                 AND sq.cm_asset_name =  cm_qr.asset_code(+)
                 AND q.cm_asset_name =  cm_q.asset_code (+)      
                 AND q.survey_question_id = sq.survey_question_id(+)        
                 AND rpt.promotion_id    = p.promotion_id           
                 AND detail_node_id      = rh.node_id           
                 AND rpt.record_type LIKE ''%node%''          
                 AND NVL(header_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))     
                 AND EXISTS (SELECT * FROM rpt_survey_minimum_response WHERE promotion_id=P.promotion_id AND node_id = rh.node_id AND is_leaf=0)            
                 AND rpt.promotion_id = '||p_in_promotionId||'                  
                 GROUP BY rh.node_id, rh.node_name
                  ,cm_qr.cms_name,cm_q.cms_name
                 ,q.survey_question_id   ) rpc       
                 WHERE rh.node_id             = rpc.node_id (+)         
                 AND rh.node_id             = rp.node_id (+)                 
            UNION ALL
                 SELECT rp.promotion_id promotion_id            
                 ,NVL(rp.surveys_taken,0)  SURVEYS_TAKEN        
                 ,rpc.SurveyQuestion    
                 ,INITCAP(rpc.SurveyQuestionResponse) SurveyQuestionResponse, 
                 rpc.survey_question_id       
                 ,rpc.eligible_responses    
                 FROM       
                 (SELECT rh.node_id AS node_id,        
                 rh.node_name node_name         
                 FROM rpt_hierarchy rh      
                 WHERE NVL(node_id,0)                           IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))) rh,          
                 (SELECT rh.node_id AS node_id , p.promotion_id         
                 ,SUM(rpt.SURVEYS_TAKEN)  SURVEYS_TAKEN         
                 FROM  rpt_survey_summary rpt,      
                 rpt_hierarchy rh,          
                 promotion p        
                 WHERE  rpt.promotion_id    = p.promotion_id            
                 AND detail_node_id      = rh.node_id           
                 AND rpt.record_type LIKE ''%team%''          
                 AND NVL(detail_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))         
                 AND rpt.promotion_id = '||p_in_promotionId||'                  
                 GROUP BY rh.node_id, p.promotion_id) rp,       
                 (SELECT rh.node_id AS node_id          
                 ,rh.node_name node_name        
                 ,cm_q.cms_name SurveyQuestion 
                 ,q.survey_question_id     
                 ,cm_qr.cms_name SurveyQuestionResponse        
                 ,NVL(SUM(rpt.eligible_responses),0) eligible_responses     
                 FROM survey_question_response sq,      
                 survey_question q,         
                 rpt_survey_response_summary rpt,       
                 rpt_hierarchy rh,          
                 promotion p
                 ,(SELECT asset_code,cms_name FROM temp_table_session where cms_code = ''QUESTION_RESPONSE'' ) cm_qr                  
                 ,(SELECT asset_code,cms_name FROM temp_table_session where cms_code = ''QUESTION_NAME'' ) cm_q         
                 WHERE sq.cm_asset_name = rpt.survey_question_response(+)       
                 AND sq.cm_asset_name =  cm_qr.asset_code(+)
                 AND q.cm_asset_name =  cm_q.asset_code (+)      
                 AND q.survey_question_id = sq.survey_question_id(+)        
                 AND rpt.promotion_id    = p.promotion_id           
                 AND detail_node_id      = rh.node_id           
                 AND rpt.record_type LIKE ''%team%''          
                 AND NVL(detail_node_id,0)    IN (SELECT * FROM TABLE(get_array_varchar( '''||p_in_organization_id||''' ) ))     
                 AND EXISTS (SELECT * FROM rpt_survey_minimum_response WHERE promotion_id=P.promotion_id AND node_id = rh.node_id AND is_leaf=1)            
                 AND rpt.promotion_id = '||p_in_promotionId||'               
                 GROUP BY rh.node_id, rh.node_name
                 ,cm_qr.cms_name,cm_q.cms_name
                 ,q.survey_question_id   ) rpc       
                 WHERE rh.node_id             = rpc.node_id (+)         
                 AND rh.node_id             = rp.node_id (+)) rspn,     
                 (SELECT s.promotion_id , sum(s.ELIGIBLE_SURVEYS) ELIGIBLE_PARTICIPANTS     
                 FROM RPT_SURVEY_summary s,
                 RPT_HIERARCHY_ROLLUP hr     
                 WHERE hr.child_node_id = s.detail_node_id 
                 AND s.record_type like ''%team%''
                 AND '''||p_in_organization_id||''' = hr.node_id         
                 group by s.promotion_id)elig       
                 WHERE elig.promotion_id = rspn.promotion_id
                  ) res,      
                 ( SELECT RESPONSE, ROWNUM sequence_num      
                 FROM (SELECT INITCAP(response) RESPONSE,COUNT(NO_SURVEY_RESPONSES) NO_SURVEY_RESPONSES     
                 FROM (SELECT 
                  lower((SELECT cms_name FROM temp_table_session where asset_code=sqr.cm_asset_name and  cms_code=''QUESTION_RESPONSE'' )) response,     
                 PARTICIPANT_SURVEY_RESPONSE_ID NO_SURVEY_RESPONSES         
                 FROM survey_question_response sqr, participant_survey_response psr,        
                 survey_question sq,        
                 promo_survey ps        
                 WHERE ps.promotion_id = '||p_in_promotionId||'    
                 AND psr.survey_question_response_id(+) = sqr.survey_question_response_id       
                 AND ps.survey_id = sq.survey_id        
                 AND psr.survey_question_response_id IS NOT NULL      
                 AND sq.survey_question_id = sqr.survey_question_id)    
                 GROUP BY INITCAP(response) ORDER BY  NO_SURVEY_RESPONSES desc)
                 ) ref    
                 WHERE res.surveyquestionresponse = ref.response    
                 AND res.surveys_taken <> 0     
                 ORDER BY ref.sequence_num
                 )     
SELECT (SELECT NODE_NAME FROM rpt_hierarchy WHERE node_id = '''||p_in_organization_id||''') NODE_NAME,
       SURVEYQUESTION,    
  NVL(ELIGIBLE_PARTICIPANTS,0) ELIGIBLE_PARTICIPANTS,   
  NVL((SURVEYS_TAKEN),0) SURVEYS_TAKEN,
  DECODE( NVL(ELIGIBLE_PARTICIPANTS,0),0,0,ROUND(NVL((SURVEYS_TAKEN),0)/ NVL(ELIGIBLE_PARTICIPANTS,0) * 100,2)) PERC_SURVEY_TAKEN'
  ||CASE WHEN v_response_result IS NULL THEN v_response_result ELSE ','||v_response_result END ||v_mean_result||v_total_avg||   -- 11/09/2016 Bug 70009  
  ' FROM pivot_set
  PIVOT (SUM(eligible_responses) AS SELECTED FOR sequence_num IN 
( '||list_column_count||'))t
 ORDER BY SURVEYQUESTION ASC )
  WHERE SURVEYS_TAKEN >= '||v_min_survey||'
)';  

  v_stage := '4';   

IF p_file_name IS NULL THEN     

OPEN p_out_result_set FOR v_query;      
  p_out_return_code :=  '00' ; 

ELSE
  v_stage := '5';  
  p_out_return_code :=  '00' ;
OPEN p_out_result_set FOR SELECT NULL FROM dual;
OPEN l_cursor FOR v_query;
  v_stage := '6';  
-- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019 
   file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);
  v_stage := '7';
   
LOOP  
     fetch l_cursor into  v_extract;
     exit when l_cursor%notfound;
           UTL_FILE.put_line(file_handler, v_extract);             
      
END LOOP;

    UTL_FILE.fclose(file_handler);
 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
      END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN --07/16/2014 Bug # 54917
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_SURVEY_EXTRACT',1,'ERROR',
        p_in_organization_id||': '||'p_in_organization_id'||p_in_promotionId||': '||'p_in_promotionId'|| --07/16/2014 Bug # 54917
        p_in_languageCode ||': '||'p_in_languageCode '||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||'At Stage '||v_stage||'-->'||SQLERRM
                          ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END prc_survey_extract;

PROCEDURE PRC_WORK_HAPPIER_DTL_EXTRACT
 (p_in_timeframe        IN  VARCHAR2,  
  p_header              IN  VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Happiness detail Extract'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- nagarajs   12/08/2015  Initial Version  
-- nagarajs   02/12/2016  Bug 65685 - Internal Extract - Additional Column for Prefix
*******************************************************************************/

   -- constants
   c_delimiter      CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter     CONSTANT VARCHAR2(1) := '"' ;  
   v_stage          VARCHAR2(200);
   v_start_date     DATE;
   v_end_date       DATE;  
   v_user_name      VARCHAR2(10);  --02/12/2016

BEGIN
  
  prc_execution_log_entry('PRC_WORK_HAPPIER_DTL_EXTRACT',1,'INFO',
        'Procedure Started for params ~ '||p_in_timeframe||': '||'p_in_timeframe'
        ,null);
        
  v_stage := 'Get last 3 calender month';
  SELECT ADD_MONTHS(TO_DATE(p_in_timeframe, 'MM/DD/YYYY'),-2) , 
         LAST_DAY(TO_DATE(p_in_timeframe, 'MM/DD/YYYY'))  
    INTO v_start_date,
         v_end_date
    FROM dual;
    
  v_stage := 'Get prefix';
  SELECT USER           --02/12/2016
    INTO v_user_name
    FROM dual;
  
  v_stage := 'Return data to cursor';
  OPEN p_out_result_set FOR   
      SELECT textline 
        FROM ( SELECT 1,p_header Textline
                 FROM dual
                UNION
               SELECT (ROWNUM+1),
                      c2_delimiter||v_user_name||c2_delimiter||c_delimiter||            --02/12/2016
                      c2_delimiter||first_name||c2_delimiter||c_delimiter||
                      c2_delimiter||last_name||c2_delimiter||c_delimiter||
                      c2_delimiter||login_id||c2_delimiter||c_delimiter||
                      c2_delimiter||org_name||c2_delimiter||c_delimiter||
                      c2_delimiter||company_name||c2_delimiter||c_delimiter||
                      c2_delimiter||country_name||c2_delimiter||c_delimiter||
                      c2_delimiter||birth_date||c2_delimiter||c_delimiter||
                      c2_delimiter||hire_date||c2_delimiter||c_delimiter||
                      c2_delimiter||slide_score||c2_delimiter||c_delimiter||
                      c2_delimiter||date_stamp||c2_delimiter||c_delimiter||
                      c2_delimiter||time_stamp||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic1_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic1_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic2_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic2_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic3_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic3_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic4_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic4_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic5_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic5_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic6_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic6_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic7_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic7_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic8_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic8_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic9_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic9_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic10_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic10_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic11_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic11_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic12_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic12_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic13_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic13_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic14_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic14_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic15_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic15_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic16_name||c2_delimiter||c_delimiter||   --03/03/2016 Start
                      c2_delimiter||characteristic16_value||c2_delimiter||c_delimiter||  
                      c2_delimiter||characteristic17_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic17_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic18_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic18_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic19_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic19_value||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic20_name||c2_delimiter||c_delimiter||
                      c2_delimiter||characteristic20_value||c2_delimiter                 --03/03/2016 End
          text
                 FROM (SELECT au.first_name,
                              au.last_name,
                              au.user_name login_id,
                              n.name org_name,
                              (select cms_value from vw_cms_asset_value where key='COUNTRY_NAME' AND locale = 'en_US' AND asset_code=c.cm_asset_code) country_name, 
                              e.name company_name,
                              au.birth_date,
                              pe.hire_date,
                              ws.score slide_score,
                              TO_CHAR(ws.date_created, 'MM/DD/YYYY') date_stamp,
                              TO_CHAR(ws.date_created, 'HH12:MI:SS AM') time_stamp,
                              characteristic1_name,
                              characteristic1_value,
                              characteristic2_name,
                              characteristic2_value,
                              characteristic3_name,
                              characteristic3_value,
                              characteristic4_name,
                              characteristic4_value,
                              characteristic5_name,
                              characteristic5_value,
                              characteristic6_name,
                              characteristic6_value,
                              characteristic7_name,
                              characteristic7_value,
                              characteristic8_name,
                              characteristic8_value,
                              characteristic9_name,
                              characteristic9_value,
                              characteristic10_name,
                              characteristic10_value,
                              characteristic11_name,
                              characteristic11_value,
                              characteristic12_name,
                              characteristic12_value,
                              characteristic13_name,
                              characteristic13_value,
                              characteristic14_name,
                              characteristic14_value,
                              characteristic15_name,
                              characteristic15_value,
                              characteristic16_name,  --03/03/2016 Start
                              characteristic16_value,
                              characteristic17_name,
                              characteristic17_value,
                              characteristic18_name,
                              characteristic18_value,
                              characteristic19_name,
                              characteristic19_value,
                              characteristic20_name,
                              characteristic20_value --03/03/2016 End    
                         FROM application_user au,
                              user_node un,
                              node n,
                              user_address ua,
                              country c,
                              vw_curr_pax_employer pe,
                              employer e,
                              workhappier_score ws,
                              (SELECT user_id,
                                       characteristic1_name,
                                       characteristic1_value,
                                       characteristic2_name,
                                       characteristic2_value,
                                       characteristic3_name,
                                       characteristic3_value,
                                       characteristic4_name,
                                       characteristic4_value,
                                       characteristic5_name,
                                       characteristic5_value,
                                       characteristic6_name,
                                       characteristic6_value,
                                       characteristic7_name,
                                       characteristic7_value,
                                       characteristic8_name,
                                       characteristic8_value,
                                       characteristic9_name,
                                       characteristic9_value,
                                       characteristic10_name,
                                       characteristic10_value,
                                       characteristic11_name,
                                       characteristic11_value,
                                       characteristic12_name,
                                       characteristic12_value,
                                       characteristic13_name,
                                       characteristic13_value,
                                       characteristic14_name,
                                       characteristic14_value,
                                       characteristic15_name,
                                       characteristic15_value,
                                       characteristic16_name,  --03/03/2016 Start
                                       characteristic16_value,
                                       characteristic17_name,
                                       characteristic17_value,
                                       characteristic18_name,
                                       characteristic18_value,
                                       characteristic19_name,
                                       characteristic19_value,
                                       characteristic20_name,
                                       characteristic20_value --03/03/2016 End 
                                  FROM (SELECT vcav.cms_value cm_char,
                                               uc.characteristic_value characteristic_values,
                                               DENSE_RANK ()
                                               OVER (PARTITION BY user_id ORDER BY uc.user_characteristic_id) char_num,
                                               user_id
                                          FROM user_characteristic uc, characteristic c,
                                               vw_cms_asset_value vcav
                                         WHERE uc.characteristic_id = c.characteristic_id
                                           AND c.cm_asset_code = vcav.asset_code
                                           AND vcav.key = 'CHARACTERISTIC_NAME'
                                           AND vcav.locale = 'en_US'
                                           ) PIVOT (MIN (SUBSTR(cm_char, 1, 120)) name,
                                                                                                  MIN (UPPER(characteristic_values)) VALUE
                                                                                           FOR (char_num)
                                                                                            IN (1 AS characteristic1,
                                                                                                2 AS characteristic2,
                                                                                                3 AS characteristic3,
                                                                                                4 AS characteristic4,
                                                                                                5 AS characteristic5,
                                                                                                6 AS characteristic6,
                                                                                                7 AS characteristic7,
                                                                                                8 AS characteristic8,
                                                                                                9 AS characteristic9,
                                                                                                10 AS characteristic10,
                                                                                                 11 AS characteristic11,
                                                                                                12 AS characteristic12,
                                                                                                13 AS characteristic13,
                                                                                                14 AS characteristic14,
                                                                                                15 AS characteristic15,
                                                                                                16 AS characteristic16, --03/03/2016 Start
                                                                                                17 AS characteristic17,
                                                                                                18 AS characteristic18,
                                                                                                19 AS characteristic19,
                                                                                                20 AS characteristic20))  --03/03/2016 End
                              ) uc
                        WHERE au.user_id = un.user_id
                          AND un.is_primary = 1
                          AND un.node_id = n.node_id
                          AND au.user_id = ua.user_id (+)
                          AND ua.is_primary (+) = 1
                          AND ua.country_id = c.country_id (+)
                          AND au.user_id = uc.user_id(+)
                          AND au.user_id = pe.user_id(+)
                          AND pe.employer_id = e.employer_id (+)
                          AND au.user_id = ws.user_id
                          AND TRUNC(ws.date_created) BETWEEN v_start_date AND v_end_date
                        ORDER BY au.user_name ASC
                        )
          );
                     
    prc_execution_log_entry('PRC_WORK_HAPPIER_DTL_EXTRACT',1,'INFO',
        'Procedure Completed sucessfully'
        ,null);

EXCEPTION
    WHEN OTHERS  THEN
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_WORK_HAPPIER_DTL_EXTRACT',1,'ERROR',
        'Error at stage '||v_stage||'-->'||SQLERRM
        ,null);
END PRC_WORK_HAPPIER_DTL_EXTRACT;

PROCEDURE PRC_CONFIDENTIAL_FEEDB_EXTRACT
 (p_in_timeframe        IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name           IN  VARCHAR2,
  p_header              IN  VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Confidential Feedback Extract'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- nagarajs   12/08/2015  Initial Version  
--Gorantla    03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter      CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter     CONSTANT VARCHAR2(1) := '"' ;  
   file_handler     UTL_FILE.file_type;
   v_extract        VARCHAR2(4000);
   v_file_location  VARCHAR2(1000);
   directory_error  EXCEPTION;
   l_cursor         SYS_REFCURSOR;  
   v_pattern        VARCHAR2(15);  
   v_start_date     DATE;
   v_end_date       DATE;  
   p_in_locale      VARCHAR2(10) := p_in_languageCode;
   
BEGIN


  BEGIN
    SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
  EXCEPTION WHEN no_data_found THEN 
    v_pattern :='MM/DD/YYYY';
  END;
  
  SELECT ADD_MONTHS(TO_DATE(p_in_timeframe, v_pattern),-2) , 
         LAST_DAY(TO_DATE(p_in_timeframe, v_pattern))  
    INTO v_start_date,
         v_end_date
    FROM dual;
    
  IF p_file_name IS NULL THEN     
    OPEN p_out_result_set FOR   
      SELECT textline 
        FROM ( SELECT 1,p_header Textline
                 FROM dual
                UNION
               SELECT (ROWNUM+1),
                      c2_delimiter||org_name||c2_delimiter||c_delimiter||
                      c2_delimiter||feedback||c2_delimiter||c_delimiter||
                      c2_delimiter||date_stamp||c2_delimiter
                 FROM (SELECT n.name org_name,
                              wf.comments feedback,
                              TO_CHAR(wf.date_created, 'MM/DD/YYYY') date_stamp
                         FROM workhappier_feedback wf,
                              node n
                        WHERE wf.node_id = n.node_id
                          AND TRUNC(wf.date_created) BETWEEN v_start_date AND v_end_date 
                        ORDER BY 1,3 ASC
                      )
              );    
    p_out_return_code :=  '00' ; 

  ELSE

    p_out_return_code :=  '00' ;
    OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

    OPEN l_cursor FOR
      SELECT textline 
        FROM ( SELECT 1,p_header Textline
                 FROM dual
                UNION
               SELECT (ROWNUM+1),
                      c2_delimiter||org_name||c2_delimiter||c_delimiter||
                      c2_delimiter||feedback||c2_delimiter||c_delimiter||
                      c2_delimiter||date_stamp||c2_delimiter
                 FROM (SELECT n.name org_name,
                              wf.comments feedback,
                              TO_CHAR(wf.date_created, 'MM/DD/YYYY') date_stamp
                         FROM workhappier_feedback wf,
                              node n
                        WHERE wf.node_id = n.node_id
                          AND TRUNC(wf.date_created) BETWEEN v_start_date AND v_end_date 
                        ORDER BY 1,3 ASC
                      )
              );     

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
    file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

    LOOP  
     FETCH l_cursor INTO  v_extract;
     EXIT WHEN l_cursor%NOTFOUND;
           UTL_FILE.put_line(file_handler, v_extract);             
      
    END LOOP;

    UTL_FILE.fclose(file_handler);
 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
  END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN 
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_CONFIDENTIAL_FEEDB_EXTRACT',1,'ERROR',
        p_in_timeframe||': '||'p_in_timeframe'||p_in_languageCode ||': '||'p_in_languageCode '||
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
        ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_CONFIDENTIAL_FEEDB_EXTRACT;
PROCEDURE PRC_HAPPINESS_PULSE_EXTRACT
(p_in_timeframe        IN  VARCHAR2,  
  p_in_languageCode     IN  VARCHAR, 
  p_file_name           IN  VARCHAR2,
  p_header              IN  VARCHAR2,
  p_out_return_code     OUT VARCHAR2,
  p_out_result_set      OUT sys_refcursor
) IS
     
     /*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Happiness Pulse Extract'
-- Person      Date        Comments
-- ---------   ----------  -----------------------------------------------------
-- nagarajs   12/15/2015  Initial Version
-- nagarajs   02/06/2016  Bug 65550 - Display line items with hypen for groups with less than 10 total members or responses   
-- nagarajs   02/09/2016  Bug 65574 - Admin View/Reports/WorkHappier Profile - Activity trend : Report does not populate the count 
                          of the Respondent in the Admin View/Reports/WorkHappier Profile - "Three month Average" column is not populating the result.
--Ravi Dhanekula 04/13/2017 Changes requested for G6.2.
--Gorantla    03/12/2019  G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/

   -- constants
   c_delimiter      CONSTANT VARCHAR2(10) := ''',''||' ;
   c2_delimiter     CONSTANT VARCHAR2(10) := '''"''||' ;  
   file_handler     UTL_FILE.file_type;
   v_extract        VARCHAR2(4000);
   v_file_location  VARCHAR2(1000);
   directory_error  EXCEPTION;
   l_cursor         SYS_REFCURSOR;  
   v_pattern        VARCHAR2(15);  
   v_start_date     DATE;
   v_end_date       DATE;  
   p_in_locale      VARCHAR2(10) := p_in_languageCode;
   list_of_column   VARCHAR2(200);
   v_query          CLOB;
   v_stage          VARCHAR2(100);
   
BEGIN


  BEGIN
    SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
  EXCEPTION WHEN no_data_found THEN 
    v_pattern :='MM/DD/YYYY';
  END;

  v_stage := 'Get Start and End date';
  SELECT ADD_MONTHS(TO_DATE(p_in_timeframe, v_pattern),-3)+1 , 
         LAST_DAY(TO_DATE(p_in_timeframe, v_pattern))  
    INTO v_start_date,
         v_end_date
    FROM dual;

  v_stage := 'Get Dynamic column count';
  SELECT LISTAGG(start_month,' ,') WITHIN GROUP( ORDER BY start_date)||',''TOTAL'' AS THE_TOTAL' 
    INTO list_of_column
    FROM (SELECT ''''||start_month||''' as MONTH'||ROWNUM start_month, start_date
            FROM ( SELECT TO_CHAR(ADD_MONTHS (TO_DATE(p_in_timeframe, 'MM/DD/YYYY'), - (LEVEL-1)),'MM') AS start_month,
                           ADD_MONTHS (TO_DATE(p_in_timeframe, 'MM/DD/YYYY'), - (LEVEL-1)) start_date
                      FROM dual
                   CONNECT BY LEVEL  <= 3
                     ORDER BY ADD_MONTHS (TO_DATE(p_in_timeframe, 'MM/DD/YYYY'), - (LEVEL-1))
                  )
          );
   
  v_stage := 'Get Dynamic query';
  v_query  := 'SELECT Textline FROM (
  SELECT 1,'''||p_header||''' Textline
   FROM dual
  UNION    
  SELECT (ROWNUM+1), 
         '||c2_delimiter||'NODE_NAME||'||c2_delimiter||c_delimiter||'
         '||c2_delimiter||'MONTH1_NUM_OF_RESP||'||c2_delimiter||c_delimiter||'
         '||c2_delimiter||'MONTH1_NUM_OF_PAX||'||c2_delimiter||c_delimiter||'
        '||c2_delimiter||'CASE WHEN MONTH1_AVG_SCORE IS NULL THEN ''-'' ELSE'||                    --02/06/2016
         '''=LEFT(''||TO_CHAR(MONTH1_AVG_SCORE)||'||''',5)''END||'||c2_delimiter||c_delimiter||'     --02/06/2016 Added LEFT and TO_CHAR --02/09/2016 ADDED 5
        '||c2_delimiter||'MONTH2_NUM_OF_RESP||'||c2_delimiter||c_delimiter||'
         '||c2_delimiter||'MONTH2_NUM_OF_PAX||'||c2_delimiter||c_delimiter||' 
        '||c2_delimiter||'CASE WHEN MONTH2_AVG_SCORE IS NULL THEN ''-'' ELSE'||                    --02/06/2016
         '''=LEFT(''||TO_CHAR(MONTH2_AVG_SCORE)||'||''',5)''END||'||c2_delimiter||c_delimiter||'     --02/06/2016 Added LEFT and TO_CHAR --02/09/2016 ADDED 5
        '||c2_delimiter||'MONTH3_NUM_OF_RESP||'||c2_delimiter||c_delimiter||'
         '||c2_delimiter||'MONTH3_NUM_OF_PAX||'||c2_delimiter||c_delimiter||'
        '||c2_delimiter||'CASE WHEN MONTH3_AVG_SCORE IS NULL THEN ''-'' ELSE'||                    --02/06/2016
         '''=LEFT(''||TO_CHAR(MONTH3_AVG_SCORE)||'||''',5)''END||'||c2_delimiter||c_delimiter||'     --02/06/2016 Added LEFT and TO_CHAR --02/09/2016 ADDED 5
         '||c2_delimiter||'CASE WHEN THREEMONTH_AVG_SCORE IS NULL THEN ''-'' ELSE'||                    --02/06/2016
         '''=LEFT(''||TO_CHAR(THREEMONTH_AVG_SCORE)||'||''',5)''END||'||'''"'''||'                   --02/06/2016 Added LEFT and TO_CHAR --02/09/2016 ADDED 5
   FROM (SELECT NODE_NAME,
                NVL(MONTH1_NUM_OF_RESP,0) AS MONTH1_NUM_OF_RESP,
                NVL(MONTH1_NUM_OF_PAX,0) AS MONTH1_NUM_OF_PAX,
                CASE WHEN NVL(MONTH1_NUM_OF_RESP,0) < 10 THEN NULL 
                ELSE DECODE(NVL(MONTH1_NUM_OF_RESP,0),0,0,ROUND((NVL(MONTH1_SUM_OF_SCORE,0)/NVL(MONTH1_NUM_OF_RESP,0)),2))
                END MONTH1_AVG_SCORE,
                NVL(MONTH2_NUM_OF_RESP,0) AS MONTH2_NUM_OF_RESP,
                NVL(MONTH2_NUM_OF_PAX,0) AS MONTH2_NUM_OF_PAX,
                CASE WHEN NVL(MONTH2_NUM_OF_RESP,0) < 10 THEN NULL 
                ELSE DECODE(NVL(MONTH2_NUM_OF_RESP,0),0,0,ROUND((NVL(MONTH2_SUM_OF_SCORE,0)/NVL(MONTH2_NUM_OF_RESP,0)),2)) 
                END MONTH2_AVG_SCORE,
                NVL(MONTH3_NUM_OF_RESP,0) AS MONTH3_NUM_OF_RESP,
                NVL(MONTH3_NUM_OF_PAX,0) AS MONTH3_NUM_OF_PAX,
                CASE WHEN NVL(MONTH3_NUM_OF_RESP,0) < 10 THEN NULL 
                ELSE DECODE(NVL(MONTH3_NUM_OF_RESP,0),0,0,ROUND((NVL(MONTH3_SUM_OF_SCORE,0)/NVL(MONTH3_NUM_OF_RESP,0)),2)) 
                END MONTH3_AVG_SCORE,
                CASE WHEN NVL(THE_TOTAL_NUM_OF_RESP,0) < 10 THEN NULL         --02/06/2016
                ELSE                                                         --02/06/2016
                DECODE(NVL(THE_TOTAL_NUM_OF_RESP,0),0,0,ROUND((NVL(THE_TOTAL_SUM_OF_SCORE,0)/NVL(THE_TOTAL_NUM_OF_RESP,0)),2)) 
                END                                                          --02/06/2016
                THREEMONTH_AVG_SCORE
          FROM (SELECT NVL(NODE_NAME,''Total'') NODE_NAME,
                       SUM(MONTH1_NUM_OF_RESP) as MONTH1_NUM_OF_RESP,
                       SUM(MONTH1_NUM_OF_PAX) as MONTH1_NUM_OF_PAX,
                       SUM(MONTH1_SUM_OF_SCORE) as MONTH1_SUM_OF_SCORE,
                       SUM(MONTH2_NUM_OF_RESP)  as MONTH2_NUM_OF_RESP,
                       SUM(MONTH2_NUM_OF_PAX)  as MONTH2_NUM_OF_PAX,
                       SUM(MONTH2_SUM_OF_SCORE)  as MONTH2_SUM_OF_SCORE,
                       SUM(MONTH3_NUM_OF_RESP)  as MONTH3_NUM_OF_RESP,
                       SUM(MONTH3_NUM_OF_PAX)  as MONTH3_NUM_OF_PAX,
                       SUM(MONTH3_SUM_OF_SCORE)  as MONTH3_SUM_OF_SCORE,
                       SUM(THE_TOTAL_NUM_OF_PAX)  as THE_TOTAL_NUM_OF_PAX,
                       SUM(THE_TOTAL_NUM_OF_RESP)  as THE_TOTAL_NUM_OF_RESP,
                       SUM(THE_TOTAL_SUM_OF_SCORE)  as THE_TOTAL_SUM_OF_SCORE
                  FROM (SELECT NVL(NODE_NAME,''TOTAL'') NODE_NAME,
                                MONTH1_NUM_OF_RESP,
                                MONTH1_NUM_OF_PAX,
                                MONTH1_SUM_OF_SCORE,
                                MONTH2_NUM_OF_RESP,
                                MONTH2_NUM_OF_PAX,
                                MONTH2_SUM_OF_SCORE,
                                MONTH3_NUM_OF_RESP,
                                MONTH3_NUM_OF_PAX,
                                MONTH3_SUM_OF_SCORE,
                                THE_TOTAL_NUM_OF_PAX,
                                THE_TOTAL_NUM_OF_RESP,
                                THE_TOTAL_SUM_OF_SCORE
                          FROM (
                            SELECT node_name,
--                                       CASE GROUPING(TO_CHAR(month_created,''MM'')) WHEN 0 THEN TO_CHAR(month_created,''MM'') else NULL END month_created,
                                       TO_CHAR(month_created,''MM'') AS month_created,
                                       SUM(CASE WHEN score is not null then 1 else 0 END) NUM_OF_RESP,
                                       COUNT(DISTINCT user_id) num_of_pax,
                                       SUM(score) score 
                                  FROM rpt_work_happier_detail WHERE month_created BETWEEN '''||v_start_date||''' and '''||v_end_date||'''
                                 GROUP BY node_name,TO_CHAR(month_created,''MM'')                                 
                                 UNION ALL                                 
                                 SELECT node_name,
                                       ''TOTAL'' AS month_created,
                                       SUM(CASE WHEN score is not null then 1 else 0 END) NUM_OF_RESP,
                                       COUNT(DISTINCT user_id) num_of_pax,
                                       SUM(score) score 
                                  FROM (SELECT NODE_NAME,USER_ID,AVG(SCORE) score FROM rpt_work_happier_detail WHERE month_created BETWEEN '''||v_start_date||''' and '''||v_end_date||'''
                                 GROUP BY node_name,user_id) group by node_name
                                )
                         PIVOT (MAX(NUM_OF_RESP) as NUM_OF_RESP ,MAX(NUM_OF_PAX) as NUM_OF_PAX, MAX(SCORE) as SUM_OF_SCORE for(month_created) IN ('||list_of_column||') )
                       )
                 GROUP BY ROLLUP(NODE_NAME)
               )
               )
               )';

DBMS_OUTPUT.PUT_LINE(V_QUERY);
  IF p_file_name IS NULL THEN     
    OPEN p_out_result_set FOR v_query;
    p_out_return_code :=  '00' ; 

  ELSE

    p_out_return_code :=  '00' ;
    OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

    OPEN l_cursor FOR v_query;

  -- start AWS changes 03/12/2019
  prc_set_gv_client_aws;
      
	IF gv_client_aws = 1 THEN
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_datadump);
	ELSE  
		v_file_location := fnc_get_dir_name_like(gc_dir_path_like_reports);
	END IF;
  --end AWS changes 03/12/2019    
    file_handler := UTL_FILE.fopen(v_file_location, p_file_name, 'w',4096);

    LOOP  
     FETCH l_cursor INTO  v_extract;
     EXIT WHEN l_cursor%NOTFOUND;
           UTL_FILE.put_line(file_handler, v_extract);             
      
    END LOOP;

    UTL_FILE.fclose(file_handler);
 
  --start AWS changes 03/12/2019
  IF gv_client_aws = 1 THEN    
    prc_set_gv_report_s3_bucket;
     
    SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
           p_bucket_name    =>  gv_report_s3_bucket,
           p_prefix         =>  p_file_name, 
           p_s3_prefix      =>  '', 
           p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
      INTO gv_aws_task_id
      FROM DUAL; 
  END IF;   
  --end AWS changes 03/12/2019
  END IF;


EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN 
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_HAPPINESS_PULSE_EXTRACT',1,'ERROR',
        p_in_timeframe||': '||'p_in_timeframe'||p_in_languageCode ||': '||'p_in_languageCode '||
        p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM
        ,null);
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END PRC_HAPPINESS_PULSE_EXTRACT;

PROCEDURE PRC_BEHAVIOR_EXTRACT
 ( parentNodeId         IN VARCHAR2,       
   p_in_pax_status      IN VARCHAR2,
   Is_team              IN NUMBER,
   p_paxid              IN NUMBER,
   p_in_promotion_Id    IN VARCHAR2,   
   p_in_position_type   IN VARCHAR2,
   p_in_department      IN VARCHAR2,    
   p_giverReceiver      IN VARCHAR2,
   p_in_from_date       IN VARCHAR2,
   p_in_to_date         IN VARCHAR2,   
   locale               IN VARCHAR2,
   p_file_name          IN VARCHAR2,
   p_header             IN VARCHAR2,
   p_out_return_code    OUT varchar2,
   p_out_result_set     OUT sys_refcursor
 )
   IS
/*******************************************************************************
-- Purpose: 
-- This procedure returns the result set which will be used for 'Behavior Extract'
-- Person       Date         Comments
-- ---------   ----------    -----------------------------------------------------
-- nagarajs    04/27/2016    Initial Version  
- -nagarajs    01/16/2017    Rewritten for perfoamnce changes in 5.6.3.3 
-- Gorantla    03/12/2019	 G6-1446  AWS - Enable Large Audience functionality.
****************************************************************************/

  -- constants
  c_delimiter      CONSTANT VARCHAR2(1) := ',' ;
  c2_delimiter     CONSTANT VARCHAR2(1) := '"' ;
  
  -- local variables
  file_handler    UTL_FILE.file_type;
  v_extract       VARCHAR2(4000);
  v_file_location VARCHAR2(1000);
  directory_error exception;
  p_in_locale     VARCHAR2(10) :=locale;
  v_pattern       VARCHAR2(15);
  v_stage           VARCHAR2(1000);
  v_directory_name  all_directories.directory_name%TYPE;
  v_default_locale OS_PROPERTYSET.STRING_VAL%TYPE;   --04/15/2019  Bug 73732
    
  l_cursor        SYS_REFCURSOR;
BEGIN

BEGIN                                                   --04/15/2019  Bug 73732
    SELECT string_val 
      INTO v_default_locale
      FROM os_propertyset
     WHERE entity_name = 'default.language';
  EXCEPTION
    WHEN OTHERS THEN
       v_default_locale := 'en_US';
  END;            

DELETE temp_table_session;
--INSERT INTO temp_table_session
--    SELECT asset_code,cms_value,key FROM mv_cms_asset_value WHERE key='COUNTRY_NAME' AND locale = p_in_locale;
    
    INSERT INTO temp_table_session
SELECT asset_code, cms_value, key
  FROM (SELECT asset_code,
               cms_value,
               key,
               RANK ()                                                   --04/15/2019  Bug 73732
               OVER (PARTITION BY asset_code
                     ORDER BY DECODE (p_in_locale, locale, 1, 2))     
                   rn
          FROM VW_CMS_ASSET_VALUE
         WHERE     key = 'COUNTRY_NAME'
               AND locale IN (p_in_locale, v_default_locale))
 WHERE rn = 1; 

--INSERT INTO temp_table_session
--SELECT asset_code,cms_value,key 
--      FROM mv_cms_asset_value 
-- WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
--                        WHERE promotion_type IN ('recognition', 'nomination')
--                    )
--   AND locale = p_in_locale
-- UNION  
--SELECT asset_code,cms_name,cms_code
--     FROM mv_cms_code_value E
-- WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items','picklist.promo.recognition.behavior.items','picklist.promo.nomination.behavior.items')   
--   AND e.locale=p_in_locale;


INSERT INTO temp_table_session ---- --04/15/2019  Bug 73732 starts
    select asset_code,cms_value,key from 
    (SELECT asset_code,cms_value,key,RANK() OVER(PARTITION BY asset_code ORDER BY DECODE(p_in_locale,locale,1,2)) rn FROM VW_CMS_ASSET_VALUE             --09/01/2017     Wip 36502
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p
                            WHERE promotion_type in  ('recognition','nomination')
                        )
    AND locale in (p_in_locale,v_default_locale)
UNION   --09/18/2014 
SELECT asset_code,cms_name,cms_code,RANK() OVER(PARTITION BY asset_code, cms_code ORDER BY DECODE(p_in_locale,locale,1,2)) rn                     --09/01/2017     Wip 36502
FROM vw_cms_code_value E
WHERE asset_code in ('picklist.department.type.items','picklist.positiontype.items','picklist.promo.recognition.behavior.items','picklist.promotion.approval.option.reason.type.items')    --10/27/2014 --03/28/2016 Bug#66208
and e.locale in (p_in_locale,v_default_locale)) where rn=1; -- --04/15/2019  Bug 73732 ends


DELETE chacracteristics_cms;                                  
INSERT INTO chacracteristics_cms
SELECT c.characteristic_id,vw.cms_name,vw.cms_code 
      FROM characteristic c,mv_cms_code_value vw 
 WHERE pl_name is not null 
   AND vw.asset_code = c.pl_name AND locale = p_in_locale
 UNION 
SELECT characteristic_id,characteristic_value cms_name,characteristic_value cms_code 
  FROM user_characteristic 
 WHERE characteristic_id in (select characteristic_id from characteristic where pl_name is null)
 UNION
SELECT characteristic_id,cms_name,cms_code 
  FROM rpt_user_characteristic
 WHERE locale = p_in_locale;

BEGIN
SELECT pattern INTO v_pattern FROM locale_date_pattern WHERE locale=p_in_locale;
  EXCEPTION WHEN NO_DATA_FOUND THEN 
v_pattern :='MM/DD/YYYY';
END;

OPEN p_out_result_set FOR
     -- column headers
     SELECT textline FROM (
        SELECT 1,p_header 
         Textline
        FROM dual
      UNION
      SELECT   (ROWNUM+1),
       c2_delimiter||DATE_SUBMITTED||c2_delimiter||c_delimiter||
       c2_delimiter||PROMOTION_NAME||c2_delimiter||c_delimiter||
       c2_delimiter||BEHAVIOR||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_LOGIN_ID||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_FIRST_NAME||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_MIDDLE_NAME||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_LAST_NAME||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_COUNTRY||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_PRIMARY_ORG_UNIT||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_DEPARTMENT||c2_delimiter||c_delimiter||
       c2_delimiter||RECVR_JOB_POSITION||c2_delimiter||c_delimiter||
       c2_delimiter||GIVER_LOGIN_ID||c2_delimiter||c_delimiter|| 
       c2_delimiter||GIVER_FIRST_NAME||c2_delimiter||c_delimiter||
       c2_delimiter||GIVER_MIDDLE_NAME||c2_delimiter||c_delimiter||
       c2_delimiter||GIVER_LAST_NAME||c2_delimiter||c_delimiter||
           c2_delimiter||PROXY_FIRST_NAME||c2_delimiter||c_delimiter|| 
           c2_delimiter||PROXY_LAST_NAME||c2_delimiter||c_delimiter||  
       c2_delimiter||GIVER_COUNTRY||c2_delimiter||c_delimiter||
       c2_delimiter||GIVER_PRIMARY_ORG_UNIT||c2_delimiter||c_delimiter||
       c2_delimiter||GIVER_DEPARTMENT||c2_delimiter||c_delimiter||
       c2_delimiter||GIVER_JOB_POSITION||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR1||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR2||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR3||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR4||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR5||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR6||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR7||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR8||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR9||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR10||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR11||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR12||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR13||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR14||c2_delimiter||c_delimiter||
       c2_delimiter||PAX_CHAR15||c2_delimiter
  FROM (SELECT Date_submitted,
               (select cms_name from temp_table_session where asset_code = p.promo_name_asset_code) promotion_name, 
                behavior, 
                recvr_first_name,
                recvr_middle_name,
                recvr_last_name,
                recvr_login_id,
                (select cms_name from temp_table_session where asset_code=c.cm_asset_code) recvr_country,
                (SELECT node_name FROM rpt_hierarchy WHERE node_id = recvr_node_id) recvr_primary_org_unit,
                (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= recvr_job_position) AS recvr_job_position,  
                (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= recvr_department) AS recvr_department,  
                giver_first_name,
                giver_middle_name,
                giver_last_name,
                giver_login_id,
                    proxy_first_name, 
                    proxy_last_name, 
                (select cms_name from temp_table_session where asset_code=c1.cm_asset_code) giver_country,    
                (SELECT node_name FROM rpt_hierarchy WHERE node_id = giver_node_id) giver_primary_org_unit,
                (select cms_name from temp_table_session where asset_code='picklist.positiontype.items' and cms_code= giver_job_position) AS giver_job_position,  
                (select cms_name from temp_table_session where asset_code='picklist.department.type.items' and cms_code= giver_department) AS giver_department,    
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id1 and cms_code=rch.characteristic_charvalue1) AS PAX_CHAR1,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id2 and cms_code=rch.characteristic_charvalue2) AS PAX_CHAR2,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id3 and cms_code=rch.characteristic_charvalue3) AS PAX_CHAR3,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id4 and cms_code=rch.characteristic_charvalue4) AS PAX_CHAR4,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id5 and cms_code=rch.characteristic_charvalue5) AS PAX_CHAR5,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id6 and cms_code=rch.characteristic_charvalue6) AS PAX_CHAR6,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id7 and cms_code=rch.characteristic_charvalue7) AS PAX_CHAR7,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id8 and cms_code=rch.characteristic_charvalue8) AS PAX_CHAR8,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id9 and cms_code=rch.characteristic_charvalue9) AS PAX_CHAR9,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id10 and cms_code=rch.characteristic_charvalue10) AS PAX_CHAR10,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id11 and cms_code=rch.characteristic_charvalue11) AS PAX_CHAR11,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id12 and cms_code=rch.characteristic_charvalue12) AS PAX_CHAR12,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id13 and cms_code=rch.characteristic_charvalue13) AS PAX_CHAR13,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id14 and cms_code=rch.characteristic_charvalue14) AS PAX_CHAR14,
                (select cms_name from chacracteristics_cms where characteristic_id=rch.characteristic_id15 and cms_code=rch.characteristic_charvalue15) AS PAX_CHAR15
   FROM (SELECT date_submitted,
               promotion_id,
               recvr_user_id,
               recvr_first_name,
               recvr_middle_name,
               recvr_last_name,
               recvr_login_id,
               recvr_country_id,
               recvr_node_id,
               recvr_node_name,
               recvr_job_position,
               recvr_department,
               recvr_pax_status,
               giver_user_id,
               giver_first_name,
               giver_middle_name,
               giver_last_name,
               giver_login_id, 
               giver_country_id,
               giver_node_id,
               giver_node_name,
               giver_job_position,
               giver_department,
               giver_pax_status,
               claim_id,
               LISTAGG(behavior_name,', ') WITHIN GROUP (ORDER BY behavior_name) behavior,
                           proxy_first_name, 
                           proxy_last_name  
          FROM (SELECT r.*,
                       CASE WHEN p.promotion_type = 'recognition' THEN
                         (SELECT cms_name FROM temp_table_session WHERE asset_code = ('picklist.promo.recognition.behavior.items')
                        and cms_code= behavior)
                        ELSE
                        (SELECT cms_name FROM temp_table_session WHERE asset_code = ('picklist.promo.nomination.behavior.items')
                        and cms_code= behavior)
                       END AS behavior_name
                  FROM rpt_behavior_detail r,
                       promotion p
                 WHERE r.promotion_id = p.promotion_id 
               )
         GROUP BY date_submitted,
               promotion_id,
               promotion_id,
               recvr_user_id,
               recvr_first_name,
               recvr_middle_name,
               recvr_last_name,
               recvr_login_id,
               recvr_country_id,
               recvr_node_id,
               recvr_node_name,
               recvr_job_position,
               recvr_department,
               recvr_pax_status,
               giver_user_id,
               giver_first_name,
               giver_middle_name,
               giver_last_name,
               giver_login_id, 
                           proxy_first_name, 
                           proxy_last_name, 
               giver_country_id,
               giver_node_id,
               giver_node_name,
               giver_job_position,
               giver_department,
               giver_pax_status,
                           claim_id 
                   ) rd,
        promotion p,
        rpt_characteristic rch,
        country c,
        country c1
  WHERE rd.promotion_id         = p.promotion_id
    AND rd.recvr_country_id   = c.country_id
    AND rd.giver_country_id   = c1.country_id
    AND rch.user_nt_id(+)     = DECODE (p_giverReceiver, 'receiver', rd.recvr_user_id, 'giver', rd.giver_user_id)
    AND rch.characteristic_type (+) = 'USER'   
    AND ((p_in_promotion_Id IS NULL) OR rd.promotion_id IN (SELECT * FROM TABLE(get_array_varchar(p_in_promotion_Id))))    
    AND DECODE (p_giverReceiver, 'receiver', recvr_pax_status, 'giver', giver_pax_status)     = NVL ( p_in_pax_status, DECODE (p_giverReceiver, 'receiver', recvr_pax_status, 'giver', giver_pax_status))
    AND DECODE (p_giverReceiver, 'receiver', NVL(recvr_job_position,'job'), 'giver', NVL(giver_job_position,'job')) = NVL ( p_in_position_type, DECODE (p_giverReceiver, 'receiver', NVL(recvr_job_position,'job'), 'giver', NVL(giver_job_position,'job')))  
    AND (p_in_department IS NULL OR DECODE (p_giverReceiver, 'receiver', recvr_department, 'giver', giver_department)   IN (SELECT * FROM TABLE(get_array_varchar(p_in_department))))
    AND NVL (TRUNC (date_submitted), TRUNC (SYSDATE)) BETWEEN TO_DATE(p_in_from_date,v_pattern) AND TO_DATE(p_in_to_date,v_pattern) 
    AND ( ( p_paxid IS NULL  AND ( 
                     (NVL(is_Team,0)=0 AND DECODE (p_giverReceiver, 'receiver', recvr_node_id, 'giver', giver_node_id)  IN (    SELECT child_node_id
                                             FROM rpt_hierarchy_rollup N2
                                       WHERE node_id IN (SELECT *
                                     FROM TABLE (
                                             get_array_varchar (
                                               parentNodeId)))))
                                 OR
                               (  is_Team=1 AND DECODE (p_giverReceiver, 'receiver', recvr_node_id, 'giver', giver_node_id) =parentNodeId))     
                               OR  (p_paxid IS  NOT NULL AND  DECODE (p_giverReceiver, 'receiver', recvr_user_id, 'giver', giver_user_id)=p_paxid)))
 )
) ;

-- write result set to file
   IF (p_file_name IS NOT NULL) THEN     
       -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 

      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
           UTL_FILE.put_line(file_handler, v_extract);           
END LOOP;

    UTL_FILE.fclose(file_handler);

      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_file_name IS NOT NULL
   
   p_out_return_code :=  '00' ;
EXCEPTION
    WHEN OTHERS  THEN
        IF utl_file.is_open(file_handler) THEN 
          UTL_FILE.fclose(file_handler);
        END IF;
        p_out_return_code :=  '99' ;
        prc_execution_log_entry('PRC_BEHAVIOR_EXTRACT',1,'ERROR',
        parentNodeId||': '||'parentNodeId'||p_in_pax_status||': '||'p_in_pax_status'||Is_team||': '||'Is_team'|| 
        p_paxid ||': '||'p_paxid '||p_in_promotion_Id||': '||'p_in_promotion_Id'||
        p_in_position_type ||': '||'p_in_position_type '||p_in_department||': '||'p_in_department'||
        p_giverReceiver||': '||'p_giverReceiver'||p_in_from_date||': '||'p_in_from_date'||
        p_in_to_date||': '||'p_in_to_date'||locale||': '||'locale'||p_file_name||': '||'p_file_name'||p_header||': '||'p_header'||CHR(10)||SQLERRM,null);     
        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;
END ;
PROCEDURE PRC_CASH_BUDGET_SUMARY_EXTRACT
( p_in_parentNodeId       IN VARCHAR,
  p_in_promotionId        IN VARCHAR,
  p_in_budgetStatus       IN VARCHAR,
  p_in_budgetDistribution IN VARCHAR,
  p_in_userid             IN NUMBER,  
  p_in_locale             IN VARCHAR,  
  p_in_file_name          IN VARCHAR2,
  p_in_header             IN VARCHAR2,
  p_out_return_code       OUT VARCHAR2,
  p_out_result_set        OUT SYS_REFCURSOR
) IS
/********************************************************************************
 Purpose: This procedure queries the points budget summary extract result set and writes it to file when a file name specified.
  Date               Author           Description
  ----------       -------------      ------------------------------------------------
 12/15/2016         nagarajs          Initial Creation - G5.6.3.3 Budget Redesign
 03/12/2019         Gorantla          G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/
   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_cash_budget_sumary_extract';

   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_return_code           NUMBER;
   v_data_result_set       SYS_REFCURSOR;
   v_total_result_set      SYS_REFCURSOR;
   v_total_rec             NUMBER;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   
   -- build query ref cursor record type
   CURSOR cur_data_ref IS
   SELECT CAST(NULL AS NUMBER) AS promo_id,
          CAST(NULL AS VARCHAR2(2000)) AS promo_name,
          CAST(NULL AS VARCHAR2(2000)) AS budget_master_name,
          CAST(NULL AS VARCHAR2(100)) AS budget_period,
          CAST(NULL AS NUMBER) AS original_budget,
          CAST(NULL AS NUMBER) AS budget_adjustments,
          CAST(NULL AS NUMBER) AS awarded,
          CAST(NULL AS NUMBER) AS available_balance,
          CAST(NULL AS NUMBER) AS total_records,
          CAST(NULL AS NUMBER) AS rec_seq
     FROM dual;

   rec_data_ref      cur_data_ref%ROWTYPE;

   -- in-line process
   PROCEDURE p_format_extract_rec
   ( p_in_rec_data_ref  IN cur_data_ref%ROWTYPE
   ) IS
BEGIN
      gv_tab_file_extract.EXTEND;
      gv_tab_file_extract(gv_tab_file_extract.LAST).file_rec :=
            gc_fld_delimiter || p_in_rec_data_ref.promo_name           || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_master_name   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_period         || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.original_budget       || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_adjustments     || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.awarded               || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.available_balance     || gc_fld_delimiter 
         ;
   END p_format_extract_rec;
BEGIN                                                                 
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      || '<, p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_promotionId >' || p_in_promotionId
      || '<, p_in_budgetStatus >' || p_in_budgetStatus
      || '<, p_in_budgetDistribution >' || p_in_budgetDistribution
      || '<, p_in_userid >' || p_in_userid              
      || '<, p_in_locale >' || p_in_locale
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

   -- get data as displayed on screen
   v_stage := 'call prc_getBalanceTabRes';
   pkg_query_cash_budget_balance.prc_getBalanceTabRes
   ( p_in_locale,
     1000000,
     0,
     p_in_parentNodeId,
     p_in_promotionId,
     p_in_budgetStatus,
     p_in_budgetDistribution,
     p_in_userid,  
     NULL,  -- p_in_sortColName
     NULL,  -- p_in_sortedBy
     v_return_code,
     v_data_result_set,
--     v_total_rec,
     v_total_result_set
   );

   IF (v_return_code != gc_return_code_success) THEN
      RAISE_APPLICATION_ERROR(-20100, 'Process call failed');
   END IF;
         
   -- initialize extract formatting
   v_stage := 'initialize extract formatting';
   gv_tab_file_extract := tab_file_extract();
   gv_tab_file_extract.EXTEND;
   gv_tab_file_extract(1).file_rec := p_in_header;

   -- format summary data for extract
   v_stage := 'FETCH v_data_result_set';
   LOOP
      FETCH v_data_result_set INTO rec_data_ref;
      EXIT WHEN (v_data_result_set%NOTFOUND); 
      p_format_extract_rec(rec_data_ref);
   END LOOP;
                                                    
   IF (p_in_file_name IS NULL) THEN     
      -- return extract via output ref cursor
      v_stage := 'OPEN p_out_result_set';
      OPEN p_out_result_set FOR
      SELECT fr.file_rec AS textline
        FROM TABLE(fnc_pipe_file_records) fr;

   ELSE
      -- write result set to file
      -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 

      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      -- loop through file records
      FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
         UTL_FILE.put_line(file_handler, gv_tab_file_extract(indx).file_rec);           
      END LOOP;

      UTL_FILE.fclose(file_handler);

      --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019    
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;
                              
EXCEPTION
   WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      p_out_return_code := gc_return_code_failure;
                             
      IF UTL_FILE.is_open(file_handler) THEN
         UTL_FILE.fclose(file_handler);
END IF;    

OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

END PRC_CASH_BUDGET_SUMARY_EXTRACT;
                                                     
PROCEDURE PRC_CASH_BUDGET_SUMDTL_EXTRACT
( p_in_parentNodeId       IN VARCHAR,
  p_in_promotionId        IN VARCHAR,
  p_in_budgetStatus       IN VARCHAR,
  p_in_budgetDistribution IN VARCHAR,
  p_in_userid             IN NUMBER, 
  p_in_locale             IN VARCHAR,   
  p_in_file_name          IN VARCHAR2,
  p_in_header             IN VARCHAR2,
  p_out_return_code       OUT VARCHAR2,
  p_out_result_set        OUT SYS_REFCURSOR
) IS
/********************************************************************************
 Purpose: This procedure queries the cash budget summary detail extract result set and writes it to file when a file name specified.
  Date               Author           Description
  ----------       -------------      ------------------------------------------------
 12/15/2016         nagarajs           Initial Creation - G5.6.3.3 Budget Redesign
 03/12/2019         Gorantla          G6-1446  AWS - Enable Large Audience functionality.
*******************************************************************************/
   -- constants
   c_process_name          CONSTANT execution_log.process_name%TYPE := 'prc_cash_budget_sumdtl_extract';
                                                     
   -- local variables
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_return_code           NUMBER;
   v_data_result_set       SYS_REFCURSOR;
   v_total_result_set      SYS_REFCURSOR;
   v_total_rec             NUMBER;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   
                     
   -- build query ref cursor record type
   CURSOR cur_data_ref IS
   SELECT CAST(NULL AS VARCHAR2(4000)) AS budget_owner_name,
          CAST(NULL AS VARCHAR2(2000)) AS budget_master_name,
          CAST(NULL AS VARCHAR2(100)) AS budget_period,
          CAST(NULL AS NUMBER) AS original_budget,
          CAST(NULL AS NUMBER) AS budget_adjustments,
          CAST(NULL AS NUMBER) AS awarded,
          CAST(NULL AS NUMBER) AS available_balance,
          CAST(NULL AS NUMBER) AS total_records,
          CAST(NULL AS NUMBER) AS rec_seq
     FROM dual;
                             
   rec_data_ref      cur_data_ref%ROWTYPE;
                              
   -- in-line process
   PROCEDURE p_format_extract_rec
   ( p_in_rec_data_ref  IN cur_data_ref%ROWTYPE
   ) IS
   BEGIN
      gv_tab_file_extract.EXTEND;
      gv_tab_file_extract(gv_tab_file_extract.LAST).file_rec :=
            gc_fld_delimiter || p_in_rec_data_ref.budget_owner_name    || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_master_name   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_period        || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.original_budget      || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.budget_adjustments   || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.awarded              || gc_fld_delimiter || gc_fld_separator
         || gc_fld_delimiter || p_in_rec_data_ref.available_balance    || gc_fld_delimiter 
         ;
   END p_format_extract_rec;
 BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      || '<, p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_promotionId >' || p_in_promotionId
      || '<, p_in_budgetStatus >' || p_in_budgetStatus
      || '<, p_in_budgetDistribution >' || p_in_budgetDistribution
      || '<, p_in_userid >' || p_in_userid
      || '<, p_in_locale >' || p_in_locale              
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';
  
   -- get data as displayed on screen
   v_stage := 'call prc_getBalanceByPromoTabRes';
   pkg_query_cash_budget_balance.prc_getBalanceByPromoTabRes
   ( p_in_locale,
     1000000,
     0,
     p_in_parentNodeId,
     p_in_promotionId,
     p_in_budgetStatus,
     p_in_budgetDistribution,
     p_in_userid,  
     NULL,  -- p_in_sortColName
     NULL,  -- p_in_sortedBy
     v_return_code,
     v_data_result_set,
--     v_total_rec,
     v_total_result_set
   );


   IF (v_return_code != gc_return_code_success) THEN
      RAISE_APPLICATION_ERROR(-20100, 'Process call failed');
   END IF;

   -- initialize extract formatting
   v_stage := 'initialize extract formatting';
   gv_tab_file_extract := tab_file_extract();
   gv_tab_file_extract.EXTEND;
   gv_tab_file_extract(1).file_rec := p_in_header;

   -- format summary data for extract
   v_stage := 'FETCH v_data_result_set';
LOOP  
      FETCH v_data_result_set INTO rec_data_ref;
      EXIT WHEN (v_data_result_set%NOTFOUND); 

      p_format_extract_rec(rec_data_ref);
   END LOOP;

   IF (p_in_file_name IS NULL) THEN     
      -- return extract via output ref cursor
      v_stage := 'OPEN p_out_result_set';
      OPEN p_out_result_set FOR
      SELECT fr.file_rec AS textline
        FROM TABLE(fnc_pipe_file_records) fr;
      
   ELSE
      -- write result set to file
      -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 
      
      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
      -- loop through file records
      FOR indx IN gv_tab_file_extract.FIRST .. gv_tab_file_extract.LAST LOOP
         UTL_FILE.put_line(file_handler, gv_tab_file_extract(indx).file_rec);           
END LOOP;

    UTL_FILE.fclose(file_handler);
 --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket;
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019  
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := gc_return_code_success;

EXCEPTION
    WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, gc_release_level, gc_error, v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      p_out_return_code := gc_return_code_failure;

      IF UTL_FILE.is_open(file_handler) THEN
          UTL_FILE.fclose(file_handler);
        END IF;

        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

END PRC_CASH_BUDGET_SUMDTL_EXTRACT;

PROCEDURE PRC_CASH_BUDGET_ISSU_EXTRACT
   (  p_in_parentNodeId       IN VARCHAR,
      p_in_promotionId        IN VARCHAR,
      p_in_budgetStatus       IN VARCHAR,
      p_in_budgetDistribution IN VARCHAR,
      p_in_userid            IN NUMBER,  
      p_in_locale             IN VARCHAR,  
      p_in_file_name          IN VARCHAR2,
      p_in_header             IN VARCHAR2,
      p_out_return_code       OUT VARCHAR2,
      p_out_result_set        OUT SYS_REFCURSOR
    )
   IS
/********************************************************************************
 Purpose: This procedure extract result set of cash budget issuance and writes it to file when a file name specified.
  Date               Author           Description
  ----------       -------------      ------------------------------------------------
 12/15/2016         nagarajs           Initial Creation - G5.6.3.3 Budget Redesign
 02/01/2017         Suresh J           Bug 71040  - First and Last names should be separate columns
 03/13/2017         Suresh J           G6-1935    - The budget issuance extract shows null values in Participant characteristics columns 
 03/12/2019         Gorantla          G6-1446  AWS - Enable Large Audience functionality.
 04/09/2019         DeepakrajS       Bug 75188  Fixed Cash currency currency value issue
*******************************************************************************/

   PRAGMA AUTONOMOUS_TRANSACTION;
   -- constants
   c_delimiter CONSTANT VARCHAR2(1) := ',' ;
   c2_delimiter CONSTANT VARCHAR2(1) := '"' ;
   c_process_name           CONSTANT execution_log.process_name%TYPE := 'prc_cash_budget_issu_extract';

   -- local variables
   v_cash_currency_value   cash_currency_current.bpom_entered_rate%TYPE;  
   v_extract               VARCHAR2(4000);
   v_stage                 execution_log.text_line%TYPE;
   v_parm_list             execution_log.text_line%TYPE;
   v_directory_name        all_directories.directory_name%TYPE;
   file_handler            utl_file.file_type;
   v_locale                locale_date_pattern.locale%TYPE;
   v_pattern               locale_date_pattern.pattern%TYPE;
   
BEGIN
   -- initialize variables
   v_stage := 'initialize variables';
   v_parm_list := '~Parms'
      || '<, p_in_parentNodeId >' || p_in_parentNodeId
      || '<, p_in_promotionId >' || p_in_promotionId
      || '<, p_in_budgetStatus >' || p_in_budgetStatus
      || '<, p_in_budgetDistribution >' || p_in_budgetDistribution
      || '<, p_in_userid >' || p_in_userid              
      || '<, p_in_file_name >' || p_in_file_name
      || '<, p_in_header >' || p_in_header
      || '<~';

DELETE FROM temp_table_session;

INSERT INTO temp_table_session
    SELECT asset_code,cms_value,key from mv_cms_asset_value where key IN ('COUNTRY_NAME','BUDGET_NAME') and locale = p_in_locale 
UNION
    SELECT asset_code,cms_value,key FROM mv_cms_asset_value 
    WHERE asset_code IN (SELECT promo_name_asset_code FROM promotion p)
AND locale = p_in_locale
UNION 
SELECT asset_code,cms_name,cms_code
    FROM mv_cms_code_value E
WHERE asset_code in ( 'picklist.budgettype.items') and e.locale = p_in_locale;

DELETE chacracteristics_cms;

INSERT INTO chacracteristics_cms
    SELECT c.characteristic_id,vw.cms_name,vw.cms_code 
      FROM characteristic c,mv_cms_code_value vw 
     WHERE pl_name is not null 
       AND vw.asset_code = c.pl_name and locale = p_in_locale
UNION 
    SELECT characteristic_id,characteristic_value cms_name,characteristic_value cms_code 
      FROM user_characteristic 
     WHERE characteristic_id in (select characteristic_id from characteristic where pl_name is null)
UNION
    SELECT characteristic_id,cms_name,cms_code 
      FROM rpt_user_characteristic
WHERE locale = p_in_locale;

   v_stage := 'stage input lists';
   DELETE gtt_id_list;
   pkg_report_common.p_stage_search_criteria(NVL(p_in_parentNodeId, pkg_report_common.f_get_root_node), gc_ref_text_parent_node_id, 1); 
   pkg_report_common.p_stage_search_criteria(NVL(p_in_budgetStatus, gc_search_all_values), gc_ref_text_budget_status, 1);
   pkg_report_common.p_stage_search_criteria(NVL(p_in_promotionId, gc_search_all_values), gc_ref_text_promotion_id, 1);
   
BEGIN
    SELECT pattern 
      INTO v_pattern 
      FROM locale_date_pattern 
     WHERE locale=p_in_locale;
  EXCEPTION 
    WHEN no_data_found THEN 
v_pattern :='MM/DD/YYYY';
END;

  v_stage := 'Get currency value';
  BEGIN    
     SELECT ccc.bpom_entered_rate
       INTO v_cash_currency_value
       FROM user_address ua,
            country c,
            cash_currency_current ccc 
      WHERE ua.user_id = p_in_userid
        AND is_primary = 1
        AND ua.country_id = c.country_id
        --AND c.country_code = ccc.to_cur; --04/09/2019
        AND c.currency_code = ccc.to_cur;  --04/09/2019
  EXCEPTION
     WHEN OTHERS THEN
       v_cash_currency_value := 1;
  END;          

OPEN p_out_result_set FOR    
    -- format the extract record
    SELECT p_in_header AS textline
        FROM dual
     UNION ALL 
    SELECT c2_delimiter||budget_master_name||c2_delimiter||c_delimiter||
           c2_delimiter||budget_type||c2_delimiter||c_delimiter||
           c2_delimiter||budget_owner||c2_delimiter||c_delimiter||
           c2_delimiter||award_date||c2_delimiter||c_delimiter||
           --c2_delimiter||recipient_name||c2_delimiter||c_delimiter||          --02/01/2017
           c2_delimiter||recipient_first_name||c2_delimiter||c_delimiter||      --02/01/2017
           c2_delimiter||recipient_last_name ||c2_delimiter||c_delimiter||      --02/01/2017     
           c2_delimiter||recvr_country||c2_delimiter||c_delimiter||
           c2_delimiter||award_amount||c2_delimiter||c_delimiter||
         c2_delimiter||promotion_name||c2_delimiter||c_delimiter||
           c2_delimiter||recvr_org_unit||c2_delimiter||c_delimiter||  
         c2_delimiter||pax_char1||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char2||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char3||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char4||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char5||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char6||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char7||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char8||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char9||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char10||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char11||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char12||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char13||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char14||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char15||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char16||c2_delimiter||c_delimiter||       
       c2_delimiter||pax_char17||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char18||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char19||c2_delimiter||c_delimiter||
       c2_delimiter||pax_char20||c2_delimiter      
      FROM ( SELECT  (SELECT cms_name FROM temp_table_session WHERE asset_code=bm.cm_asset_code) AS budget_master_name,
                     (SELECT cms_name FROM temp_table_session WHERE asset_code='picklist.budgettype.items' AND cms_code=bm.budget_type) AS budget_type,       
                     DECODE (bm.budget_type,'pax', au.last_name || ' , ' || au.first_name, n.name) AS budget_owner,
                     TRUNC (rad.trans_date) AS award_date,
                     rad.recipient_name AS recipient_name,
                     rad.recipient_first_name,          --02/01/2017
                     rad.recipient_last_name,           --02/01/2017
                     (SELECT cms_name FROM temp_table_session WHERE asset_code=c.cm_asset_code) AS recvr_country, 
                     ROUND(rad.trans_amount * v_cash_currency_value, 2) AS award_amount,
                     (SELECT cms_name FROM temp_table_session WHERE asset_code = p.promo_name_asset_code) AS promotion_name, 
                     (SELECT node_name FROM rpt_hierarchy WHERE node_id = un.node_id) AS recvr_org_unit,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id1 AND cms_code=rch.characteristic_charvalue1) AS pax_char1,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id2 AND cms_code=rch.characteristic_charvalue2) AS pax_char2,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id3 AND cms_code=rch.characteristic_charvalue3) AS pax_char3,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id4 AND cms_code=rch.characteristic_charvalue4) AS pax_char4,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id5 AND cms_code=rch.characteristic_charvalue5) AS pax_char5,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id6 AND cms_code=rch.characteristic_charvalue6) AS pax_char6,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id7 AND cms_code=rch.characteristic_charvalue7) AS pax_char7,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id8 AND cms_code=rch.characteristic_charvalue8) AS pax_char8,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id9 AND cms_code=rch.characteristic_charvalue9) AS pax_char9,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id10 AND cms_code=rch.characteristic_charvalue10) AS pax_char10,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id11 AND cms_code=rch.characteristic_charvalue11) AS pax_char11,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id12 AND cms_code=rch.characteristic_charvalue12) AS pax_char12,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id13 AND cms_code=rch.characteristic_charvalue13) AS pax_char13,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id14 AND cms_code=rch.characteristic_charvalue14) AS pax_char14,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id15 AND cms_code=rch.characteristic_charvalue15) AS pax_char15,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id16 AND cms_code=rch.characteristic_charvalue16) AS pax_char16,    
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id17 AND cms_code=rch.characteristic_charvalue17) AS pax_char17,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id18 AND cms_code=rch.characteristic_charvalue18) AS pax_char18,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id19 AND cms_code=rch.characteristic_charvalue19) AS pax_char19,
                     (SELECT cms_name FROM chacracteristics_cms WHERE characteristic_id=rch.characteristic_id20 AND cms_code=rch.characteristic_charvalue20) AS pax_char20     
                FROM rpt_cash_budget_trans_detail rad,
         promotion p,
         budget_master bm,
         budget b,
         application_user au,
         user_node un,
         rpt_characteristic rch,        
         node n,
                     country c,
                     rpt_hierarchy_rollup hr,
                     gtt_id_list gil_hr, -- hierarchy rollup
                     gtt_id_list gil_b,  -- budget status
                     gtt_id_list gil_p  -- promotion
               WHERE rad.promotion_id = p.promotion_id(+)
                 AND ((p_in_promotionId IS NULL AND p.promotion_status IN('live','expired')) 
                      OR (p_in_promotionId IS NOT NULL AND p.promotion_status = 'live'))
         AND rad.budget_master_id = bm.budget_master_id
                 AND bm.multi_promotion = NVL ( DECODE (p_in_budgetdistribution,'one_to_one', 0, 'shared', 1, NULL),bm.multi_promotion)
                 AND rad.budget_id = b.budget_id
                 AND gil_hr.ref_text_1 = gc_ref_text_parent_node_id
                 AND gil_hr.id = hr.node_id (+)
                 AND hr.child_node_id = un.node_id
                 AND gil_p.ref_text_1 = gc_ref_text_promotion_id
                 AND (  gil_p.ref_text_2 = gc_search_all_values
                        OR gil_p.id = p.promotion_id )
                 AND gil_b.ref_text_1 = gc_ref_text_budget_status
                 AND (  gil_b.ref_text_2 = gc_search_all_values
                        OR gil_b.ref_text_2 = rad.budget_status )
         AND un.is_primary = 1   
         AND b.user_id = au.user_id(+)
         --AND rch.user_nt_id (+) = au.user_id        --03/13/2017
         AND rch.user_nt_id (+) = recipient_user_id   --03/13/2017    
         AND rad.recipient_user_id = un.user_id
         AND b.node_id = n.node_id(+)
         AND rad.recipient_country_id = c.country_id
            ORDER BY budget_master_name,
                     budget_type,
                     budget_owner,
                     recipient_name
) ;
  
-- write result set to file
   IF (p_in_file_name IS NOT NULL) THEN     
      -- start AWS changes 03/12/2019
      v_stage := 'Get value to know deployed in AWS';
      prc_set_gv_client_aws;
      
      IF gv_client_aws = 1 THEN
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_datadump);
      ELSE  
        v_stage := 'call fnc_get_dir_name_like';
        v_directory_name := fnc_get_dir_name_like(gc_dir_path_like_reports);
      END IF;
      --end AWS changes 03/12/2019 

      v_stage := 'open file';
      file_handler := UTL_FILE.fopen(v_directory_name, p_in_file_name, 'w', 4096);

      v_stage := 'FETCH p_out_result_set';
LOOP  
         FETCH p_out_result_set INTO v_extract;
         EXIT WHEN p_out_result_set%NOTFOUND;
           UTL_FILE.put_line(file_handler, v_extract);           
END LOOP;

    UTL_FILE.fclose(file_handler);
 --start AWS changes 03/12/2019
      IF gv_client_aws = 1 THEN    
        prc_set_gv_report_s3_bucket; 
     
        SELECT pkg_rdsadmin_s3_tasks.upload_to_s3(
               p_bucket_name    =>  gv_report_s3_bucket,
               p_prefix         =>  p_in_file_name, 
               p_s3_prefix      =>  '', 
               p_directory_name =>  'DATA_PUMP_DIR') AS task_id 
          INTO gv_aws_task_id
          FROM DUAL; 
      END IF;   
      --end AWS changes 03/12/2019   
      -- reset ref cursor
      OPEN p_out_result_set FOR SELECT NULL FROM dual;
   END IF; -- p_in_file_name IS NOT NULL

   -- successful
   p_out_return_code := '00';

   COMMIT;  -- release DML locks on temp table
EXCEPTION
    WHEN OTHERS  THEN
      prc_execution_log_entry(c_process_name, 1, 'ERROR', v_stage || v_parm_list || SQLCODE || ':' || SQLERRM, NULL);
      ROLLBACK;  -- release DML locks on temp table
      p_out_return_code := '99';
      IF UTL_FILE.is_open(file_handler) THEN 
          UTL_FILE.fclose(file_handler);
        END IF;

        OPEN p_out_result_set FOR SELECT NULL FROM dual  ;

END PRC_CASH_BUDGET_ISSU_EXTRACT;

END pkg_extracts; -- Package body
